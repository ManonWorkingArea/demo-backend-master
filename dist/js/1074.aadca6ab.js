"use strict";(self["webpackChunknode_backend"]=self["webpackChunknode_backend"]||[]).push([[1074],{19895:function(e,t,s){s.d(t,{A:function(){return S}});var i=s(20641),a=s(90033);const o={class:"aspect-w-16 aspect-h-9"},r={class:"absolute inset-0 flex justify-center items-center"},n={class:"w-full h-full bg-gray-900"},l={ref:"videoElement",autoplay:"",playsinline:"",class:"w-full h-full object-cover"},c=["src"],d={class:"relative bottom-0 left-0 w-full p-4 bg-gray-900 bg-opacity-75 flex justify-center"},h=["disabled"],m=["disabled"],u={key:0},p={key:1},g={key:0,class:"absolute top-0 left-0 w-full p-2"},x={key:1,class:"absolute top-0 right-0 m-2 text-white font-bold code-overlay"},f={key:2,class:"absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-white text-4xl font-bold code-overlay"};function v(e,t,s,v,b,k){return(0,i.uX)(),(0,i.CE)("div",{class:(0,a.C4)(["relative",[b.activeBlock?"isblock":"isunblock"]]),"data-content":"กำลังอัพโหลดไฟล์วีดีโอ กรุณารอสักครู่....."},[(0,i.Lk)("div",o,[(0,i.Lk)("div",r,[(0,i.Lk)("div",n,[(0,i.Lk)("video",l,null,512),b.videoURL?((0,i.uX)(),(0,i.CE)("video",{key:0,src:b.videoURL,controls:"","webkit-playsinline":"",playsinline:"",class:"absolute top-0 left-0 w-full h-full object-cover"},null,8,c)):(0,i.Q3)("",!0)])])]),(0,i.Lk)("div",d,[(0,i.Lk)("button",{onClick:t[0]||(t[0]=(...e)=>k.activateCamera&&k.activateCamera(...e)),disabled:b.recording||b.cameraActive,class:"py-2 px-4 bg-blue-500 text-white rounded hover:bg-blue-600 mr-2"},"1.เปิดกล้อง",8,h),(0,i.Lk)("button",{onClick:t[1]||(t[1]=(...e)=>k.startRecording&&k.startRecording(...e)),disabled:b.recording||!b.cameraActive,class:"py-2 px-4 bg-red-500 text-white rounded hover:bg-red-600 mr-2"},[b.recording?((0,i.uX)(),(0,i.CE)("span",p," กำลังบันทึก... ")):((0,i.uX)(),(0,i.CE)("span",u,"2.บันทึกวีดีโอ"))],8,m),(0,i.Lk)("button",{onClick:t[2]||(t[2]=(...e)=>k.uploadRecordedVideo&&k.uploadRecordedVideo(...e)),class:"py-2 px-4 bg-green-500 text-white rounded hover:bg-green-600"},"3.ส่งวีดีโอ")]),b.recording?((0,i.uX)(),(0,i.CE)("div",g,t[3]||(t[3]=[(0,i.Lk)("div",{class:"bg-red-500 text-white text-sm font-bold px-4 py-2 rounded-full inline-flex items-center"},[(0,i.Lk)("i",{class:"fas fa-circle red-icon mr-1"}),(0,i.eW)(" Recording... ")],-1)]))):(0,i.Q3)("",!0),b.recording?((0,i.uX)(),(0,i.CE)("div",x,(0,a.v_)(b.currentDateTime),1)):(0,i.Q3)("",!0),b.showCode?((0,i.uX)(),(0,i.CE)("div",f,(0,a.v_)(b.code),1)):(0,i.Q3)("",!0)],2)}s(44114),s(14603),s(47566),s(98721);var b=s(57146),k=s(30554),y=s(40475),w={data(){const e=y.A.get("configs"),t=e,s=new b.S3({forcePathStyle:!1,endpoint:t.s3EndpointDefault,region:t.s3Region,ResponseContentEncoding:"utf-8",credentials:{accessKeyId:t.s3Key,secretAccessKey:t.s3Secret}});return{activeBlock:!1,uploadedFiles:[],S3:s,schoolSession:t,outputfile:[],errorText:"",successText:"",previewImages:[],uploadedFileUrl:"",videoElement:null,recording:!1,videoBase64:null,mediaRecorder:null,recordedChunks:[],cameraActive:!1,videoURL:null,mediaStream:null,currentDateTime:"",showCode:!1,code:null,preview:!1}},mounted(){this.videoElement=this.$refs.videoElement,setInterval(this.updateDateTime,1e3)},methods:{async captureImage(){const e=this.$refs.videoElement,t=document.createElement("canvas");t.width=e.videoWidth,t.height=e.videoHeight;const s=t.getContext("2d");s.drawImage(e,0,0,t.width,t.height),t.toBlob((async e=>{try{this.activeBlock=!0;const t=Date.now()+"-"+Math.floor(1e10*Math.random()),s="png",i=`verified_image/${t}.${s}`,a={Bucket:this.schoolSession.s3Bucket,Key:i,Body:e,ACL:"public-read"};await this.S3.send(new k.w(a));const o=`${this.schoolSession.s3Endpoint}${i}`;console.log("Image uploaded successfully:",o),this.$emit("imageUploaded",o),this.activeBlock=!1}catch(t){console.error("Error uploading image:",t),this.activeBlock=!1}}),"image/png")},async uploadRecordedVideo(){if(this.videoBlob&&0!==this.videoBlob.size)try{await this.uploadVideo(this.videoBlob),console.log("Upload successful"),this.successText="Video uploaded successfully"}catch(e){console.error("Upload failed:",e),this.errorText="Error uploading video"}else console.error("No video to upload or video is empty.")},async uploadVideo(e){try{this.activeBlock=!0;const t=Date.now()+"-"+Math.floor(1e10*Math.random()),s="mp4",i=`${t}.${s}`,a={Bucket:this.schoolSession.s3Bucket,Key:"verified/"+i,Body:e,ACL:"public-read"},o=await this.S3.send(new k.w(a));this.uploadedFileUrl=`${this.schoolSession.s3Endpoint}verified/${i}`,console.log("Video uploaded successfully:",o),this.successText="Video uploaded successfully",this.activeBlock=!1,this.$emit("webcam-recorder",this.uploadedFileUrl)}catch(t){console.error("Error uploading video:",t),this.errorText="Error uploading video"}},sendBase64(){this.convertToBase64()},async activateCamera(){try{const e=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0});this.videoElement.srcObject=e,this.mediaStream=e,this.cameraActive=!0,console.log("Camera activated")}catch(e){console.error("Error accessing webcam:",e)}},startRecording(){if(this.cameraActive){this.recordedChunks=[],this.videoURL=null;try{this.mediaRecorder=new MediaRecorder(this.mediaStream),this.mediaRecorder.ondataavailable=this.handleDataAvailable,this.mediaRecorder.start(),this.recording=!0,this.showCode=!0,this.preview=!1,this.generateRandomCode(),console.log("Recording started"),setTimeout(this.stopRecording,5e3)}catch(e){console.error("Error starting recording:",e)}}else console.error("Camera is not active.")},stopRecording(){this.mediaRecorder&&this.recording&&(this.mediaRecorder.stop(),this.recording=!1,this.showCode=!1,console.log("Recording stopped"),this.mediaRecorder.onstop=()=>{const e=new Blob(this.recordedChunks,{type:"video/mp4"});console.log("Blob size:",e.size),e.size>0?(this.videoBlob=e,this.previewRecording()):console.error("No video data available to upload.")})},handleDataAvailable(e){e.data.size>0&&(this.recordedChunks.push(e.data),this.previewRecording())},async previewRecording(){const e=new Blob(this.recordedChunks,{type:"video/mp4"});this.videoURL=URL.createObjectURL(e),console.log("Preview updated")},async convertToBase64(){if(0===this.recordedChunks.length)return void console.error("No video data available.");const e=new Blob(this.recordedChunks,{type:"video/mp4"}),t=await this.blobToBase64(e);this.videoBase64=t,this.$emit("webcam-recorder",this.videoBase64),console.log("Video converted to Base64")},blobToBase64(e){return new Promise(((t,s)=>{const i=new FileReader;i.readAsDataURL(e),i.onloadend=()=>t(i.result),i.onerror=e=>s(e)}))},updateDateTime(){const e=new Date;this.currentDateTime=e.toLocaleString()},generateRandomCode(){const e=Math.floor(1e3+9e3*Math.random());this.code=e.toString()}}},L=s(64621);const T=(0,L.A)(w,[["render",v]]);var S=T},11074:function(e,t,s){s.r(t),s.d(t,{default:function(){return ze}});var i=s(20641);function a(e,t,s,a,o,r){return(0,i.uX)(),(0,i.Wv)((0,i.$y)(r.componentName))}var o=s(52968),r=s(75220),n=s(40475),l=s(90033);const c={key:0,class:"text-center"},d={class:"hidden lg:block mx-auto max-w-2xl px-4 pt-3 pb-4 sm:px-18 sm:pt-3 sm:pb-4 lg:grid lg:max-w-7xl lg:grid-cols-2 lg:gap-x-4"},h={class:"lg:flex lg:items-center lg:justify-between"},m={class:"min-w-0 flex-1"},u={class:"flex","aria-label":"Breadcrumb"},p={role:"list",class:"flex items-center space-x-4"},g={class:"flex items-center"},x={class:"flex items-center"},f={class:"flex items-center"},v={class:"ml-4 text-sm font-bold text-gray-600 hover:text-gray-700 max-w-xs truncate min-w-xs"},b={key:0,class:"bg-gray-900"},k={class:"mx-auto max-w-2xl pt-5 mb-5 sm:px-2 sm:pt-8 sm:pb-8 lg:px-8"},y={"aria-labelledby":"details-heading",class:"mb-5"},w={class:"flex flex-col items-center text-center"},L={id:"details-heading",class:"text-2xl font-bold tracking-tight text-white sm:text-2xl"},T={class:"mt-3 max-w-3xl text-lg text-white"},S={key:0,"aria-labelledby":"details-heading",class:"p-6 bg-white mb-5"},C={key:1,"aria-labelledby":"details-heading",class:"p-6 bg-white mb-5"},E={class:"list-decimal ml-6"},I={key:0},D={class:"text-center"},A={key:1,"aria-labelledby":"details-heading",class:"p-6 bg-white mb-5"},P={class:"list-decimal ml-6"},R={key:0},_={class:"text-center"},$={class:"bg-gray-900"},q={class:"mx-auto max-w-2xl pt-5 mb-5 sm:px-2 sm:pt-8 sm:pb-8 lg:max-w-4xl lg:px-8"},U={"aria-labelledby":"details-heading",class:"mb-5"},O={class:"flex flex-col items-center text-center"},B={id:"details-heading",class:"text-2xl font-bold tracking-tight text-white sm:text-2xl"},Q={class:"mt-3 max-w-3xl text-lg text-white"},F={class:"grid grid-cols-1 gap-6"},X={class:"question px-6 py-4 border-b border-gray-500"},W={class:"font-semibold mb-4"},N=["innerHTML"],j={class:"answer bg-gray-100"},M={class:""},V=["name","value","onClick","checked"],J={class:"ml-2"},z={key:0},K={class:"absolute top-0 left-0 w-full h-full flex justify-center items-center pointer-events-none"},H={class:"text-center opacity-20 transform rotate-25 text-3xl"},G={class:"flex justify-center space-x-4 mb-5"},Y=["disabled"],Z=["onClick"],ee=["disabled"],te={class:"bg-gray-100 py-6"},se={class:"mx-auto max-w-4xl grid grid-cols-1 sm:grid-cols-3 gap-4 sm:px-6 lg:px-8"},ie={class:"bg-white shadow-md rounded-lg p-6 sm:col-span-1"},ae={"aria-labelledby":"details-heading"},oe={class:"flex flex-col items-center text-center"},re={class:"text-center mb-3"},ne={id:"details-heading",class:"text-2xl font-bold tracking-tight text-gray-900 sm:text-4xl"},le={class:"bg-white shadow-md rounded-lg p-6 sm:col-span-2"},ce={"aria-labelledby":"details-heading"},de={class:"flex flex-col items-center text-center"},he={id:"details-heading",class:"text-2xl font-bold tracking-tight text-gray-900 sm:text-2xl"},me={class:"flex flex-col sm:flex-row justify-center items-center mt-8 space-y-4 sm:space-y-0 sm:space-x-4"},ue={key:2,class:"bg-gray-900"},pe={class:"mx-auto max-w-2xl pt-5 mb-5 sm:px-2 sm:pt-8 sm:pb-8 lg:px-8"},ge={"aria-labelledby":"details-heading",class:"mb-5"},xe={class:"flex flex-col items-center text-center"},fe={id:"details-heading",class:"text-2xl font-bold tracking-tight text-white sm:text-2xl"},ve={class:"mt-3 max-w-3xl text-lg text-white"},be={"aria-labelledby":"details-heading",class:"p-6 bg-white mb-5"},ke={class:""},ye={class:"text-3xl"},we={key:0},Le={class:"text-lg"},Te={key:0},Se={class:"text-lg"},Ce={key:2,class:"pt-5 text-sm text-gray-900"},Ee={class:"text-center mt-8"};function Ie(e,t,s,a,o,r){const n=(0,i.g2)("Loader"),Ie=(0,i.g2)("router-link"),De=(0,i.g2)("timer"),Ae=(0,i.g2)("webcam"),Pe=(0,i.g2)("font-awesome-icon");return(0,i.uX)(),(0,i.CE)(i.FK,null,[o.loader?(0,i.Q3)("",!0):((0,i.uX)(),(0,i.CE)("div",c,[(0,i.bF)(n)])),o.loader?((0,i.uX)(),(0,i.CE)("div",{key:1,class:(0,l.C4)(["bg-gray-100 noselect relative",[o.activeBlock?"isblock":"isunblock"]]),"data-content":"กำลังติดต่อฐานข้อมูล กรุณารอสักครู่....."},[(0,i.Lk)("div",d,[(0,i.Lk)("div",h,[(0,i.Lk)("div",m,[(0,i.Lk)("nav",u,[(0,i.Lk)("ol",p,[(0,i.Lk)("li",null,[(0,i.Lk)("div",null,[(0,i.bF)(Ie,{to:"/",class:"text-gray-400 hover:text-gray-500"},{default:(0,i.k6)((()=>t[7]||(t[7]=[(0,i.Lk)("svg",{class:"h-5 w-5 flex-shrink-0",viewBox:"0 0 20 20",fill:"currentColor","aria-hidden":"true"},[(0,i.Lk)("path",{"fill-rule":"evenodd",d:"M9.293 2.293a1 1 0 011.414 0l7 7A1 1 0 0117 11h-1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-3a1 1 0 00-1-1H9a1 1 0 00-1 1v3a1 1 0 01-1 1H5a1 1 0 01-1-1v-6H3a1 1 0 01-.707-1.707l7-7z","clip-rule":"evenodd"})],-1),(0,i.Lk)("span",{class:"sr-only"},"Home",-1)]))),_:1})])]),(0,i.Lk)("li",null,[(0,i.Lk)("div",g,[t[9]||(t[9]=(0,i.Lk)("svg",{class:"h-5 w-5 flex-shrink-0 text-gray-300",fill:"currentColor",viewBox:"0 0 20 20","aria-hidden":"true"},[(0,i.Lk)("path",{d:"M5.555 17.776l8-16 .894.448-8 16-.894-.448z"})],-1)),(0,i.bF)(Ie,{to:"bypass"===o.session.mode?"/user/employee":"/lesson/home",class:"ml-4 text-sm font-medium text-gray-500 hover:text-gray-700"},{default:(0,i.k6)((()=>t[8]||(t[8]=[(0,i.eW)("หลักสูตร")]))),_:1},8,["to"])])]),(0,i.Lk)("li",null,[(0,i.Lk)("div",x,[t[10]||(t[10]=(0,i.Lk)("svg",{class:"h-5 w-5 flex-shrink-0 text-gray-300",fill:"currentColor",viewBox:"0 0 20 20","aria-hidden":"true"},[(0,i.Lk)("path",{d:"M5.555 17.776l8-16 .894.448-8 16-.894-.448z"})],-1)),(0,i.bF)(Ie,{to:"/lesson/detail/"+o.lesson._id,class:"ml-4 text-sm font-medium text-gray-500 hover:text-gray-700 max-w-xs truncate min-w-xs"},{default:(0,i.k6)((()=>[(0,i.eW)((0,l.v_)(this.lesson.name),1)])),_:1},8,["to"])])]),(0,i.Lk)("li",null,[(0,i.Lk)("div",f,[t[11]||(t[11]=(0,i.Lk)("svg",{class:"h-5 w-5 flex-shrink-0 text-gray-300",fill:"currentColor",viewBox:"0 0 20 20","aria-hidden":"true"},[(0,i.Lk)("path",{d:"M5.555 17.776l8-16 .894.448-8 16-.894-.448z"})],-1)),(0,i.Lk)("span",v,(0,l.v_)(this.exam.name),1)])])])])])])]),(0,i.Lk)("div",null,[(0,i.bF)(De,{ref:"timerComponent",mode:"blank",timer:60,onTimerStatus:r.handleTimerStatus,onUpdateTimer:r.handleUpdate,onTimerFinished:r.handleFinish},null,8,["onTimerStatus","onUpdateTimer","onTimerFinished"]),(0,i.Lk)("section",{"aria-labelledby":"details-heading",class:"p-6 bg-white mb-5",style:(0,l.Tr)({display:o.shouldShowDiv?"block":"none"})},[(0,i.bF)(Ae,{ref:"webcamComponent",onWebcamRecorder:r.handleWebcamRecorder,onImageCaptured:r.handleImageCaptured,onImageUploaded:r.handleImageUploaded},null,8,["onWebcamRecorder","onImageCaptured","onImageUploaded"])],4),"welcome"===this.examState?((0,i.uX)(),(0,i.CE)("div",b,[(0,i.Lk)("div",k,[(0,i.Lk)("section",y,[(0,i.Lk)("div",w,[(0,i.Lk)("h2",L,(0,l.v_)(this.lesson.name),1),(0,i.Lk)("p",T,(0,l.v_)(this.exam.name),1)])]),"yes"===o.exam.verified?((0,i.uX)(),(0,i.CE)(i.FK,{key:0},[o.videoVerified?(0,i.Q3)("",!0):((0,i.uX)(),(0,i.CE)("section",S,t[12]||(t[12]=[(0,i.Lk)("h3",{class:"font-bold text-lg mb-4"},"การยืนยันตัวก่อนสอบ",-1),(0,i.Lk)("ol",{class:"list-decimal ml-6 pb-3"},[(0,i.Lk)("li",null,"กดปุ่มเปิดกล้องและอนุญาติให้เว็บไซต์ทำการใช้งานกล้องได้"),(0,i.Lk)("li",null,'คลิกที่ปุ่ม "บันทึก" เพื่อเริ่มต้นการบันทึกข้อมูล'),(0,i.Lk)("li",null,"อ่านตัวหนังสือบนหน้าจอ"),(0,i.Lk)("li",null,"หลังจากผ่านไป 5 วินาทีวีดีโอจะถูกบันทึกโดยอัตโนมัติ"),(0,i.Lk)("li",null,"จะมีการสุ่มบันทึกภาพระหว่างการสอบ")],-1)]))),o.videoVerified?((0,i.uX)(),(0,i.CE)("section",C,[t[23]||(t[23]=(0,i.Lk)("h3",{class:"font-bold text-lg mb-4"},"Instructions",-1)),(0,i.Lk)("ol",E,[(0,i.Lk)("li",null,[t[13]||(t[13]=(0,i.eW)("แบบทดสอบก่อนเรียน ข้อสอบทั้งหมด ")),(0,i.Lk)("strong",null,(0,l.v_)(this.exam.total),1),t[14]||(t[14]=(0,i.eW)(" ข้อ เวลาในการทำ ")),(0,i.Lk)("strong",null,(0,l.v_)(this.exam.timer),1),t[15]||(t[15]=(0,i.eW)(" นาที"))]),"no"!==this.exam.is_score?((0,i.uX)(),(0,i.CE)("li",I,[t[16]||(t[16]=(0,i.eW)("เกณฑ์ในการผ่านการประเมิน ")),(0,i.Lk)("strong",null,(0,l.v_)(this.exam.measure),1),t[17]||(t[17]=(0,i.eW)(" คะแนน"))])):(0,i.Q3)("",!0),t[18]||(t[18]=(0,i.Lk)("li",null,'คลิกที่ปุ่ม "เริ่มการสอบ" เพื่อเริ่มต้นการสอบ',-1)),t[19]||(t[19]=(0,i.Lk)("li",null,"คุณจะมีเวลาจำกัดในการทำข้อสอบ ตัวจับเวลาจะปรากฏที่ด้านบนของหน้าจอ",-1)),t[20]||(t[20]=(0,i.Lk)("li",null,"ตอบคำถามทั้งหมดให้ดีที่สุดที่คุณสามารถทำได้",-1)),t[21]||(t[21]=(0,i.Lk)("li",null,"คุณสามารถส่งคำตอบของคุณได้เพียงครั้งเดียว เช็คคำตอบของคุณอีกครั้งก่อนส่ง",-1))]),t[24]||(t[24]=(0,i.Lk)("h3",{class:"font-bold text-lg mt-8 mb-4"},"Rules",-1)),t[25]||(t[25]=(0,i.Lk)("ul",{class:"list-disc ml-6"},[(0,i.Lk)("li",null,"Do not use any external resources or communication during the exam."),(0,i.Lk)("li",null,"Do not share the exam questions or answers with anyone."),(0,i.Lk)("li",null,"Do not use any prohibited devices during the exam."),(0,i.Lk)("li",null,"Any attempt to cheat or violate the rules will result in immediate disqualification.")],-1)),(0,i.Lk)("div",D,[(0,i.bF)(Ie,{to:"/lesson/detail/"+o.lesson._id,class:"mt-8 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mr-2"},{default:(0,i.k6)((()=>t[22]||(t[22]=[(0,i.eW)("ไปที่หลักสูตร")]))),_:1},8,["to"]),(0,i.Lk)("button",{class:"mt-8 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded",onClick:t[0]||(t[0]=(...e)=>r.startExam&&r.startExam(...e))},"เริ่มการสอบ")])])):(0,i.Q3)("",!0)],64)):((0,i.uX)(),(0,i.CE)("section",A,[t[36]||(t[36]=(0,i.Lk)("h3",{class:"font-bold text-lg mb-4"},"Instructions",-1)),(0,i.Lk)("ol",P,[(0,i.Lk)("li",null,[t[26]||(t[26]=(0,i.eW)("แบบทดสอบก่อนเรียน ข้อสอบทั้งหมด ")),(0,i.Lk)("strong",null,(0,l.v_)(this.exam.total),1),t[27]||(t[27]=(0,i.eW)(" ข้อ เวลาในการทำ ")),(0,i.Lk)("strong",null,(0,l.v_)(this.exam.timer),1),t[28]||(t[28]=(0,i.eW)(" นาที"))]),"no"!==this.exam.is_score?((0,i.uX)(),(0,i.CE)("li",R,[t[29]||(t[29]=(0,i.eW)("เกณฑ์ในการผ่านการประเมิน ")),(0,i.Lk)("strong",null,(0,l.v_)(this.exam.measure),1),t[30]||(t[30]=(0,i.eW)(" คะแนน"))])):(0,i.Q3)("",!0),t[31]||(t[31]=(0,i.Lk)("li",null,'คลิกที่ปุ่ม "เริ่มการสอบ" เพื่อเริ่มต้นการสอบ',-1)),t[32]||(t[32]=(0,i.Lk)("li",null,"คุณจะมีเวลาจำกัดในการทำข้อสอบ ตัวจับเวลาจะปรากฏที่ด้านบนของหน้าจอ",-1)),t[33]||(t[33]=(0,i.Lk)("li",null,"ตอบคำถามทั้งหมดให้ดีที่สุดที่คุณสามารถทำได้",-1)),t[34]||(t[34]=(0,i.Lk)("li",null,"คุณสามารถส่งคำตอบของคุณได้เพียงครั้งเดียว เช็คคำตอบของคุณอีกครั้งก่อนส่ง",-1))]),t[37]||(t[37]=(0,i.Lk)("h3",{class:"font-bold text-lg mt-8 mb-4"},"Rules",-1)),t[38]||(t[38]=(0,i.Lk)("ul",{class:"list-disc ml-6"},[(0,i.Lk)("li",null,"Do not use any external resources or communication during the exam."),(0,i.Lk)("li",null,"Do not share the exam questions or answers with anyone."),(0,i.Lk)("li",null,"Do not use any prohibited devices during the exam."),(0,i.Lk)("li",null,"Any attempt to cheat or violate the rules will result in immediate disqualification.")],-1)),(0,i.Lk)("div",_,[(0,i.bF)(Ie,{to:"/lesson/detail/"+o.lesson._id,class:"mt-8 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mr-2"},{default:(0,i.k6)((()=>t[35]||(t[35]=[(0,i.eW)("ไปที่หลักสูตร")]))),_:1},8,["to"]),(0,i.Lk)("button",{class:"mt-8 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded",onClick:t[1]||(t[1]=(...e)=>r.startExam&&r.startExam(...e))},"เริ่มการสอบ")])]))])])):(0,i.Q3)("",!0),"exam"===this.examState?((0,i.uX)(),(0,i.CE)(i.FK,{key:1},[(0,i.Lk)("div",$,[(0,i.Lk)("div",q,[(0,i.Lk)("section",U,[(0,i.Lk)("div",O,[(0,i.Lk)("h2",B,(0,l.v_)(this.lesson.name),1),(0,i.Lk)("p",Q,(0,l.v_)(this.exam.name),1)])]),(0,i.Lk)("div",F,[((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(r.paginatedQuestions,((s,a)=>((0,i.uX)(),(0,i.CE)("div",{key:s.number,class:(0,l.C4)([{"unanswered-border":o.unansweredQuestions.includes(s.number)},"relative bg-white shadow-md"])},[(0,i.Lk)("div",X,[(0,i.Lk)("h3",W,(0,l.v_)("โจทย์ "+((o.currentPage-1)*o.questionsPerPage+a+1)),1),(0,i.Lk)("div",{innerHTML:s.text},null,8,N)]),(0,i.Lk)("div",j,[(0,i.Lk)("form",null,[(0,i.Lk)("div",M,[((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(s.answers,(e=>((0,i.uX)(),(0,i.CE)("label",{key:e.value,class:"block p-4 border-b border-gray-300 hover:bg-gray-200 cursor-pointer"},[(0,i.Lk)("input",{type:"radio",name:s.number,value:e.value,onClick:t=>r.addUserData(s.number,e.value),checked:r.isOptionSelected(s.number,e.value)},null,8,V),(0,i.Lk)("span",J,(0,l.v_)(e.label),1),"yes"===this.exam.adminmode&&s.correct===e.value?((0,i.uX)(),(0,i.CE)("span",z,[(0,i.bF)(Pe,{icon:"check-circle",class:"text-green-500 ml-2"})])):(0,i.Q3)("",!0)])))),128))])])]),(0,i.Lk)("div",K,[(0,i.Lk)("div",H,[t[39]||(t[39]=(0,i.Lk)("span",{class:"font-bold"},"Licensed to : ",-1)),t[40]||(t[40]=(0,i.eW)()),t[41]||(t[41]=(0,i.Lk)("br",null,null,-1)),(0,i.eW)(" "+(0,l.v_)(o.session.user.firstname+" "+o.session.user.lastname)+" ("+(0,l.v_)(o.userIp)+") ",1),t[42]||(t[42]=(0,i.Lk)("br",null,null,-1)),(0,i.eW)(" "+(0,l.v_)(e.currentDateTime),1)])])],2)))),128)),(0,i.Lk)("div",G,[(0,i.Lk)("button",{onClick:t[2]||(t[2]=(...e)=>r.goToPreviousPage&&r.goToPreviousPage(...e)),disabled:1===o.currentPage,class:"text-white"}," ย้อนกลับ ",8,Y),((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(Math.ceil(o.questions.length/o.questionsPerPage),(e=>((0,i.uX)(),(0,i.CE)("button",{key:e,onClick:t=>r.setPage(e),class:(0,l.C4)([e===o.currentPage?"bg-white text-black":"text-white","rounded-xs hover:bg-gray-200 hover:text-gray-600 px-2"])},(0,l.v_)(e),11,Z)))),128)),(0,i.Lk)("button",{onClick:t[3]||(t[3]=(...e)=>r.goToNextPage&&r.goToNextPage(...e)),disabled:o.currentPage===Math.ceil(o.questions.length/o.questionsPerPage),class:"text-white"}," ถัดไป ",8,ee)])])])]),(0,i.Lk)("div",te,[(0,i.Lk)("div",se,[(0,i.Lk)("div",ie,[(0,i.Lk)("section",ae,[(0,i.Lk)("div",oe,[(0,i.Lk)("div",re,[(0,i.Lk)("span",null,"ความคืบหน้า "+(0,l.v_)(r.answeredQuestionsCount.answered)+" / "+(0,l.v_)(r.answeredQuestionsCount.total),1)]),(0,i.Lk)("h2",ne,[(0,i.bF)(De,{ref:"timerComponent",mode:"display",timer:o.examDuration,onTimerStatus:r.handleTimerStatus,onUpdateTimer:r.handleUpdate,onTimerFinished:r.handleFinish},null,8,["timer","onTimerStatus","onUpdateTimer","onTimerFinished"])]),t[43]||(t[43]=(0,i.Lk)("p",{class:"mt-3 max-w-3xl text-lg text-gray-600"},"เวลาทำข้อสอบคงเหลือ",-1))])])]),(0,i.Lk)("div",le,[(0,i.Lk)("section",ce,[(0,i.Lk)("div",de,[(0,i.Lk)("h2",he,(0,l.v_)(this.exam.name),1),t[44]||(t[44]=(0,i.Lk)("p",{class:"mt-3 max-w-3xl text-lg text-gray-600"},"อ่านและทำแบบทดสอบให้ครบทุกข้อก่อนส่งคำตอบ",-1))]),(0,i.Lk)("div",me,[(0,i.Lk)("button",{type:"button",class:"bg-green-500 hover:bg-green-600 px-6 py-3 rounded-md text-white font-semibold",onClick:t[4]||(t[4]=(...e)=>r.submitExam&&r.submitExam(...e))},"ส่งคำตอบ"),(0,i.Lk)("button",{type:"button",class:"bg-red-500 hover:bg-red-600 px-6 py-3 rounded-md text-white font-semibold",onClick:t[5]||(t[5]=(...e)=>r.cancelExam&&r.cancelExam(...e))},"ยกเลิกการสอบ")])])])])])],64)):(0,i.Q3)("",!0),"result"===this.examState?((0,i.uX)(),(0,i.CE)("div",ue,[(0,i.Lk)("div",pe,[(0,i.Lk)("section",ge,[(0,i.Lk)("div",xe,[(0,i.Lk)("h2",fe,(0,l.v_)(this.lesson.name),1),(0,i.Lk)("p",ve,(0,l.v_)(this.exam.name),1)])]),(0,i.Lk)("section",be,[t[50]||(t[50]=(0,i.Lk)("div",{class:"text-center pb-5"},[(0,i.Lk)("h2",{id:"details-heading",class:"text-2xl font-bold text-gray-900 mb-5"},"ผลการทำแบบทดสอบ"),(0,i.Lk)("p",{class:"text-sm text-gray-900"},"คุณทำแบบทดสอบเรียบร้อยแล้ว.ตรวจสอบผลการประเมินได้จากข้อมูลด้านล่าง")],-1)),r.checkResultExamDue(this.exam.result_duedate)&&"now"!==this.exam.result?((0,i.uX)(),(0,i.CE)("div",{key:1,class:(0,l.C4)("no"===this.exam.is_score?"grid grid-cols-1 gap-4 border-t border-gray-200 pt-5 border-b border-gray-200 pb-5 text-center":"grid grid-cols-1 gap-4 border-t border-gray-200 pt-5 border-b border-gray-200 pb-5")},[t[48]||(t[48]=(0,i.Lk)("div",{class:""},[(0,i.Lk)("h3",{class:"font-bold text-lg"},"ยังไม่ได้ประกาศผลการทดสอบ:"),(0,i.Lk)("p",{class:"text-3xl"},"ประกาศผลวันที่")],-1)),"yes"===this.exam.is_score?((0,i.uX)(),(0,i.CE)("div",Te,[t[47]||(t[47]=(0,i.Lk)("h3",{class:"font-bold text-lg"},null,-1)),(0,i.Lk)("p",Se,(0,l.v_)(r.formatThaidate(this.exam.result_duedate)),1)])):(0,i.Q3)("",!0)],2)):((0,i.uX)(),(0,i.CE)("div",{key:0,class:(0,l.C4)("no"===this.exam.is_score?"grid grid-cols-1 gap-4 border-t border-gray-200 pt-5 border-b border-gray-200 pb-5 text-center":"grid grid-cols-2 gap-4 border-t border-gray-200 pt-5 border-b border-gray-200 pb-5")},[(0,i.Lk)("div",ke,[t[45]||(t[45]=(0,i.Lk)("h3",{class:"font-bold text-lg"},"คะแนน:",-1)),(0,i.Lk)("p",ye,(0,l.v_)(this.score.score)+"/"+(0,l.v_)(this.exam.total),1)]),"yes"===this.exam.is_score?((0,i.uX)(),(0,i.CE)("div",we,[t[46]||(t[46]=(0,i.Lk)("h3",{class:"font-bold text-lg"},"ผลลัพธ์:",-1)),(0,i.Lk)("p",Le,[this.score.score>=this.exam.measure?((0,i.uX)(),(0,i.Wv)(Pe,{key:0,icon:"check-circle",class:"text-green-500"})):((0,i.uX)(),(0,i.Wv)(Pe,{key:1,icon:"times-circle",class:"text-red-500"})),(0,i.eW)(" "+(0,l.v_)(this.score.score>=this.exam.measure?"ผ่านการรับรอง":"ไม่ผ่านการรับรอง"),1)])])):(0,i.Q3)("",!0)],2)),"pre"===this.exam.type?((0,i.uX)(),(0,i.CE)("p",Ce,"Note: คะแนนในแบบทดสอบนี้ไม่มีผลกับการออกใบรับรองผลการเรียน.")):(0,i.Q3)("",!0),(0,i.Lk)("div",Ee,[(0,i.bF)(Ie,{to:"/lesson/detail/"+o.lesson._id,class:"bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded"},{default:(0,i.k6)((()=>t[49]||(t[49]=[(0,i.eW)("กลับสู่บทเรียน")]))),_:1},8,["to"]),"yes"===this.exam.is_repeat&&this.score.score<this.exam.measure?((0,i.uX)(),(0,i.CE)("button",{key:0,class:"ml-2 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded",onClick:t[6]||(t[6]=(...e)=>r.resetExam&&r.resetExam(...e))},"ทดสอบใหม่")):(0,i.Q3)("",!0)])])])])):(0,i.Q3)("",!0)])],2)):(0,i.Q3)("",!0)],64)}s(44114),s(98992),s(23215),s(30670),s(3949),s(81454),s(37550);var De=s(9964),Ae=s(57313),Pe=s(19895),Re=s(75435);const _e={key:0},$e={key:0},qe={key:1};function Ue(e,t,s,a,o,r){return"display"===s.mode?((0,i.uX)(),(0,i.CE)("div",_e,[o.timeLeft>=0||!o.timerStarted?((0,i.uX)(),(0,i.CE)("div",$e,[(0,i.Lk)("p",null,(0,l.v_)(r.formattedTime),1)])):((0,i.uX)(),(0,i.CE)("div",qe,t[0]||(t[0]=[(0,i.Lk)("p",null,"OO:OO:OO",-1)])))])):(0,i.Q3)("",!0)}s(54520),s(72577);var Oe={props:{timer:{type:Number,default:5},mode:{type:String,default:"display"}},data(){return{endTime:null,timeLeft:null,interval:null,timerStarted:!1}},computed:{formattedTime(){let e=null!==this.timeLeft?this.timeLeft:60*this.timer;const t=Math.floor(e/60),s=e%60;return`${t}:${s.toString().padStart(2,"0")}`}},methods:{checkAndEmitStatus(){const e=JSON.parse(sessionStorage.getItem("timers"))||[],t=(new Date).getTime(),s=e.some((e=>t<e.endTime));this.$emit("timer-status",s?"resume":"fresh")},updateCountdown(){const e=(new Date).getTime();this.timeLeft=Math.floor((this.endTime-e)/1e3),this.timeLeft<0&&(clearInterval(this.interval),this.timeLeft=0,this.timerFinished())},startTimer(){if(this.timerStarted)return;const e=(new Date).getTime(),t=60*this.timer*1e3;this.endTime=e+t,this.timeLeft=t/1e3,this.timerStarted=!0,this.storeTimer({startTime:e,endTime:this.endTime}),this.initializeCountdown()},storeTimer(e){let t=JSON.parse(sessionStorage.getItem("timers"))||[];t.push(e),sessionStorage.setItem("timers",JSON.stringify(t)),this.$emit("update-timer",e)},resetTimer(){clearInterval(this.interval),this.endTime=null,this.timeLeft=null,this.timerStarted=!1,sessionStorage.removeItem("timers")},timerFinished(){this.$emit("timer-finished",{endTime:this.endTime}),this.clearFinishedTimer(this.endTime),this.timerStarted=!1},clearFinishedTimer(e){let t=JSON.parse(sessionStorage.getItem("timers"))||[];t=t.filter((t=>t.endTime!==e)),t.length>0?sessionStorage.setItem("timers",JSON.stringify(t)):sessionStorage.removeItem("timers")},initializeCountdown(){this.updateCountdown(),this.interval=setInterval(this.updateCountdown,1e3)},checkSessionAndAutoStart(){const e=JSON.parse(sessionStorage.getItem("timers"))||[],t=(new Date).getTime(),s=e.find((e=>t<e.endTime));s&&(this.endTime=s.endTime,this.timerStarted=!0,this.initializeCountdown())}},mounted(){this.checkSessionAndAutoStart(),this.$nextTick((()=>{this.checkAndEmitStatus()}))},beforeUnmount(){clearInterval(this.interval)}},Be=s(64621);const Qe=(0,Be.A)(Oe,[["render",Ue]]);var Fe=Qe,Xe=s(73288),We=s(63084),Ne={name:"Lesson Assessment",components:{webcam:Pe.A,Loader:Re.A,Timer:Fe},data(){return{limitItem:50,limitOptions:[1,5,10,50,100,200,500,600,700,800,1e3,2e3,3e3],currentPage:1,totalPages:0,totalItems:0,questionsPerPage:10,shouldShowDiv:!0,activeBlock:!1,loader:!1,examState:"",shuffleQuestions:!0,shuffleAnswers:!0,showWelcome:!0,examDuration:0,examTemp:{answers:{}},videoVerified:void 0,isSubmitting:!1,score:[],enroll:[],unansweredQuestions:[],userIp:"0.0.0.0",questions:[],capturedImages:[],playOption:"step",login:n.A.get("session","login"),configs:n.A.get("configs"),session:n.A.get("session"),dataItem:this.$route.params.cid,examItem:this.$route.params.eid,examType:this.$route.params.type,examRound:this.$route.params.round,deviceType:Ae.A.deviceDetect(),lesson:[],exam:[],player:[],progress:[],progressArray:[],param_id:"",param_ep:"",loading_sources:!0,timeout:!1,playerLogo:"",playerSource:"",playerPoster:"",displayExam:!1,webcamRecord:!1,playerOptions:{controls:["play-large","current-time","play","mute","volume","progress","settings","fullscreen"],settings:["quality","speed","loop"],retestScore:null,retestStatus:null}}},methods:{async fetchUserIP(){try{const e=await fetch("https://api.ipify.org?format=json");if(!e.ok)throw new Error("Failed to fetch IP address");const t=await e.json();this.userIp=t.ip,console.log("Fetched User IP Address:",this.userIp)}catch(e){console.error("Error fetching user IP:",e)}},checkResultExamDue(e){const t=420,s=new Date(e),i=new Date(s.getUTCFullYear(),s.getUTCMonth(),s.getUTCDate(),s.getUTCHours(),s.getUTCMinutes()+t),a=new Date,o=new Date(a.getUTCFullYear(),a.getUTCMonth(),a.getUTCDate(),a.getUTCHours(),a.getUTCMinutes()+t);return o<i},areAllQuestionsAnsweredOnCurrentPage(){const e=(this.currentPage-1)*this.questionsPerPage,t=e+this.questionsPerPage,s=this.questions.slice(e,t);return s.every((e=>this.examTemp.answers[e.number]))},handleImageCaptured(e){this.capturedImages.push(e)},handleImageUploaded(e){this.capturedImages.push(e),this.updateVerifiedImage()},async updateVerifiedImage(){try{if(0===this.capturedImages.length)return void console.error("No images captured.");let e=this.enroll&&this.enroll.capture?{...this.enroll.capture}:{};"post"===this.exam.type?this.retestStatus?e.retest={urls:[...this.capturedImages]}:e.post={urls:[...this.capturedImages]}:"pre"===this.exam.type&&(e.pre={urls:[...this.capturedImages]}),this.enroll.capture=e;const t={data:{capture:this.enroll.capture}},{data:s,status:i}=await this.$Request.PUT(`enroll/${this.enroll._id}`,t,this.configs.key);console.log(s,i)}catch(e){console.error(e)}},goToNextPage(){if(!this.areAllQuestionsAnsweredOnCurrentPage())return void Xe.A.prompt({title:"เกิดข้อผิดพลาด",message:"คุณยังทำแบบทดสอบในหน้านี้ไม่ครบทุกข้อ !",confirm:async()=>{},cancel:()=>{}});this.$refs.webcamComponent.captureImage();const e=Math.ceil(this.questions.length/this.questionsPerPage);this.currentPage<e&&(this.currentPage++,window.scrollTo({top:0,behavior:"smooth"}))},goToPreviousPage(){this.areAllQuestionsAnsweredOnCurrentPage()?(this.$refs.webcamComponent.captureImage(),this.currentPage>1&&(this.currentPage--,window.scrollTo({top:0,behavior:"smooth"}))):Xe.A.prompt({title:"เกิดข้อผิดพลาด",message:"คุณยังทำแบบทดสอบในหน้านี้ไม่ครบทุกข้อ !",confirm:async()=>{},cancel:()=>{}})},setPage(e){this.areAllQuestionsAnsweredOnCurrentPage()?(this.currentPage=e,this.$refs.webcamComponent.captureImage()):Xe.A.prompt({title:"เกิดข้อผิดพลาด",message:"คุณยังทำแบบทดสอบในหน้านี้ไม่ครบทุกข้อ !",confirm:async()=>{},cancel:()=>{}})},determineInitialState(){const e=localStorage.getItem("examTemp");e&&(this.examTemp=JSON.parse(e));const t=JSON.parse(sessionStorage.getItem("timers"))||[],s=(new Date).getTime(),i=t.some((e=>s<e.endTime));this.score&&Object.keys(this.score).length>0?this.retestStatus?(We.A.log("No Score",this.score),this.examState=i?"exam":"welcome"):(We.A.log("Has Score",this.score),this.examState="result",this.shouldShowDiv=!1):(We.A.log("No Score",this.score),this.examState=i?"exam":"welcome")},startTimer(){this.$refs.timerComponent.startTimer()},resetTimer(){this.$refs.timerComponent.resetTimer()},handleUpdate(e){We.A.log("Timer updated:",e)},handleFinish(e){this.timeout=!0,this.submitExam(!0),We.A.log("Timer finished:",e)},handleTimerStatus(e){We.A.log("handleTimerStatus:",e)},preventCopyPaste(e){e.preventDefault(),alert("Copying and pasting are disabled on this page.")},isOptionSelected(e,t){if(this.examTemp.answers&&this.examTemp.answers[e]){const s=this.examTemp.answers[e].map((e=>e.answer));return s.includes(t)}return!1},handleWebcamRecorder(e){this.videoVerified=e,localStorage.setItem("webcamRecord",e),this.shouldShowDiv=!1},shuffle(e){let t,s=e.length;while(0!=s)t=Math.floor(Math.random()*s),s--,[e[s],e[t]]=[e[t],e[s]];return e},startExam(){this.showWelcome=!1,this.examState="exam",this.renderExam(),this.$refs.webcamComponent.captureImage(),this.$refs.timerComponent.startTimer()},renderExam(){this.shuffleQuestions&&(this.questions=this.shuffle(this.questions)),this.shuffleAnswers&&this.questions.forEach((e=>{e.answers=this.shuffle(e.answers)}))},addUserData(e,t){const s=(new Date).getTime();this.examTemp.answers[e]=[{answer:t,timestamp:s}],localStorage.setItem("examTemp",JSON.stringify(this.examTemp))},calculateScore(){let e=0;for(const t of this.questions){We.A.log("question",t);const s=this.examTemp.answers[t.number];We.A.log("userAnswer",s),s&&s[0].answer===t.correct&&e++}return e},resetAnswers(){for(const e of this.questions)this.examTemp.answers[e.number]=null;localStorage.setItem("examTemp",JSON.stringify(this.examTemp))},async resetExam(){this.examState="welcome",this.showWelcome=!0,this.examTemp.answers={};try{const e=await this.addQuestionsToExam(this.examItem);We.A.log("updatedExams",e),this.shuffleQuestions&&(this.questions=this.shuffle(e.questionArray),this.questions.forEach((e=>{e.answers=this.shuffle(e.answers)})))}catch(e){console.error("Error resetting the exam:",e)}},async submitExam(){if(this.unansweredQuestions=[],this.isSubmitting)return;this.isSubmitting=!0;const e=(new Date).getTime();let t=!0;for(const i of this.questions)if(!this.examTemp.answers[i.number]){t=!1;break}if(t||this.timeout){this.examTemp.submitTime=e,this.examTemp.remark=this.timeout?"timeout":"user",this.examTemp.score=this.calculateScore();try{await this.saveScore(this.examTemp),this.examState="result",this.shouldShowDiv=!1,this.examTemp.score>=this.exam.measure||this.examTemp.score<this.exam.measure&&"yes"===this.exam.is_repeat?We.A.log("Pass or allowed to retake"):We.A.log("Fail and not allowed to retake")}catch(s){console.error("Error saving score:",s)}}else this.questions.forEach((e=>{this.examTemp.answers[e.number]||this.unansweredQuestions.push(e.number)})),Xe.A.prompt({title:"เกิดข้อผิดพลาด",message:"คุณยังทำแบบทดสอบไม่ครบทุกข้อ !",confirm:async()=>{},cancel:()=>{}}),this.startTimer();this.isSubmitting=!1},async saveScore(e){try{this.activeBlock=!0,this.$refs.webcamComponent.captureImage();let t="";this.retestStatus&&(t="retest");const s=await fetch("https://gateway.cloudrestfulapi.com/api/score/query",{method:"POST",headers:{"Content-Type":"application/json","client-token-key":this.configs.key},body:JSON.stringify({method:"find",args:[{$and:[{userID:this.session.userID,examID:this.examItem,courseID:this.dataItem,type:t}]}]})}),i=await s.json();if(0===i.length||"yes"===this.exam.is_repeat&&i.length>0){We.A.log("No Score or Can Repeat Exam");const s=await fetch("https://gateway.cloudrestfulapi.com/api/score/",{method:"POST",headers:{"Content-Type":"application/json","client-token-key":this.configs.key},body:JSON.stringify({data:{userID:this.session.userID,examID:this.examItem,courseID:this.dataItem,score:e.score,remark:e.remark,startTime:e.startTime,submitTime:e.submitTime,answer:e.answers,type:t},options:{}})}),i=await s.json();if(200===s.status){this.examState="result",this.shouldShowDiv=!1,this.score=i,localStorage.removeItem("examTemp");let e=this.enroll&&this.enroll.verified?this.enroll.verified:{},t=localStorage.getItem("webcamRecord");"post"===this.exam.type?this.retestStatus?e.retest={status:!0,url:t}:e.post={status:!0,url:t}:"pre"===this.exam.type&&(e.pre={status:!0,url:t}),this.enroll.verified=e;const s={data:{verified:this.enroll.verified}},{data:a,status:o}=await this.$Request.PUT(`enroll/${this.enroll._id}`,s,this.configs.key);We.A.log(a,o),localStorage.removeItem("webcamRecord"),this.activeBlock=!1;const r=await fetch("https://gateway.cloudrestfulapi.com/api/enroll/query",{method:"POST",headers:{"Content-Type":"application/json","client-token-key":this.configs.key},body:JSON.stringify({method:"find",args:[{$and:[{courseID:this.dataItem,userID:this.session.userID}]}]})}),n=await r.json(),l={...n[0]};l.analytics={...l.analytics},"post"===this.exam.type?this.retestStatus?l.analytics.retest={req:!0,has:!0,measure:this.exam.measure,score:this.score.score,result:this.score.score>=this.exam.measure,message:this.score.score>=this.exam.measure?"ผ่านการรับรอง":"ไม่ผ่านการรับรอง"}:l.analytics.post={req:!0,has:!0,verified:"xxx",measure:this.exam.measure,score:this.score.score,result:this.score.score>=this.exam.measure,message:this.score.score>=this.exam.measure?"ผ่านการรับรอง":"ไม่ผ่านการรับรอง"}:"pre"===this.exam.type&&(l.analytics.pre={req:!0,has:!0,verified:"xxx",measure:this.exam.measure,score:this.score.score,result:this.score.score>=this.exam.measure,message:this.score.score>=this.exam.measure?"ผ่านการรับรอง":"ไม่ผ่านการรับรอง"});const c=n[0]._id,d=`https://gateway.cloudrestfulapi.com/api/enroll/${c}`,h={data:{analytics:l.analytics},options:{}},m=await fetch(d,{method:"PUT",headers:{"Content-Type":"application/json","client-token-key":this.configs.key},body:JSON.stringify(h)});await m.json(),this.$refs.timerComponent.resetTimer()}}else We.A.log("Has Score || Can't Repeat Exam")}catch(t){We.A.log(t)}},formatSeconds(e){return De.A.secondsToTime(e)},formatThaidate(e){return De.A.toThaiDatetime(e)},detectDevice(){return Ae.A.deviceDetect()},async getData(){try{this.loader=!1,this.loading_sources=!1;const e=await fetch("https://gateway.cloudrestfulapi.com/api/course/"+this.dataItem,{method:"GET",headers:{"Content-Type":"application/json","client-token-key":this.configs.key}}),t=await e.json();if(localStorage.removeItem("webcamRecord"),200===e.status){this.lesson=t;const e=await fetch("https://gateway.cloudrestfulapi.com/api/exam/"+this.examItem,{method:"GET",headers:{"Content-Type":"application/json","client-token-key":this.configs.key}}),s=await e.json();console.log("examReturn",s),this.exam=s,this.examDuration=s.timer;const i=await fetch("https://gateway.cloudrestfulapi.com/api/enroll/query",{method:"POST",headers:{"Content-Type":"application/json","client-token-key":this.configs.key},body:JSON.stringify({method:"find",args:[{$and:[{userID:this.session.userID,courseID:this.dataItem}]}]})}),a=await i.json();this.enroll=a[0],console.log("enroll",this.enroll);const o=await fetch("https://gateway.cloudrestfulapi.com/api/form/query",{method:"POST",headers:{"Content-Type":"application/json","client-token-key":this.configs.key},body:JSON.stringify({method:"find",args:[{$and:[{userID:this.session.userID,courseID:this.dataItem}]}]})}),r=await o.json();if(this.form=r[0],console.log("form",this.form),"yes"===this.exam.verified?this.enroll&&this.enroll.verified?(We.A.log("che k verified",this.enroll,this.enroll.verified),"post"===this.exam.type&&this.enroll.verified.post&&this.enroll.verified.post.url?(this.videoVerified=this.enroll.verified.post.url,this.shouldShowDiv=!1,We.A.log("post",this.videoVerified)):"pre"===this.exam.type&&this.enroll.verified.pre&&this.enroll.verified.pre.url?(this.videoVerified=this.enroll.verified.pre.url,this.shouldShowDiv=!1,We.A.log("pre",this.videoVerified)):(this.videoVerified=!1,this.shouldShowDiv=!0)):(this.videoVerified=!1,this.shouldShowDiv=!0):(this.videoVerified=!1,this.shouldShowDiv=!1),!0===this.checkResultExamDue(this.exam.end_duedate)?this.displayExam=!0:this.displayExam=!1,localStorage.setItem("webcamRecord",this.videoVerified),We.A.log("videoVerified",this.videoVerified),this.form&&"round-1"===this.form.formData["radiobox-23-10-10"].value.value&&this.enroll.analytics.post&&this.enroll.analytics.post.score&&this.enroll?.analytics?.post?.score>33)return void this.$router.push("/user/profile");if(this.form&&"round-2"===this.form.formData["radiobox-23-10-10"].value.value&&this.enroll.analytics.post&&this.enroll.analytics.post.score&&this.enroll?.analytics?.post?.score>33)return void this.$router.push("/user/profile");const n=await fetch("https://gateway.cloudrestfulapi.com/api/score/query",{method:"POST",headers:{"Content-Type":"application/json","client-token-key":this.configs.key},body:JSON.stringify({method:"find",args:[{$and:[{userID:this.session.userID,examID:this.examItem,courseID:this.dataItem}]}]})}),l=await n.json();if(console.log("DEBUG","4"),"retest"===this.examType){console.log("DEBUG","5");const e=this.enroll.analytics,t=e?.post?.score||0,s=e?.post?.measure||33;let i=!1,a=0,o=null,r=null;"1"===this.examRound?(console.log("DEBUG","6"),o=this.lesson.retestDateRound1,r=this.lesson.retestDateEndDateRound1):(o=this.lesson.retestDateRound2,r=this.lesson.retestDateEndDateRound2),t<s?(i=!1,a="number"===typeof e.retest?.score&&e.retest.score,!1===this.checkResultExamDue(o)&&this.checkResultExamDue(r)?We.A.slack("กำลังสอบซ่อม"):We.A.slack("ไมไ่ด้เปิดสอบซ่อม"),We.A.slack("*retestOpen*",this.checkResultExamDue(o)),We.A.slack("*retestClose*",this.checkResultExamDue(r))):i=!0,this.retestScore=a,this.retestStatus="number"!==typeof a,We.A.slack("Post score",t),We.A.slack("Post measure",s),We.A.slack("Post result",i),We.A.slack("Retest Score",a),"post"===this.exam.type&&this.enroll.verified.retest&&this.enroll.verified.retest.url?(this.videoVerified=this.enroll.verified.post.url,this.shouldShowDiv=!1,We.A.log("post",this.videoVerified)):(this.videoVerified=!1,this.shouldShowDiv=!0)}else this.retestStatus=!1;if(200===n.status){if(l.length>0)this.score=l[l.length-1],this.loader=!0,this.determineInitialState();else{if(this.examTemp.answers){const e=await this.addQuestionsToExam(s._id);We.A.log("updatedExams",e),this.renderExam(),this.loader=!0}else{const e=await this.addQuestionsToExam(s._id);this.loader=!0,We.A.log("updatedExams",e)}this.determineInitialState()}if(this.retestStatus){if(this.examTemp.answers){const e=await this.addQuestionsToExam(s._id);We.A.log("updatedExams",e),this.renderExam(),this.loader=!0}else{const e=await this.addQuestionsToExam(s._id);this.loader=!0,We.A.log("updatedExams",e)}this.determineInitialState()}}}}catch(e){We.A.log(e)}},async addQuestionsToExam(e){const t=[{$match:{$and:[{examID:e}]}},{$lookup:{from:"answer",let:{questionId:{$toString:"$_id"}},pipeline:[{$match:{$expr:{$eq:["$$questionId","$questionID"]}}}],as:"answers"}},{$facet:{post:[{$skip:(this.currentPage-1)*this.limitItem},{$limit:this.limitItem}],totalCount:[{$count:"count"}]}}],s={pipeline:t},{data:i,status:a}=await this.$Request.POST("questions/aggregate",s,this.configs.key);200===a&&(this.questions=this.convertQuestionsData(i))},convertQuestionsData(e){const t=e.flatMap((e=>e.post.map((e=>{const{_id:t,detail:s,correct:i,answers:a}=e,o=a.map((e=>({value:e._id,label:e.detail})));return{number:t,text:s,correct:i,answers:o}}))));return t},cancelExam(){Xe.A.confirm({title:"กรุณายืนยันการยกเลิกการสอบ?",message:"ข้อมูลการสอบในตอนนี้ จะถูกยกเลิก เวลาจะจับใหม่ ข้อสอบจะถูกประมวลผลใหม่",confirm:async()=>{this.examState="welcome",this.showWelcome=!0,We.A.log("cancelExam"),this.examTemp={answers:{}},this.$refs.timerComponent.resetTimer(),localStorage.removeItem("examTemp")},cancel:()=>{}})}},created(){},computed:{paginatedQuestions(){const e=(this.currentPage-1)*this.questionsPerPage,t=e+this.questionsPerPage;return this.questions.slice(e,t)},answeredQuestionsCount(){let e=0;return this.questions.forEach((t=>{this.examTemp.answers[t.number]&&e++})),{answered:e,total:this.questions.length}}},async mounted(){try{if(!this.login)return void this.$router.push("/");this.fetchUserIP(),document.addEventListener("copy",this.preventCopyPaste),document.addEventListener("paste",this.preventCopyPaste),await this.getData()}catch(e){We.A.log(e)}},setup(){},watch:{"$route.params.cid":{deep:!0,immediate:!0,handler(){}}}};const je=(0,Be.A)(Ne,[["render",Ie]]);var Me=je,Ve={name:"Lesson Play",components:{Frontend:Me},data(){return{session:n.A.get("session")}},setup(){const e=(0,r.lq)(),t=e.meta.title;(0,o.K7)(t)},computed:{componentName(){return"Frontend"}}};const Je=(0,Be.A)(Ve,[["render",a]]);var ze=Je},57313:function(e,t){class s{isMobile(){return window.innerWidth<=768}deviceDetect(){return this.isMobile()?"mobile":"desktop"}}const i=new s;t.A=i},48646:function(e,t,s){var i=s(69565),a=s(28551),o=s(1767),r=s(50851);e.exports=function(e,t){t&&"string"===typeof e||a(e);var s=r(e);return o(a(void 0!==s?i(s,e):e))}},81148:function(e,t,s){var i=s(46518),a=s(72652),o=s(79306),r=s(28551),n=s(1767);i({target:"Iterator",proto:!0,real:!0},{every:function(e){r(this),o(e);var t=n(this),s=0;return!a(t,(function(t,i){if(!e(t,s++))return i()}),{IS_RECORD:!0,INTERRUPTED:!0}).stopped}})},30531:function(e,t,s){var i=s(46518),a=s(69565),o=s(79306),r=s(28551),n=s(1767),l=s(48646),c=s(19462),d=s(9539),h=s(96395),m=c((function(){var e,t,s=this.iterator,i=this.mapper;while(1){if(t=this.inner)try{if(e=r(a(t.next,t.iterator)),!e.done)return e.value;this.inner=null}catch(o){d(s,"throw",o)}if(e=r(a(this.next,s)),this.done=!!e.done)return;try{this.inner=l(i(e.value,this.counter++),!1)}catch(o){d(s,"throw",o)}}}));i({target:"Iterator",proto:!0,real:!0,forced:h},{flatMap:function(e){return r(this),o(e),new m(n(this),{mapper:e,inner:null})}})},23215:function(e,t,s){s(81148)},30670:function(e,t,s){s(30531)}}]);
//# sourceMappingURL=1074.aadca6ab.js.map