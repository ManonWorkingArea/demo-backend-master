"use strict";(self["webpackChunknode_backend"]=self["webpackChunknode_backend"]||[]).push([[2614],{22614:function(t,e,s){s.r(e),s.d(e,{default:function(){return U}});var n=s(20641);function a(t,e,s,a,r,o){return(0,n.uX)(),(0,n.Wv)((0,n.$y)(o.componentName))}var r=s(52968),o=s(75220),i=s(40475),c=s(90033);const u={class:"bg-gray-50"},l={key:0},d={class:"flex min-h-full flex-col justify-center py-12 sm:px-6 lg:px-8"},h={class:"mt-8 bg-white rounded-lg shadow-md sm:mx-auto sm:w-full sm:max-w-sm"},m={class:"px-6 py-8"},f={class:"flex justify-center mb-4"},g=["src"],y={class:"text-center"},p={class:"text-2xl font-semibold"},x={class:"text-gray-600"},w={key:0,class:"mt-2 text-gray-700"},k={key:0,class:"text-center mt-4 text-gray-600"},v={key:1};function L(t,e,s,a,r,o){return(0,n.uX)(),(0,n.CE)("div",u,[r.userData?((0,n.uX)(),(0,n.CE)("div",l,[(0,n.Lk)("div",d,[e[0]||(e[0]=(0,n.Lk)("div",{class:"sm:mx-auto sm:w-full sm:max-w-lg"},[(0,n.Lk)("h2",{class:"mt-6 text-center text-3xl font-bold tracking-tight text-gray-900"},"ตรวจสอบข้อมูลบัญชีเรียบร้อย"),(0,n.Lk)("p",{class:"mt-2 text-center text-sm text-gray-600"}," ระบบกำลังประมวลผล และจะดำเนินการในขั้นตอนต่อไปโดยอัตโนมัติ... ")],-1)),(0,n.Lk)("div",h,[(0,n.Lk)("div",m,[(0,n.Lk)("div",f,[r.userData.pictureUrl?((0,n.uX)(),(0,n.CE)("img",{key:0,src:r.userData.pictureUrl,alt:"Profile Picture",class:"w-24 h-24 rounded-full"},null,8,g)):(0,n.Q3)("",!0)]),(0,n.Lk)("div",y,[(0,n.Lk)("h2",p,(0,c.v_)(r.userData.displayName),1),(0,n.Lk)("p",x,(0,c.v_)(r.userData.userId),1),r.userData.statusMessage?((0,n.uX)(),(0,n.CE)("p",w,(0,c.v_)(r.userData.statusMessage),1)):(0,n.Q3)("",!0)]),r.countdown>0?((0,n.uX)(),(0,n.CE)("div",k," จะเปลี่ยนหน้าใน "+(0,c.v_)(r.countdown)+" วินาที... ",1)):(0,n.Q3)("",!0)])])])])):((0,n.uX)(),(0,n.CE)("div",v,e[1]||(e[1]=[(0,n.Lk)("div",{class:"flex min-h-full flex-col justify-center py-12 sm:px-6 lg:px-8"},[(0,n.Lk)("div",{class:"sm:mx-auto sm:w-full sm:max-w-lg"},[(0,n.Lk)("h2",{class:"mt-6 text-center text-3xl font-bold tracking-tight text-gray-900"},"กำลังตรวจสอบบัญชีของคุณ"),(0,n.Lk)("p",{class:"mt-2 text-center text-sm text-gray-600"}," Handling authentication... ")])],-1)])))])}s(44114),s(64979);var D=s(40471);const E=new D.A(!1);var b={name:"AuthHandler",data(){return{configs:i.A.get("configs"),hostname:i.A.get("hostname"),session:i.A.get("session"),userData:null,messageText:"",countdown:5}},mounted(){this.handleAuth()},methods:{async handleAuth(){const t=this.$route.query.code,e=JSON.parse(atob(this.$route.query.state)),s=e.redirect,n=this.configs.hostname;if(!t)return console.error("No code found in URL"),void this.$router.push({name:"Error"});try{const e=await fetch("https://gateway.cloudrestfulapi.com/auth/line",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:t,hostname:n})});if(!e.ok)throw new Error("Failed to login with LINE");const{userData:a}=await e.json(),r=await this.checkUserExists(a);if(r){const t=this.constructSessionData(a,r);i.A.update("session",t)}else await this.createUser(a,s);this.userData=a,this.startCountdown(s)}catch(a){console.error("Error during LINE authentication:",a)}},async checkUserExists(t){try{const e=await E.POST("user/query",{method:"find",args:[{$and:[{username:t.userId,channel:"line"}]}]},this.configs.key),s=e.data[0];return s}catch(e){throw console.error("Error checking user existence:",e),e}},constructSessionData(t,e){const s={active:!0,token:e._id,refresh:"",login:!0,userID:e._id,user:e,loader:!1,role:e.role,nav:"normal-nav",layout:"frontend-layout",current:"",list:"",enroll:"",channel:"line"};return s},async createUser(t,e){try{const s=await fetch("https://gateway.cloudrestfulapi.com/api/user/",{method:"POST",headers:{"Content-Type":"application/json","client-token-key":this.configs.key},body:JSON.stringify({data:{firstname:t.displayName,lastname:t.statusMessage,avatar_img:t.pictureUrl,citizen:"",phone:"",email:"",username:t.userId,parent:this.configs.siteID,role:"user",channel:"line",info:{}},options:{fieldType:[],uniqueFields:[["username"]]}})});if(!s.ok)throw new Error("Failed to create user");const n=await s.json();console.log("createUser",n);const a=this.constructSessionData(n,n);i.A.update("session",a),this.userData=t,this.startCountdown(e)}catch(s){throw console.error("Error creating user:",s),s}},startCountdown(t){const e=setInterval((()=>{this.countdown--,0===this.countdown&&(clearInterval(e),window.location.href=t)}),1e3)}}},C=s(64621);const A=(0,C.A)(b,[["render",L]]);var N=A,I={name:"Lesson Detail",components:{Frontend:N},data(){return{session:i.A.get("session")}},setup(){const t=(0,o.lq)(),e=t.meta.title;(0,r.K7)(e)},computed:{componentName(){return"Frontend"}}};const S=(0,C.A)(I,[["render",a]]);var U=S}}]);
//# sourceMappingURL=2614.66a651ef.js.map