{"version":3,"file":"js/2614.66a651ef.js","mappings":"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","sources":["webpack://node-backend/./src/extensions/modules/system/user/view/AuthHandler.vue","webpack://node-backend/./src/extensions/modules/system/user/component/frontend/AuthHandler.vue","webpack://node-backend/./src/extensions/modules/system/user/component/frontend/AuthHandler.vue?512c","webpack://node-backend/./src/extensions/modules/system/user/view/AuthHandler.vue?a46d"],"sourcesContent":["<template>\n    <component :is=\"componentName\" />\n    </template>\n    \n    <script>\n    import { useTitle } from 'vue-page-title';\n    import { useRoute } from 'vue-router';\n    import storageManager from '@/plugins/storage';\n    import Frontend from '../component/frontend/AuthHandler.vue';\n    \n    export default {\n    name: 'Lesson Detail',\n    components: {\n        Frontend,\n    },\n    data() {\n        return {\n            session: storageManager.get('session')\n        };\n    },\n    setup() {\n        const route = useRoute();\n        const routeName = route.meta.title;\n        useTitle(routeName);\n    },\n    computed: {\n        componentName() {\n            return 'Frontend';\n        }\n    }\n    };\n    </script>\n        ","<template>\n    <div class=\"bg-gray-50\">\n        <div  v-if=\"userData\">\n            <div class=\"flex min-h-full flex-col justify-center py-12 sm:px-6 lg:px-8\">\n                <div class=\"sm:mx-auto sm:w-full sm:max-w-lg\">\n                    <h2 class=\"mt-6 text-center text-3xl font-bold tracking-tight text-gray-900\">ตรวจสอบข้อมูลบัญชีเรียบร้อย</h2>\n                    <p class=\"mt-2 text-center text-sm text-gray-600\">\n                        ระบบกำลังประมวลผล และจะดำเนินการในขั้นตอนต่อไปโดยอัตโนมัติ...\n                    </p>\n                </div>\n        \n                <div class=\"mt-8  bg-white rounded-lg shadow-md sm:mx-auto sm:w-full sm:max-w-sm\">\n                    <div class=\"px-6 py-8\">\n                        <div class=\"flex justify-center mb-4\">\n                            <img v-if=\"userData.pictureUrl\" :src=\"userData.pictureUrl\" alt=\"Profile Picture\" class=\"w-24 h-24 rounded-full\" />\n                        </div>\n                        <div class=\"text-center\">\n                            <h2 class=\"text-2xl font-semibold\">{{ userData.displayName }}</h2>\n                            <p class=\"text-gray-600\">{{ userData.userId }}</p>\n                            <p v-if=\"userData.statusMessage\" class=\"mt-2 text-gray-700\">{{ userData.statusMessage }}</p>\n                        </div>\n                        <div class=\"text-center mt-4 text-gray-600\" v-if=\"countdown > 0\">\n                            จะเปลี่ยนหน้าใน {{ countdown }} วินาที...\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n        <div v-else>\n            <div class=\"flex min-h-full flex-col justify-center py-12 sm:px-6 lg:px-8\">\n                <div class=\"sm:mx-auto sm:w-full sm:max-w-lg\">\n                    <h2 class=\"mt-6 text-center text-3xl font-bold tracking-tight text-gray-900\">กำลังตรวจสอบบัญชีของคุณ</h2>\n                    <p class=\"mt-2 text-center text-sm text-gray-600\">\n                        Handling authentication...\n                    </p>\n                </div>\n            </div>\n        </div>\n    </div>\n</template>\n  \n<script>\nimport storageManager from '@/plugins/storage';\nimport requestClient from '@/plugins/requestClient';\nconst Request = new requestClient(false);\n\nexport default {\n    name: 'AuthHandler',\n    data() {\n        return {\n            configs: storageManager.get('configs'),\n            hostname: storageManager.get('hostname'),\n            session: storageManager.get('session'),\n            userData: null,\n            messageText: '',\n            countdown: 5,\n        };\n    },\n    mounted() {\n        this.handleAuth();\n    },\n    methods: {\n        async handleAuth() {\n            const code      = this.$route.query.code;\n            const stateData = JSON.parse(atob(this.$route.query.state));\n            const callback  = stateData.redirect;\n            const hostname  = this.configs.hostname;\n\n            if (!code) {\n                console.error('No code found in URL');\n                this.$router.push({ name: 'Error' });\n                return;\n            }\n\n            try {\n                const response = await fetch('https://gateway.cloudrestfulapi.com/auth/line', {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/json',\n                    },\n                    body: JSON.stringify({ code, hostname }),\n                });\n\n                if (!response.ok) {\n                    throw new Error('Failed to login with LINE');\n                }\n\n                const { userData }  = await response.json();\n                const userExists    = await this.checkUserExists(userData);\n\n                if (!userExists) {\n                    await this.createUser(userData,callback);\n                } else {\n                    const sessionData = this.constructSessionData(userData, userExists);\n                    storageManager.update('session', sessionData);\n                }\n                this.userData = userData;\n                this.startCountdown(callback);\n\n            } catch (error) {\n                console.error('Error during LINE authentication:', error);\n            }\n        },\n        async checkUserExists(userData) {\n            try {\n                const resAPILogin = await Request.POST('user/query', {\n                    method: 'find',\n                    args: [{\n                        $and: [\n                            { username: userData.userId, channel: 'line' }\n                        ]\n                    }]\n                }, this.configs.key);\n                const getLogin = resAPILogin.data[0];\n                return getLogin;\n            } catch (error) {\n                console.error('Error checking user existence:', error);\n                throw error;\n            }\n        },\n        constructSessionData(userData,userExists) {\n            const session = {\n                active: true,\n                token: userExists._id,\n                refresh: \"\",\n                login: true,\n                userID: userExists._id,\n                user: userExists,\n                loader: false,\n                role: userExists.role,\n                nav: \"normal-nav\",\n                layout: \"frontend-layout\",\n                current: '',\n                list: '',\n                enroll: '',\n                channel: 'line',\n            };\n            return session;\n        },\n        async createUser(userData,callback) {\n            try {\n                const response = await fetch('https://gateway.cloudrestfulapi.com/api/user/', {\n                    method: 'POST',\n                    headers: { 'Content-Type': 'application/json', 'client-token-key': this.configs.key },\n                    body: JSON.stringify({\n                        data: {\n                            firstname: userData.displayName,\n                            lastname: userData.statusMessage,\n                            avatar_img: userData.pictureUrl,\n                            citizen: '',\n                            phone: '',\n                            email: '',\n                            username: userData.userId,\n                            parent: this.configs.siteID,\n                            role: \"user\",\n                            channel: \"line\",\n                            info: {}\n                        },\n                        options: {\n                            fieldType: [],\n                            uniqueFields: [\n                                [\"username\"]\n                            ]\n                        }\n                    })\n                });\n\n                if (!response.ok) {\n                    throw new Error('Failed to create user');\n                }\n                const userJSON = await response.json();\n                console.log(\"createUser\",userJSON);\n\n                const sessionData = this.constructSessionData(userJSON, userJSON);\n                storageManager.update('session', sessionData);\n\n                this.userData = userData;\n                this.startCountdown(callback);\n            } catch (error) {\n                console.error('Error creating user:', error);\n                throw error;\n            }\n        },\n        startCountdown(callback) {\n            // Countdown timer\n            const timer = setInterval(() => {\n                this.countdown--;\n                if (this.countdown === 0) {\n                    clearInterval(timer); // Stop countdown when it reaches 0\n                    window.location.href = callback; // Redirect\n                }\n            }, 1000); // Update countdown every second\n        },\n        \n    },\n};\n</script>\n  ","import { render } from \"./AuthHandler.vue?vue&type=template&id=65cfbe12\"\nimport script from \"./AuthHandler.vue?vue&type=script&lang=js\"\nexport * from \"./AuthHandler.vue?vue&type=script&lang=js\"\n\nimport exportComponent from \"../../../../../../../node_modules/@vue/cli-service/node_modules/vue-loader/dist/exportHelper.js\"\nconst __exports__ = /*#__PURE__*/exportComponent(script, [['render',render]])\n\nexport default __exports__","import { render } from \"./AuthHandler.vue?vue&type=template&id=acd0987a\"\nimport script from \"./AuthHandler.vue?vue&type=script&lang=js\"\nexport * from \"./AuthHandler.vue?vue&type=script&lang=js\"\n\nimport exportComponent from \"../../../../../../node_modules/@vue/cli-service/node_modules/vue-loader/dist/exportHelper.js\"\nconst __exports__ = /*#__PURE__*/exportComponent(script, [['render',render]])\n\nexport default __exports__"],"names":["_createBlock","_resolveDynamicComponent","$options","componentName","class","key","_createElementBlock","_hoisted_1","$data","userData","_hoisted_2","_createElementVNode","_hoisted_3","_hoisted_4","_hoisted_5","_hoisted_6","pictureUrl","src","alt","_hoisted_7","_createCommentVNode","_hoisted_8","_hoisted_9","_toDisplayString","displayName","_hoisted_10","userId","statusMessage","_hoisted_11","countdown","_hoisted_12","_hoisted_13","_cache","Request","requestClient","name","data","configs","storageManager","get","hostname","session","messageText","mounted","this","handleAuth","methods","code","$route","query","stateData","JSON","parse","atob","state","callback","redirect","console","error","$router","push","response","fetch","method","headers","body","stringify","ok","Error","json","userExists","checkUserExists","sessionData","constructSessionData","update","createUser","startCountdown","resAPILogin","POST","args","$and","username","channel","getLogin","active","token","_id","refresh","login","userID","user","loader","role","nav","layout","current","list","enroll","firstname","lastname","avatar_img","citizen","phone","email","parent","siteID","info","options","fieldType","uniqueFields","userJSON","log","timer","setInterval","clearInterval","window","location","href","__exports__","components","Frontend","setup","route","useRoute","routeName","meta","title","useTitle","computed","render"],"sourceRoot":""}