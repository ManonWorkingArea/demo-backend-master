"use strict";(self["webpackChunknode_backend"]=self["webpackChunknode_backend"]||[]).push([[9173],{73172:function(e,t,s){s.r(t),s.d(t,{default:function(){return T}});var a=s(20641);function o(e,t,s,o,r,n){return(0,a.uX)(),(0,a.Wv)((0,a.$y)(n.componentName))}var r=s(52968),n=s(75220),i=s(40475),c=s(90033);const d={class:"mx-auto max-w-2xl px-3 pt-2 pb-2 sm:px-6 sm:pt-2 sm:pb-2 lg:max-w-7xl"},l={class:"flex items-center justify-between flex-wrap sm:flex-nowrap"},u={class:"text-md font-bold w-full sm:w-auto text-center mb-3 sm:mb-0"},m={class:"flex flex-col sm:flex-row sm:justify-between mt-3 space-y-2 sm:space-y-0"},f={class:"flex items-center justify-center pt-5 pb-5 bg-gray-600"};function p(e,t,s,o,r,n){const i=(0,a.g2)("router-link"),p=(0,a.g2)("font-awesome-icon"),h=(0,a.g2)("result-component");return(0,a.uX)(),(0,a.CE)("div",null,[(0,a.Lk)("div",d,[(0,a.Lk)("div",l,[(0,a.Lk)("h1",u,(0,c.v_)(r.lesson.name),1)]),(0,a.Lk)("div",m,[(0,a.bF)(i,{to:"/lesson/detail/"+r.lesson._id,class:"bg-gray-500 hover:bg-gray-600 text-white py-1 px-3 rounded text-sm w-full sm:w-auto text-center"},{default:(0,a.k6)((()=>t[1]||(t[1]=[(0,a.eW)(" กลับหน้าหลัก ")]))),_:1},8,["to"]),(0,a.Lk)("button",{onClick:t[0]||(t[0]=(...e)=>n.downloadPDF&&n.downloadPDF(...e)),class:"bg-green-500 hover:bg-green-600 text-white py-1 px-3 rounded text-sm w-full sm:w-auto text-center sm:ml-3"},[(0,a.bF)(p,{icon:["fas","download"],class:"mr-1.5 h-3 w-3 flex-shrink-0 text-white"}),t[2]||(t[2]=(0,a.eW)(" ดาวน์โหลดใบรับรอง "))])])]),(0,a.Lk)("div",f,[(0,a.bF)(h,{certId:s.userId,pages:r.certificationTemplate.pages,certMode:r.certMode,certData:r.certification,debug:!1,onBackgroundImageChange:n.handleBackgroundImage,ref:"resultComponentRef"},null,8,["certId","pages","certMode","certData","onBackgroundImageChange"])])])}var h=s(20354),$=s.n(h),g=s(87583),I=s(9964),w=s(35839),b=s(40471),y=s(63084);const k=new b.A(!1);var D={components:{ResultComponent:w.A},name:"Certification",props:{dataItem:{type:String,default:null},userId:{type:String,default:null}},data(){return{configs:i.A.get("configs"),session:i.A.get("session"),certification:[],lesson:[],user:[],cert:{image:""},qrCodeUrl:null,showImage:!1,certImageSrc:null,certificationTemplate:[],certMode:"",backgroundImage:null,courseIDs:["646399b1db2e5913d490fdc1","646399b3db2e5913d490fdc2","646399b5db2e5913d490fdc3","646399b6db2e5913d490fdc4","646399b8db2e5913d490fdc5","65c967c4e83775a8e0d42771","64ba0f8e95b73060a5db8674"]}},computed:{resolvedDataItem(){return this.dataItem||this.$route.params.cid},resolvedUserId(){return this.userId||this.$route.params.uid}},async mounted(){try{this.resolvedUserId?(this.certMode="new",await this.getUserAndCertificationData()):(this.certMode="old",await this.getData())}catch(e){y.A.log(e)}},methods:{handleBackgroundImage(e){this.backgroundImage=e},getCustomStyle(){return y.A.log("Theme",this.cert.template),"custom"===this.cert.template?{backgroundColor:"red",fontSize:"16px",paddingTop:"400px"}:{}},formatDateWithAge(e,t){const s=new Date(e),a=parseInt(t,10);return s.setFullYear(s.getFullYear()+a),y.A.log("date",e),y.A.log("newDate",s),this.formatThaidate(s,"date")},formatThaidate(e){return I.A.toThaiDatetime(e,"date")},async generateQRCode(){try{const e="https://fti.academy/lesson/certification/"+this.resolvedDataItem+"/"+this.resolvedUserId,t=await g.toDataURL(e);this.qrCodeUrl=t}catch(e){console.error(e)}},downloadPDF(){this.$refs.resultComponentRef.captureDivAsCanvas()},async generateImage(){const e=this.$refs.certContainer,t=this.backgroundImage;try{const s=await $()(e,{useCORS:!0,background:t,allowTaint:!0,scale:4,dpi:600,imageSmoothingEnabled:!0});this.certImageSrc=s.toDataURL("image/jpeg",1),this.showImage=!0}catch(s){console.error(s)}},async getData(){try{this.loading_sources=!1;const e=[{$match:{$expr:{$eq:["$_id",{$toObjectId:this.resolvedDataItem}]}}},{$lookup:{from:"user",let:{userId:{$toObjectId:"$userID"}},pipeline:[{$match:{$expr:{$eq:["$_id","$$userId"]}}}],as:"user"}},{$unwind:"$user"},{$lookup:{from:"course",let:{courseId:{$toObjectId:"$courseID"}},pipeline:[{$match:{$expr:{$eq:["$_id","$$courseId"]}}}],as:"course"}},{$unwind:"$course"},{$lookup:{from:"form",let:{userId:"$userID",courseId:"$courseID"},pipeline:[{$match:{$expr:{$and:[{$eq:["$userID","$$userId"]},{$eq:["$courseID","$$courseId"]}]}}},{$set:{formID:{$toObjectId:"$formID"}}}],as:"forms"}}],t=await fetch("https://gateway.cloudrestfulapi.com/api/certification/aggregate",{method:"POST",headers:{"Content-Type":"application/json","client-token-key":this.configs.key},body:JSON.stringify({pipeline:e})}),s=await t.json();if(y.A.log("CertReturn",s[0]),200===t.status){if(this.certification=s[0],this.lesson=s[0].course,this.user=s[0].user,"custom"===s[0].course.certification_template){const e=await k.GET(`certification_template/${s[0].course.certificationId}`,this.configs.key);200===e.status&&(this.certificationTemplate=e.data)}else{const e={method:"find",args:[{$and:[{unit:this.session.current._id,default:!0}]}]},t=await k.POST("certification_template/query",e,this.configs.key);if(200!==t.status)throw new Error("Failed to fetch player data from API");y.A.log("resAPICert",t.data),this.certificationTemplate=t.data[0]}this.generateQRCode().then((()=>{this.generateImage()}))}}catch(e){y.A.log(e)}},async getUserAndCertificationData(){try{this.loading_sources=!1;const e=[{$match:{$expr:{$eq:["$_id",{$toObjectId:this.resolvedDataItem}]}}},{$lookup:{from:"user",let:{userId:{$toObjectId:this.resolvedUserId}},pipeline:[{$match:{$expr:{$eq:["$_id","$$userId"]}}}],as:"user"}},{$unwind:"$user"},{$lookup:{from:"form",let:{userId:this.resolvedUserId,courseId:this.resolvedDataItem},pipeline:[{$match:{$expr:{$and:[{$eq:["$userID","$$userId"]},{$eq:["$courseID","$$courseId"]}]}}},{$set:{formID:{$toObjectId:"$formID"}}}],as:"forms"}},{$lookup:{from:"enroll",let:{userId:this.resolvedUserId,courseId:this.resolvedDataItem},pipeline:[{$match:{$expr:{$and:[{$eq:["$userID","$$userId"]},{$eq:["$courseID","$$courseId"]}]}}},{$set:{formID:{$toObjectId:"$formID"}}}],as:"enrolls"}},{$replaceRoot:{newRoot:{course:"$$ROOT",user:"$user",forms:"$forms",enrolls:"$enrolls"}}}],t=await fetch("https://gateway.cloudrestfulapi.com/api/course/aggregate",{method:"POST",headers:{"Content-Type":"application/json","client-token-key":this.configs.key},body:JSON.stringify({pipeline:e})}),s=await t.json();if(y.A.slack("CertReturn",s[0].course.certificationId),200===t.status){this.certification=s[0],this.lesson=s[0].course,this.user=s[0].user,this.enroll=s[0].enrolls;let e=s[0]?.enrolls[0]?.analytics?.post,t=s[0]?.enrolls[0]?.analytics?.retest;if(e?.score>=e?.measure||e?.score<e?.measure&&t?.score>=t?.measure?console.log("pass"):console.log("no pass"),"custom"===s[0].course.certification_template){const e=await k.GET(`certification_template/${s[0].course.certificationId}`,this.configs.key);200===e.status&&(this.certificationTemplate=e.data)}else{const e={method:"find",args:[{$and:[{unit:this.session.current._id,default:!0}]}]},t=await k.POST("certification_template/query",e,this.configs.key);if(200!==t.status)throw new Error("Failed to fetch player data from API");y.A.log("resAPICert",t.data),this.certificationTemplate=t.data[0]}this.generateQRCode().then((()=>{this.generateImage()}))}}catch(e){y.A.log(e)}}}},x=s(64621);const v=(0,x.A)(D,[["render",p],["__scopeId","data-v-26fe055a"]]);var C=v,A={name:"Lesson Play",components:{Frontend:C},data(){return{session:i.A.get("session")}},setup(){const e=(0,n.lq)(),t=e.meta.title;(0,r.K7)(t)},computed:{componentName(){return"Frontend"}}};const _=(0,x.A)(A,[["render",o]]);var T=_}}]);
//# sourceMappingURL=9173.7134bca6.js.map