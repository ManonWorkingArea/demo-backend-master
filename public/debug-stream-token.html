<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stream Token Debug</title>
    <style>
        body {
            font-family: monospace;
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        .token-info {
            background: #2a2a2a;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #00ff00;
        }
        .button {
            background: #333;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }
        .button:hover {
            background: #00ff00;
            color: #000;
        }
        .log {
            background: #000;
            color: #fff;
            padding: 10px;
            height: 400px;
            overflow-y: scroll;
            border: 1px solid #333;
            font-size: 12px;
        }
        .error { color: #ff6b6b; }
        .success { color: #51cf66; }
        .info { color: #339af0; }
        .warning { color: #ffd43b; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”‘ Stream Token Debug Panel</h1>
        
        <div class="controls">
            <button class="button" onclick="generateToken()">ğŸ†• Generate New Token</button>
            <button class="button" onclick="clearCache()">ğŸ§¹ Clear Cache</button>
            <button class="button" onclick="refreshPage()">ğŸ”„ Refresh Page</button>
            <button class="button" onclick="showCurrentToken()">ğŸ‘ï¸ Show Current</button>
            <button class="button" onclick="clearLog()">ğŸ—‘ï¸ Clear Log</button>
        </div>
        
        <div id="currentToken" class="token-info">
            <strong>Current Token:</strong> <span id="tokenValue">None</span><br>
            <strong>Generated:</strong> <span id="tokenTime">Never</span><br>
            <strong>Stream Key:</strong> <span id="streamKey">None</span>
        </div>
        
        <div class="token-info">
            <strong>Instructions:</strong><br>
            1. Click "Generate New Token" to create a fresh token<br>
            2. Refresh the page and check if token changes<br>
            3. Use browser DevTools Network tab to see x-stream-token header<br>
            4. Check Service Worker logs in DevTools Application tab
        </div>
        
        <h3>ğŸªµ Debug Log</h3>
        <div id="log" class="log"></div>
    </div>

    <script type="module">
        import { SecureStreamManager } from './src/components/videoplayer/utils/SecureStreamManager.js';
        
        let secureManager;
        let tokenHistory = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = type;
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        async function initManager() {
            try {
                secureManager = new SecureStreamManager();
                await secureManager.registerStreamInterceptor();
                log('âœ… SecureStreamManager initialized', 'success');
                window.secureManager = secureManager; // For console access
            } catch (error) {
                log('âŒ Failed to initialize: ' + error.message, 'error');
            }
        }
        
        async function generateToken() {
            if (!secureManager) {
                log('âŒ Manager not initialized', 'error');
                return;
            }
            
            try {
                // Clear cache first
                await secureManager.forceRefreshSWToken();
                log('ğŸ§¹ Cache cleared', 'info');
                
                // Generate new token
                const result = await secureManager.generateSecureStreamKey();
                await secureManager.updateSWSecureToken(result);
                
                // Update display
                document.getElementById('tokenValue').textContent = result.token.substring(0, 30) + '...';
                document.getElementById('tokenTime').textContent = new Date(result.timestamp).toISOString();
                document.getElementById('streamKey').textContent = result.streamKey.substring(0, 40) + '...';
                
                // Add to history
                tokenHistory.push({
                    token: result.token,
                    streamKey: result.streamKey,
                    timestamp: result.timestamp,
                    time: new Date(result.timestamp).toISOString()
                });
                
                log(`ğŸ”‘ New token generated: ${result.streamKey}`, 'success');
                log(`ğŸ“… Timestamp: ${result.timestamp} (${new Date(result.timestamp).toISOString()})`, 'info');
                
                // Check uniqueness
                const unique = new Set(tokenHistory.map(t => t.token));
                log(`ğŸ“Š Total tokens: ${tokenHistory.length}, Unique: ${unique.size}`, 'info');
                
            } catch (error) {
                log('âŒ Token generation failed: ' + error.message, 'error');
            }
        }
        
        async function clearCache() {
            if (!secureManager) {
                log('âŒ Manager not initialized', 'error');
                return;
            }
            
            try {
                await secureManager.clearSWSecureToken();
                await secureManager.forceRefreshSWToken();
                log('ğŸ§¹ All caches cleared', 'success');
            } catch (error) {
                log('âŒ Cache clear failed: ' + error.message, 'error');
            }
        }
        
        function refreshPage() {
            log('ğŸ”„ Refreshing page...', 'warning');
            setTimeout(() => window.location.reload(), 500);
        }
        
        function showCurrentToken() {
            log(`ğŸ“‹ Token history (${tokenHistory.length} tokens):`, 'info');
            tokenHistory.forEach((token, i) => {
                log(`${i + 1}. ${token.streamKey} (${token.time})`, 'info');
            });
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        // Make functions global
        window.generateToken = generateToken;
        window.clearCache = clearCache;
        window.refreshPage = refreshPage;
        window.showCurrentToken = showCurrentToken;
        window.clearLog = clearLog;
        
        // Initialize on load
        initManager();
        log('ğŸš€ Debug panel loaded', 'success');
    </script>
</body>
</html>
