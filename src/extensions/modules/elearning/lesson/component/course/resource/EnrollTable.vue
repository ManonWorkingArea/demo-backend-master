<script>
import storageManager from '@/plugins/storage';
import Loader       from '@/interface/template/Loader.vue';

import Pagination from '@/utils/Paginated.vue';
import BatchProgress from '@/utils/BatchProgress.vue';
import convertUtils from "@/plugins/convertUtils";
import debug from '@/plugins/Logger.js';

import CryptoJS from 'crypto-js';
import dialog from '@/plugins/Dialog.js';

import Limit       from './Limitation.vue';
import ExamReviewManager from './ExamReviewManager.vue';

export default {
    props: {
      pageTitle: {
        type: String,
        default: () => ''
      },
      courseData: Object,
      callParentFunctionProp: Function,
      tabs: Object,
      updateTabs: Object,
    },
    data() {
      const session = storageManager.get('session')
      return {
        // üöÄ PROGRESSIVE/LAZY LOADING SYSTEM - Always enabled for optimization
        lazy: true,                    // ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö lazy loading ‡πÄ‡∏™‡∏°‡∏≠
        initialDisplayCount: 20,       // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
        loadMoreCount: 10,             // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡∏•‡∏∞‡∏Ñ‡∏£‡∏±‡πâ‡∏á
        currentDisplayCount: 20,       // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        isLoadingMore: false,          // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
        scrollCleanup: null,           // function ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö cleanup scroll listeners
        showProgressToast: false,      // ‡πÅ‡∏™‡∏î‡∏á progress toast ‡πÄ‡∏°‡∏∑‡πà‡∏≠ scroll
        scrollTimeout: null,           // timeout ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ã‡πà‡∏≠‡∏ô toast

        open: false,
        dropdownVisible: false,
        manualInputShowMore: [], // Added for accordion state
        dataItem: this.$route.params.id,
        school: session.current.id,
        login:session.login,
        isModalOpen: false,
        csvData: [], // Store parsed CSV data here
        csvColumns: [], // Store CSV column headers
        editingCell: null,
        
        // üéØ USER MAPPING CONFIGURATION
        userMappingConfig: {
          enabled: true,
          matchFields: [
            { csv: '', user: 'email', primary: true },
            { csv: '', user: 'phone', primary: false },
            { csv: 'citizen', user: 'citizen', primary: false }
          ],
          createMode: 'auto', // 'auto', 'create_only', 'enroll_only'
          // üîê PASSWORD & USERNAME CONFIGURATION
          usernameSettings: {
            type: 'email', // 'email', 'phone', 'custom_pattern', 'from_csv'
            customPattern: '{firstname}.{lastname}', // ‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠ type='custom_pattern'
            csvColumn: null, // ‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠ type='from_csv'
            prefix: '', // ‡πÄ‡∏û‡∏¥‡πà‡∏° prefix ‡πÄ‡∏ä‡πà‡∏ô 'user_'
            suffix: '' // ‡πÄ‡∏û‡∏¥‡πà‡∏° suffix ‡πÄ‡∏ä‡πà‡∏ô '_2024'
          },
          passwordSettings: {
            type: 'auto_generated', // 'auto_generated', 'email', 'phone', 'custom_value', 'from_csv'
            customValue: 'password123', // ‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠ type='custom_value'
            csvColumn: null, // ‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠ type='from_csv'
            autoGenerated: {
              length: 12,
              includeUppercase: true,
              includeLowercase: true,
              includeNumbers: true,
              includeSymbols: true,
              excludeSimilar: true // ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ 0, O, l, I, 1
            }
          }
        },
        
        // üéØ AVAILABLE MATCH FIELDS (including nested fields)
        availableMatchFields: {
          csv: [
            { value: 'email', label: 'Email (‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 8)', column: 7 },
            { value: 'phone', label: 'Phone (‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 7)', column: 6 },
            { value: 'citizen', label: 'Citizen ID (‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 9)', column: 8 },
            { value: 'firstname', label: '‡∏ä‡∏∑‡πà‡∏≠ (‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 4)', column: 3 },
            { value: 'lastname', label: '‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 5)', column: 4 },
            { value: 'bu_name', label: '‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô (‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 1)', column: 0 },
            { value: 'employee_id', label: '‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 10)', column: 9 },
            { value: 'final_badge_id', label: '‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ï‡∏£ (‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 11)', column: 10 }
          ],
          user: [
            { value: 'email', label: 'email', nested: false },
            { value: 'phone', label: 'phone', nested: false },
            { value: 'citizen', label: 'citizen', nested: false },
            { value: 'firstname', label: 'firstname', nested: false },
            { value: 'lastname', label: 'lastname', nested: false },
            { value: 'username', label: 'username', nested: false },
            { value: 'info.employee_id', label: 'info.employee_id', nested: true },
            { value: 'info.final_badge_id', label: 'info.final_badge_id', nested: true },
            { value: 'info.bu_name', label: 'info.bu_name', nested: true },
            { value: 'info.position', label: 'info.position', nested: true },
            { value: 'info.level', label: 'info.level', nested: true },
            { value: 'info.barcode', label: 'info.barcode', nested: true }
          ]
        },
        
        // üéØ CSV COLUMN MAPPING - ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
        csvMapping: {
          firstname: { 
            column: '', 
            target: 'firstname', 
            targetType: 'root', 
            fieldName: 'firstname',
            label: '‡∏ä‡∏∑‡πà‡∏≠',
            dataType: 'string',
            optional: false 
          },
          lastname: { 
            column: '', 
            target: 'lastname', 
            targetType: 'root', 
            fieldName: 'lastname',
            label: '‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•',
            dataType: 'string',
            optional: false 
          },
          phone: { 
            column: '', 
            target: 'phone', 
            targetType: 'root', 
            fieldName: 'phone',
            label: '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå',
            dataType: 'string',
            optional: true 
          },
          email: { 
            column: '', 
            target: 'email', 
            targetType: 'root', 
            fieldName: 'email',
            label: '‡∏≠‡∏µ‡πÄ‡∏°‡∏•',
            dataType: 'string',
            optional: true 
          }
        },
        
        // üéØ PROCESSING RESULTS
        processingResults: {
          total: 0,
          created: 0,
          enrolled: 0,
          skipped: 0,
          errors: 0,
          details: []
        },
        
        showMappingModal: false,
        showResultsModal: false,
        
        // ‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÑ‡∏î‡πâ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)
        defaultMappingFields: ['firstname', 'lastname', 'phone', 'email'],
        
        // üíæ Configuration Save Timer for debouncing
        configSaveTimer: null,
        
        // üéâ Toast Notification System
        toastVisible: false,
        toastMessage: '',
        toastType: 'info', // 'success', 'error', 'warning', 'info'
        toastTimeout: null,
        
        listItems: [],
        listItems_chunk: [],
        categoryData:[],
        loading_sources: true,
        endpoint: "",
        master:session.master,
        accessToken: storageManager.get('session','token'),
        configs: storageManager.get('configs'),
        session: storageManager.get('session'),
        limitItem:100,
        limitOptions: [1,10, 50, 100, 200, 500, 1000, 2000, 3000, 4000], // Define the available options
        currentPage: 1,
        totalPages: 0,
        totalItems: 0,
        loading: false,
        showingOverlay: false,
        searchQuery: "",
        statusFilter:"all",
        isCreatingUser: false,
        isShowingOverlay: false,
        loadingMessage: '',
        processingCount: '',
        debounceTimer: null,
        activeBlock: false,
        scb:[],
        isProcessing: false,
        selectedTab: 'csv', // Initial selected tab
        manualInput: [ // Changed to an array
          {
            firstname: '',
            lastname: '',
            citizen: null,
            phone: '',
            email: '',
            username: '',
            password: '',
            parent: session.current._id,
            salt: '',
            role: 'user',
            info: {
              prefix: '',
              sex: '',
              bu_type: '',
              bu_name: '',
              position: '',
            },
          }
        ],
        prefixMapping: {
          'mrs': '‡∏ô‡∏≤‡∏á',
          'mis': '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß',
          'mr': '‡∏ô‡∏≤‡∏¢'
        },
        sexMapping: {
          'male': '‡∏ä‡∏≤‡∏¢',
          'female': '‡∏´‡∏ç‡∏¥‡∏á',
          'other': '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'
        },
        
        // üîê MANUAL PASSWORD SETTINGS
        manualPasswordSettings: {
          length: 12,
          includeUppercase: true,
          includeLowercase: true,
          includeNumbers: true,
          includeSymbols: true
        },
        educationMapping: {
          'standard_bachelor': '‡∏õ‡∏£‡∏¥‡∏ç‡∏ç‡∏≤‡∏ï‡∏£‡∏µ',
          'upper_bachelor': '‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏õ‡∏£‡∏¥‡∏ç‡∏ç‡∏≤‡∏ï‡∏£‡∏µ',
          'under_bachelor': '‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏õ‡∏£‡∏¥‡∏ç‡∏ç‡∏≤‡∏ï‡∏£‡∏µ',
        },
        processName: "Enroll Processing", // Customize this process name
        progressText: "",
        progressTotal: 0,
        progressCurrent: 0,
        startTime: null,
        endTime: null,
        layoutVisibility: {
          order: true,
          enroll: true
        },
        cert_area : [
          { id: "1", value: "‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡πÅ‡∏•‡∏∞‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡πÄ‡∏Ç‡∏ï‡∏ó‡∏µ‡πà 1"},
          { id: "2", value: "‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡πÅ‡∏•‡∏∞‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡πÄ‡∏Ç‡∏ï‡∏ó‡∏µ‡πà 2"},
          { id: "3", value: "‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡πÅ‡∏•‡∏∞‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡πÄ‡∏Ç‡∏ï‡∏ó‡∏µ‡πà 3"},
          { id: "4", value: "‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡πÅ‡∏•‡∏∞‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡πÄ‡∏Ç‡∏ï‡∏ó‡∏µ‡πà 4"},
          { id: "5", value: "‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡πÅ‡∏•‡∏∞‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡πÄ‡∏Ç‡∏ï‡∏ó‡∏µ‡πà 5"},
          { id: "6", value: "‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡πÅ‡∏•‡∏∞‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡πÄ‡∏Ç‡∏ï‡∏ó‡∏µ‡πà 6"},
          { id: "7", value: "‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡πÅ‡∏•‡∏∞‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡πÄ‡∏Ç‡∏ï‡∏ó‡∏µ‡πà 7"},
          { id: "8", value: "‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡πÅ‡∏•‡∏∞‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡πÄ‡∏Ç‡∏ï‡∏ó‡∏µ‡πà 8"},
          { id: "9", value: "‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏û‡∏∑‡∏ä‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£ ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£"},
        ],
        cert_age : [
          { id: "3", value: "‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢‡∏™‡∏≤‡∏£‡πÑ‡∏Å‡∏•‡πÇ‡∏ü‡πÄ‡∏ã‡∏ï"},
          { id: "5", value: "‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢‡∏™‡∏≤‡∏£‡πÑ‡∏Å‡∏•‡πÇ‡∏ü‡πÄ‡∏ã‡∏ï"},
        ],
        allData: [], // Stores all data for CSV export
        chunkSize: 100, // Number of items per fetch
        showPreviewModal: false,
        isExporting: false,
        progressMessage: '',
        extractedData: [],
        selectedFileName: '',
        activeDropdown: null, // Track which dropdown is open
        imageErrors: {}, // Track image loading errors
      }
    },
    components: {
      Loader,
      Pagination,
      BatchProgress,
      Limit,
      ExamReviewManager
    },
    methods: {
      // üíæ LOCALSTORAGE CONFIGURATION MANAGEMENT
      saveConfigToLocalStorage(showNotification = true) {
        try {
          const configToSave = {
            userMappingConfig: this.userMappingConfig,
            csvMapping: this.csvMapping,
            savedAt: new Date().toISOString(),
            version: '1.0'
          };
          
          localStorage.setItem('enrollTable_mapping_config', JSON.stringify(configToSave));
          
          // Show success notification only if requested
          if (showNotification) {
            console.log('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            this.showToast('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Mapping ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
          }
          
          console.log('Configuration saved to localStorage:', configToSave);
        } catch (error) {
          console.error('Error saving configuration to localStorage:', error);
          if (showNotification) {
            console.error('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å:', error.message);
            this.showToast('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏î‡πâ', 'error');
          }
        }
      },

      loadConfigFromLocalStorage() {
        try {
          const savedConfig = localStorage.getItem('enrollTable_mapping_config');
          if (!savedConfig) {
            console.log('No saved configuration found in localStorage');
            return false;
          }

          const config = JSON.parse(savedConfig);
          
          // Validate config structure
          if (!config.userMappingConfig || !config.csvMapping) {
            console.warn('Invalid configuration structure in localStorage');
            return false;
          }

          // Load userMappingConfig
          this.userMappingConfig = {
            ...this.userMappingConfig,
            ...config.userMappingConfig
          };

          // Load csvMapping
          this.csvMapping = {
            ...this.csvMapping,
            ...config.csvMapping
          };

          // Show success notification
          console.log('‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
          this.showToast(`‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date(config.savedAt).toLocaleString('th-TH')})`, 'success');

          console.log('Configuration loaded from localStorage:', config);
          return true;
        } catch (error) {
          console.error('Error loading configuration from localStorage:', error);
          console.error('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏î‡πâ');
          this.showToast('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏î‡πâ', 'error');
          return false;
        }
      },

      clearConfigFromLocalStorage() {
        try {
          localStorage.removeItem('enrollTable_mapping_config');
          
          console.log('‚úÖ ‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
          this.showToast('‚úÖ ‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å LocalStorage ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
          
          console.log('Configuration removed from localStorage');
        } catch (error) {
          console.error('Error clearing configuration from localStorage:', error);
          console.error('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö:', error.message);
          this.showToast('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏î‡πâ', 'error');
        }
      },

      hasConfigInLocalStorage() {
        try {
          const savedConfig = localStorage.getItem('enrollTable_mapping_config');
          return !!savedConfig;
        } catch (error) {
          console.error('Error checking localStorage:', error);
          return false;
        }
      },

      exportConfigAsJSON() {
        const configToExport = {
          userMappingConfig: this.userMappingConfig,
          csvMapping: this.csvMapping,
          exportedAt: new Date().toISOString(),
          version: '1.0'
        };

        const blob = new Blob([JSON.stringify(configToExport, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `enrollTable_mapping_config_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);

        console.log('‚úÖ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        this.showToast('‚úÖ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå JSON ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
      },

      // üîß DEBUG METHODS - ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö debug ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
      debugCurrentConfig() {
        console.log('=== DEBUG CURRENT CONFIG ===');
        console.log('userMappingConfig:', JSON.stringify(this.userMappingConfig, null, 2));
        console.log('csvMapping:', JSON.stringify(this.csvMapping, null, 2));
        console.log('csvColumns:', this.csvColumns);
        console.log('configSaveTimer:', this.configSaveTimer);
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö localStorage
        try {
          const savedConfig = localStorage.getItem('enrollTable_mapping_config');
          if (savedConfig) {
            const parsed = JSON.parse(savedConfig);
            console.log('üì¶ Saved in localStorage:', JSON.stringify(parsed, null, 2));
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ
            const csvMappingFields = Object.keys(parsed.csvMapping || {});
            
            let message = `‚úÖ ‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô localStorage\n\n`;
            message += `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date(parsed.savedAt).toLocaleString('th-TH')}\n\n`;
            message += `üìã CSV Mapping Fields (${csvMappingFields.length}):\n`;
            csvMappingFields.forEach(field => {
              const config = parsed.csvMapping[field];
              message += `  ‚Ä¢ ${field}: ${config.target || '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î'}\n`;
            });
            message += `\nüîß User Mapping Config:\n`;
            message += `  ‚Ä¢ Match Fields: ${parsed.userMappingConfig?.matchFields?.length || 0}\n`;
            message += `  ‚Ä¢ Username Type: ${parsed.userMappingConfig?.usernameSettings?.type || '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î'}\n`;
            message += `  ‚Ä¢ Password Type: ${parsed.userMappingConfig?.passwordSettings?.type || '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î'}`;
            
            alert(message);
          } else {
            console.log('‚ùå No saved config in localStorage');
            this.showToast('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô localStorage', 'warning');
          }
        } catch (error) {
          console.error('Error reading localStorage:', error);
          this.showToast('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô localStorage', 'error');
        }
      },

      forceRemoveWatchTimeout() {
        if (this.configSaveTimer) {
          clearTimeout(this.configSaveTimer);
          this.configSaveTimer = null;
          console.log('üßπ Cleared config save timer');
        }
      },

      forceSaveCurrentConfig() {
        this.forceRemoveWatchTimeout();
        console.log('üîÑ Force saving current config...');
        console.log('Current csvMapping keys:', Object.keys(this.csvMapping));
        console.log('Current userMappingConfig:', this.userMappingConfig);
        this.saveConfigToLocalStorage(true); // With notification
      },

      resetToBasicFields() {
        const confirmed = confirm(
          'üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏´‡∏•‡∏±‡∏Å\n\n' +
          '‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏à‡∏∞:\n' +
          '‚Ä¢ ‡∏•‡∏ö‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î\n' +
          '‚Ä¢ ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏´‡∏•‡∏±‡∏Å: ‡∏ä‡∏∑‡πà‡∏≠, ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•, ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå, ‡∏≠‡∏µ‡πÄ‡∏°‡∏•\n' +
          '‚Ä¢ ‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô localStorage\n\n' +
          '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?'
        );
        
        if (!confirmed) return;
        
        console.log('üîÑ Resetting to basic fields...');
        
        // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï csvMapping ‡πÄ‡∏õ‡πá‡∏ô‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
        this.csvMapping = {
          firstname: { 
            column: '', 
            target: 'firstname', 
            targetType: 'root', 
            fieldName: 'firstname',
            label: '‡∏ä‡∏∑‡πà‡∏≠',
            dataType: 'string',
            optional: false 
          },
          lastname: { 
            column: '', 
            target: 'lastname', 
            targetType: 'root', 
            fieldName: 'lastname',
            label: '‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•',
            dataType: 'string',
            optional: false 
          },
          phone: { 
            column: '', 
            target: 'phone', 
            targetType: 'root', 
            fieldName: 'phone',
            label: '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå',
            dataType: 'string',
            optional: true 
          },
          email: { 
            column: '', 
            target: 'email', 
            targetType: 'root', 
            fieldName: 'email',
            label: '‡∏≠‡∏µ‡πÄ‡∏°‡∏•',
            dataType: 'string',
            optional: true 
          }
        };
        
        // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï userMappingConfig
        this.userMappingConfig = {
          createMode: 'auto',
          matchFields: [
            { csv: '', user: 'email', primary: true }
          ],
          usernameSettings: {
            type: 'email',
            prefix: '',
            suffix: '',
            customPattern: '{firstname}.{lastname}',
            csvColumn: null
          },
          passwordSettings: {
            type: 'auto_generated',
            customValue: '',
            csvColumn: null,
            autoGenerated: {
              length: 12,
              includeLowercase: true,
              includeUppercase: true,
              includeNumbers: true,
              includeSymbols: false,
              excludeSimilar: true
            }
          }
        };
        
        // ‡∏•‡∏ö localStorage
        this.clearConfigFromLocalStorage();
        
        // Force update
        this.$forceUpdate();
        
        this.showToast('üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
        
        console.log('‚úÖ Reset completed');
        console.log('New csvMapping keys:', Object.keys(this.csvMapping));
      },

      // üéâ TOAST NOTIFICATION SYSTEM
      showToast(message, type = 'info', duration = 3000) {
        // Remove existing toast if any
        if (this.toastTimeout) {
          clearTimeout(this.toastTimeout);
        }
        
        // Set toast data
        this.toastMessage = message;
        this.toastType = type;
        this.toastVisible = true;
        
        // Auto hide toast
        this.toastTimeout = setTimeout(() => {
          this.hideToast();
        }, duration);
      },

      hideToast() {
        this.toastVisible = false;
        if (this.toastTimeout) {
          clearTimeout(this.toastTimeout);
          this.toastTimeout = null;
        }
      },

      toggleDropdown() {
        this.dropdownVisible = !this.dropdownVisible;
      },
      
      // üöÄ PROGRESSIVE/LAZY LOADING METHODS
      async loadMoreItems() {
        if (this.isLoadingMore || !this.hasMoreItems) return;
        
        this.isLoadingMore = true;
        
        // Simulate loading delay for better UX
        await new Promise(resolve => setTimeout(resolve, 300));
        
        this.currentDisplayCount = Math.min(
          this.currentDisplayCount + this.loadMoreCount,
          this.listItems.length
        );
        
        this.isLoadingMore = false;
      },

      setupScrollDetection() {
        if (!this.lazy) return;

        const handleScroll = this.debounce(() => {
          if (this.isLoadingMore || !this.hasMoreItems) return;

          const containers = [window, document.documentElement, document.body];
          
          for (const container of containers) {
            const scrollHeight = container === window ? 
              Math.max(document.documentElement.scrollHeight, document.body.scrollHeight) :
              container.scrollHeight;
            
            const scrollTop = container === window ? 
              (window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop) :
              container.scrollTop;
            
            const clientHeight = container === window ? 
              window.innerHeight :
              container.clientHeight;

            if (scrollTop + clientHeight >= scrollHeight * 0.8) {
              this.loadMoreItems();
              break;
            }
          }
        }, 100);

        // Setup listeners
        const events = ['scroll', 'wheel'];
        const targets = [window, document, document.body];
        
        targets.forEach(target => {
          events.forEach(event => {
            target.addEventListener(event, handleScroll, { passive: true });
          });
        });

        // Return cleanup function
        this.scrollCleanup = () => {
          targets.forEach(target => {
            events.forEach(event => {
              target.removeEventListener(event, handleScroll);
            });
          });
        };
      },

      resetDisplayCount() {
        const totalItems = this.listItems.length;
        
        // Progressive Loading ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏°‡∏≠
        // Adjust initial count based on limitItem
        if (this.limitItem <= 50) {
          this.initialDisplayCount = Math.min(25, totalItems);
        } else if (this.limitItem <= 100) {
          this.initialDisplayCount = Math.min(50, totalItems);
        } else if (this.limitItem <= 500) {
          this.initialDisplayCount = Math.min(100, totalItems);
        } else {
          this.initialDisplayCount = Math.min(200, totalItems);
        }
        
        this.currentDisplayCount = this.initialDisplayCount;
        
        // Setup scroll detection
        this.$nextTick(() => {
          this.setupScrollDetection();
          this.setupScrollToastDetection();
        });
      },

      // üöÄ PROGRESSIVE/LAZY LOADING - SCROLL TOAST METHODS
      setupScrollToastDetection() {
        const handleScroll = () => {
          if (!this.progressiveLoadingStats || this.progressiveLoadingStats.percentage >= 100) return;
          
          // ‡πÅ‡∏™‡∏î‡∏á toast ‡πÄ‡∏°‡∏∑‡πà‡∏≠ scroll (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà 100%)
          this.showProgressToast = true;
          
          // ‡∏ã‡πà‡∏≠‡∏ô toast ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
          if (this.scrollTimeout) {
            clearTimeout(this.scrollTimeout);
          }
          
          this.scrollTimeout = setTimeout(() => {
            this.showProgressToast = false;
          }, 2000);
        };

        // Setup scroll listeners
        const targets = [window, document, document.body];
        
        targets.forEach(target => {
          target.addEventListener('scroll', handleScroll, { passive: true });
        });

        // Return cleanup function
        const cleanup = () => {
          targets.forEach(target => {
            target.removeEventListener('scroll', handleScroll);
          });
          if (this.scrollTimeout) {
            clearTimeout(this.scrollTimeout);
            this.scrollTimeout = null;
          }
        };

        // ‡πÄ‡∏û‡∏¥‡πà‡∏° cleanup ‡πÑ‡∏õ‡∏¢‡∏±‡∏á scrollCleanup ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà
        const originalCleanup = this.scrollCleanup;
        this.scrollCleanup = () => {
          if (originalCleanup) originalCleanup();
          cleanup();
        };
      },

      showAllItems() {
        this.currentDisplayCount = this.listItems.length;
        if (this.scrollCleanup) {
          this.scrollCleanup();
          this.scrollCleanup = null;
        }
      },

      debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      },

      // üöÄ PROGRESSIVE/LAZY LOADING - Reset toast state
      resetProgressToast() {
        this.showProgressToast = false;
        if (this.scrollTimeout) {
          clearTimeout(this.scrollTimeout);
          this.scrollTimeout = null;
        }
      },

      addManualInputRow() {
        const session = storageManager.get('session')
        this.manualInput.push({
          firstname: '',
          lastname: '',
          citizen: null,
          phone: '',
          email: '',
          username: '',
          password: '',
          parent: session.current._id,
          salt: '',
          role: 'user',
          info: {
            prefix: '',
            sex: '',
            bu_type: '',
            bu_name: '',
            position: '',
          },
        });
      },
      removeManualInputRow(index) {
        if (this.manualInput.length > 1) { // Only allow removal if there's more than one row
          this.manualInput.splice(index, 1);
        }
      },
      async batchProcess() {
        try {
          this.isProcessing = true;
          this.progressTotal = this.totalItems;
          this.startTime = new Date().toISOString();
          this.endTime = null;

          while (this.currentPage <= this.totalPages) {
              // Process current page data
              for (const item of this.listItems) {
              console.log("User", item.user._id); // Log the user._id for each item
              
              // Fetch additional data (replace with your actual data fetching logic)
              const additionalData = await this.fetchAdditionalData(item.user);
              
              if (additionalData && additionalData[0]) {
                const avatarImg = additionalData[0].formData["upload-33-13-13"]?.value?.[0];
                
                if (avatarImg) { // Check if avatarImg has data
                  console.log("Form", avatarImg); // Log the additional data if needed
                  await this.updateAvatarImg(item.user, avatarImg);
                }
              }
            }

            // Update progress
            this.progressCurrent += this.listItems.length;
            this.progressText = `Processing: ${this.progressCurrent}/${this.progressTotal}`;

            // Load next page if available
            if (this.currentPage < this.totalPages) {
              this.currentPage++;
              await this.getData(); // Fetch data for the next page
            } else {
              break; // Exit the loop if all pages are processed
            }
          }

          this.progressText = `All Process: Done`;
          this.endTime = new Date().toISOString();
          this.isProcessing = false;
        } catch (error) {
          console.error("Error during batch processing:", error);
          this.isProcessing = false;
        }
      },
      async updateAvatarImg(item, avatarImg) {
        const requestBody = {
          data: {
            avatar_img: avatarImg,
          },
          options: {}
        };

        try {
          const { data, status } = await this.$Request.PUT(`user/${item._id}`, requestBody, this.configs.key);
          if (status === 200) {
            console.log(`Avatar updated for user ${item._id} ${data}`);
          } else {
            console.error(`Failed to update avatar for user ${item._id}`);
          }
        } catch (error) {
          console.error(`Error updating avatar for user ${item._id}:`, error);
        }
      },
        
      async fetchAdditionalData(item) {
        try {
          const response = await this.$Request.POST(
            'form/query',
            { method: 'find', args: [{ $and: [{ userID: item._id }] }] },
            this.configs.key
          );
          return response.data;
        } catch (error) {
          console.error("Error fetching additional data:", error);
          return null;
        }
      },
      async callbackFunction() {
        try {
          debug.log("callbackFunction");
          await this.getData();
        } catch (error) {
          console.error(error);
        }
      },
      updateBadge(badgeValue) {
        debug.log(badgeValue);
        this.$emit('update-badge', { code: this.tabs.code, badge: badgeValue });
      },
      isEditing(rowIndex, cellIndex) {
        return this.editingCell !== null && this.editingCell.rowIndex === rowIndex && this.editingCell.cellIndex === cellIndex;
      },
      startEditing(rowIndex, cellIndex) {
        this.editingCell = { rowIndex, cellIndex };
      },
      stopEditing(rowIndex, cellIndex) {
        this.editingCell = null;
        debug.log(rowIndex,cellIndex);
        // You can save the edited data to your CSV data array or perform other actions here.
      },
      selectTab(tabName) {
        this.selectedTab = tabName;
      },
      assignUserModal() {
        this.isModalOpen = true;
      },
      closeModal() {
        document.body.classList.remove('body-scroll-lock');
        this.isModalOpen = false;
      },
      handleFileUpload(event) {
        const file = event.target.files[0];
        if (file) {
          this.selectedFileName = file.name;
          const reader = new FileReader();
          reader.onload = (e) => {
            const contents = e.target.result;
            this.parseCSV(contents);
          };
          reader.readAsText(file);
        }
      },
      parseCSV(contents) {
        console.log('Parsing CSV content:', contents.substring(0, 200) + '...');
        
        // Split lines and filter out completely empty lines
        const lines = contents.split('\n').filter(line => line.trim() !== '');
        console.log('Total lines found:', lines.length);
        
        const data = [];

        for (let i = 0; i < lines.length; i++) {
          // Handle CSV parsing with better comma splitting (handles quoted values)
          const values = this.parseCSVLine(lines[i]);
          data.push(values);
          console.log(`Line ${i + 1}:`, values);
        }
        
        console.log('Parsed data array:', data);
        
        // Handle different scenarios
        if (data.length === 0) {
          // No data at all
          console.warn('No data found in CSV');
          this.csvColumns = [];
          this.csvData = [];
          alert('‡πÑ‡∏ü‡∏•‡πå CSV ‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå');
          return;
        } else if (data.length === 1) {
          // Only header or only one row of data
          console.log('Only 1 line found, treating as data row without headers');
          
          // Ask user if this line contains headers or data
          const hasHeaders = confirm(
            '‡πÑ‡∏ü‡∏•‡πå CSV ‡∏°‡∏µ‡πÄ‡∏û‡∏µ‡∏¢‡∏á 1 ‡πÅ‡∏ñ‡∏ß\n\n' +
            '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + data[0].join(', ') + '\n\n' +
            '‡∏Ñ‡∏•‡∏¥‡∏Å "‡∏ï‡∏Å‡∏•‡∏á" ‡∏´‡∏≤‡∏Å‡πÅ‡∏ñ‡∏ß‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå\n' +
            '‡∏Ñ‡∏•‡∏¥‡∏Å "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å" ‡∏´‡∏≤‡∏Å‡πÅ‡∏ñ‡∏ß‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'
          );
          
          if (hasHeaders) {
            // User says it's headers - no data rows
            this.csvColumns = data[0];
            this.csvData = [];
            alert('‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏µ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ñ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå');
            return;
          } else {
            // User says it's data - generate generic headers
            this.csvColumns = data[0].map((_, index) => `Column_${index + 1}`);
            this.csvData = data; // Use the single row as data
            console.log('Generated headers:', this.csvColumns);
            console.log('Data rows:', this.csvData);
          }
        } else {
          // Normal case: first row = headers, rest = data
          this.csvColumns = data[0];
          this.csvData = data.slice(1);
          console.log('Headers:', this.csvColumns);
          console.log('Data rows:', this.csvData.length);
        }
        
        // Validate that we have data to process
        if (this.csvData.length === 0) {
          alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå CSV ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå');
          return;
        }
        
        console.log('Final result - Columns:', this.csvColumns.length, 'Data rows:', this.csvData.length);
        
        // Auto-detect and suggest column mappings (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ)
        this.autoDetectColumnMappings();
        
        // ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö‡∏Å‡∏≤‡∏£ auto-detect
        if (this.hasConfigInLocalStorage()) {
          console.log('üì• Loading saved configuration to override auto-detection...');
          this.loadConfigFromLocalStorage();
        }
      },
      
      // Helper method to parse CSV line with better handling of quoted values
      parseCSVLine(line) {
        const result = [];
        let current = '';
        let inQuotes = false;
        let quoteChar = null;
        
        for (let i = 0; i < line.length; i++) {
          const char = line[i];
          
          if (!inQuotes && (char === '"' || char === "'")) {
            inQuotes = true;
            quoteChar = char;
          } else if (inQuotes && char === quoteChar) {
            // Check for escaped quotes
            if (i + 1 < line.length && line[i + 1] === quoteChar) {
              current += char;
              i++; // Skip next quote
            } else {
              inQuotes = false;
              quoteChar = null;
            }
          } else if (!inQuotes && char === ',') {
            result.push(current.trim());
            current = '';
          } else {
            current += char;
          }
        }
        
        // Add the last field
        result.push(current.trim());
        
        // Clean up quotes from values
        return result.map(val => val.replace(/^["']|["']$/g, ''));
      },
      
      autoDetectColumnMappings() {
        if (this.csvColumns.length === 0) return;
        
        // ‡πÑ‡∏°‡πà‡∏ó‡∏≥ auto-detect ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ
        if (this.hasConfigInLocalStorage()) {
          console.log('‚ö° Skip auto-detect: Found saved configuration in localStorage');
          return;
        }
        
        console.log('üîç Auto-detecting column mappings...');
        
        // Auto-detect ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
        const detectionPatterns = {
          'email': /email|e-mail|‡∏≠‡∏µ‡πÄ‡∏°‡∏•/i,
          'phone': /phone|tel|‡πÇ‡∏ó‡∏£|‡πÄ‡∏ö‡∏≠‡∏£‡πå/i,
          'firstname': /firstname|fname|‡∏ä‡∏∑‡πà‡∏≠|name.*first/i,
          'lastname': /lastname|lname|‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•|name.*last/i
        };
        
        this.csvColumns.forEach((column, index) => {
          for (const [key, pattern] of Object.entries(detectionPatterns)) {
            if (pattern.test(column) && this.csvMapping[key]) {
              console.log(`üéØ Auto-detected: "${column}" -> ${key} (column ${index})`);
              
              // Update csvMapping if it exists
              this.csvMapping[key].column = index;
              
              // Update matchFields if appropriate
              const matchField = this.userMappingConfig.matchFields.find(f => 
                f.csv === key || f.csv === index.toString()
              );
              if (matchField) {
                matchField.csv = index;
              }
              break;
            }
          }
        });
        
        console.log('‚úÖ Auto-detection completed');
      },
      
      // üéØ USER MAPPING & PROCESSING METHODS
      openMappingConfig() {
        this.showMappingModal = true;
      },
      
      openUsernamePasswordConfig() {
        // ‡πÄ‡∏õ‡∏¥‡∏î Modal ‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏™‡πà‡∏ß‡∏ô Username/Password ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
        this.showMappingModal = true;
        this.$nextTick(() => {
          // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏™‡πà‡∏ß‡∏ô Username/Password Configuration
          const usernamePasswordSection = document.querySelector('.username-password-config');
          if (usernamePasswordSection) {
            usernamePasswordSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        });
      },
      
      closeMappingConfig() {
        this.showMappingModal = false;
      },
      
      addMatchField() {
        this.userMappingConfig.matchFields.push({
          csv: '',
          user: '',
          primary: false
        });
      },
      
      getMatchFieldsSummary() {
        const primaryFields = this.userMappingConfig.matchFields.filter(f => f.primary && f.csv !== '');
        if (primaryFields.length === 0) return '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î';
        
        return primaryFields.map(f => {
          const columnName = this.csvColumns[f.csv] || `‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå ${parseInt(f.csv) + 1}`;
          return columnName;
        }).join(', ');
      },

      // üîê NEW METHODS FOR USERNAME/PASSWORD SUMMARY
      getUsernameSettingSummary() {
        const settings = this.userMappingConfig.usernameSettings;
        switch (settings.type) {
          case 'email':
            return '‡πÉ‡∏ä‡πâ Email';
          case 'phone':
            return '‡πÉ‡∏ä‡πâ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå';
          case 'custom_pattern':
            return `‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: ${settings.customPattern}`;
          case 'from_csv': {
            const columnName = this.csvColumns[settings.csvColumn] || `‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå ${parseInt(settings.csvColumn) + 1}`;
            return `‡∏à‡∏≤‡∏Å CSV: ${columnName}`;
          }
          default:
            return '‡πÉ‡∏ä‡πâ Email/‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå';
        }
      },

      getPasswordSettingSummary() {
        const settings = this.userMappingConfig.passwordSettings;
        switch (settings.type) {
          case 'auto_generated':
            return `‡∏™‡∏∏‡πà‡∏° ${settings.autoGenerated.length} ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£`;
          case 'email':
            return '‡πÉ‡∏ä‡πâ Email';
          case 'phone':
            return '‡πÉ‡∏ä‡πâ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå';
          case 'custom_value':
            return '‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡∏ó‡∏µ‡πà (‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô)';
          case 'from_csv': {
            const columnName = this.csvColumns[settings.csvColumn] || `‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå ${parseInt(settings.csvColumn) + 1}`;
            return `‡∏à‡∏≤‡∏Å CSV: ${columnName}`;
          }
          default:
            return '‡∏™‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥';
        }
      },
      
      // üéØ CSV MAPPING METHODS - Enhanced Custom Field Management
      addNewMappingField() {
        console.log('Adding new mapping field...');
        
        // Prompt user for field name (this will be the actual field name)
        // Examples: department, employee_code, final_badge_id, etc.
        const fieldName = prompt(
          '‡∏ä‡∏∑‡πà‡∏≠‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©):\n' +
          '‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: department, employee_code, badge_number\n' +
          '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á', 
          ''
        );
        if (!fieldName || !fieldName.trim()) return;
        
        // Clean field name (remove spaces, special characters)
        const cleanFieldName = fieldName.trim().replace(/[^a-zA-Z0-9_]/g, '_').toLowerCase();
        
        // Prompt user for display label
        const label = prompt('‡∏õ‡πâ‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÑ‡∏î‡πâ):', cleanFieldName);
        if (!label) return;
        
        // Ask user if they want to save in root level or info object
        const useRootLevel = confirm(
          `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ü‡∏¥‡∏•‡∏î‡πå "${cleanFieldName}":\n\n` +
          '‡∏Ñ‡∏•‡∏¥‡∏Å "‡∏ï‡∏Å‡∏•‡∏á" = Root level (‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏´‡∏•‡∏±‡∏Å)\n' +
          '- ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö: firstname, lastname, email, phone\n' +
          '- ‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô: user.' + cleanFieldName + '\n\n' +
          '‡∏Ñ‡∏•‡∏¥‡∏Å "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å" = Info object (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°)\n' +
          '- ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö: department, employee_code, badge_number\n' +
          '- ‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô: user.info.' + cleanFieldName
        );
        
        let target;
        if (useRootLevel) {
          // User chose root level
          target = cleanFieldName;
          
          // Warn if this might conflict with system fields
          const systemFields = ['_id', 'username', 'password', 'salt', 'role', 'parent', 'created', 'updated'];
          if (systemFields.includes(cleanFieldName)) {
            const proceed = confirm(
              `‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: "${cleanFieldName}" ‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏£‡∏∞‡∏ö‡∏ö\n\n` +
              '‡∏Ñ‡∏•‡∏¥‡∏Å "‡∏ï‡∏Å‡∏•‡∏á" = ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠ (‡∏≠‡∏≤‡∏à‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö)\n' +
              '‡∏Ñ‡∏•‡∏¥‡∏Å "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å" = ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ô‡∏µ‡πâ'
            );
            if (!proceed) return;
          }
        } else {
          // User chose info object (default and recommended)
          target = `info.${cleanFieldName}`;
        }
        
        console.log('Adding field:', cleanFieldName, 'with label:', label, 'and target:', target);
        
        // Check if field already exists (including default fields)
        if (this.csvMapping[cleanFieldName] || this.defaultMappingFields.includes(cleanFieldName)) {
          alert(`‡∏ü‡∏¥‡∏•‡∏î‡πå "${cleanFieldName}" ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∑‡πà‡∏ô`);
          return;
        }
        
        // Create new mapping object with default target type and field name
        const defaultTargetType = useRootLevel ? 'root' : 'info';
        const newMapping = {
          column: '',
          target: target,
          targetType: defaultTargetType,
          fieldName: cleanFieldName,
          optional: true,
          customValue: '',
          label: label,
          dataType: 'string'
        };
        
        // Method 1: Try direct assignment
        this.csvMapping[cleanFieldName] = newMapping;
        
        // Method 2: Force reactivity with spread operator
        this.csvMapping = { ...this.csvMapping, [cleanFieldName]: newMapping };
        
        console.log('Updated csvMapping:', this.csvMapping);
        
        // Auto-save configuration after adding new field
        this.saveConfigToLocalStorage(false); // Silent save
        
        // Force component update
        this.$forceUpdate();
        
        // Trigger reactivity
        this.$nextTick(() => {
          console.log('Field should be added now, configuration saved');
          this.showToast(`‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏¥‡∏•‡∏î‡πå "${label}" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥`, 'success');
        });
      },
      
      removeCsvMapping(key) {
        if (this.isDefaultMapping(key)) return;
        
        console.log('Removing mapping field:', key);
        
        // Create new object without the key
        const newCsvMapping = Object.keys(this.csvMapping)
          .filter(k => k !== key)
          .reduce((obj, k) => {
            obj[k] = this.csvMapping[k];
            return obj;
          }, {});
        
        this.csvMapping = newCsvMapping;
        
        console.log('Updated csvMapping after delete:', this.csvMapping);
        
        // Auto-save configuration after removing field
        this.saveConfigToLocalStorage(false); // Silent save
        
        // Force update
        this.$forceUpdate();
        
        this.showToast(`‚úÖ ‡∏•‡∏ö‡∏ü‡∏¥‡∏•‡∏î‡πå "${key}" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥`, 'success');
      },
      
      isDefaultMapping(key) {
        return this.defaultMappingFields.includes(key);
      },
      
      getDataTypeLabel(dataType) {
        const labels = {
          'string': 'Text',
          'number': 'Number',
          'boolean': 'Boolean',
          'date': 'Date'
        };
        return labels[dataType] || dataType;
      },
      
      // üéØ New methods for target location management
      updateMappingTarget(mapping, key) {
        // Don't allow changes to default mapping fields
        if (this.isDefaultMapping(key)) {
          console.log('Cannot modify target for default mapping field:', key);
          return;
        }
        
        if (mapping.targetType === 'custom') {
          // For custom type, user will input the full path manually
          return;
        }
        
        // Auto-generate target based on type and field name
        const fieldName = mapping.fieldName || key;
        
        if (mapping.targetType === 'root') {
          mapping.target = fieldName;
        } else {
          mapping.target = `${mapping.targetType}.${fieldName}`;
        }
        
        console.log(`Updated mapping for ${key}:`, mapping.target);
        
        // Force reactivity
        this.$forceUpdate();
      },
      
      getFieldNamePlaceholder(targetType) {
        const placeholders = {
          'root': '‡πÄ‡∏ä‡πà‡∏ô firstname, lastname, email',
          'info': '‡πÄ‡∏ä‡πà‡∏ô department, employee_id, position',
          'contact': '‡πÄ‡∏ä‡πà‡∏ô emergency_phone, line_id',
          'address': '‡πÄ‡∏ä‡πà‡∏ô province, district, zipcode',
          'work': '‡πÄ‡∏ä‡πà‡∏ô company, department, position',
          'education': '‡πÄ‡∏ä‡πà‡∏ô degree, university, major'
        };
        return placeholders[targetType] || '‡∏ä‡∏∑‡πà‡∏≠‡∏ü‡∏¥‡∏•‡∏î‡πå';
      },
      
      getTargetExamples(targetType) {
        const examples = {
          'root': 'firstname, lastname, email, phone',
          'info': 'department, employee_id, position, badge_number',
          'contact': 'emergency_phone, line_id, facebook',
          'address': 'province, district, zipcode, full_address',
          'work': 'company, department, position, salary',
          'education': 'degree, university, major, graduation_year'
        };
        return examples[targetType] || '';
      },
      
      async findExistingUser(rowData) {
        const matchResults = [];
        
        for (const matchField of this.userMappingConfig.matchFields) {
          const csvValue = this.getValueFromRow(rowData, matchField.csv);
          if (!csvValue) continue;
          
          try {
            // Build query conditions for this field
            const fieldCondition = this.buildQueryObject(matchField.user, csvValue);
            
            // Add parent condition to ensure we only search within current site
            const queryConditions = {
              $and: [
                fieldCondition,
                { parent: this.session.current._id }
              ]
            };

            console.log(`üîç Searching user by ${matchField.user} = "${csvValue}"`);
            console.log('Query conditions:', JSON.stringify(queryConditions, null, 2));
            
            const resAPI = await fetch("https://gateway.cloudrestfulapi.com/api/user/query", {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'client-token-key': this.configs.key
              },
              body: JSON.stringify({
                method: 'find',
                args: [queryConditions]
              })
            });

            if (resAPI.ok) {
              const response = await resAPI.json();
              console.log(`üìã Full API response for ${matchField.user}:`, response);
              
              // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö response ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ
              let userData = null;
              
              if (response && Array.isArray(response) && response.length > 0) {
                // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: [{ _id: "xxx", ... }] (array ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á - ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏™‡∏î‡∏á)
                userData = response[0];
                console.log(`‚úÖ Found user in direct array format:`, userData);
              } else if (response.data && Array.isArray(response.data) && response.data.length > 0) {
                // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: { data: [{ _id: "xxx", ... }] }
                userData = response.data[0];
                console.log(`‚úÖ Found user in data wrapper format:`, userData);
              } else if (response.data && response.data._id) {
                // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: { data: { _id: "xxx", ... } }
                userData = response.data;
                console.log(`‚úÖ Found user in single object format:`, userData);
              } else if (response._id) {
                // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: { _id: "xxx", ... }
                userData = response;
                console.log(`‚úÖ Found user in direct object format:`, userData);
              }
              
              if (userData && userData._id) {
                console.log(`‚úÖ Found user by ${matchField.user} with ID ${userData._id}:`, userData);
                matchResults.push({
                  field: matchField.csv,
                  user: userData,
                  isPrimary: matchField.primary
                });
              } else {
                console.log(`‚ùå No user found by ${matchField.user} = "${csvValue}"`);
                console.log('Response structure:', Object.keys(response));
              }
            } else {
              const errorText = await resAPI.text();
              console.error(`‚ùå API error for ${matchField.user}:`, resAPI.status, resAPI.statusText, errorText);
            }
            
          } catch (error) {
            console.warn(`Error searching user by ${matchField.user}:`, error);
          }
        }
        
        // Return primary match first, or any match if no primary
        const primaryMatch = matchResults.find(m => m.isPrimary);
        const foundUser = primaryMatch ? primaryMatch.user : (matchResults[0]?.user || null);
        
        if (foundUser) {
          console.log('‚úÖ Found existing user:', foundUser);
        } else {
          console.log('‚ùå No existing user found for this row');
        }
        
        return foundUser;
      },
      
      buildQueryObject(fieldPath, value) {
        // Convert numeric strings to numbers for specific fields
        const numericFields = ['info.employee_id', 'info.final_badge_id', 'info.level', 'user_id'];
        let processedValue = value;
        
        if (numericFields.includes(fieldPath) && !isNaN(value)) {
          processedValue = parseInt(value);
        }
        
        // Handle nested fields
        if (fieldPath.includes('.')) {
          const parts = fieldPath.split('.');
          const queryObj = {};
          let current = queryObj;
          
          for (let i = 0; i < parts.length - 1; i++) {
            current[parts[i]] = {};
            current = current[parts[i]];
          }
          current[parts[parts.length - 1]] = processedValue;
          
          return queryObj;
        } else {
          return { [fieldPath]: processedValue };
        }
      },
      
      getValueFromRow(rowData, fieldName) {
        // If fieldName is a number (column index), use it directly
        if (typeof fieldName === 'number' || !isNaN(fieldName)) {
          const columnIndex = parseInt(fieldName);
          return rowData[columnIndex]?.trim() || null;
        }
        
        // Otherwise, use the mapping configuration
        const mapping = this.csvMapping[fieldName];
        if (!mapping) return null;
        
        // Check if this is a custom value (not mapped to CSV column)
        if (mapping.column === 'custom' && mapping.customValue) {
          return mapping.customValue.trim();
        }
        
        // Regular CSV column mapping
        if (mapping.column !== '' && mapping.column !== 'custom') {
          return rowData[mapping.column]?.trim() || null;
        }
        
        return null;
      },
      
      buildUserDataFromRow(rowData) {
        const userData = {
          parent: this.session.current._id,
          role: 'user',
          info: {}
        };
        
        // Map CSV data to user object
        for (const [fieldName, config] of Object.entries(this.csvMapping)) {
          const value = this.getValueFromRow(rowData, fieldName);
          
          // Skip if no value and field is not optional
          if (!value && !config.optional) continue;
          
          // Skip if no value and no custom value is set
          if (!value && config.column !== 'custom') continue;
          
          // Parse target path
          const targetPath = config.target.split('.');
          let target = userData;
          
          // Navigate to nested object, creating if necessary
          for (let i = 0; i < targetPath.length - 1; i++) {
            const pathPart = targetPath[i];
            if (!target[pathPart]) {
              target[pathPart] = {};
            }
            target = target[pathPart];
          }
          
          // Set the value with data type conversion
          const finalKey = targetPath[targetPath.length - 1];
          const finalValue = this.convertDataType(value, config.dataType);
          
          // Set the value
          target[finalKey] = finalValue;
          
          console.log(`Set ${config.target} = ${finalValue} (type: ${config.dataType})`);
        }
        
        console.log('Built user data:', userData);
        return userData;
      },
      
      convertDataType(value, dataType) {
        if (!value || !dataType) return value;
        
        try {
          switch (dataType) {
            case 'number':
              return isNaN(value) ? value : parseFloat(value);
            
            case 'boolean': {
              const lowerValue = value.toString().toLowerCase();
              if (['true', '1', 'yes', 'y', '‡πÄ‡∏õ‡πá‡∏ô', '‡πÉ‡∏ä‡πà'].includes(lowerValue)) return true;
              if (['false', '0', 'no', 'n', '‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô', '‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà'].includes(lowerValue)) return false;
              return value;
            }
            
            case 'date': {
              const date = new Date(value);
              return isNaN(date.getTime()) ? value : date.toISOString();
            }
            
            case 'string':
            default:
              return value.toString();
          }
        } catch (error) {
          console.warn(`Error converting value "${value}" to ${dataType}:`, error);
          return value; // Return original value if conversion fails
        }
      },
      
      async processAdvancedCSV() {
        if (!this.csvData || this.csvData.length === 0) {
          alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• CSV ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô');
          return;
        }
        
        // Show confirmation for single row
        if (this.csvData.length === 1) {
          const confirmed = confirm(
            `‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• CSV ‡∏°‡∏µ‡πÄ‡∏û‡∏µ‡∏¢‡∏á 1 ‡πÅ‡∏ñ‡∏ß\n\n` +
            `‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${this.csvData[0].join(', ')}\n\n` +
            `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ 1 ‡∏Ñ‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`
          );
          
          if (!confirmed) {
            return;
          }
        }
        
        console.log('Starting advanced CSV processing with', this.csvData.length, 'rows');
        
        // Initialize processing results
        this.processingResults = {
          total: this.csvData.length,
          created: 0,
          enrolled: 0,
          skipped: 0,
          errors: 0,
          details: []
        };
        
        // Show progress overlay
        this.isCreatingUser = true;
        this.loadingMessage = '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
        this.processingCount = '';
        
        // Add small delay to show initial state
        await new Promise(resolve => setTimeout(resolve, 500));
        
        for (let i = 0; i < this.csvData.length; i++) {
          const rowData = this.csvData[i];
          const currentRow = i + 1;
          
          // Update progress
          this.processingCount = `${currentRow}/${this.csvData.length}`;
          this.loadingMessage = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà ${currentRow}`;
          
          // Force Vue to update the UI
          await this.$nextTick();
          
          try {
            // Add small delay to show progress for each item
            await new Promise(resolve => setTimeout(resolve, 100));
            
            await this.processRow(rowData, currentRow);
          } catch (error) {
            console.error(`Error processing row ${currentRow}:`, error);
            this.processingResults.errors++;
            this.processingResults.details.push({
              row: currentRow,
              action: 'error',
              message: error.message,
              data: rowData
            });
          }
        }
        
        // Complete processing with success animation
        this.loadingMessage = '‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô ‚úÖ';
        
        // Show completion state for a moment
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        this.isCreatingUser = false;
        this.showResultsModal = true;
        this.isModalOpen = false;
        
        // Reset processing count
        this.processingCount = '';
      },
      
      async processRow(rowData, rowNumber) {
        // Update specific progress message
        this.loadingMessage = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà ${rowNumber}`;
        await this.$nextTick();
        
        const userData = this.buildUserDataFromRow(rowData);
        
        // Check if user exists
        this.loadingMessage = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà ${rowNumber}`;
        await this.$nextTick();
        
        const existingUser = await this.findExistingUser(rowData);
        
        if (existingUser) {
          // User exists - handle based on configuration
          this.loadingMessage = `‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß - ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (${rowNumber})`;
          await this.$nextTick();
          await this.handleExistingUser(existingUser, userData, rowNumber);
        } else {
          // User doesn't exist - create if allowed
          this.loadingMessage = `‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ - ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà (${rowNumber})`;
          await this.$nextTick();
          await this.handleNewUser(userData, rowNumber, rowData);
        }
      },
      
      async handleExistingUser(existingUser, userData, rowNumber) {
        // User ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß - ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
        const enrollExists = await this.checkEnrollmentExists(existingUser._id);
        
        if (enrollExists) {
          // ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß - ‡∏Ç‡πâ‡∏≤‡∏°
          this.processingResults.skipped++;
          this.processingResults.details.push({
            row: rowNumber,
            action: 'skipped',
            message: '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß',
            user: existingUser
          });
        } else {
          // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô - ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
          await this.enrollUser(existingUser._id, rowNumber, existingUser);
        }
      },
      
      async handleNewUser(userData, rowNumber, rowData = null) {
        // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ user ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö - ‡∏™‡∏£‡πâ‡∏≤‡∏á user ‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•
        if (this.userMappingConfig.createMode === 'enroll_only') {
          this.processingResults.skipped++;
          this.processingResults.details.push({
            row: rowNumber,
            action: 'skipped',
            message: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà (‡πÇ‡∏´‡∏°‡∏î‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)',
            data: userData
          });
          return;
        }
        
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á user ‡πÉ‡∏´‡∏°‡πà
        try {
          // Generate password ‡πÅ‡∏•‡∏∞ salt ‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà
          const salt = CryptoJS.lib.WordArray.random(16);
          const plainPassword = this.generatePassword(userData, rowData);
          const username = this.generateUsername(userData, rowData);
          const hash = CryptoJS.SHA256(plainPassword + salt).toString();
          
          userData.password = hash;
          userData.salt = salt.toString();
          userData.username = username;
          
          // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å plain password ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô details ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
          userData._plainPassword = plainPassword;
          
          console.log(`üë§ Creating new user with username: ${username}`);
          console.log('üîß User data to be created:', {
            username,
            email: userData.email,
            phone: userData.phone,
            firstname: userData.firstname,
            lastname: userData.lastname,
            plainPassword: plainPassword,
            hashedPassword: hash.substring(0, 16) + '...',
            salt: salt.toString().substring(0, 16) + '...'
          });
          
          // ‡∏™‡∏£‡πâ‡∏≤‡∏á user
          const userResponse = await fetch("https://gateway.cloudrestfulapi.com/api/user/", {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'client-token-key': this.configs.key
            },
            body: JSON.stringify({
              data: userData
            })
          });
          
          if (userResponse.ok) {
            const userResult = await userResponse.json();
            console.log(`‚úÖ User creation response:`, userResult);
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á response ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö
            let createdUser = null;
            let userId = null;
            
            // ‡∏•‡∏≠‡∏á‡∏´‡∏≤ user data ‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ
            if (userResult._id) {
              // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏Å: { _id: "xxx", ... } (‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏™‡∏î‡∏á)
              createdUser = userResult;
              userId = userResult._id;
              console.log('üìù Found user ID in root level:', userId);
            } else if (userResult.data && userResult.data._id) {
              // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: { data: { _id: "xxx", ... } }
              createdUser = userResult.data;
              userId = userResult.data._id;
              console.log('üìù Found user ID in data wrapper:', userId);
            } else if (userResult.id) {
              // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: { id: "xxx", ... }
              createdUser = userResult;
              userId = userResult.id;
              console.log('üìù Found user ID as "id" field:', userId);
            } else {
              // ‡πÑ‡∏°‡πà‡∏û‡∏ö ID ‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á - ‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á
              console.error('‚ùå Cannot find user ID in response structure:', Object.keys(userResult));
              console.error('Full response:', userResult);
              throw new Error('User was created but no ID was returned from server');
            }
            
            console.log(`‚úÖ User created successfully with ID: ${userId}`);
            console.log('Created user data:', createdUser);
            
            this.processingResults.created++;
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á user ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à - ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
            await this.enrollUser(userId, rowNumber, createdUser);
          } else {
            const errorText = await userResponse.text();
            console.error('‚ùå User creation failed:', userResponse.status, userResponse.statusText, errorText);
            throw new Error(`Failed to create user: ${userResponse.status} ${userResponse.statusText}`);
          }
        } catch (error) {
          this.processingResults.errors++;
          this.processingResults.details.push({
            row: rowNumber,
            action: 'error',
            message: `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ: ${error.message}`,
            data: userData
          });
        }
      },
      
      async checkEnrollmentExists(userId) {
        try {
          console.log(`üîç Checking enrollment for user ${userId} in course ${this.dataItem}`);
          
          const queryConditions = {
            $and: [
              { userID: userId },
              { courseID: this.dataItem }
            ]
          };

          const resAPI = await fetch("https://gateway.cloudrestfulapi.com/api/enroll/query", {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'client-token-key': this.configs.key
            },
            body: JSON.stringify({
              method: 'find',
              args: [queryConditions]
            })
          });

          if (resAPI.ok) {
            const response = await resAPI.json();
            console.log(`üìã Enrollment query response:`, response);
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            let enrollmentExists = false;
            
            if (response && Array.isArray(response) && response.length > 0) {
              // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: [{ _id: "xxx", ... }] (array ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á)
              enrollmentExists = true;
            } else if (response.data && Array.isArray(response.data) && response.data.length > 0) {
              // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: { data: [{ _id: "xxx", ... }] }
              enrollmentExists = true;
            } else if (response.data && response.data._id) {
              // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: { data: { _id: "xxx", ... } }
              enrollmentExists = true;
            } else if (response._id) {
              // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: { _id: "xxx", ... }
              enrollmentExists = true;
            }
            
            console.log(`üìù Enrollment ${enrollmentExists ? 'EXISTS' : 'NOT FOUND'} for user ${userId}`);
            return enrollmentExists;
          } else {
            console.error('API error checking enrollment:', resAPI.status, resAPI.statusText);
            return false;
          }
        } catch (error) {
          console.error('Error checking enrollment exists:', error);
          return false;
        }
      },
      
      async enrollUser(userId, rowNumber, userData) {
        console.log(`üìù Creating enrollment for user ${userId} in course ${this.dataItem}`);
        
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
        const enrollData = {
          userID: userId,
          courseID: this.dataItem,
          analytics: {
            total: 0,
            pending: 0,
            processing: 0,
            complete: 0,
            status: "pending",
            message: "Not started",
            post: { req: false, has: false, measure: null, score: null, result: false, message: null },
            pre: { req: false, has: false, measure: null, result: false, message: null },
            retest: { req: false, has: false, measure: null, result: false, message: null },
            option: { cert_area: null, exam_round: null },
            percent: 0
          }
        };
        
        try {
          // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
          const enrollResponse = await fetch("https://gateway.cloudrestfulapi.com/api/enroll/", {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'client-token-key': this.configs.key
            },
            body: JSON.stringify({
              data: enrollData
            })
          });
          
          if (enrollResponse.ok) {
            const enrollResult = await enrollResponse.json();
            console.log(`‚úÖ Enrollment creation response:`, enrollResult);
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á enrollment response
            let enrollmentId = null;
            let enrollmentData = null;
            
            if (enrollResult._id) {
              // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏Å: { _id: "xxx", ... } (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ö user creation)
              enrollmentData = enrollResult;
              enrollmentId = enrollResult._id;
              console.log('üìù Found enrollment ID in root level:', enrollmentId);
            } else if (enrollResult.data && enrollResult.data._id) {
              // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: { data: { _id: "xxx", ... } }
              enrollmentData = enrollResult.data;
              enrollmentId = enrollResult.data._id;
              console.log('üìù Found enrollment ID in data wrapper:', enrollmentId);
            } else if (enrollResult.id) {
              // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: { id: "xxx", ... }
              enrollmentData = enrollResult;
              enrollmentId = enrollResult.id;
              console.log('üìù Found enrollment ID as "id" field:', enrollmentId);
            } else {
              console.error('‚ùå Cannot find enrollment ID in response structure:', Object.keys(enrollResult));
              console.error('Full enrollment response:', enrollResult);
              throw new Error('Enrollment was created but no ID was returned from server');
            }
            
            console.log(`‚úÖ Enrollment created with ID: ${enrollmentId}`);
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£
            const courseUpdateResponse = await fetch(`https://gateway.cloudrestfulapi.com/api/course/${this.dataItem}/enroll`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'client-token-key': this.configs.key
              },
              body: JSON.stringify({
                action: "add",
                element: enrollmentId,
                type: "string"
              })
            });
            
            if (courseUpdateResponse.ok) {
              console.log(`‚úÖ User enrolled successfully in course`);
              
              this.processingResults.enrolled++;
              this.processingResults.details.push({
                row: rowNumber,
                action: 'enrolled',
                message: '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                user: userData,
                enrollment: enrollmentData
              });
            } else {
              const errorText = await courseUpdateResponse.text();
              console.error('‚ùå Course update failed:', courseUpdateResponse.status, errorText);
              throw new Error(`Failed to add enrollment to course: ${courseUpdateResponse.status}`);
            }
          } else {
            const errorText = await enrollResponse.text();
            console.error('‚ùå Enrollment creation failed:', enrollResponse.status, errorText);
            throw new Error(`Failed to create enrollment: ${enrollResponse.status}`);
          }
        } catch (error) {
          console.error(`‚ùå Enrollment failed for user ${userId}:`, error);
          
          this.processingResults.errors++;
          this.processingResults.details.push({
            row: rowNumber,
            action: 'error',
            message: `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ: ${error.message}`,
            user: userData
          });
        }
      },
      
      async updateUser(userId, userData) {
        try {
          await this.$Request.PUT(`user/${userId}`, {
            data: userData
          }, this.configs.key);
        } catch (error) {
          console.warn('Could not update user:', error);
        }
      },
      
      resetProcessingResults() {
        this.processingResults = {
          total: 0,
          created: 0,
          enrolled: 0,
          skipped: 0,
          errors: 0,
          details: []
        };
        this.showResultsModal = false;
      },
      openCSVModal() {
        // Method to open CSV processing modal
        document.body.classList.add('body-scroll-lock');
        this.csvModalOpen = true;
      },
      async processManualInput() {
        try {
          for (const userInput of this.manualInput) { // Loop through each user input
            const salt = CryptoJS.lib.WordArray.random(16);
            const hash = CryptoJS.SHA256(userInput.password + salt).toString();

            const userData = {
              firstname: userInput.firstname,
              lastname: userInput.lastname,
              citizen: null,
              phone: userInput.phone,
              email: userInput.email,
              username: userInput.username,
              password: hash,
              parent: this.session.current._id,
              salt: salt.toString(),
              role: 'user',
              info: {
                prefix: userInput.info.prefix,
                bu_type: userInput.info.bu_type,
                bu_name: userInput.info.bu_name,
                position: userInput.info.position,
              },
            };

            const userResponse = await fetch("https://gateway.cloudrestfulapi.com/api/user/", {
              method: 'POST',
              headers: {'Content-Type': 'application/json','client-token-key':this.configs.key},
              body: JSON.stringify({ data: userData })
            });

            if (userResponse.status === 200) {
              const userJson = await userResponse.json();
              const enrollResponse = await fetch("https://gateway.cloudrestfulapi.com/api/enroll/", {
                method: 'POST',
                headers: {'Content-Type': 'application/json','client-token-key':this.configs.key},
                body: JSON.stringify({
                  data: {
                    "userID": userJson._id,
                    "courseID": this.dataItem,
                    "analytics": {
                      "total": 0,
                      "pending": 0,
                      "processing": 0,
                      "complete": 0,
                      "status": "pending",
                      "message": "Not started",
                      "post": {
                        "req": false,
                        "has": false,
                        "measure": null,
                        "score": null,
                        "result": false,
                        "message": null
                      },
                      "pre": {
                        "req": false,
                        "has": false,
                        "measure": null,
                        "result": false,
                        "message": null
                      },
                      "retest": {
                        "req": false,
                        "has": false,
                        "measure": null,
                        "result": false,
                        "message": null
                      },
                      "option": {
                        "cert_area": null,
                        "exam_round": null
                      },
                      "percent": 0
                    }
                  },
                  options: {}
                })
              });

              if (enrollResponse.status === 200) {
                const finalRes = await enrollResponse.json();
                await fetch("https://gateway.cloudrestfulapi.com/api/course/" + this.dataItem + "/enroll", {
                  method: 'POST',
                  headers: {'Content-Type': 'application/json','client-token-key':this.configs.key},
                  body: JSON.stringify({
                    action: "add",
                    element: finalRes._id,
                    type: "string",
                  })
                });
              }
            }
          }

          this.isModalOpen = false;
          // Reset manualInput to one empty form
          this.manualInput = [
            {
              firstname: '',
              lastname: '',
              citizen: null,
              phone: '',
              email: '',
              username: '',
              password: '',
              parent: this.session.current._id,
              salt: '',
              role: 'user',
              info: {
                prefix: '',
                sex: '',
                bu_type: '',
                bu_name: '',
                position: '',
              },
            }
          ];
          await this.getData();
          await this.getCourse();
          this.fetchData();
        } catch (error) {
          console.error("Error processing manual input:", error);
        }
      },
      async processCSV() {
        try {
          for (const row of this.csvData) {
            const salt = CryptoJS.lib.WordArray.random(16);
            const hash = CryptoJS.SHA256(row[6] + salt).toString();

            const userData = {
              firstname: row[3],
              lastname: row[4],
              citizen: null,
              phone: row[6],
              email: row[7].trim(),
              username: row[7].trim(),
              password: hash,
              parent: this.session.current._id,
              salt: salt.toString(),
              role: "user",
              info: {}
            };

            if (row[2]) { userData.info.prefix = row[2]; }
            if (row[1]) { userData.info.bu_type = row[1]; }
            if (row[0]) { userData.info.bu_name = row[0]; }
            if (row[5]) { userData.info.position = row[5]; }

            const userResponse = await fetch("https://gateway.cloudrestfulapi.com/api/user/", {
              method: 'POST',
              headers: {'Content-Type': 'application/json','client-token-key':this.configs.key},
              body: JSON.stringify({ data: userData })
            });

            if (userResponse.status === 200) {
              const userJson = await userResponse.json();
              const enrollResponse = await fetch("https://gateway.cloudrestfulapi.com/api/enroll/", {
                method: 'POST',
                headers: {'Content-Type': 'application/json','client-token-key':this.configs.key},
                body: JSON.stringify({
                  data: {
                    "userID": userJson._id,
                    "courseID": this.dataItem,
                    "analytics": {
                      "total": 0,
                      "pending": 0,
                      "processing": 0,
                      "complete": 0,
                      "status": "pending",
                      "message": "Not started",
                      "post": {
                        "req": false,
                        "has": false,
                        "measure": null,
                        "score": null,
                        "result": false,
                        "message": null
                      },
                      "pre": {
                        "req": false,
                        "has": false,
                        "measure": null,
                        "result": false,
                        "message": null
                      },
                      "retest": {
                        "req": false,
                        "has": false,
                        "measure": null,
                        "result": false,
                        "message": null
                      },
                      "option": {
                        "cert_area": null,
                        "exam_round": null
                      },
                      "percent": 0
                    }
                  },
                  options: {}
                })
              });

              if (enrollResponse.status === 200) {
                const finalRes = await enrollResponse.json();
                await fetch("https://gateway.cloudrestfulapi.com/api/course/" + this.dataItem + "/enroll", {
                  method: 'POST',
                  headers: {'Content-Type': 'application/json','client-token-key':this.configs.key},
                  body: JSON.stringify({
                    action: "add",
                    element: finalRes._id,
                    type: "string",
                  })
                });
              }
            }
          }
          this.isModalOpen = false;
          await this.getData();
          await this.getCourse();
          this.fetchData();
        } catch (error) {
          console.error("Error processing CSV:", error);
        }
      },
      togglePanel() {
        this.open = !this.open;
      },
      closePanel() {
        this.open = false;
      },
      leadingZero(number) {
        return number < 10 ? '0' + number : number.toString();
      },
      getCertAreaValue(certAreaId) {
        const area = this.cert_area.find(item => item.id === certAreaId);
        return area ? area.value : '';
      },
      getCertAgeValue(certAgeId) {
        const age = this.cert_age.find(item => item.id === certAgeId);
        return age ? age.value : '';
      },
      async fetchData() {
          try {
            const response = await fetch('https://vue-project.sgp1.digitaloceanspaces.com/Demo3/convertcsv_3155.json');
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            const jsonData = await response.json();
            this.scb = jsonData;
          } catch (error) {
            console.error('Error fetching data:', error.message);
          }
      },
      searchData(matching,id) {
        const value1 = matching;
        const result = this.searchSCBData(value1);
        
        if(result)
        {
          this.updateOrderStatus(id);
        }
        debug.log("Result:", result);
      },
      searchSCBData(value1) {
        const foundValue1 = this.scb.some((data) => data.id1 === value1);
        return foundValue1;
      },
      // Main function to export data to CSV
      async exportToCSV() {
        this.isExporting = true;
        this.allData = [];
        let page = 1;
        let hasMoreData = true;
        let processedItems = 0;

        // Load data in chunks
        while (hasMoreData) {
          const chunkData = await this.getDataChunk(page, this.chunkSize);
          processedItems += chunkData.length;
          this.progressMessage = `Processing ${processedItems} / ${this.totalItems} items`;

          if (chunkData.length === 0) {
            hasMoreData = false;
          } else {
            this.allData = this.allData.concat(chunkData);
            page++;
          }
        }

        this.isExporting = false;
        this.extractedData = this.extractData(this.allData); // Extract relevant data for preview
        this.showPreviewModal = true; // Show modal for data preview
      },

      // Method to fetch a specific chunk of data
      async getDataChunk(page, limit) {
        // Temporarily override currentPage and limitItem for pagination in chunks
        // Fetch the chunk of data using getData
        await this.getData(page, limit, 'silence');
        // Restore original values after fetching
        const chunkData = [...this.listItems_chunk]; // Copy listItems for this chunk
        return chunkData;
      },

      // Download CSV file with extracted data
      downloadCSV(data) {
        const extractedData = this.extractData(data); // Extract necessary fields
        const csvContent = this.convertToCSV(extractedData); // Convert to CSV
        
        // Format the filename
        const courseName = this.courseData.name || 'course';
        const date = new Date();
        const formattedDate = `${date.getFullYear()}${(date.getMonth() + 1).toString().padStart(2, '0')}${date.getDate().toString().padStart(2, '0')}_${date.getHours().toString().padStart(2, '0')}${date.getMinutes().toString().padStart(2, '0')}`;
        const filename = `${courseName}_‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£_${formattedDate}.csv`;

        const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", filename);
        link.style.visibility = "hidden";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      },

      // Function to extract required data with Thai headers
      extractData(data) {
        return data.map(entry => ({
          ‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á: entry.user?.firstname ?? '',                             // userFirstname
          ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•: entry.user?.lastname ?? '',                              // userLastname
          ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô: entry.user?.citizen ?? '',                       // userCitizen
          ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£: entry.user?.phone ?? '',                                // userPhone
          ‡∏≠‡∏µ‡πÄ‡∏°‡∏•: entry.user?.email ?? '',                                   // userEmail
          ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£: entry.enroll?.course?.name ?? '',                   // courseName
          ‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: entry.enroll?.analytics?.total ?? 0,                   // enrollTotal
          ‡∏£‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: entry.enroll?.analytics?.pending ?? 0,               // enrollPending
          ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: entry.enroll?.analytics?.processing ?? 0,        // enrollProcessing
          ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß: entry.enroll?.analytics?.complete ?? 0,             // enrollComplete
          ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏≠‡∏ö‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: entry.enroll?.analytics?.post?.score ?? 0,     // enrollPostScore
          ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô: entry.enroll?.createdAt ?? '',                        // enrollCreatedAt
          ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: entry.enroll?.updatedAt ?? '',                       // enrollUpdatedAt
        }));
      },

      // Convert extracted data to CSV format
      convertToCSV(data) {
        if (!data || !data.length) return '';

        const header = Object.keys(data[0]).join(","); // Extract headers from keys
        const rows = data.map(row =>
          Object.values(row)
            .map(value => {
              // Escape values with commas, quotes, or newlines by wrapping them in quotes
              if (typeof value === 'string' && /[",\n]/.test(value)) {
                value = `"${value.replace(/"/g, '""')}"`; // Escape double quotes by doubling them
              }
              return value;
            })
            .join(",")
        );

        return [header, ...rows].join("\n");
      },

        formatDeliveryAddress(addressObj) {
          const addressLabels = {
            "mailinG_NO": "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà",
            "mailinG_MOO": "‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà",
            "mailinG_ROAD_TH": "‡∏ñ‡∏ô‡∏ô",
            "mailinG_SOI_TH": "‡∏ã‡∏≠‡∏¢",
            "mailinG_BUILDING_TH": "‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£/‡∏ï‡∏∂‡∏Å",
            "mailinG_SUB_DISTRICT_TH": "‡∏ï‡∏≥‡∏ö‡∏•/‡πÅ‡∏Ç‡∏ß‡∏á",
            "mailinG_DISTRICT_TH": "‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡πÄ‡∏Ç‡∏ï",
          };
          return this.getAddressString(addressObj, addressLabels);
        },
        formatInvoiceAddress(addressObj) {
          debug.log(addressObj);
          const addressLabels = {
            "officE_NO": "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà",
            "officE_MOO": "‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà",
            "officE_ROAD_TH": "‡∏ñ‡∏ô‡∏ô",
            "officE_SOI_TH": "‡∏ã‡∏≠‡∏¢",
            "officE_BUILDING_TH": "‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£/‡∏ï‡∏∂‡∏Å",
            "officE_SUB_DISTRICT_TH": "‡∏ï‡∏≥‡∏ö‡∏•/‡πÅ‡∏Ç‡∏ß‡∏á",
            "officE_DISTRICT_TH": "‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡πÄ‡∏Ç‡∏ï",
          };
          return this.getAddressString(addressObj, addressLabels);
        },
        formatTaxAddress(addressObj) {
          const addressLabels = {
            "taX_NO": "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà",
            "taX_MOO": "‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà",
            "taX_ROAD_TH": "‡∏ñ‡∏ô‡∏ô",
            "taX_SOI_TH": "‡∏ã‡∏≠‡∏¢",
            "taX_BUILDING_TH": "‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£/‡∏ï‡∏∂‡∏Å",
            "taX_SUB_DISTRICT_TH": "‡∏ï‡∏≥‡∏ö‡∏•/‡πÅ‡∏Ç‡∏ß‡∏á",
            "taX_DISTRICT_TH": "‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡πÄ‡∏Ç‡∏ï",
          };
          return this.getAddressString(addressObj, addressLabels);
        },
        // Common function to format address from object
        getAddressString(addressObj, addressLabels) {
          const addressParts = [];
          Object.keys(addressLabels).forEach((key) => {
            if (addressObj && key in addressObj && addressObj[key]) {
              if (typeof addressObj[key] === "object") {
                const subAddress = Object.values(addressObj[key]).join(" ");
                if (subAddress.trim().length > 0) {
                  addressParts.push(`${addressLabels[key]} ${subAddress}`);
                }
              } else {
                addressParts.push(`${addressLabels[key]} ${addressObj[key]}`);
              }
            }
          });

          const formattedAddress = addressParts.join(" ");
          return formattedAddress.length > 0 ? formattedAddress : "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà";
        },
        formatThaidate(date) {
          return convertUtils.toThaiDatetime(date,"short");
        },
        handleLimitChange() {
          const session = storageManager.get('session');
          session.limitItem = this.limitItem;
          storageManager.set('session', session);
          this.currentPage = 1; // Reset current page to 1
          session.currentPage = this.currentPage;
          storageManager.set('session', session);
          const updatedUrlParams = new URLSearchParams(window.location.search);
          updatedUrlParams.set('page', session.currentPage);
          const updatedUrl = `${window.location.pathname}?${updatedUrlParams.toString()}`;
          window.history.replaceState({}, '', updatedUrl);
          debug.log("getdata","handleLimitChange");
          this.getData();
          
          // üöÄ PROGRESSIVE/LAZY LOADING - Reset after limit change
          this.resetProgressToast();
          this.$nextTick(() => {
            this.resetDisplayCount();
          });
        },
        handlePageChanged(page) {
          if (page !== this.currentPage) {
              window.scrollTo(0, 0);
              this.currentPage = page;
              const session = storageManager.get('session');
              session.currentPage = this.currentPage;
              storageManager.set('session', session);
              debug.log("getdata","handlePageChanged");
              this.getData();
              
              // üöÄ PROGRESSIVE/LAZY LOADING - Reset after page change
              this.resetProgressToast();
              this.$nextTick(() => {
                this.resetDisplayCount();
              });
          }
        },
        clearSearchQuery() {
            this.searchQuery = '';
            const session = storageManager.get('session');
            session.searchQuery = '';
            storageManager.set('session', session);
            debug.log("getdata","clearSearchQuery");
            this.getData();
        },
        async callAPI(token) {
            try {
            const url = `https://faas-sgp1-18bc02ac.doserverless.co/api/v1/web/fn-3bf765c8-bb4f-4bac-ba41-9698000f7334/default/getstudentdata?id=${token}`;
            const response = await fetch(url);
            const data = await response.json();
            debug.log(data);
            } catch (error) {
            debug.log(error);
            }
        },
        async getCourse() {
        try {
            const resAPI = await fetch(`https://gateway.cloudrestfulapi.com/api/course/${this.dataItem}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json','client-token-key':this.configs.key,
            },
            });

            const restReturn = await resAPI.json();
            if(resAPI.status === 200)
            {
                //this.courseData = restReturn;
                debug.log(restReturn);
            }
            
        } catch (error) {
            console.error(error);
        }
      },
      async executeCustomQueries(ref, id) {
        const mainQuery = 
        `
          SELECT *
          FROM transaction
          WHERE transaction.transaction_token = '${ref}'
        `;
        const countQuery = ``; // Add your count query here
        const requestBody = {
          query: {
            mainQuery: mainQuery,
            countQuery: countQuery,
          },
        };
        try {
          const response = await fetch('https://multisource-api-edsdv.ondigitalocean.app/api/GOLqSG7QyA10uoasyN9x/query', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json','client-token-key':this.configs.key
            },
            body: JSON.stringify(requestBody),
          });
          const responseData = await response.json();
          let transaction = responseData.data[0];
          debug.log("responseData",responseData.data[0]);
          await this.updateOrder(id, transaction.get_bill, transaction.receipt_type);
        } catch (error) {
          console.error(error);
        }
      },
      async executemarketplaceQueries(ref, id) {
        const mainQuery = 
        `
          SELECT *
          FROM marketplace
          WHERE marketplace.order_ref_no = '${ref}'
        `;
        const countQuery  = ``; // Add your count query here
        const requestBody = {
          query: {
            mainQuery: mainQuery,
            countQuery: countQuery,
          },
        };

        try {
          const response = await fetch('https://multisource-api-edsdv.ondigitalocean.app/api/04ZQdW5sGA9C9eXXXk6x/query', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json','client-token-key':this.configs.key
            },
            body: JSON.stringify(requestBody),
          });
          const responseData = await response.json();
          let transaction = responseData.data[0];
          debug.log("responseData",responseData.data[0]);

          const addressData = {
            delivery: {
              province: transaction.order_delivery_province,
            },
            invoice: {
              province: transaction.order_invoice_province,
            },
            tax: {
              province: transaction.order_tax_province,
            },
          };
          await this.updateProvince(id, addressData);
        } catch (error) {
          console.error(error);
        }
      },
      async executemarketplaceQueriesPersonal(ref, id) {
        const mainQuery = 
        `
          SELECT *
          FROM marketplace
          WHERE marketplace.order_ref_no = '${ref}'
        `;
        const countQuery  = ``; // Add your count query here
        const requestBody = {
          query: {
            mainQuery: mainQuery,
            countQuery: countQuery,
          },
        };

        try {
          const response = await fetch('https://multisource-api-edsdv.ondigitalocean.app/api/04ZQdW5sGA9C9eXXXk6x/query', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json','client-token-key':this.configs.key
            },
            body: JSON.stringify(requestBody),
          });
          const responseData = await response.json();
          let transaction = responseData.data[0];
          debug.log("responseData",responseData.data[0]);

          const addressData = {
            delivery: {
              province: transaction.order_delivery_province,
            },
            invoice: {
              province: transaction.order_invoice_province,
            },
            tax: {
              province: transaction.order_invoice_province,
              zipcode: transaction.order_invoice_zipcode,
            },
          };
          await this.updateProvince(id, addressData);
        } catch (error) {
          console.error(error);
        }
      },
      isImageValid(url) {
        const image = new Image();
        image.src = url;
        return image.complete && image.naturalWidth !== 0;
      },
      modifyURL(url) {
        if (url.includes('https://doa-academy.sgp1.digitaloceanspaces.com/https://doa-academy.sgp1.digitaloceanspaces.com/https://doa-academy.sgp1.digitaloceanspaces.com/Upload/')) {
          return url.replace('https://doa-academy.sgp1.digitaloceanspaces.com/https://doa-academy.sgp1.digitaloceanspaces.com/https://doa-academy.sgp1.digitaloceanspaces.com/Upload/', 'https://doa-academy.sgp1.digitaloceanspaces.com/Upload/');
        } else if (url.includes('https://doa-academy.sgp1.digitaloceanspaces.com/https://doa-academy.sgp1.digitaloceanspaces.com/1639435666414290693/')) {
          return url.replace('https://doa-academy.sgp1.digitaloceanspaces.com/https://doa-academy.sgp1.digitaloceanspaces.com/1639435666414290693/', 'https://content.fti.academy/doa-academy/1639435666414290693/');
        } else if (url.includes('1639435666414290693/') && url.includes('https://doa-academy.sgp1.digitaloceanspaces.com')) {
          return url.replace('https://doa-academy.sgp1.digitaloceanspaces.com', 'https://content.fti.academy/doa-academy');
        } else if (url.includes('1639435666414290693/') && !url.includes('https://doa-academy.sgp1.digitaloceanspaces.com')) {
          return `https://content.fti.academy/doa-academy/${url}`;
        } else {
          url = `https://doa-academy.sgp1.digitaloceanspaces.com/${url}`;
        }
        return url;
      },
      async executUserQueries(token,id) {
        const mainQuery = 
        `
        SELECT  student_idcard AS Card,student_avatar AS Profile
        FROM    student
        WHERE   student_id = '${token}'
        `;
        const countQuery  = ``; // Add your count query here
        const requestBody = {
          query: {
            mainQuery: mainQuery,
            countQuery: countQuery,
          },
        };

        try {
          const response = await fetch('https://multisource-api-edsdv.ondigitalocean.app/api/04ZQdW5sGA9C9eXXXk6x/query', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json','client-token-key':this.configs.key
            },
            body: JSON.stringify(requestBody),
          });
          const responseData = await response.json();
          //let transaction = responseData.data[0];
          debug.log("responseData",responseData.data[0]);
          let avatar  = this.modifyURL(responseData.data[0].Profile)
          let card    = this.modifyURL(responseData.data[0].Card)

          await this.updateProfile(id, card, avatar);

          debug.log("id",id);
        } catch (error) {
          console.error(error);
        }
      },
      async createUserCourse(token,id,ref) {
        const formData = {
        student: token,
        lesson: id
      };

      try {
        const response = await fetch("https://api.fti.academy/api/firebase/setup", {
          method: "POST",
          headers: {
            "API-KEY": "5CB584F5ECFD7",
            "SECRET-KEY": "6A5891C7352197F8A5CE8A9B67EF3",
            "Content-Type": "application/json"
          },
          body: JSON.stringify(formData)
        });

        await response.json();
        await this.confirmTransaction(ref);
        // Handle the result as needed
        this.status = true; // Assuming you need to set some status variable
      } catch (error) {
        // Handle errors here
        console.error("Error creating user course:", error);
      }
      },
      async confirmTransaction(transactionRefNo) {
        const url = `https://api.fti.academy/api/connection/confirm/${transactionRefNo}`;
        const headers = {
          "API-KEY": "5CB584F5ECFD7",
          "SECRET-KEY": "6A5891C7352197F8A5CE8A9B67EF3",
          "Content-Type": "application/json"
        };

        try {
          const response = await fetch(url, {
            method: "GET",
            headers: headers
          });

          await response.json();
          // Handle the output as needed
        } catch (error) {
          // Handle errors here
          console.error("Error confirming transaction:", error);
        }
      },
      async updateOrderStatus(id) {
        try {
          const resAPI = await fetch("https://gateway.cloudrestfulapi.com/api/order/" + id, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json','client-token-key':this.configs.key},
            body: JSON.stringify({
              data: {
                status: '‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß',
              },
              options: {}
            })
          });
          const finalRes   = await resAPI.json();
          debug.log(finalRes);

          if (resAPI.status===200) {
            debug.log("order : " + id + " Update Success!!");
          }

        } catch (error) {
          debug.log(error)
        }
      },
      async updateOrder(id, bill, receipt) {
        try {
          const resAPI = await fetch("https://gateway.cloudrestfulapi.com/api/order/" + id, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json','client-token-key':this.configs.key},
            body: JSON.stringify({
              data: {
                bill: bill,
                receipt: receipt,
              },
              options: {}
            })
          });
          const finalRes   = await resAPI.json();
          debug.log(finalRes);

          if (resAPI.status===200) {
            debug.log("order : " + id + " Update Success!!");
          }

        } catch (error) {
          debug.log(error)
        }
      },
      async updateProfile(id, card, avatar) {
        try {
          const resAPI = await fetch("https://gateway.cloudrestfulapi.com/api/user/" + id, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json','client-token-key':this.configs.key},
            body: JSON.stringify({
              data: {
                card_img: card,
                avatar_img: avatar,
              },
              options: {}
            })
          });
          await resAPI.json();
          //debug.log(finalRes);

          if (resAPI.status===200) {
            debug.log("user : " + id + " Update Success!!");
          }

        } catch (error) {
          debug.log(error)
        }
      },
      async updateOrderEnroll(id, enroll) {
        try {
          const resAPI = await fetch("https://gateway.cloudrestfulapi.com/api/order/" + id, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json','client-token-key':this.configs.key},
            body: JSON.stringify({
              data: {
                enrollID: enroll,
              },
              options: {}
            })
          });
          await resAPI.json();
          //debug.log(finalRes);

          if (resAPI.status===200) {
            debug.log("order : " + id + " Update Success!!");
          }

        } catch (error) {
          debug.log(error)
        }
      },
      async updateProvince(id, addressData) {
        try {
          const addressTypes = ["delivery", "invoice", "tax"]; // Specify the address types to update
          for (const addressType of addressTypes) {
            const addressObj = addressData[addressType];
            const province = addressObj.province;
            const zipcode = addressObj.zipcode;

            if (province !== undefined && province !== null && province !== '') {
              const resAPI = await fetch(`https://gateway.cloudrestfulapi.com/api/order/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json','client-token-key':this.configs.key },
                body: JSON.stringify({
                  data: {
                    [`address.${addressType}.province`]: province,
                    [`address.${addressType}.zipcode`]: zipcode,
                  },
                  options: {}
                })
              });

              const finalRes = await resAPI.json();
              debug.log(finalRes);

              if (resAPI.status === 200) {
                debug.log(`Province (${addressType}) for order ${id} updated successfully!!`);
              }
            }
          }
        } catch (error) {
          debug.log(error);
        }
      },
      async resetScore(exam, user, enroll) {
        try {
          const response = await this.$Request.POST('score/query', {
            method: 'find',
            hidden: ['userID'],
            args: [
              {
                $and: [
                  { userID: user, examID: exam }
                ]
              }
            ]
          }, this.configs.key);

          const { data, status } = response;

          if (status === 200 && data.length > 0) {
            dialog.confirm({
                title: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö?',
                message: '‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏≠‡∏ö‡∏£‡∏° !',
                confirm: async () => {
                try {
                  const deleteResponse = await this.$Request.DELETE(`score/${data[0]._id}`, null, this.configs.key);
                  const { data: deleteData } = deleteResponse;
            
                  if (deleteData) {
                    debug.log(deleteData);

                    const requestBody = {
                      data: {
                        verified: {
                          pre: {}
                        }
                      }
                    };
                    const { status } = await this.$Request.PUT(`enroll/${enroll}`, requestBody, this.configs.key);
                    debug.log(status);

                    await this.getData();
                  }
                } catch (error) {
                  debug.log(error)
                }
                },
                cancel: () => {}
            });
          } else {
            dialog.prompt({
              title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
              message: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÑ‡∏î‡πâ !',
              confirm: async () => {},
              cancel: () => {}
            });
          }
        } catch (error) {
          console.error("Error confirming transaction:", error);
        }
      },
      async bypassVerified(enroll,type,verified) {
        try {
          const currentDate = new Date();
          console.log("verified",verified);
          const formattedDateTime = currentDate.toISOString(); // Convert date to ISO string format
          dialog.confirm({
              title: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ Bypass ‡∏£‡∏∞‡∏ö‡∏ö Verified?',
              message: '‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏≠‡∏ö‡∏£‡∏°‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á Verified !',
              confirm: async () => {
              try {
                  // Ensure the verified object has the existing values or defaults
                  const updatedVerified = {
                    ...verified,
                    [type]: { status: true, url: `bypass-${formattedDateTime}` }
                  };

                  const requestBody = {
                    data: {
                      verified: updatedVerified
                    }
                  };
                  const { status } = await this.$Request.PUT(`enroll/${enroll}`, requestBody, this.configs.key);
                  debug.log(status);

                  await this.getData();
              } catch (error) {
                debug.log(error)
              }
              },
              cancel: () => {}
          });
        } catch (error) {
          console.error("Error confirming transaction:", error);
        }
      },
      async getData(currentPage = this.currentPage, limitItem = this.limitItem, mode='normal') {
        try {
            if (this.login) {

              if (mode==='normal') {
                this.loading      = true;
                this.activeBlock  = true;
                this.listItems    = [];
              }
              
              

              // let ref2Values = [
              //   "1100501277525","1100800965521","1101401050074","1101401693099","1101700184901","1102001579125","1110100140189","1119900750788","1160100354359","1199600153890","1209700340879","1220400167936","1229900503747","1239900263606","1249900297314","1301800082342","1309901247701","1310600189525","1340700282055","1349700102802","1369900308544","1370300003647","1400600141599","1401600022604","1409900907161","1410600007736","1410600027524","1419900310165","1419900421242","1430200241368","1450600128860","1459900520305","1460800064181","1500300104018","1509900249490","1509900361788","1509900693063","1509900904188","1510101435847","1550400057275","1570700098431","1571100118466","1600800176530","1601100230133","1601200005034","1609700118871","1610100089103","1659900509661","1669900005778","1669900108356","1671100047495","1679900284669","1739900269715","1800400085446","1800600154034","1819900200625","1840100514341","1849800069446","1849901334544","1860500037915","1860700092081","1900500003114","2550500015025","2600900021340","2920100006882","3100202046111","3100800015367","3101203307806","3101800181896","3120500112821","3160300893390","3160600390539","3170200320407","3170200336430","3180600402383","3209900420716","3240100614453","3240300490286","3250500443958","3250500478985","3250700038810","3251000408062","3251000457284","3301700016590","3301700040903","3309800091582","3309900775157","3310400631522","3310600738291","3319900186810","3321000165851","3330100443747","3330600385321","3330900402654","3340101106426","3340400658439","3340700948688","3341000126660","3341100903587","3341500056881","3341500421628","3341900013683","3350100307286","3350600184601","3360600441654","3360700065689","3401001035070","3408500465992","3409800003232","3410101219157","3411700007433","3411700210522","3411800176202","3440100863851","3440600171923","3440600385061","3470101563419","3480500695939","3500200728521","3500300260555","3500400210177","3500700471341","3500900435836","3500900435852","3500900507365","3502000016804","3510500099944","3520600061817","3520900022809","3530600026213","3530700112294","3540200130773","3560200305883","3570400730936","3570501009949","3570501133828","3570700921494","3571000121925","3580300077017","3600040018047","3600300254805","3600300273923","3601200116932","3630600284629","3640100589048","3640200235607","3640200257942","3640408323388","3640600424226","3640700257968","3650101172515","3650700155961","3650800497642","3650801072327","3700200030297","3710100763705","3720100865770","3720200729312","3720300107020","3720300206915","3720600153566","3720800038221","3720900098773","3730500660938","3760500937654","3770060324727","3770700140229","3800100878714","3800101236422","3800400747763","3800801059442","3801100402982","3801200642853","3810400424051","3840300138030","3841200304532","3841400009381","3860200070921","3860300057404","3869800050547","3900700728879","3920200409057","5321200022139","5340590018823","5421000001706","5540700007420","8570784011479","8570784029726","8576573000014"
              // ];

              let andConditions = [{
                courseID: this.dataItem,
                //bill: "offline",
                //ref2: { $in: ref2Values }
              }];

              if (this.statusFilter !== 'all') {
                andConditions.push({
                  status: this.statusFilter,
                });
              }

              // üöÄ OPTIMIZED PIPELINE - ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏•‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥
              const pipeline = [
                // Step 1: Match ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (Early filtering)
                {
                    $match: {
                        $and: andConditions,
                    },
                },
                
                // Step 2: Convert string IDs to ObjectId
                {
                    $set: {
                        userID: {
                          $convert: {
                            input: "$userID",
                            to: "objectId",
                            onError: null,
                            onNull: null,
                          },
                        },
                        courseID: {
                          $convert: {
                            input: "$courseID",
                            to: "objectId",
                            onError: null,
                            onNull: null,
                          },
                        },
                    },
                },

                // Step 3: Search filtering (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) - ‡∏ó‡∏≥‡∏Å‡πà‡∏≠‡∏ô lookup ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                ...(this.searchQuery
                  ? [
                      {
                        $lookup: {
                          from: "user",
                          localField: "userID",
                          foreignField: "_id",
                          pipeline: [
                            {
                              $match: {
                                $or: [
                                  { "name": { $regex: `.*${this.searchQuery}.*`, $options: "i" } },
                                  { "citizen": { $regex: `.*${this.searchQuery}.*`, $options: "i" } },
                                  { "email": { $regex: `.*${this.searchQuery}.*`, $options: "i" } },
                                  { "firstname": { $regex: `.*${this.searchQuery}.*`, $options: "i" } },
                                  { "lastname": { $regex: `.*${this.searchQuery}.*`, $options: "i" } },
                                  { "old_id": { $regex: `.*${this.searchQuery}.*`, $options: "i" } },
                                  { "phone": { $regex: `.*${this.searchQuery}.*`, $options: "i" } },
                                  { "token": { $regex: `.*${this.searchQuery}.*`, $options: "i" } },
                                ],
                              },
                            },
                            {
                              $project: {
                                _id: 1,
                                firstname: 1,
                                lastname: 1,
                                citizen: 1,
                                phone: 1,
                                email: 1,
                                token: 1,
                                old_id: 1,
                                createdAt: 1,
                                card_img: 1,
                                avatar_img: 1,
                                enroll: 1
                              }
                            }
                          ],
                          as: "user",
                        },
                      },
                      {
                        $match: {
                          "user": { $ne: [] }
                        }
                      },
                      {
                        $unwind: "$user",
                      },
                    ]
                  : [
                      // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ search ‡∏Å‡πá lookup user ‡πÅ‡∏ö‡∏ö‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ ‡πÅ‡∏ï‡πà project ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
                      {
                        $lookup: {
                          from: "user",
                          localField: "userID",
                          foreignField: "_id",
                          pipeline: [
                            {
                              $project: {
                                _id: 1,
                                firstname: 1,
                                lastname: 1,
                                citizen: 1,
                                phone: 1,
                                email: 1,
                                token: 1,
                                old_id: 1,
                                createdAt: 1,
                                card_img: 1,
                                avatar_img: 1,
                                enroll: 1
                              }
                            }
                          ],
                          as: "user",
                        },
                      },
                      {
                        $unwind: "$user",
                      },
                    ]),

                // Step 4: Lookup course data (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)
                {
                    $lookup: {
                        from: "course",
                        localField: "courseID",
                        foreignField: "_id",
                        pipeline: [
                          {
                            $project: {
                              _id: 1,
                              master: 1,
                              name: 1,
                              lesson_old_id: 1
                            }
                          }
                        ],
                        as: "course",
                    },
                },
                {
                    $unwind: "$course",
                },
                
                // Step 5: Lookup exam data ‡πÅ‡∏ö‡∏ö efficient (‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô facet)
                {
                  $lookup: {
                    from: "exam",
                    let: { masterID: "$course.master" },
                    pipeline: [
                      {
                        $match: {
                          $expr: {
                            $eq: ["$courseId", "$$masterID"]
                          }
                        }
                      },
                      {
                        $project: {
                          _id: 1,
                          courseId: 1,
                          type: 1,
                          name: 1
                        }
                      },
                      {
                        $facet: {
                          pre: [
                            { $match: { type: "pre" } },
                            { $limit: 1 }
                          ],
                          post: [
                            { $match: { type: "post" } },
                            { $limit: 1 }
                          ]
                        }
                      }
                    ],
                    as: "exams"
                  }
                },
                {
                  $set: {
                    examPre: { $arrayElemAt: ["$exams.pre", 0] },
                    examPost: { $arrayElemAt: ["$exams.post", 0] }
                  }
                },
                {
                  $unset: "exams"
                },

                // Step 6: Sort ‡πÅ‡∏•‡∏∞ Facet ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö pagination
                {
                    $sort: { createdAt: -1 }
                },
                {
                    $facet: {
                        paginatedData: [
                            { $skip: (currentPage - 1) * limitItem },
                            { $limit: limitItem },
                            {
                                $project: {
                                    enroll: {
                                      _id: "$$ROOT._id",
                                      userID: "$$ROOT.userID",
                                      courseID: "$$ROOT.courseID",
                                      analytics: "$$ROOT.analytics",
                                      verified: "$$ROOT.verified",
                                      capture: "$$ROOT.capture",
                                      certification: "$$ROOT.certification",
                                      status: "$$ROOT.status",
                                      createdAt: "$$ROOT.createdAt",
                                      updatedAt: "$$ROOT.updatedAt",
                                      examPre: "$$ROOT.examPre",
                                      examPost: "$$ROOT.examPost"
                                    },
                                    user: "$user",
                                },
                            },
                        ],
                        totalCount: [
                            { $count: "count" },
                        ],
                    },
                },
            ];

              const requestOptions = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json','client-token-key':this.configs.key },
                body: JSON.stringify({
                  pipeline: pipeline,
                }),
              };

              const resAPI      = await fetch('https://gateway.cloudrestfulapi.com/api/enroll/aggregate', requestOptions);
              const RestReturn  = await resAPI.json();

              if (RestReturn) {
                const paginatedData = RestReturn[0].paginatedData;
                const totalCount = RestReturn[0].totalCount[0].count;

                const formattedData = {
                  data: paginatedData.map(item => {
                    return {
                      user: item.user,
                      enroll: item.enroll,
                    };
                  }),
                  total: totalCount,
                  paging: {
                    page: this.currentPage,
                    limit: this.limitItem,
                    totalPages: Math.ceil(totalCount / this.limitItem)
                  }
                };

                //this.updateBadge(totalCount)
                if (mode==='normal') {
                  this.loading      = false;
                  this.activeBlock  = false;
                  this.listItems    = formattedData.data;
                } else {
                  this.listItems_chunk    = formattedData.data;
                  this.totalItems   = formattedData.total;
                }
                this.totalItems   = formattedData.total;
                this.totalPages   = formattedData.paging.totalPages;
                this.updateBadge(totalCount);
                
                // üöÄ PROGRESSIVE/LAZY LOADING - Reset toast after data loading
                if (mode === 'normal') {
                  this.resetProgressToast();
                }
              }
            }
        } catch (error) {
            debug.log(error);
        }
      },
      async getEnrollData(course, user, old_id, order_id) {
        try {
          if (this.login) {

            let andConditions = [
              {
                courseID: course,
                userID: user,
              },
            ];

            const pipeline = [
              {
                $match: {
                  $and: andConditions,
                },
              },
              {
                $facet: {
                  paginatedData: [
                    { $skip: (1 - 1) * 1 },
                    { $limit: 1 },
                    {
                      $project: {
                        enroll: "$$ROOT",
                      },
                    },
                  ],
                  totalCount: [
                    { $count: "count" },
                  ],
                },
              },
            ];

            const requestOptions = {
              method: 'POST',
              headers: { 'Content-Type': 'application/json','client-token-key':this.configs.key },
              body: JSON.stringify({
                pipeline: pipeline,
              }),
            };

            const resAPI = await fetch('https://gateway.cloudrestfulapi.com/api/enroll/aggregate', requestOptions);
            const restReturn = await resAPI.json();

            if (restReturn) {
              const paginatedData = restReturn[0].paginatedData;
              const totalCount = restReturn[0].totalCount[0].count;

              const formattedData = {
                data: paginatedData.map(item => {
                  return {
                    enroll: item.enroll,
                  };
                }),
                total: totalCount,
                paging: {
                  page: this.currentPage,
                  limit: this.limitItem,
                  totalPages: Math.ceil(totalCount / this.limitItem)
                }
              };
              debug.log("Enroll Local Data",formattedData.data[0].enroll._id);
              await this.getEnrollRemote(old_id,formattedData.data[0].enroll._id,order_id);
            }
          }
        } catch (error) {
          debug.log(error);
        } finally {
          this.loading = false;
          this.activeBlock = false;
        }
      },
      async getEnrollRemote(student,enroll_id,order_id) {
        const mainQuery = `
        SELECT
        MAX(CASE WHEN data_type = 'cert_area' THEN data_value END) AS cert_area,
        MAX(CASE WHEN data_type = 'cert_age' THEN data_value END) AS cert_age,
        MAX(CASE WHEN data_type = 'exam_round' THEN data_value END) AS exam_round,
        MAX(CASE WHEN data_type = 'get_receipt' THEN data_value END) AS get_receipt,

        MAX(CASE WHEN data_type = 'progress' THEN data_value END) AS progress,
        MAX(CASE WHEN data_type = 'pretest' THEN data_value END) AS pretest,
        MAX(CASE WHEN data_type = 'posttest' THEN data_value END) AS posttest,
        MAX(CASE WHEN data_type = 'retest' THEN data_value END) AS retest
        FROM student_adddition_data
        WHERE data_target = '${this.courseData.lesson_old_id}' AND student_id = '${student}'
        AND data_type IN ('cert_area','cert_age','exam_round','get_receipt','progress', 'pretest', 'posttest', 'retest');
        `;
        const countQuery = ``;
        const requestBody = {
          query: {
            mainQuery: mainQuery,
            countQuery: countQuery,
          },
        };

        try {
          const response = await fetch('https://multisource-api-edsdv.ondigitalocean.app/api/04ZQdW5sGA9C9eXXXk6x/query', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json','client-token-key':this.configs.key
            },
            body: JSON.stringify(requestBody),
          });
          const responseData = await response.json();
          debug.log("Enroll Remote Data",responseData.data[0]);

          const remoteEnrollData = responseData.data[0];

          let progress = parseInt(remoteEnrollData.progress)
          let processing = 0
          let pending = 0
          let complete = 0
          let status =''
          let message =''

          let measure = 33

          if (progress < 13) {
            pending = 13 - progress;
            processing = progress;
            complete = progress;
            status = 'processing';
            message = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô';
          } else if (progress === 0 || progress === null || progress === undefined) {
            pending = 13;
            processing = 0;
            complete = 0;
            status = 'pending';
            message = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô';
          } else if (progress === 13) {
            processing = 0;
            complete = 13;
            pending = 0;
            status = 'complete';
            message = '‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß';
          }

          const newData = {
            "analytics": {
              "total": 13,
              "pending": pending,
              "processing": processing,
              "complete": complete,
              "status": status,
              "message": message,
              "post": {
                "req": true,
                "has": true,
                "measure": measure,
                "score": remoteEnrollData.posttest,
                "result": remoteEnrollData.posttest >= measure,
                "message": remoteEnrollData.posttest === null || remoteEnrollData.posttest === undefined ? '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡∏≠‡∏ö‡∏ß‡∏±‡∏î‡∏ú‡∏•' : (remoteEnrollData.posttest >= measure ? '‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á' : '‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á')
              },
              "pre": {
                "req": true,
                "has": true,
                "measure": measure,
                "score": remoteEnrollData.pretest,
                "result": remoteEnrollData.pretest >= measure,
                "message": remoteEnrollData.pretest === null || remoteEnrollData.pretest === undefined ? '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô' : (remoteEnrollData.pretest >= measure ? '‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ú‡πà‡∏≤‡∏ô' : '‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô')
              },
              "retest": {
                "req": true,
                "has": true,
                "measure": measure,
                "result": remoteEnrollData.retest >= measure,
                "score": remoteEnrollData.retest,
                "message": remoteEnrollData.retest === null || remoteEnrollData.retest === undefined ? '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡∏≠‡∏ö‡∏ß‡∏±‡∏î‡∏ú‡∏•' : (remoteEnrollData.retest >= measure ? '‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á' : '‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á')
              },
              "option": {
                "cert_age": remoteEnrollData.cert_age,
                "cert_area": remoteEnrollData.cert_area,
                "exam_round": remoteEnrollData.exam_round,
                "get_receipt": remoteEnrollData.get_receipt,
              },
            },
            "certification": []
          };
          debug.log("updateEnroll",enroll_id,newData)
          await this.updateEnroll(enroll_id, newData);

          debug.log("updateOrderEnroll",order_id)
          await this.updateOrderEnroll(order_id, enroll_id);

        } catch (error) {
          console.error(error);
        }
      },
      async updateEnroll(id,newData) {
        try {
          const resAPI = await fetch("https://gateway.cloudrestfulapi.com/api/enroll/" + id, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json','client-token-key':this.configs.key},
            body: JSON.stringify({
              data: newData,
            }),
          });

          await resAPI.json();
          //debug.log(finalRes);

          if (resAPI.status === 200) {
            debug.log("Enroll " + id + " updated successfully!");
          }
        } catch (error) {
          debug.log(error);
        }
      },
      toggleStatus(status) {
        debug.log("Toggle Status", status);
        this.statusFilter = status;
        this.getData();
      },
      async renderStatus() {
        debug.log("renderStatus");
        for (const item of this.listItems) {
          debug.log(item.order.ref3);
          if (item.order.status === '‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠') {
            debug.log("searchData");
            await this.searchData(item.order.ref3, item.order._id);
          }
        }
      },
      async renderProvince() {
        debug.log("renderProvince");
        for (const item of this.listItems) {
          debug.log(item.order.ref_no);
          await this.executemarketplaceQueriesPersonal(item.order.ref_no, item.order._id);
        }
      },
      async renderProfile() {
        const totalItems = this.listItems.length;
        let counter = 0;
        /* Batch Process Param */
        this.isProcessing   = true;
        this.processName    = `Render Profile Image`;
        this.progressTotal  = totalItems
        this.startTime      = new Date().toISOString();
        this.endTime        = null;
        for (const item of this.listItems) {
          counter++;
          /* Batch Process Param */
          this.progressText     = `Processing : ${counter}/${totalItems}`;
          this.progressCurrent  =  counter
          await this.executUserQueries(item.user.old_id, item.user._id);
        }
        /* Batch Process Param */
        this.progressText = `All Process : Done`;
        this.endTime      = new Date().toISOString();
      },
      closeProgress() {
        this.isProcessing = false;
      },
      async makePosttest(single) {
        this.open = false;
        if(!single)
        {
          const totalItems  = this.listItems.length;
          let counter       = 0;
          /* Batch Process Param */
          this.isProcessing   = true;
          this.processName    = `Render Posttest`;
          this.progressTotal  = totalItems
          this.startTime      = new Date().toISOString();
          this.endTime        = null;
          
          for (const item of this.listItems) {
            counter++;
            /* Batch Process Param */
            this.progressText     = `Processing : ${counter}/${totalItems}`;
            this.progressCurrent  =  counter;

            debug.log("item",item);

          }
        } else {
          const totalItems    = 1;
          let counter         = 0;
          /* Batch Process Param */
          this.isProcessing   = true;
          this.processName    = `Render Single Posttest`;
          this.progressTotal  = totalItems
          this.startTime      = new Date().toISOString();
          this.endTime        = null;
          
          /* Batch Process Param */
          this.progressText     = `Processing : ${counter}/${totalItems}`;
          this.progressCurrent  =  0
          debug.log("single",single);
          const score = Math.floor(Math.random() * 4) + 33;
          await this.executeInsertQueries(single,score);
          await this.saveExamRecord(single,score);
          await this.renderEnroll(single);

          this.progressCurrent  =  1
        }
        
        /* Batch Process Param */
        this.progressText = `All Process : Done`;
        this.endTime      = new Date().toISOString();
        //this.isProcessing = false;
      },
      async executeInsertQueries(data,score) {
        const insertQuery = `
          INSERT INTO student_adddition_data (student_id, student_token, data_type, data_value, data_target, data_method, data_status)
          VALUES ('${data.user.old_id}', '${data.user.token}', 'posttest', '${score}', '224', 'edit', 'active')
        `;
        const countQuery = ``; // Add your count query here
        const requestBody = {
          query: {
            mainQuery: insertQuery,
            countQuery: countQuery,
          },
        };
        try {
          const response = await fetch('https://multisource-api-edsdv.ondigitalocean.app/api/04ZQdW5sGA9C9eXXXk6x/query', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json','client-token-key':this.configs.key
            },
            body: JSON.stringify(requestBody),
          });
          const responseData = await response.json();
          //let transaction = responseData.data[0];
          debug.log("responseData",responseData.data[0]);
          //await this.updateOrder(id, transaction.get_bill, transaction.receipt_type);
        } catch (error) {
          console.error(error);
        }
      },
      async saveExamRecord(dataProcess,score) {
        const data = {
          user: dataProcess.user.token,
          course: "224",
          score: "posttest",
          data: {
            result: score,
          },
        };

        try {
          const response = await fetch('https://asia-southeast1-academy-f0925.cloudfunctions.net/api/user/course/score', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
          });

          const result = await response.json();
          debug.log("API response:", result);

          // Perform other actions based on the API response
        } catch (error) {
          console.error(error);
        }
      },
      async renderEnroll(single) {
        this.open = false;
        if(!single)
        {
          const totalItems  = this.listItems.length;
          let counter       = 0;
          /* Batch Process Param */
          this.isProcessing   = true;
          this.processName    = `Render Enroll`;
          this.progressTotal  = totalItems
          this.startTime      = new Date().toISOString();
          this.endTime        = null;
          
          for (const item of this.listItems) {
            counter++;
            /* Batch Process Param */
            this.progressText     = `Processing : ${counter}/${totalItems}`;
            this.progressCurrent  =  counter

            await this.getEnrollData(
              item.order.courseID,
              item.order.userID,
              item.user.old_id,
              item.order._id
            );
          }
        } else {
          const totalItems    = 1;
          let counter         = 0;
          /* Batch Process Param */
          this.isProcessing   = true;
          this.processName    = `Render Single Enroll`;
          this.progressTotal  = totalItems
          this.startTime      = new Date().toISOString();
          this.endTime        = null;
          
          /* Batch Process Param */
          this.progressText     = `Processing : ${counter}/${totalItems}`;
          this.progressCurrent  =  0

          await this.getEnrollData(
            single.order.courseID,
            single.order.userID,
            single.user.old_id,
            single.order._id
          );
          await this.getData();
          this.progressCurrent  =  1
        }
        
        /* Batch Process Param */
        this.progressText = `All Process : Done`;
        this.endTime      = new Date().toISOString();
        //this.isProcessing = false;
      },
      async renderEnrollFirebase() {
        debug.log("########## Render Firebase");
        const totalItems = this.listItems.length;
        let counter = 0;

        for (const item of this.listItems) {
          counter++;
          await this.createUserCourse(item.user.token, '20',item.order.ref_no);
          debug.log(`Processing ${counter}/${totalItems}`);
        }
      },
      async renderData() {
        this.open = false;
        const totalItems  = this.listItems.length;
        let counter       = 0;

        /* Batch Process Param */
        this.isProcessing   = true;
        this.processName    = `Render Billing`;
        this.progressTotal  = totalItems
        this.startTime      = new Date().toISOString();
        this.endTime        = null;

        for (const item of this.listItems) {
            counter++;
            /* Batch Process Param */
            this.progressText     = `Processing : ${counter}/${totalItems}`;
            this.progressCurrent  =  counter
            debug.log("item",item);
            //await this.executeCustomQueries(item.order.ref, item.order._id);
        }

        /* Batch Process Param */
        this.progressText = `All Process : Done`;
        this.endTime      = new Date().toISOString();
      },
      async renderBilling() {
        this.open = false;
        const totalItems  = this.listItems.length;
        let counter       = 0;

        /* Batch Process Param */
        this.isProcessing   = true;
        this.processName    = `Render Billing`;
        this.progressTotal  = totalItems
        this.startTime      = new Date().toISOString();
        this.endTime        = null;

        for (const item of this.listItems) {
            counter++;
            /* Batch Process Param */
            this.progressText     = `Processing : ${counter}/${totalItems}`;
            this.progressCurrent  =  counter
            await this.executeCustomQueries(item.order.ref, item.order._id);
        }

        /* Batch Process Param */
        this.progressText = `All Process : Done`;
        this.endTime      = new Date().toISOString();
      },
      downloadSampleCSV() {
        const headers = 'bu_name,bu_type,prefix,firstname,lastname,position,phone,email\n';
        const sampleData = [
          '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡πÄ‡∏≠‡∏ö‡∏µ‡∏ã‡∏µ ‡∏à‡∏≥‡∏Å‡∏±‡∏î,‡πÄ‡∏≠‡∏Å‡∏ä‡∏ô,‡∏ô‡∏≤‡∏¢,‡∏™‡∏°‡∏ä‡∏≤‡∏¢,‡πÉ‡∏à‡∏î‡∏µ,‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£,0891234567,user1@example.com',
          '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡πÄ‡∏≠‡πá‡∏Å‡∏ã‡πå‡∏ß‡∏≤‡∏¢ ‡∏à‡∏≥‡∏Å‡∏±‡∏î,‡∏£‡∏±‡∏ê‡∏ß‡∏¥‡∏™‡∏≤‡∏´‡∏Å‡∏¥‡∏à,‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß,‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á,‡∏£‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô,‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô,0891234568,user2@example.com'
        ].join('\n');
        
        const csvContent = headers + sampleData;
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        link.setAttribute('href', url);
        link.setAttribute('download', 'enroll_template_multiple.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      },
      
      downloadSingleRowCSV() {
        const headers = 'bu_name,bu_type,prefix,firstname,lastname,position,phone,email\n';
        const singleRowData = '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏ó‡∏î‡∏™‡∏≠‡∏ö ‡∏à‡∏≥‡∏Å‡∏±‡∏î,‡πÄ‡∏≠‡∏Å‡∏ä‡∏ô,‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß,‡∏™‡∏¥‡∏£‡∏¥‡∏ß‡∏£‡∏£‡∏ì,‡∏õ‡∏£‡∏∞‡πÄ‡∏™‡∏£‡∏¥‡∏ê‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå,Supervisor,0891234569,test@example.com';
        
        const csvContent = headers + singleRowData;
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        link.setAttribute('href', url);
        link.setAttribute('download', 'enroll_template_single_row.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      },
      generateRandomPassword(index) {
        const length = 12;
        const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%&";
        let password = "";
        for (let i = 0; i < length; i++) {
          const randomIndex = Math.floor(Math.random() * charset.length);
          password += charset[randomIndex];
        }
        this.manualInput[index].password = password;
      },

      // üîê MANUAL PASSWORD METHODS
      generateManualPassword() {
        const settings = this.manualPasswordSettings;
        let charset = '';
        
        if (settings.includeLowercase) charset += 'abcdefghijklmnopqrstuvwxyz';
        if (settings.includeUppercase) charset += 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        if (settings.includeNumbers) charset += '0123456789';
        if (settings.includeSymbols) charset += '!@#$%^&*';
        
        if (charset === '') charset = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        
        let password = '';
        for (let i = 0; i < settings.length; i++) {
          const randomIndex = Math.floor(Math.random() * charset.length);
          password += charset[randomIndex];
        }
        
        return password;
      },

      generateManualPasswordForIndex(index) {
        this.manualInput[index].password = this.generateManualPassword();
      },

      fillAllPasswords() {
        this.manualInput.forEach((input) => {
          if (!input.password) { // ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
            input.password = this.generateManualPassword();
          }
        });
      },

      // üîê NEW USERNAME/PASSWORD GENERATION METHODS
      generateUsername(userData, rowData = null) {
        const settings = this.userMappingConfig.usernameSettings;
        let username = '';

        switch (settings.type) {
          case 'email':
            username = userData.email || '';
            break;
          case 'phone':
            username = userData.phone || '';
            break;
          case 'custom_pattern':
            username = this.applyUsernamePattern(settings.customPattern, userData);
            break;
          case 'from_csv':
            if (rowData && settings.csvColumn !== null) {
              username = rowData[settings.csvColumn] || '';
            }
            break;
          default:
            username = userData.email || userData.phone || '';
        }

        // ‡πÄ‡∏û‡∏¥‡πà‡∏° prefix/suffix
        if (settings.prefix) username = settings.prefix + username;
        if (settings.suffix) username = username + settings.suffix;

        // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡πá‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÑ‡∏°‡πà‡∏•‡∏ö‡∏≠‡∏±‡∏Å‡∏Ç‡∏£‡∏∞‡∏û‡∏¥‡πÄ‡∏®‡∏©
        return username.toLowerCase();
      },

      applyUsernamePattern(pattern, userData) {
        return pattern
          .replace('{firstname}', userData.firstname || '')
          .replace('{lastname}', userData.lastname || '')
          .replace('{email}', userData.email || '')
          .replace('{phone}', userData.phone || '')
          .replace('{citizen}', userData.citizen || '');
      },

      generatePassword(userData, rowData = null) {
        const settings = this.userMappingConfig.passwordSettings;
        let password = '';

        switch (settings.type) {
          case 'email':
            password = userData.email || this.generateRandomPasswordAdvanced();
            break;
          case 'phone':
            password = userData.phone || this.generateRandomPasswordAdvanced();
            break;
          case 'custom_value':
            password = settings.customValue || this.generateRandomPasswordAdvanced();
            break;
          case 'from_csv':
            if (rowData && settings.csvColumn !== null) {
              password = rowData[settings.csvColumn] || this.generateRandomPasswordAdvanced();
            } else {
              password = this.generateRandomPasswordAdvanced();
            }
            break;
          case 'auto_generated':
          default:
            password = this.generateRandomPasswordAdvanced();
        }

        // ‡∏•‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
        return password.replace(/\s/g, '');
      },

      generateRandomPasswordAdvanced() {
        const settings = this.userMappingConfig.passwordSettings.autoGenerated;
        let charset = '';

        if (settings.includeLowercase) charset += 'abcdefghijklmnopqrstuvwxyz';
        if (settings.includeUppercase) charset += 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        if (settings.includeNumbers) charset += '0123456789';
        if (settings.includeSymbols) charset += '!@#$%^&*';

        if (settings.excludeSimilar) {
          charset = charset.replace(/[0OlI1]/g, '');
        }

        let password = '';
        for (let i = 0; i < settings.length; i++) {
          const randomIndex = Math.floor(Math.random() * charset.length);
          password += charset[randomIndex];
        }

        return password;
      },
      toggleShowMore(index) {
        this.manualInputShowMore[index] = !this.manualInputShowMore[index];
      },
      // New action methods for enhanced functionality
      toggleActionDropdown(userId) {
        this.activeDropdown = this.activeDropdown === userId ? null : userId;
      },
      sendNotification(userId) {
        // Send notification to user
        dialog.confirm({
          title: '‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô',
          message: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
          confirm: async () => {
            try {
              // Implementation for sending notification
              console.log('Sending notification to:', userId);
              // You can implement actual notification logic here
              dialog.prompt({
                title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                message: '‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                confirm: () => {},
                cancel: () => {}
              });
            } catch (error) {
              console.error('Error sending notification:', error);
            }
          },
          cancel: () => {}
        });
        this.activeDropdown = null;
      },
      resetProgress(userId) {
        // Reset user progress
        dialog.confirm({
          title: '‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤',
          message: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ',
          confirm: async () => {
            try {
              // Implementation for resetting progress
              console.log('Resetting progress for:', userId);
              // Add your reset logic here
              await this.getData();
              dialog.prompt({
                title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                message: '‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                confirm: () => {},
                cancel: () => {}
              });
            } catch (error) {
              console.error('Error resetting progress:', error);
            }
          },
          cancel: () => {}
        });
        this.activeDropdown = null;
      },
      generateCertificate(userId) {
        // Generate certificate for completed user
        dialog.confirm({
          title: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á',
          message: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
          confirm: async () => {
            try {
              // Implementation for generating certificate
              console.log('Generating certificate for:', userId);
              // Add your certificate generation logic here
              dialog.prompt({
                title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                message: '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                confirm: () => {},
                cancel: () => {}
              });
            } catch (error) {
              console.error('Error generating certificate:', error);
            }
          },
          cancel: () => {}
        });
        this.activeDropdown = null;
      },
      removeEnrollment(userId) {
        // Remove user from course
        dialog.confirm({
          title: '‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£',
          message: '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£? ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ',
          confirm: async () => {
            try {
              // Implementation for removing enrollment
              console.log('Removing enrollment for:', userId);
              // Add your removal logic here
              await this.getData();
              dialog.prompt({
                title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                message: '‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                confirm: () => {},
                cancel: () => {}
              });
            } catch (error) {
              console.error('Error removing enrollment:', error);
            }
          },
          cancel: () => {}
        });
        this.activeDropdown = null;
      },
      generateDetailReport(userId) {
        // Generate detailed report for user
        try {
          console.log('Generating detailed report for:', userId);
          // Implementation for generating detailed report
          // You can redirect to a detailed report page or download a PDF
          this.$router.push(`/student/report/${userId}?course=${this.dataItem}`);
        } catch (error) {
          console.error('Error generating detailed report:', error);
        }
      },
      reviewExam(userId, enrollId, examType = 'general') {
        console.log('üéØ EnrollTable.reviewExam called with:', { userId, enrollId, examType });
        console.log('üìö Course ID (dataItem):', this.dataItem);
        console.log('üèóÔ∏è Course Data:', this.courseData);
        
        // Find the user item from listItems
        const userItem = this.listItems.find(item => item.user._id === userId);
        console.log('üë§ Found user item:', userItem);
        
        if (!userItem) {
          console.error('‚ùå User not found in listItems');
          alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
          return;
        }
        
        // Extract exam information
        // Use the course ID (dataItem) as examId since we're reviewing course exam scores
        const examId = this.dataItem; // Course ID from route params
        const userInfo = {
          name: `${userItem.user.firstname} ${userItem.user.lastname}`,
          email: userItem.user.email
        };
        
        // Get masterId from courseData
        const masterId = this.courseData?.master || null;
        console.log('üéØ Master ID from courseData:', masterId);
        
        console.log('üîÑ Calling ExamReviewManager with:', {
          examId,
          userId,
          userInfo,
          enrollId,
          examType,
          masterId
        });
        
        // Delegate to ExamReviewManager component with masterId parameter
        this.$refs.examReviewManager.reviewExam(examId, userId, userInfo, examType, masterId);
      },
      sendProgressUpdate(userId) {
        // Send progress update to user
        dialog.confirm({
          title: '‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤',
          message: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
          confirm: async () => {
            try {
              // Implementation for sending progress update
              console.log('Sending progress update to:', userId);
              // Add your progress update sending logic here
              dialog.prompt({
                title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                message: '‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                confirm: () => {},
                cancel: () => {}
              });
            } catch (error) {
              console.error('Error sending progress update:', error);
            }
          },
          cancel: () => {}
        });
      },
      
      handleExamGradesSaved() {
        // Handle when grades are saved from the exam review manager
        console.log('Exam grades saved successfully');
        // Optionally refresh data or show success message
        // this.getData(); // Uncomment if you want to refresh the table data
      },
      
      handleExamReviewClosed() {
        // Handle when exam review modal is closed
        console.log('ExamReviewManager modal closed, refreshing data...');
        // Refresh the table data to show updated scores and enrollment analytics
        this.getData();
      },
      
      // File upload methods
      
      handleClickOutside(event) {
        // Close dropdown if clicked outside
        if (!event.target.closest('.relative')) {
          this.activeDropdown = null;
        }
      },
      // Avatar and initials methods
      getInitials(firstname, lastname) {
        const first = firstname ? firstname.charAt(0).toUpperCase() : '';
        const last = lastname ? lastname.charAt(0).toUpperCase() : '';
        return first + last;
      },
      getAvatarBgColor(firstname, lastname) {
        // Generate consistent color based on initials
        const colors = [
          'bg-red-500', 'bg-blue-500', 'bg-green-500', 'bg-yellow-500',
          'bg-purple-500', 'bg-pink-500', 'bg-indigo-500', 'bg-teal-500',
          'bg-orange-500', 'bg-cyan-500', 'bg-emerald-500', 'bg-violet-500'
        ];
        
        const str = (firstname || '') + (lastname || '');
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
          hash = str.charCodeAt(i) + ((hash << 5) - hash);
        }
        return colors[Math.abs(hash) % colors.length];
      },
      onImageError(userId) {
        this.imageErrors[userId] = true;
      },
      onImageLoad(userId) {
        this.imageErrors[userId] = false;
      },
      shouldShowInitials(user) {
        return !user.avatar_img || 
               user.avatar_img === '' || 
               user.avatar_img === null || 
               user.avatar_img === undefined ||
               this.imageErrors[user._id];
      },
      
      scrollToQuestion(index) {
        // Delegate to ExamReviewManager component if needed
        if (this.$refs.examReviewManager) {
          this.$refs.examReviewManager.scrollToQuestion(index);
        }
      },
    },
    async mounted () {
      try {
        
        const urlParams = new URLSearchParams(window.location.search);
        const page = urlParams.get('page');
        if (page && /^\d+$/.test(page)) {
          this.currentPage = parseInt(page);
        } else {
          const session = storageManager.get('session');
          if (session && session.currentPage) {
            this.currentPage = session.currentPage;
            const updatedUrlParams = new URLSearchParams(window.location.search);
            updatedUrlParams.set('page', session.currentPage);
            const updatedUrl = `${window.location.pathname}?${updatedUrlParams.toString()}`;
            window.history.replaceState({}, '', updatedUrl);
          }
        }
        const session = storageManager.get('session');
        if (session && session.searchQuery) {
          this.searchQuery = session.searchQuery;
        }
        const storedLimitItem = session.limitItem;
        if (storedLimitItem) {
          this.limitItem = storedLimitItem;
        }
        await this.getData();
        await this.getCourse();
        this.fetchData();

        // üíæ Load saved configuration from localStorage
        if (this.hasConfigInLocalStorage()) {
          console.log('Found saved configuration in localStorage, loading...');
          this.loadConfigFromLocalStorage();
        } else {
          console.log('No saved configuration found in localStorage');
        }

        // Add click outside listener for dropdown
        document.addEventListener('click', this.handleClickOutside);
        
        // üöÄ PROGRESSIVE/LAZY LOADING - Initial setup after mount
        this.$nextTick(() => {
          this.resetDisplayCount();
        });
      } catch (error) {
        debug.log(Error);
      }
    },
    beforeUnmount() {
      // Remove click outside listener
      document.removeEventListener('click', this.handleClickOutside);
      
      // üßπ Clear configuration save timer
      if (this.configSaveTimer) {
        clearTimeout(this.configSaveTimer);
        this.configSaveTimer = null;
      }
      
      // üöÄ PROGRESSIVE/LAZY LOADING - Cleanup
      if (this.scrollCleanup) {
        this.scrollCleanup();
        this.scrollCleanup = null;
      }
      if (this.scrollTimeout) {
        clearTimeout(this.scrollTimeout);
        this.scrollTimeout = null;
      }
    },
    setup() {
      debug.log("Setup");
    },
    watch: {
      // üíæ Auto-save configuration when changed (with debounce)
      userMappingConfig: {
        handler() {
          // Debounce to avoid too frequent saves
          clearTimeout(this.configSaveTimer);
          this.configSaveTimer = setTimeout(() => {
            console.log('userMappingConfig changed, auto-saving...');
            this.saveConfigToLocalStorage(false); // Silent save
          }, 2000); // Save after 2 seconds of no changes
        },
        deep: true
      },
      
      csvMapping: {
        handler() {
          // Debounce to avoid too frequent saves
          clearTimeout(this.configSaveTimer);
          this.configSaveTimer = setTimeout(() => {
            console.log('csvMapping changed, auto-saving...');
            this.saveConfigToLocalStorage(false); // Silent save
          }, 2000); // Save after 2 seconds of no changes
        },
        deep: true
      },
      
      searchQuery() {
        clearTimeout(this.debounceTimer);
        this.debounceTimer = setTimeout(() => {
            this.getData();
            const session = storageManager.get('session');
            session.searchQuery = this.searchQuery;
            storageManager.set('session', session);

            this.currentPage = 1;
            /*
            const updatedUrlParams = new URLSearchParams(window.location.search);
            updatedUrlParams.set('page', session.currentPage);
            const updatedUrl = `${window.location.pathname}?${updatedUrlParams.toString()}`;
            window.history.replaceState({}, '', updatedUrl);
            */
        }, 500);
      }
    },
    computed: {
      // üöÄ PROGRESSIVE/LAZY LOADING COMPUTED PROPERTIES
      visibleItems() {
        if (!this.lazy) {
          return this.listItems; // ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ lazy
        }
        const visible = this.listItems.slice(0, this.currentDisplayCount);
        return visible;
      },
      
      hasMoreItems() {
        return this.lazy && this.currentDisplayCount < this.listItems.length;
      },
      
      progressiveLoadingStats() {
        if (!this.lazy) return null;
        return {
          showing: Math.min(this.currentDisplayCount, this.listItems.length),
          total: this.listItems.length,
          remaining: Math.max(0, this.listItems.length - this.currentDisplayCount),
          percentage: Math.round((this.currentDisplayCount / this.listItems.length) * 100)
        };
      },
      
      filteredListItems() {
        if (this.selectedStatus === "All") {
          return this.listItems;
        } else {
          return this.listItems.filter(item => item.status === this.selectedStatus);
        }
      }
    }
};
</script>

<template>
  <!-- Loading overlay -->
  <div v-if="isExporting" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-lg">
      <div class="text-gray-800 text-lg">{{ progressMessage }}</div>
    </div>
  </div>

  <!-- Data Preview Modal -->
  <div v-if="showPreviewModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
    <div class="w-full max-w-6xl mx-4 bg-white rounded-lg shadow-lg relative max-h-[90vh] flex flex-col">
      <div class="flex items-center justify-between p-4 border-b">
        <h2 class="text-lg font-semibold">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
        <button @click="showPreviewModal = false" class="text-gray-400 hover:text-gray-600">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <div class="overflow-auto flex-1 p-4">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-50">
            <tr>
              <th v-for="(value, key) in extractedData[0]" :key="key" class="px-3 py-2 text-left font-medium text-gray-700 border-b">
                {{ key }}
              </th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="(item, index) in extractedData" :key="index" class="hover:bg-gray-50">
              <td v-for="(value, key) in item" :key="key" class="px-3 py-2 border-b text-gray-600">
                {{ value }}
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="p-4 border-t">
        <button @click="downloadCSV(allData)" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
          ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV
        </button>
      </div>
    </div>
  </div>

  <!-- Side Panel -->
  <div v-if="open" class="relative z-10" aria-labelledby="slide-over-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-black bg-opacity-25"></div>
    <div class="fixed inset-0 overflow-hidden">
      <div class="absolute inset-0 overflow-hidden">
        <div class="pointer-events-none fixed inset-y-0 right-0 flex max-w-full pl-10">
          <div class="pointer-events-auto w-screen max-w-md">
            <div class="flex h-full flex-col bg-white shadow-xl">
              <div class="flex items-center justify-between p-4 border-b">
                <h2 class="text-lg font-semibold text-gray-900">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</h2>
                <button @click="closePanel" class="text-gray-400 hover:text-gray-600">
                  <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>
              <div class="flex-1 p-4">
                <div class="space-y-2">
                  <button class="w-full text-left p-2 text-blue-600 hover:bg-blue-50 rounded" @click="renderData">Render Data</button>
                  <button class="w-full text-left p-2 text-blue-600 hover:bg-blue-50 rounded" @click="renderBilling">Render Billing</button>
                  <button class="w-full text-left p-2 text-blue-600 hover:bg-blue-50 rounded" @click="renderEnroll()">Render Enroll</button>
                  <button class="w-full text-left p-2 text-blue-600 hover:bg-blue-50 rounded" @click="renderProfile">Render Profile</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading indicator -->
  <div v-if="!loading_sources" class="text-center py-8">
    <Loader/>
  </div>

  <!-- Batch Progress -->
  <batch-progress
    :processName="processName"
    :progressText="progressText"
    :progressTotal="progressTotal"
    :progressCurrent="progressCurrent"
    :isVisible="isProcessing"
    :startTime="startTime"
    :endTime="endTime"
    @close="closeProgress"
  />

  <!-- Header Section -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200">
    <div class="px-4 py-3 border-b border-gray-200">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center">
            <font-awesome-icon :icon="['fas','users']" class="text-white text-sm" />
          </div>
          <div>
            <h2 class="text-base font-semibold text-gray-900">{{ pageTitle }}</h2>
            <p class="text-xs text-gray-500">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£ ({{ totalItems }} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</p>
          </div>
        </div>
        <div class="flex items-center space-x-2">
          <button
            @click="exportToCSV"
            type="button"
            class="inline-flex items-center rounded-lg border border-transparent bg-green-600 px-3 py-1.5 text-sm font-medium text-white shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-colors"
          >
            <font-awesome-icon :icon="['fas', 'download']" class="mr-1.5" />
            Export
          </button>
          <button
            @click="assignUserModal"
            type="button"
            class="inline-flex items-center rounded-lg border border-transparent bg-blue-600 px-3 py-1.5 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors"
          >
            <font-awesome-icon :icon="['fas', 'plus']" class="mr-1.5" />
            Enroll
          </button>
          <button
            @click="togglePanel"
            type="button"
            class="inline-flex items-center rounded-lg border border-gray-300 bg-white px-3 py-1.5 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-colors"
          >
            <font-awesome-icon :icon="['fas', 'cogs']" class="mr-1.5" />
            ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠
          </button>
          <button
            @click="getData"
            type="button"
            class="inline-flex items-center rounded-lg border border-gray-300 bg-white px-3 py-1.5 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-colors"
          >
            <font-awesome-icon :icon="['fas', 'refresh']" class="mr-1.5" />
            ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
          </button>
        </div>
      </div>
    </div>

    <!-- Info Banner -->
    <div class="bg-blue-50 border-l-4 border-blue-400 p-3">
      <div class="flex">
        <div class="flex-shrink-0">
          <font-awesome-icon :icon="['fas','info-circle']" class="text-blue-400 text-sm" />
        </div>
        <div class="ml-2">
          <p class="text-xs text-blue-700">
            <strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ‡∏ú‡∏π‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏ô‡∏µ‡πâ ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
          </p>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="p-4">
      <!-- Enroll Modal -->
      <div v-if="isModalOpen" class="fixed inset-0 z-[30]">
        <!-- Background Overlay -->
        <div class="fixed inset-0 bg-black bg-opacity-50" @click="closeModal"></div>
        
        <!-- Modal Container -->
        <div class="fixed inset-0 flex items-center justify-center p-4">
          <div class="bg-white w-full max-w-6xl max-h-[90vh] flex flex-col rounded-lg shadow-xl relative z-10">
          
          <!-- Modal Header -->
          <div class="border-b bg-gray-50 p-4">
            <h2 class="text-lg font-semibold mb-3">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£</h2>
            <div class="flex space-x-1">
              <button @click="selectTab('csv')" :class="{ 'bg-white text-gray-800 border border-gray-300': selectedTab === 'csv', 'bg-gray-200 text-gray-600': selectedTab !== 'csv' }" class="px-3 py-1.5 text-sm rounded">Upload CSV</button>
              <button @click="selectTab('manual')" :class="{ 'bg-white text-gray-800 border border-gray-300': selectedTab === 'manual', 'bg-gray-200 text-gray-600': selectedTab !== 'manual' }" class="px-3 py-1.5 text-sm rounded">Input Manual</button>
              <button @click="selectTab('assign')" :class="{ 'bg-white text-gray-800 border border-gray-300': selectedTab === 'assign', 'bg-gray-200 text-gray-600': selectedTab !== 'assign' }" class="px-3 py-1.5 text-sm rounded">Select User</button>
            </div>
          </div>

          <!-- Modal Body -->
          <div class="overflow-y-auto flex-grow p-4">
            <!-- CSV Tab -->
            <div v-if="selectedTab === 'csv'" class="space-y-4">
              <!-- Mapping Configuration -->
              <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <div class="flex items-center justify-between mb-3">
                  <div>
                    <h3 class="font-medium text-yellow-800">‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤ Mapping ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
                    <p class="text-sm text-yellow-700">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà</p>
                  </div>
                  <div class="flex gap-2">
                    <button @click="openMappingConfig" 
                            :disabled="!csvData.length"
                            :class="[
                              csvData.length 
                                ? 'bg-yellow-600 hover:bg-yellow-700 text-white' 
                                : 'bg-gray-300 text-gray-500 cursor-not-allowed',
                              'px-3 py-1.5 rounded text-sm'
                            ]">
                      {{ csvData.length ? '‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î CSV ‡∏Å‡πà‡∏≠‡∏ô' }}
                    </button>
                    
                    <!-- Quick Username/Password Settings Button -->
                    <button @click="openUsernamePasswordConfig" 
                            :disabled="!csvData.length"
                            :class="[
                              csvData.length 
                                ? 'bg-blue-600 hover:bg-blue-700 text-white' 
                                : 'bg-gray-300 text-gray-500 cursor-not-allowed',
                              'px-3 py-1.5 rounded text-sm flex items-center gap-1'
                            ]">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-3l7.257-7.257A6 6 0 0117 9z"/>
                      </svg>
                      Username/Password
                    </button>
                  </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm">
                  <div class="bg-white p-3 rounded border">
                    <div class="font-medium text-gray-700 mb-1">‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•</div>
                    <div class="text-gray-600">
                      {{ userMappingConfig.createMode === 'auto' ? '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥' : 
                         userMappingConfig.createMode === 'create_only' ? '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô' : 
                         '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà' }}
                    </div>
                  </div>
                  
                  <div class="bg-white p-3 rounded border">
                    <div class="font-medium text-gray-700 mb-1">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
                    <div class="text-gray-600">
                      {{ getMatchFieldsSummary() }}
                    </div>
                  </div>
                  
                  <div class="bg-white p-3 rounded border">
                    <div class="font-medium text-gray-700 mb-1 flex items-center gap-1">
                      <svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                      </svg>
                      Username
                    </div>
                    <div class="text-gray-600 text-xs">
                      {{ getUsernameSettingSummary() }}
                    </div>
                    <div class="mt-1">
                      <span class="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded">
                        ‡∏Ñ‡∏•‡∏¥‡∏Å "Username/Password" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
                      </span>
                    </div>
                  </div>
                  
                  <div class="bg-white p-3 rounded border">
                    <div class="font-medium text-gray-700 mb-1 flex items-center gap-1">
                      <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-3l7.257-7.257A6 6 0 0117 9z"/>
                      </svg>
                      Password
                    </div>
                    <div class="text-gray-600 text-xs">
                      {{ getPasswordSettingSummary() }}
                    </div>
                    <div class="mt-1">
                      <span class="text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded">
                        ‡∏Ñ‡∏•‡∏¥‡∏Å "Username/Password" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
                      </span>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="bg-gray-50 rounded-lg p-4">
                <div class="flex items-center justify-between mb-3">
                  <h3 class="font-medium">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå CSV</h3>
                  <div class="flex gap-2">
                    <button @click="downloadSampleCSV" class="flex items-center gap-2 bg-blue-50 text-blue-600 px-3 py-1.5 rounded text-sm hover:bg-blue-100">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                      </svg>
                      ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏ñ‡∏ß
                    </button>
                    <button @click="downloadSingleRowCSV" class="flex items-center gap-2 bg-green-50 text-green-600 px-3 py-1.5 rounded text-sm hover:bg-green-100">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                      </svg>
                      ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á 1 ‡πÅ‡∏ñ‡∏ß
                    </button>
                  </div>
                </div>

                <div class="bg-white rounded border overflow-x-auto">
                  <table class="min-w-full text-xs">
                    <thead class="bg-gray-100">
                      <tr>
                        <th class="px-2 py-1 text-left">bu_name</th>
                        <th class="px-2 py-1 text-left">bu_type</th>
                        <th class="px-2 py-1 text-left">prefix</th>
                        <th class="px-2 py-1 text-left">firstname</th>
                        <th class="px-2 py-1 text-left">lastname</th>
                        <th class="px-2 py-1 text-left">position</th>
                        <th class="px-2 py-1 text-left">phone</th>
                        <th class="px-2 py-1 text-left">email</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr class="border-t">
                        <td class="px-2 py-1">‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡πÄ‡∏≠‡∏ö‡∏µ‡∏ã‡∏µ ‡∏à‡∏≥‡∏Å‡∏±‡∏î</td>
                        <td class="px-2 py-1">‡πÄ‡∏≠‡∏Å‡∏ä‡∏ô</td>
                        <td class="px-2 py-1">‡∏ô‡∏≤‡∏¢</td>
                        <td class="px-2 py-1">‡∏™‡∏°‡∏ä‡∏≤‡∏¢</td>
                        <td class="px-2 py-1">‡πÉ‡∏à‡∏î‡∏µ</td>
                        <td class="px-2 py-1">‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</td>
                        <td class="px-2 py-1">0891234567</td>
                        <td class="px-2 py-1">user1@example.com</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>

              <div class="bg-white rounded-lg border p-4">
                <h3 class="font-medium mb-3">‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå CSV</h3>
                <div class="flex items-center">
                  <label class="cursor-pointer bg-blue-50 text-blue-600 px-3 py-1.5 rounded text-sm hover:bg-blue-100">
                    ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå
                    <input type="file" @change="handleFileUpload" accept=".csv" class="hidden"/>
                  </label>
                  <span class="ml-3 text-sm text-gray-500" v-if="!selectedFileName">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</span>
                  <span class="ml-3 text-sm text-gray-700" v-else>{{ selectedFileName }}</span>
                </div>

                <!-- CSV Data Preview -->
                <div v-if="csvData.length > 0" class="mt-4">
                  <div class="flex items-center justify-between mb-2">
                    <h4 class="font-medium">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î ({{ csvData.length }} ‡πÅ‡∏ñ‡∏ß)</h4>
                    <div class="flex items-center space-x-4 text-sm text-gray-600">
                      <span>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏û‡∏ö: {{ csvColumns.length }} ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå</span>
                      <span v-if="csvData.length === 1" class="text-orange-600 font-medium">‚ö†Ô∏è ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏Ñ‡πà 1 ‡πÅ‡∏ñ‡∏ß</span>
                    </div>
                  </div>
                  
                  <!-- Warning for single row -->
                  <div v-if="csvData.length === 1" class="mb-3 p-3 bg-orange-50 border border-orange-200 rounded-lg">
                    <div class="flex items-center">
                      <svg class="w-5 h-5 text-orange-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.728-.833-2.498 0L3.316 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                      </svg>
                      <div>
                        <div class="font-medium text-orange-800">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏µ‡πÄ‡∏û‡∏µ‡∏¢‡∏á 1 ‡πÅ‡∏ñ‡∏ß</div>
                        <div class="text-sm text-orange-700">
                          ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô 1 ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- CSV Columns Preview -->
                  <div class="bg-blue-50 border border-blue-200 rounded p-3 mb-3">
                    <div class="text-sm font-medium text-blue-800 mb-2">‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô CSV:</div>
                    <div class="flex flex-wrap gap-1">
                      <span v-for="(column, index) in csvColumns" :key="index" 
                            class="inline-flex items-center px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded">
                        ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå {{ index + 1 }}: {{ column || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠' }}
                      </span>
                    </div>
                  </div>
                  
                  <div class="overflow-x-auto bg-gray-50 rounded border max-h-64">
                    <table class="min-w-full text-xs">
                      <thead class="bg-gray-100 sticky top-0">
                        <tr>
                          <th v-for="(column, index) in csvColumns" :key="index" 
                              class="px-2 py-2 text-left font-medium text-gray-700 border-r border-gray-200">
                            ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå {{ index + 1 }}
                            <div class="text-gray-500 font-normal mt-1">{{ column || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠' }}</div>
                          </th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr v-for="(row, rowIndex) in csvData.slice(0, 5)" :key="rowIndex" class="border-b last:border-b-0">
                          <td v-for="(cell, cellIndex) in row" :key="cellIndex" 
                              class="px-2 py-1 border-r border-gray-200 max-w-[120px] truncate" 
                              :title="cell">
                            <span v-if="!isEditing(rowIndex, cellIndex)" @click="startEditing(rowIndex, cellIndex)" class="cursor-pointer hover:bg-gray-100 px-1 py-0.5 rounded">
                              {{ cell }}
                            </span>
                            <input
                              v-else
                              type="text"
                              v-model="csvData[rowIndex][cellIndex]"
                              @blur="stopEditing(rowIndex, cellIndex)"
                              @keyup.enter="stopEditing(rowIndex, cellIndex)"
                              class="border rounded px-1 py-0.5 w-full text-xs focus:outline-none focus:ring-1 focus:ring-blue-500"
                            />
                          </td>
                        </tr>
                      </tbody>
                    </table>
                    <div v-if="csvData.length > 5" class="p-2 text-center text-gray-500 text-xs bg-gray-100">
                      ... ‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡∏Å {{ csvData.length - 5 }} ‡πÅ‡∏ñ‡∏ß
                    </div>
                    <div v-else-if="csvData.length === 1" class="p-2 text-center text-blue-600 text-xs bg-blue-50">
                      ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß (1 ‡πÅ‡∏ñ‡∏ß)
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Manual Tab -->
            <div v-if="selectedTab === 'manual'" class="space-y-4">
              <!-- Quick Password Generator Settings -->
              <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div class="flex items-center justify-between mb-3">
                  <h3 class="font-medium text-blue-800 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-3l7.257-7.257A6 6 0 0117 9z"/>
                    </svg>
                    ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
                  </h3>
                  <button @click="fillAllPasswords" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs">
                    ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                  </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                  <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                    <input v-model.number="manualPasswordSettings.length" type="number" min="6" max="50" 
                           class="w-full px-2 py-1 text-xs border rounded focus:ring-1 focus:ring-blue-500">
                  </div>
                  <div class="space-y-1">
                    <label class="flex items-center cursor-pointer">
                      <input type="checkbox" v-model="manualPasswordSettings.includeUppercase" class="mr-2 text-xs">
                      <span class="text-xs">‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏ç‡πà A-Z</span>
                    </label>
                    <label class="flex items-center cursor-pointer">
                      <input type="checkbox" v-model="manualPasswordSettings.includeLowercase" class="mr-2 text-xs">
                      <span class="text-xs">‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡πá‡∏Å a-z</span>
                    </label>
                  </div>
                  <div class="space-y-1">
                    <label class="flex items-center cursor-pointer">
                      <input type="checkbox" v-model="manualPasswordSettings.includeNumbers" class="mr-2 text-xs">
                      <span class="text-xs">‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 0-9</span>
                    </label>
                    <label class="flex items-center cursor-pointer">
                      <input type="checkbox" v-model="manualPasswordSettings.includeSymbols" class="mr-2 text-xs">
                      <span class="text-xs">‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå !@#$</span>
                    </label>
                  </div>
                </div>
              </div>
              
              <div class="flex justify-between items-center">
                <div>
                  <h3 class="font-medium text-gray-800">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á</h3>
                  <p class="text-sm text-gray-600">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</p>
                </div>
                <button @click="addManualInputRow" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1.5 rounded text-sm flex items-center">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                  </svg>
                  ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
                </button>
              </div>

              <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="px-2 py-2 text-left text-xs font-medium text-gray-500">#</th>
                      <th class="px-2 py-2 text-left text-xs font-medium text-gray-500">‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</th>
                      <th class="px-2 py-2 text-left text-xs font-medium text-gray-500">‡∏ä‡∏∑‡πà‡∏≠</th>
                      <th class="px-2 py-2 text-left text-xs font-medium text-gray-500">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                      <th class="px-2 py-2 text-left text-xs font-medium text-gray-500">‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</th>
                      <th class="px-2 py-2 text-left text-xs font-medium text-gray-500">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</th>
                      <th class="px-2 py-2 text-left text-xs font-medium text-gray-500">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</th>
                      <th class="px-2 py-2 text-left text-xs font-medium text-gray-500">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</th>
                      <th class="px-2 py-2 text-left text-xs font-medium text-gray-500">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                    </tr>
                  </thead>
                  <tbody class="bg-white divide-y divide-gray-200">
                    <template v-for="(userInput, index) in manualInput" :key="index">
                      <tr class="hover:bg-gray-50">
                        <td class="px-2 py-1 text-gray-500">{{ index + 1 }}</td>
                        <td class="px-2 py-1">
                          <select v-model="userInput.info.prefix" class="w-full px-2 py-1 text-xs border rounded focus:ring-1 focus:ring-blue-500 focus:outline-none">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option>
                            <option v-for="(value, key) in prefixMapping" :key="key" :value="key">{{ value }}</option>
                          </select>
                        </td>
                        <td class="px-2 py-1">
                          <input type="text" v-model="userInput.firstname" placeholder="‡∏ä‡∏∑‡πà‡∏≠" class="w-full px-2 py-1 text-xs border rounded focus:ring-1 focus:ring-blue-500 focus:outline-none" />
                        </td>
                        <td class="px-2 py-1">
                          <input type="text" v-model="userInput.lastname" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" class="w-full px-2 py-1 text-xs border rounded focus:ring-1 focus:ring-blue-500 focus:outline-none" />
                        </td>
                        <td class="px-2 py-1">
                          <input type="text" v-model="userInput.phone" placeholder="‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå" class="w-full px-2 py-1 text-xs border rounded focus:ring-1 focus:ring-blue-500 focus:outline-none" />
                        </td>
                        <td class="px-2 py-1">
                          <input type="text" v-model="userInput.email" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" class="w-full px-2 py-1 text-xs border rounded focus:ring-1 focus:ring-blue-500 focus:outline-none" />
                        </td>
                        <td class="px-2 py-1">
                          <input type="text" v-model="userInput.username" placeholder="‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô" class="w-full px-2 py-1 text-xs border rounded focus:ring-1 focus:ring-blue-500 focus:outline-none" />
                        </td>
                        <td class="px-2 py-1">
                          <div class="flex items-center space-x-1">
                            <input type="password" v-model="userInput.password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="flex-grow px-2 py-1 text-xs border rounded focus:ring-1 focus:ring-blue-500 focus:outline-none" />
                            <button @click="generateManualPasswordForIndex(index)" type="button" title="‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="p-1 bg-blue-100 hover:bg-blue-200 text-blue-600 rounded">
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm1 9.899a7.002 7.002 0 0111.601-2.566 1 1 0 111.885-.666A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 111.885.666A5.002 5.002 0 005.999 13H9a1 1 0 110-2H4a1 1 0 01-1-1V3a1 1 0 011-1z" clip-rule="evenodd" />
                              </svg>
                            </button>
                          </div>
                        </td>
                        <td class="px-2 py-1">
                          <div class="flex items-center space-x-1">
                            <button @click="toggleShowMore(index)" type="button" title="‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°" class="p-1 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded">
                              <svg v-if="!manualInputShowMore[index]" xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                              </svg>
                              <svg v-else xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                              </svg>
                            </button>
                            <button v-if="manualInput.length > 1" @click="removeManualInputRow(index)" type="button" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs">
                              ‡∏•‡∏ö
                            </button>
                          </div>
                        </td>
                      </tr>
                      <tr v-if="manualInputShowMore[index]" class="bg-gray-50">
                        <td></td>
                        <td colspan="8" class="px-2 py-2">
                          <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                            <div>
                              <label class="block text-xs font-medium text-gray-700 mb-1">‡πÄ‡∏û‡∏®</label>
                              <select v-model="userInput.info.sex" class="w-full px-2 py-1 text-xs border rounded focus:ring-1 focus:ring-blue-500 focus:outline-none">
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option>
                                <option v-for="(value, key) in sexMapping" :key="key" :value="key">{{ value }}</option>
                              </select>
                            </div>
                            <div>
                              <label class="block text-xs font-medium text-gray-700 mb-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</label>
                              <input type="text" v-model="userInput.info.bu_type" placeholder="‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô" class="w-full px-2 py-1 text-xs border rounded focus:ring-1 focus:ring-blue-500 focus:outline-none" />
                            </div>
                            <div>
                              <label class="block text-xs font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</label>
                              <input type="text" v-model="userInput.info.bu_name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô" class="w-full px-2 py-1 text-xs border rounded focus:ring-1 focus:ring-blue-500 focus:outline-none" />
                            </div>
                            <div>
                              <label class="block text-xs font-medium text-gray-700 mb-1">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label>
                              <input type="text" v-model="userInput.info.position" placeholder="‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á" class="w-full px-2 py-1 text-xs border rounded focus:ring-1 focus:ring-blue-500 focus:outline-none" />
                            </div>
                          </div>
                        </td>
                      </tr>
                    </template>
                  </tbody>
                </table>
              </div>
            </div>
            
            <div v-if="selectedTab === 'assign'" class="text-center py-8 text-gray-500">
              <p>Select User Content (Placeholder)</p>
            </div>
          </div>

          <!-- Modal Footer -->
          <div class="border-t p-4 flex justify-end space-x-2">
            <button @click="closeModal" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded text-sm">
              ‡∏õ‡∏¥‡∏î
            </button>
            <button @click="processCSV" v-if="selectedTab === 'csv'" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded text-sm">
              ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢
            </button>
            <button @click="processAdvancedCSV" v-if="selectedTab === 'csv'" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm">
              ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏ö‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á
            </button>
            <button @click="processManualInput" v-if="selectedTab === 'manual' && manualInput.length > 0" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm">
              ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
            </button>
          </div>
          </div>
        </div>
      </div>
      
      <!-- üöÄ CSV Processing Progress Overlay -->
      <div v-if="isCreatingUser" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[60] backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full mx-4 p-8 transform transition-all duration-300 scale-100">
          <div class="text-center">
            <!-- Loading Spinner -->
            <div class="flex justify-center mb-6">
              <div class="relative">
                <div class="animate-spin rounded-full h-16 w-16 border-4 border-gray-200 border-t-blue-500"></div>
                <div class="absolute inset-0 flex items-center justify-center">
                  <div class="w-6 h-6 bg-blue-500 rounded-full animate-pulse"></div>
                </div>
              </div>
            </div>
            
            <!-- Progress Info -->
            <h3 class="text-xl font-bold text-gray-800 mb-3">{{ loadingMessage }}</h3>
            
            <!-- Progress Details -->
            <div v-if="processingCount" class="text-base text-gray-600 mb-6 font-medium">
              ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•: {{ processingCount }}
            </div>
            
            <!-- Progress Bar -->
            <div v-if="processingResults.total > 0" class="mb-6">
              <div class="flex justify-between text-sm text-gray-600 mb-2">
                <span>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</span>
                <span class="font-semibold">{{ Math.round(((processingResults.created + processingResults.enrolled + processingResults.skipped + processingResults.errors) / processingResults.total) * 100) }}%</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-4 shadow-inner">
                <div class="bg-gradient-to-r from-blue-500 via-blue-600 to-blue-700 h-4 rounded-full transition-all duration-500 shadow-lg relative overflow-hidden" 
                     :style="{ width: ((processingResults.created + processingResults.enrolled + processingResults.skipped + processingResults.errors) / processingResults.total * 100) + '%' }">
                  <div class="absolute inset-0 bg-white opacity-20 transform skew-x-12 animate-pulse"></div>
                </div>
              </div>
            </div>
            
            <!-- Current Stats -->
            <div v-if="processingResults.total > 0" class="grid grid-cols-2 gap-4 text-sm bg-gray-50 rounded-lg p-4">
              <div class="text-center p-2 bg-white rounded-lg shadow-sm">
                <div class="font-bold text-lg text-green-600">{{ processingResults.created }}</div>
                <div class="text-gray-500 text-xs">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà</div>
              </div>
              <div class="text-center p-2 bg-white rounded-lg shadow-sm">
                <div class="font-bold text-lg text-blue-600">{{ processingResults.enrolled }}</div>
                <div class="text-gray-500 text-xs">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</div>
              </div>
              <div class="text-center p-2 bg-white rounded-lg shadow-sm">
                <div class="font-bold text-lg text-yellow-600">{{ processingResults.skipped }}</div>
                <div class="text-gray-500 text-xs">‡∏Ç‡πâ‡∏≤‡∏°</div>
              </div>
              <div class="text-center p-2 bg-white rounded-lg shadow-sm">
                <div class="font-bold text-lg text-red-600">{{ processingResults.errors }}</div>
                <div class="text-gray-500 text-xs">‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Mapping Configuration Modal -->
      <div v-if="showMappingModal" class="fixed inset-0 z-[40]">
        <div class="fixed inset-0 bg-black bg-opacity-50" @click="closeMappingConfig"></div>
        <div class="fixed inset-0 flex items-center justify-center p-4">
          <div class="bg-white w-full max-w-4xl max-h-[90vh] flex flex-col rounded-lg shadow-xl relative z-10">
            
            <!-- Modal Header -->
            <div class="border-b bg-gray-50 p-4">
              <h2 class="text-lg font-semibold">‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤ User Mapping</h2>
              <p class="text-sm text-gray-600 mt-1">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á CSV ‡πÅ‡∏•‡∏∞‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</p>
            </div>
            
            <!-- Modal Body -->
            <div class="overflow-y-auto flex-grow p-4 space-y-6">
              
              <!-- Processing Mode -->
              <div class="bg-blue-50 p-4 rounded-lg">
                <h3 class="font-medium text-blue-900 mb-3">‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                  <label class="flex items-center p-3 bg-white rounded border cursor-pointer" :class="{'ring-2 ring-blue-500': userMappingConfig.createMode === 'auto'}">
                    <input type="radio" v-model="userMappingConfig.createMode" value="auto" class="mr-2">
                    <div>
                      <div class="font-medium text-sm">‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div>
                      <div class="text-xs text-gray-600">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏û‡∏ö</div>
                    </div>
                  </label>
                  
                  <label class="flex items-center p-3 bg-white rounded border cursor-pointer" :class="{'ring-2 ring-blue-500': userMappingConfig.createMode === 'create_only'}">
                    <input type="radio" v-model="userMappingConfig.createMode" value="create_only" class="mr-2">
                    <div>
                      <div class="font-medium text-sm">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</div>
                      <div class="text-xs text-gray-600">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô</div>
                    </div>
                  </label>
                  
                  <label class="flex items-center p-3 bg-white rounded border cursor-pointer" :class="{'ring-2 ring-blue-500': userMappingConfig.createMode === 'enroll_only'}">
                    <input type="radio" v-model="userMappingConfig.createMode" value="enroll_only" class="mr-2">
                    <div>
                      <div class="font-medium text-sm">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</div>
                      <div class="text-xs text-gray-600">‡πÉ‡∏ä‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</div>
                    </div>
                  </label>
                </div>
              </div>
              
              <!-- üîê USERNAME & PASSWORD CONFIGURATION -->
              <div class="bg-yellow-50 p-4 rounded-lg username-password-config">
                <div class="flex items-center justify-between mb-3">
                  <h3 class="font-medium text-yellow-900 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-3l7.257-7.257A6 6 0 0117 9z"/>
                    </svg>
                    ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Username ‡πÅ‡∏•‡∏∞ Password
                  </h3>
                  <div class="text-sm text-yellow-700 bg-yellow-100 px-2 py-1 rounded">
                    ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á
                  </div>
                </div>
                
                <!-- Username Settings -->
                <div class="bg-white p-4 rounded border mb-4">
                  <h4 class="font-medium text-gray-800 mb-3">‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á Username</h4>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label class="block text-xs font-medium text-gray-700 mb-1">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö Username</label>
                      <select v-model="userMappingConfig.usernameSettings.type" class="w-full px-2 py-1 text-sm border rounded focus:ring-1 focus:ring-yellow-500">
                        <option value="email">‡πÉ‡∏ä‡πâ Email</option>
                        <option value="phone">‡πÉ‡∏ä‡πâ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</option>
                        <option value="custom_pattern">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á</option>
                        <option value="from_csv">‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÉ‡∏ô CSV</option>
                      </select>
                    </div>
                    
                    <div v-if="userMappingConfig.usernameSettings.type === 'custom_pattern'">
                      <label class="block text-xs font-medium text-gray-700 mb-1">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö (Pattern)</label>
                      <input v-model="userMappingConfig.usernameSettings.customPattern" 
                             type="text" 
                             placeholder="‡πÄ‡∏ä‡πà‡∏ô {firstname}.{lastname}"
                             class="w-full px-2 py-1 text-sm border rounded focus:ring-1 focus:ring-yellow-500">
                      <div class="text-xs text-gray-500 mt-1">
                        ‡πÉ‡∏ä‡πâ: {firstname}, {lastname}, {email}, {phone}, {citizen}
                      </div>
                    </div>
                    
                    <div v-if="userMappingConfig.usernameSettings.type === 'from_csv'">
                      <label class="block text-xs font-medium text-gray-700 mb-1">‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Username</label>
                      <select v-model="userMappingConfig.usernameSettings.csvColumn" class="w-full px-2 py-1 text-sm border rounded focus:ring-1 focus:ring-yellow-500">
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå --</option>
                        <option v-for="(column, colIndex) in csvColumns" :key="colIndex" :value="colIndex">
                          ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå {{ colIndex + 1 }}: {{ column || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠' }}
                        </option>
                      </select>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2">
                      <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Prefix</label>
                        <input v-model="userMappingConfig.usernameSettings.prefix" 
                               type="text" 
                               placeholder="user_"
                               class="w-full px-2 py-1 text-sm border rounded focus:ring-1 focus:ring-yellow-500">
                      </div>
                      <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Suffix</label>
                        <input v-model="userMappingConfig.usernameSettings.suffix" 
                               type="text" 
                               placeholder="_2024"
                               class="w-full px-2 py-1 text-sm border rounded focus:ring-1 focus:ring-yellow-500">
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Password Settings -->
                <div class="bg-white p-4 rounded border">
                  <h4 class="font-medium text-gray-800 mb-3">‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á Password</h4>
                  <div class="space-y-4">
                    <div>
                      <label class="block text-xs font-medium text-gray-700 mb-1">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö Password</label>
                      <select v-model="userMappingConfig.passwordSettings.type" class="w-full px-2 py-1 text-sm border rounded focus:ring-1 focus:ring-yellow-500">
                        <option value="auto_generated">‡∏™‡∏∏‡πà‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</option>
                        <option value="email">‡πÉ‡∏ä‡πâ Email</option>
                        <option value="phone">‡πÉ‡∏ä‡πâ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</option>
                        <option value="custom_value">‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡∏ó‡∏µ‡πà</option>
                        <option value="from_csv">‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÉ‡∏ô CSV</option>
                      </select>
                    </div>
                    
                    <div v-if="userMappingConfig.passwordSettings.type === 'custom_value'">
                      <label class="block text-xs font-medium text-gray-700 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ</label>
                      <input v-model="userMappingConfig.passwordSettings.customValue" 
                             type="password" 
                             placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô"
                             class="w-full px-2 py-1 text-sm border rounded focus:ring-1 focus:ring-yellow-500">
                    </div>
                    
                    <div v-if="userMappingConfig.passwordSettings.type === 'from_csv'">
                      <label class="block text-xs font-medium text-gray-700 mb-1">‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Password</label>
                      <select v-model="userMappingConfig.passwordSettings.csvColumn" class="w-full px-2 py-1 text-sm border rounded focus:ring-1 focus:ring-yellow-500">
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå --</option>
                        <option v-for="(column, colIndex) in csvColumns" :key="colIndex" :value="colIndex">
                          ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå {{ colIndex + 1 }}: {{ column || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠' }}
                        </option>
                      </select>
                    </div>
                    
                    <div v-if="userMappingConfig.passwordSettings.type === 'auto_generated'" class="bg-gray-50 p-3 rounded">
                      <div class="text-sm font-medium text-gray-700 mb-2">‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</div>
                      <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                          <label class="block text-xs text-gray-600 mb-1">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß</label>
                          <input v-model.number="userMappingConfig.passwordSettings.autoGenerated.length" 
                                 type="number" 
                                 min="6" 
                                 max="50"
                                 class="w-full px-2 py-1 text-xs border rounded">
                        </div>
                        <div class="space-y-1">
                          <label class="flex items-center cursor-pointer">
                            <input type="checkbox" v-model="userMappingConfig.passwordSettings.autoGenerated.includeUppercase" class="mr-2 text-xs">
                            <span class="text-xs">‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏ç‡πà A-Z</span>
                          </label>
                          <label class="flex items-center cursor-pointer">
                            <input type="checkbox" v-model="userMappingConfig.passwordSettings.autoGenerated.includeLowercase" class="mr-2 text-xs">
                            <span class="text-xs">‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡πá‡∏Å a-z</span>
                          </label>
                          <label class="flex items-center cursor-pointer">
                            <input type="checkbox" v-model="userMappingConfig.passwordSettings.autoGenerated.includeNumbers" class="mr-2 text-xs">
                            <span class="text-xs">‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 0-9</span>
                          </label>
                          <label class="flex items-center cursor-pointer">
                            <input type="checkbox" v-model="userMappingConfig.passwordSettings.autoGenerated.includeSymbols" class="mr-2 text-xs">
                            <span class="text-xs">‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå !@#$</span>
                          </label>
                          <label class="flex items-center cursor-pointer">
                            <input type="checkbox" v-model="userMappingConfig.passwordSettings.autoGenerated.excludeSimilar" class="mr-2 text-xs">
                            <span class="text-xs">‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢ (0,O,l,I,1)</span>
                          </label>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
                <!-- Match Fields -->
              <div class="bg-green-50 p-4 rounded-lg">
                <div class="flex items-center justify-between mb-3">
                  <h3 class="font-medium text-green-900">‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
                  <div class="text-sm text-green-700">
                    ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å CSV ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                  </div>
                </div>
                <div class="space-y-3">
                  <div v-for="(field, index) in userMappingConfig.matchFields" :key="index" class="flex items-center p-3 bg-white rounded border">
                    <div class="flex-1 grid grid-cols-3 gap-3">
                      <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÉ‡∏ô CSV</label>
                        <select v-model="field.csv" class="w-full px-2 py-1 text-sm border rounded focus:ring-1 focus:ring-blue-500">
                          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå --</option>
                          <option v-for="(column, colIndex) in csvColumns" :key="colIndex" :value="colIndex">
                            ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå {{ colIndex + 1 }}: {{ column || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠' }}
                          </option>
                        </select>
                      </div>
                      
                      <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">‡∏ü‡∏¥‡∏•‡∏î‡πå‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</label>
                        <select v-model="field.user" class="w-full px-2 py-1 text-sm border rounded focus:ring-1 focus:ring-blue-500">
                          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ü‡∏¥‡∏•‡∏î‡πå --</option>
                          <option v-for="userField in availableMatchFields.user" :key="userField.value" :value="userField.value">
                            {{ userField.label }}
                          </option>
                        </select>
                      </div>
                      
                      <div class="flex items-center">
                        <label class="flex items-center cursor-pointer">
                          <input type="checkbox" v-model="field.primary" class="mr-2">
                          <span class="text-sm">‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏´‡∏•‡∏±‡∏Å</span>
                        </label>
                      </div>
                    </div>
                    
                    <button v-if="userMappingConfig.matchFields.length > 1" @click="userMappingConfig.matchFields.splice(index, 1)" class="ml-3 text-red-600 hover:bg-red-50 p-1 rounded">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                      </svg>
                    </button>
                  </div>
                  
                  <button @click="addMatchField" class="w-full p-2 border-2 border-dashed border-gray-300 text-gray-600 rounded hover:border-gray-400 hover:text-gray-700">
                    + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà
                  </button>
                </div>
              </div>
              
              <!-- CSV Column Mapping -->
              <div class="bg-purple-50 p-4 rounded-lg">
                <div class="flex items-center justify-between mb-3">
                  <h3 class="font-medium text-purple-900">‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î Mapping ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå</h3>
                  <div class="text-sm text-purple-700">
                    ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡πà‡∏≤‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÉ‡∏ô CSV ‡∏à‡∏∞ map ‡∏Å‡∏±‡∏ö‡∏ü‡∏¥‡∏•‡∏î‡πå‡πÑ‡∏´‡∏ô‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà
                  </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div v-for="(mapping, key) in csvMapping" :key="key" class="bg-white p-3 rounded border">
                    <div class="mb-2">
                      <div class="flex items-center justify-between mb-1">
                        <label class="block text-xs font-medium text-gray-700">
                          {{ mapping.label || key }}
                        </label>
                        <div class="flex gap-1">
                          <span v-if="!isDefaultMapping(key)" class="inline-flex items-center px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">
                            ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á
                          </span>
                          <span v-if="mapping.optional" class="inline-flex items-center px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded-full">
                            ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö
                          </span>
                        </div>
                      </div>
                      <div class="text-xs text-gray-500 mb-1">‚Üí ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏õ‡∏ó‡∏µ‡πà: {{ mapping.target }}</div>
                      <div v-if="mapping.dataType" class="text-xs text-blue-600">
                        ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: {{ getDataTypeLabel(mapping.dataType) }}
                      </div>
                    </div>
                    
                    <div class="space-y-2">
                      <!-- Column Selection Row -->
                      <div class="flex gap-2">
                        <select v-model="mapping.column" class="flex-1 px-2 py-1 text-sm border rounded focus:ring-1 focus:ring-purple-500">
                          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå --</option>
                          <option v-for="(column, colIndex) in csvColumns" :key="colIndex" :value="colIndex">
                            ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå {{ colIndex + 1 }}: {{ column || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠' }}
                          </option>
                          <option value="custom">-- ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡πÄ‡∏≠‡∏á --</option>
                        </select>
                        
                        <label class="flex items-center cursor-pointer text-xs">
                          <input type="checkbox" v-model="mapping.optional" class="mr-1">
                          ‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
                        </label>
                        
                        <button @click="removeCsvMapping(key)" 
                                v-if="!isDefaultMapping(key)"
                                class="text-red-600 hover:bg-red-50 p-1 rounded"
                                title="‡∏•‡∏ö‡∏ü‡∏¥‡∏•‡∏î‡πå">
                          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                          </svg>
                        </button>
                      </div>
                      
                      <!-- Target Location Selection Row -->
                      <div class="bg-gray-50 p-2 rounded">
                        <label class="block text-xs font-medium text-gray-700 mb-1">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å:</label>
                        <div class="flex gap-2">
                          <select v-model="mapping.targetType" 
                                  @change="updateMappingTarget(mapping, key)" 
                                  :disabled="isDefaultMapping(key)"
                                  class="flex-1 px-2 py-1 text-xs border rounded focus:ring-1 focus:ring-blue-500"
                                  :class="{ 'bg-gray-100 cursor-not-allowed': isDefaultMapping(key) }">
                            <option value="root">Root Level (‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏´‡∏•‡∏±‡∏Å)</option>
                            <option value="info">info.* (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°)</option>
                            <option value="contact">contact.* (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠)</option>
                            <option value="address">address.* (‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà)</option>
                            <option value="work">work.* (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô)</option>
                            <option value="education">education.* (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤)</option>
                            <option value="custom">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á</option>
                          </select>
                          
                          <input v-if="mapping.targetType !== 'custom'" 
                                 v-model="mapping.fieldName" 
                                 @input="updateMappingTarget(mapping, key)"
                                 :disabled="isDefaultMapping(key)"
                                 type="text" 
                                 :placeholder="getFieldNamePlaceholder(mapping.targetType)"
                                 class="flex-1 px-2 py-1 text-xs border rounded focus:ring-1 focus:ring-blue-500"
                                 :class="{ 'bg-gray-100 cursor-not-allowed': isDefaultMapping(key) }">
                                 
                          <input v-else
                                 v-model="mapping.target" 
                                 :disabled="isDefaultMapping(key)"
                                 type="text" 
                                 placeholder="‡πÄ‡∏ä‡πà‡∏ô contact.emergency_phone, work.department"
                                 class="flex-1 px-2 py-1 text-xs border rounded focus:ring-1 focus:ring-blue-500"
                                 :class="{ 'bg-gray-100 cursor-not-allowed': isDefaultMapping(key) }">
                        </div>
                        
                        <!-- Target Preview -->
                        <div class="mt-1 text-xs text-blue-600 bg-blue-50 px-2 py-1 rounded">
                          ‚Üí ‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô: <span class="font-mono font-bold">user.{{ mapping.target || (mapping.targetType === 'root' ? (mapping.fieldName || key) : mapping.targetType + '.' + (mapping.fieldName || key)) }}</span>
                        </div>
                        
                        <!-- Default Field Notice -->
                        <div v-if="isDefaultMapping(key)" class="mt-1 text-xs text-gray-500 bg-yellow-50 px-2 py-1 rounded">
                          <span class="inline-flex items-center">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                            </svg>
                            ‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô - ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ
                          </span>
                        </div>
                        
                        <!-- Field Name Examples -->
                        <div v-else-if="mapping.targetType && mapping.targetType !== 'custom'" class="mt-1 text-xs text-gray-500">
                          ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: {{ getTargetExamples(mapping.targetType) }}
                        </div>
                      </div>
                    </div>
                    
                    <!-- Custom value input when "‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡πÄ‡∏≠‡∏á" is selected -->
                    <div v-if="mapping.column === 'custom'" class="mt-2">
                      <label class="block text-xs font-medium text-gray-700 mb-1">‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î:</label>
                      <input v-model="mapping.customValue" 
                             type="text" 
                             placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£"
                             class="w-full px-2 py-1 text-sm border rounded focus:ring-1 focus:ring-purple-500">
                      <div class="text-xs text-gray-500 mt-1">‡∏Ñ‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</div>
                    </div>
                    
                    <!-- Preview of selected column data -->
                    <div v-if="mapping.column !== '' && mapping.column !== 'custom' && csvData.length > 0" class="mt-2 p-2 bg-gray-50 rounded">
                      <div class="text-xs text-gray-600 mb-1">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:</div>
                      <div class="text-xs text-gray-800">
                        <span v-for="(row, index) in csvData.slice(0, Math.min(3, csvData.length))" :key="index" class="mr-2">
                          "{{ row[mapping.column] || '-' }}"<span v-if="index < Math.min(2, csvData.length - 1)">,</span>
                        </span>
                        <span v-if="csvData.length > 3">...</span>
                        <span v-else-if="csvData.length === 1" class="text-blue-600">(‡πÄ‡∏û‡∏µ‡∏¢‡∏á 1 ‡πÅ‡∏ñ‡∏ß)</span>
                      </div>
                    </div>
                    
                    <!-- Preview of custom value -->
                    <div v-if="mapping.column === 'custom' && mapping.customValue" class="mt-2 p-2 bg-blue-50 rounded">
                      <div class="text-xs text-blue-600 mb-1">‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏ä‡πâ:</div>
                      <div class="text-xs text-blue-800 font-medium">
                        "{{ mapping.customValue }}"
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Add New Field Button -->
                <div class="mt-4">
                  <button @click="addNewMappingField" class="w-full p-3 border-2 border-dashed border-purple-300 text-purple-600 rounded hover:border-purple-400 hover:text-purple-700 text-sm transition-colors">
                    <div class="flex items-center justify-center space-x-2">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                      </svg>
                      <span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏¥‡∏•‡∏î‡πå‡πÉ‡∏´‡∏°‡πà</span>
                    </div>
                  </button>
                  <div class="mt-2 text-xs text-gray-500 text-center">
                    ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô, ‡πÅ‡∏ú‡∏ô‡∏Å, ‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ï‡∏£
                  </div>
                </div>
              </div>
              
              <!-- Processing Logic Info -->
              <div class="bg-blue-50 p-4 rounded-lg">
                <h3 class="font-medium text-blue-900 mb-3">‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•</h3>
                <div class="bg-white p-4 rounded border">
                  <div class="space-y-2 text-sm">
                    <div class="flex items-start">
                      <div class="w-2 h-2 bg-green-500 rounded-full mt-2 mr-3"></div>
                      <div>
                        <div class="font-medium text-green-700">‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</div>
                        <div class="text-gray-600">‚Üí ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£</div>
                        <div class="text-gray-600 ml-4">‚Ä¢ ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß: ‡∏Ç‡πâ‡∏≤‡∏°</div>
                        <div class="text-gray-600 ml-4">‚Ä¢ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô: ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</div>
                      </div>
                    </div>
                    
                    <div class="flex items-start">
                      <div class="w-2 h-2 bg-blue-500 rounded-full mt-2 mr-3"></div>
                      <div>
                        <div class="font-medium text-blue-700">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</div>
                        <div class="text-gray-600">‚Üí ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà ‚Üí ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
            </div>
            
            <!-- Modal Footer -->
            <div class="border-t p-4">
              <!-- Configuration Management Buttons -->
              <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-2">
                  <span class="text-sm font-medium text-gray-700">üíæ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤:</span>
                  
                  <!-- Load Configuration -->
                  <button @click="loadConfigFromLocalStorage" 
                          :disabled="!hasConfigInLocalStorage()"
                          class="flex items-center gap-1 px-3 py-1 text-xs rounded transition-colors"
                          :class="hasConfigInLocalStorage() ? 'bg-green-50 text-green-600 hover:bg-green-100' : 'bg-gray-100 text-gray-400 cursor-not-allowed'">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
                    </svg>
                    ‡πÇ‡∏´‡∏•‡∏î
                  </button>
                  
                  <!-- Save Configuration -->
                  <button @click="saveConfigToLocalStorage" 
                          class="flex items-center gap-1 bg-blue-50 text-blue-600 hover:bg-blue-100 px-3 py-1 text-xs rounded transition-colors">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3-3m0 0l-3 3m3-3v12"/>
                    </svg>
                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                  </button>
                  
                  <!-- Export Configuration -->
                  <button @click="exportConfigAsJSON" 
                          class="flex items-center gap-1 bg-purple-50 text-purple-600 hover:bg-purple-100 px-3 py-1 text-xs rounded transition-colors">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å
                  </button>
                  
                  <!-- Clear Configuration -->
                  <button @click="clearConfigFromLocalStorage" 
                          :disabled="!hasConfigInLocalStorage()"
                          class="flex items-center gap-1 px-3 py-1 text-xs rounded transition-colors"
                          :class="hasConfigInLocalStorage() ? 'bg-red-50 text-red-600 hover:bg-red-100' : 'bg-gray-100 text-gray-400 cursor-not-allowed'">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                    ‡∏•‡∏ö
                  </button>
                </div>
                
                <!-- Configuration Status -->
                <div class="flex items-center gap-2 text-xs text-gray-500">
                  <span v-if="hasConfigInLocalStorage()" class="flex items-center gap-1 text-green-600">
                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                    ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ
                  </span>
                  <span v-else class="flex items-center gap-1 text-gray-400">
                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                    </svg>
                    ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                  </span>
                </div>
              </div>
              
              <!-- Main Action Buttons -->
              <div class="flex justify-between">
                <!-- Debug Buttons -->
                <div class="flex space-x-2">
                  <button @click="debugCurrentConfig" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-2 rounded text-xs">
                    üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
                  </button>
                  <button @click="forceSaveCurrentConfig" class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-2 rounded text-xs">
                    üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                  </button>
                  <button @click="resetToBasicFields" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded text-xs">
                    üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏õ‡πá‡∏ô‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏´‡∏•‡∏±‡∏Å
                  </button>
                </div>
                
                <!-- Main Buttons -->
                <div class="flex space-x-2">
                  <button @click="closeMappingConfig" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded text-sm">
                    ‡∏õ‡∏¥‡∏î
                  </button>
                  <button @click="saveConfigToLocalStorage(); closeMappingConfig()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm">
                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Processing Results Modal -->
      <div v-if="showResultsModal" class="fixed inset-0 z-[50]">
        <div class="fixed inset-0 bg-black bg-opacity-50" @click="resetProcessingResults"></div>
        <div class="fixed inset-0 flex items-center justify-center p-4">
          <div class="bg-white w-full max-w-5xl max-h-[90vh] flex flex-col rounded-lg shadow-xl relative z-10">
            
            <!-- Modal Header -->
            <div class="border-b bg-gray-50 p-4">
              <h2 class="text-lg font-semibold">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
              <p class="text-sm text-gray-600 mt-1">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</p>
            </div>
            
            <!-- Modal Body -->
            <div class="overflow-y-auto flex-grow p-4">
              
              <!-- Summary Stats -->
              <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                <div class="bg-blue-50 p-4 rounded-lg text-center">
                  <div class="text-2xl font-bold text-blue-600">{{ processingResults.total }}</div>
                  <div class="text-sm text-blue-800">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                </div>
                
                <div class="bg-green-50 p-4 rounded-lg text-center">
                  <div class="text-2xl font-bold text-green-600">{{ processingResults.created }}</div>
                  <div class="text-sm text-green-800">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà</div>
                </div>
                
                <div class="bg-purple-50 p-4 rounded-lg text-center">
                  <div class="text-2xl font-bold text-purple-600">{{ processingResults.enrolled }}</div>
                  <div class="text-sm text-purple-800">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>
                </div>
                
                <div class="bg-yellow-50 p-4 rounded-lg text-center">
                  <div class="text-2xl font-bold text-yellow-600">{{ processingResults.skipped }}</div>
                  <div class="text-sm text-yellow-800">‡∏Ç‡πâ‡∏≤‡∏°</div>
                </div>
                
                <div class="bg-red-50 p-4 rounded-lg text-center">
                  <div class="text-2xl font-bold text-red-600">{{ processingResults.errors }}</div>
                  <div class="text-sm text-red-800">‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</div>
                </div>
              </div>
              
              <!-- Detailed Results -->
              <div class="bg-gray-50 rounded-lg p-4">
                <h3 class="font-medium mb-3">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•</h3>
                <div class="overflow-x-auto">
                  <table class="min-w-full text-sm">
                    <thead class="bg-gray-100">
                      <tr>
                        <th class="px-3 py-2 text-left">‡πÅ‡∏ñ‡∏ß</th>
                        <th class="px-3 py-2 text-left">‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th>
                        <th class="px-3 py-2 text-left">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</th>
                        <th class="px-3 py-2 text-left">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</th>
                      </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                      <tr v-for="detail in processingResults.details" :key="detail.row">
                        <td class="px-3 py-2">{{ detail.row }}</td>
                        <td class="px-3 py-2">
                          <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium"
                                :class="{
                                  'bg-green-100 text-green-800': detail.action === 'enrolled',
                                  'bg-blue-100 text-blue-800': detail.action === 'created',
                                  'bg-yellow-100 text-yellow-800': detail.action === 'skipped',
                                  'bg-red-100 text-red-800': detail.action === 'error'
                                }">
                            {{ detail.action === 'enrolled' ? '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô' : 
                               detail.action === 'created' ? '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ' :
                               detail.action === 'skipped' ? '‡∏Ç‡πâ‡∏≤‡∏°' : '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î' }}
                          </span>
                        </td>
                        <td class="px-3 py-2">{{ detail.message }}</td>
                        <td class="px-3 py-2">
                          {{ detail.user ? `${detail.user.firstname} ${detail.user.lastname}` : '-' }}
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            
            <!-- Modal Footer -->
            <div class="border-t p-4 flex justify-end space-x-2">
              <button @click="resetProcessingResults" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded text-sm">
                ‡∏õ‡∏¥‡∏î
              </button>
              <button @click="getData(); resetProcessingResults()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm">
                ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Exam Review Manager Component -->
      <ExamReviewManager
        ref="examReviewManager"
        :listItems="listItems"
        :dataItem="dataItem"
        :configs="configs"
        @grades-saved="handleExamGradesSaved"
        @exam-review-closed="handleExamReviewClosed"
      />

      <!-- Main Table Section -->
      <div class="bg-white shadow-sm border border-gray-200 rounded-lg">
        <!-- Controls -->
        <div class="bg-gray-50 border-b p-3">
          <div class="flex justify-between flex-col lg:flex-row gap-3">
            <div class="flex flex-col sm:flex-row gap-2">
              <input
                type="text"
                class="px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500 w-full sm:w-64"
                placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..."
                v-model="searchQuery"
              />
              <div v-if="searchQuery.length > 0" class="text-sm text-gray-600 flex items-center">
                ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ <span class="text-black font-semibold mx-1">{{ totalItems }}</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                <button @click="clearSearchQuery" class="ml-2 text-blue-500 hover:underline">
                  ‡∏•‡πâ‡∏≤‡∏á
                </button>
              </div>
            </div>

            <div class="flex items-center gap-2">
              <div class="flex items-center space-x-4 text-sm">
                <div class="flex items-center space-x-2">
                  <span class="text-gray-600">‡πÅ‡∏™‡∏î‡∏á:</span>
                  <select v-model="limitItem" @change="handleLimitChange" class="px-2 py-1 border border-gray-300 rounded text-sm">
                    <option v-for="option in limitOptions" :key="option" :value="option">{{ option }}</option>
                  </select>
                </div>

                <!-- Progressive Loading Controls -->
                <button v-if="hasMoreItems" @click="showAllItems" 
                        class="text-xs px-2 py-1 bg-orange-500 text-white rounded hover:bg-orange-600">
                  ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏•‡∏¢
                </button>
                
                <label class="flex items-center cursor-pointer">
                  <input type="checkbox" v-model="layoutVisibility.order" class="mr-2 rounded"/>
                  ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
                </label>
                <label class="flex items-center cursor-pointer">
                  <input type="checkbox" v-model="layoutVisibility.enroll" class="mr-2 rounded"/>
                  ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- Layout Options -->
        <div class="bg-gray-100 border-b p-2">
          <div class="flex gap-4 text-sm">
            <label class="flex items-center cursor-pointer">
              <input type="checkbox" v-model="layoutVisibility.order" class="mr-1 rounded"/>
              ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
            </label>
            <label class="flex items-center cursor-pointer">
              <input type="checkbox" v-model="layoutVisibility.enroll" class="mr-1 rounded"/>
              ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
            </label>
          </div>
        </div>

        <!-- Table Header -->
        <div class="bg-gray-200 border-b">
          <div class="grid grid-cols-12 text-sm font-medium text-gray-700">
            <div class="col-span-1 py-3 px-3 text-center">#</div>
            <div class="col-span-3 py-3 px-3">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</div>
            <div class="col-span-2 py-3 px-3 hidden lg:block">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</div>
            <div class="col-span-2 py-3 px-3 hidden md:block">‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</div>
            <div class="col-span-1 py-3 px-3 hidden lg:block text-center">‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£</div>
            <div class="col-span-1 py-3 px-3 hidden xl:block text-center">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</div>
            <div class="col-span-2 py-3 px-3 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</div>
          </div>
        </div>

        <!-- Table Body -->
        <div class="min-h-[400px] relative" :class="[(activeBlock ? 'isblock' : 'isunblock')]" v-if="!isModalOpen">
          <!-- Loading State -->
          <div v-if="loading">
            <!-- Loading Header -->
            <div class="flex items-center justify-center py-8 border-b border-gray-100">
              <div class="flex items-center space-x-2">
                <div class="inline-block animate-spin w-5 h-5 border-2 border-blue-500 border-t-transparent rounded-full"></div>
                <span class="text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</span>
              </div>
            </div>
            
            <!-- Skeleton Rows -->
            <div v-for="i in 5" :key="i" class="grid grid-cols-12 border-b border-gray-100 text-sm">
              <div class="col-span-1 py-4 flex items-center justify-center bg-gray-50">
                <div class="w-6 h-4 skeleton rounded"></div>
              </div>
              
              <div class="col-span-3 py-4 px-3">
                <div class="flex items-center">
                  <div class="w-10 h-10 skeleton rounded-full mr-3"></div>
                  <div class="flex-1">
                    <div class="w-32 h-4 skeleton rounded mb-1"></div>
                    <div class="w-20 h-3 skeleton rounded"></div>
                  </div>
                </div>
              </div>
              
              <div class="col-span-2 py-4 px-3 hidden lg:block">
                <div class="w-40 h-4 skeleton rounded"></div>
              </div>
              
              <div class="col-span-2 py-4 px-3 hidden md:block">
                <div class="space-y-2">
                  <div class="w-28 h-3 skeleton rounded"></div>
                  <div class="w-36 h-3 skeleton rounded"></div>
                </div>
              </div>
              
              <div class="col-span-1 py-4 px-3 hidden lg:block text-center">
                <div class="w-8 h-4 skeleton rounded mx-auto"></div>
              </div>
              
              <div class="col-span-1 py-4 px-3 hidden xl:block text-center">
                <div class="w-20 h-3 skeleton rounded mx-auto"></div>
              </div>
              
              <div class="col-span-2 py-4 px-3">
                <div class="flex items-center justify-center space-x-1">
                  <div class="w-8 h-8 skeleton rounded-lg"></div>
                  <div class="w-8 h-8 skeleton rounded-lg"></div>
                  <div class="w-8 h-8 skeleton rounded-lg"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Empty State -->
          <div v-else-if="listItems.length === 0" class="flex items-center justify-center py-20">
            <div class="text-center">
              <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <font-awesome-icon :icon="['fas','users']" class="text-gray-400 text-3xl" />
              </div>
              <h3 class="text-xl font-semibold text-gray-900 mb-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h3>
              <p class="text-gray-500 mb-8 max-w-md mx-auto">
                ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏î‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏ô‡∏µ‡πâ 
                <br />‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
              </p>
              <div class="space-y-3">
                <button
                  @click="assignUserModal"
                  type="button"
                  class="inline-flex items-center px-6 py-3 border border-transparent bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors shadow-sm"
                >
                  <font-awesome-icon :icon="['fas', 'plus']" class="mr-2" />
                  ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å
                </button>
                <div class="text-sm text-gray-400">
                  ‡∏´‡∏£‡∏∑‡∏≠ <a href="#" @click="exportToCSV" class="text-blue-600 hover:underline">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏≤‡∏Å CSV</a>
                </div>
              </div>
            </div>
          </div>

          <!-- Data Rows -->
          <template v-else v-for="(item, index) in visibleItems" :key="item.user._id">
            <!-- Main Row -->
            <div class="grid grid-cols-12 border-b border-gray-100 text-sm hover:bg-gray-50 transition-colors">
              <div class="col-span-1 py-4 flex items-center justify-center bg-gray-50">
                <span class="text-gray-600 font-medium text-base">{{ leadingZero((currentPage - 1) * limitItem + index + 1) }}</span>
              </div>

              <div class="col-span-3 py-4 px-3">
                <router-link :to="'/student/detail/'+item.user._id+'?back=/lesson/detail/'+this.dataItem + '/enroll'" class="group">
                  <div class="flex items-center">
                    <div class="relative">
                      <!-- Avatar with fallback to initials -->
                      <div v-if="shouldShowInitials(item.user)" 
                           :class="['w-10 h-10 mr-3 rounded-full ring-2 ring-gray-100 group-hover:ring-blue-200 transition-all flex items-center justify-center text-white font-semibold text-sm', getAvatarBgColor(item.user.firstname, item.user.lastname)]">
                        {{ getInitials(item.user.firstname, item.user.lastname) }}
                      </div>
                      <img v-else
                           :src="item.user.avatar_img" 
                           class="w-10 h-10 mr-3 rounded-full bg-gray-200 ring-2 ring-gray-100 group-hover:ring-blue-200 transition-all" 
                           alt="Profile"
                           @error="onImageError(item.user._id)"
                           @load="onImageLoad(item.user._id)">
                      
                      <!-- Status indicators -->
                      <div class="absolute -bottom-1 -right-1 w-4 h-4 bg-green-400 rounded-full border-2 border-white" v-if="item.enroll?.analytics?.status === 'complete'" title="‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß"></div>
                      <div class="absolute -bottom-1 -right-1 w-4 h-4 bg-yellow-400 rounded-full border-2 border-white" v-else-if="item.enroll?.analytics?.status === 'processing'" title="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô"></div>
                      <div class="absolute -bottom-1 -right-1 w-4 h-4 bg-gray-400 rounded-full border-2 border-white" v-else title="‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ô"></div>
                    </div>
                    <div class="min-w-0 flex-1">
                      <div class="font-medium text-gray-900 group-hover:text-blue-600 transition-colors">
                        {{ item.user.firstname }} {{ item.user.lastname }}
                      </div>
                      <div class="text-xs text-gray-500 truncate">
                        ID: {{ item.user._id.slice(-8) }}
                      </div>
                    </div>
                  </div>
                </router-link>
              </div>

              <div class="col-span-2 py-4 px-3 hidden lg:block">
                <div class="flex items-center text-gray-600">
                  <font-awesome-icon :icon="['fas','id-card']" class="mr-2 text-xs text-gray-400"/>
                  <span class="font-mono text-sm">{{ item.user.citizen || '-' }}</span>
                </div>
              </div>

              <div class="col-span-2 py-4 px-3 hidden md:block">
                <div class="space-y-1">
                  <div class="flex items-center text-gray-600">
                    <font-awesome-icon :icon="['fas','phone']" class="mr-2 text-xs text-gray-400"/>
                    <span class="text-sm">{{ item.user.phone || '-' }}</span>
                  </div>
                  <div class="flex items-center text-gray-600">
                    <font-awesome-icon :icon="['fas','envelope']" class="mr-2 text-xs text-gray-400"/>
                    <span class="text-sm truncate max-w-[180px]" :title="item.user.email">{{ item.user.email || '-' }}</span>
                  </div>
                </div>
              </div>

              <div class="col-span-1 py-4 px-3 hidden lg:block text-center">
                <div class="inline-flex items-center">
                  <span class="font-semibold text-lg text-blue-600">{{ item.user.enroll ? (item.user.enroll.length > 0 ? item.user.enroll.length : '0') : '0' }}</span>
                  <font-awesome-icon :icon="['fas','book']" class="ml-1 text-gray-400 text-xs"/>
                </div>
              </div>

              <div class="col-span-1 py-4 px-3 hidden xl:block text-center">
                <div class="text-xs text-gray-600">
                  {{ item.enroll.createdAt ? formatThaidate(item.enroll.createdAt) : "-" }}
                </div>
              </div>

              <!-- Actions Column -->
              <div class="col-span-2 py-4 px-3">
                <div class="flex items-center justify-center space-x-1">
                  <!-- Quick Actions -->
                  <div class="flex items-center space-x-1">
                    <button 
                      @click="$router.push('/student/detail/'+ item.user._id)"
                      class="p-2 text-blue-600 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors group"
                      title="‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î"
                    >
                      <font-awesome-icon :icon="['fas','eye']" class="text-xs group-hover:scale-110 transition-transform"/>
                    </button>
                    
                    <button 
                      @click="$router.push('/lesson/edit/'+ item.user._id)"
                      class="p-2 text-green-600 bg-green-50 hover:bg-green-100 rounded-lg transition-colors group"
                      title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"
                    >
                      <font-awesome-icon :icon="['fas','edit']" class="text-xs group-hover:scale-110 transition-transform"/>
                    </button>

                    <!-- More Actions Dropdown -->
                    <div class="relative">
                      <button 
                        @click="toggleActionDropdown(item.user._id)"
                        class="p-2 text-gray-600 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors group"
                        title="‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"
                      >
                        <font-awesome-icon :icon="['fas','ellipsis-vertical']" class="text-xs group-hover:scale-110 transition-transform"/>
                      </button>
                      
                      <div v-if="activeDropdown === item.user._id" class="absolute right-0 z-20 mt-1 w-48 bg-white rounded-lg shadow-lg border border-gray-200 py-1">
                        <button 
                          @click="sendNotification(item.user._id)"
                          class="w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center"
                        >
                          <font-awesome-icon :icon="['fas','bell']" class="mr-2 text-xs"/>
                          ‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
                        </button>
                        <button 
                          @click="resetProgress(item.user._id)"
                          class="w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center"
                        >
                          <font-awesome-icon :icon="['fas','redo']" class="mr-2 text-xs"/>
                          ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤
                        </button>
                        <button 
                          @click="generateCertificate(item.user._id)"
                          class="w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center"
                          v-if="item.enroll?.analytics?.status === 'complete'"
                        >
                          <font-awesome-icon :icon="['fas','certificate']" class="mr-2 text-xs"/>
                          ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á
                        </button>
                        <hr class="my-1">
                        <button 
                          @click="removeEnrollment(item.user._id)"
                          class="w-full text-left px-3 py-2 text-sm text-red-600 hover:bg-red-50 flex items-center"
                        >
                          <font-awesome-icon :icon="['fas','trash']" class="mr-2 text-xs"/>
                          ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Mobile View -->
            <div class="md:hidden border-b border-gray-200 bg-gray-50">
              <div class="p-3">
                <!-- Mobile contact info -->
                <div class="space-y-2 mb-3">
                  <div class="lg:hidden flex items-center text-gray-600">
                    <font-awesome-icon :icon="['fas','id-card']" class="mr-2 text-xs text-gray-400"/>
                    <span class="font-mono text-sm">{{ item.user.citizen || '-' }}</span>
                  </div>
                  <div class="md:hidden flex items-center text-gray-600">
                    <font-awesome-icon :icon="['fas','phone']" class="mr-2 text-xs text-gray-400"/>
                    <span class="text-sm">{{ item.user.phone || '-' }}</span>
                  </div>
                  <div class="md:hidden flex items-center text-gray-600">
                    <font-awesome-icon :icon="['fas','envelope']" class="mr-2 text-xs text-gray-400"/>
                    <span class="text-sm truncate">{{ item.user.email || '-' }}</span>
                  </div>
                </div>
                
                <!-- Mobile action buttons -->
                <div class="flex flex-wrap gap-2">
                  <button @click="$router.push('/student/detail/'+ item.user._id)" class="flex-1 bg-blue-600 text-white px-3 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors">
                    <font-awesome-icon :icon="['fas','eye']" class="mr-1"/>
                    ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                  </button>
                  <button @click="$router.push('/lesson/edit/'+ item.user._id)" class="flex-1 bg-green-600 text-white px-3 py-2 rounded-lg text-sm font-medium hover:bg-green-700 transition-colors">
                    <font-awesome-icon :icon="['fas','edit']" class="mr-1"/>
                    ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                  </button>
                </div>
              </div>
            </div>

            <!-- Details Section -->
            <div v-if="Object.values(layoutVisibility).some(option => option)" class="border-b border-gray-200 bg-gray-50">
              <div class="p-3">
                <!-- Enrollment Details -->
                <div v-if="layoutVisibility.enroll" class="space-y-3">
                  <!-- Progress Cards -->
                  <div class="grid grid-cols-2 md:grid-cols-5 gap-2">
                    <div class="bg-white p-3 border border-gray-200">
                      <div class="text-xs text-gray-600 mb-1">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</div>
                      <div class="text-lg font-semibold text-gray-900">
                        <template v-if="item.enroll?.analytics?.status === 'complete'">
                          {{ item.enroll?.analytics?.complete || 'N/A' }}
                        </template>
                        <template v-else-if="item.enroll?.analytics?.status === 'processing'">
                          {{ item.enroll?.analytics?.complete || '0' }} / {{ (item.enroll?.analytics?.total || '') }}
                        </template>
                        <template v-else>
                          0 / {{ (item.enroll?.analytics?.total || '') }}
                        </template>
                      </div>
                    </div>

                    <div class="bg-white p-3 border border-gray-200">
                      <div class="text-xs text-gray-600 mb-1">‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
                      <div class="text-lg font-semibold" :class="[item.enroll?.analytics?.pre?.score >= 33 ? 'text-green-600' : 'text-red-600']">
                        {{ item.enroll?.analytics?.pre?.score || 'N/A' }}
                      </div>
                      <div class="mt-2 flex gap-1 flex-wrap">
                        <button @click="resetScore(item.enroll?.examPre[0]?._id, item.user._id, item.enroll._id)" class="text-xs bg-gray-100 text-gray-700 px-2 py-1 hover:bg-gray-200">
                          ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
                        </button>
                        <div class="relative">
                          <button @click="toggleDropdown" class="text-xs bg-gray-100 text-gray-700 px-2 py-1 hover:bg-gray-200">
                            ‡∏Ç‡πâ‡∏≤‡∏°
                          </button>
                          <div v-if="dropdownVisible" class="absolute right-0 z-10 mt-1 w-44 bg-white border border-gray-200 text-xs">
                            <a href="#" @click.prevent="bypassVerified(item.enroll._id, 'pre',item.enroll.verified)" class="block px-3 py-2 text-gray-700 hover:bg-gray-100">
                              ‡∏Ç‡πâ‡∏≤‡∏° Verified (‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô)
                            </a>
                            <a href="#" @click.prevent="bypassVerified(item.enroll._id, 'post',item.enroll.verified)" class="block px-3 py-2 text-gray-700 hover:bg-gray-100">
                              ‡∏Ç‡πâ‡∏≤‡∏° Verified (‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô)
                            </a>
                          </div>
                        </div>
                        <button 
                          @click="reviewExam(item.user._id, item.enroll_id, 'pre')"
                          class="text-xs text-blue-600 bg-blue-50 border border-blue-200 px-2 py-1 hover:bg-blue-100"
                        >
                          <font-awesome-icon :icon="['fas','clipboard-check']" class="mr-1"/>
                          ‡∏ï‡∏£‡∏ß‡∏à‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö
                        </button>
                      </div>
                    </div>

                    <div class="bg-white p-3 border border-gray-200">
                      <div class="text-xs text-gray-600 mb-1">‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
                      <div class="text-lg font-semibold" :class="[item.enroll?.analytics?.post?.score > 32 ? 'text-green-600' : 'text-red-600']">
                        {{ item.enroll?.analytics?.post?.score || 'N/A' }}
                      </div>
                      <div class="mt-2">
                        <button 
                          @click="reviewExam(item.user._id, item.enroll_id, 'post')"
                          class="text-xs text-green-600 bg-green-50 border border-green-200 px-2 py-1 hover:bg-green-100"
                        >
                          <font-awesome-icon :icon="['fas','clipboard-check']" class="mr-1"/>
                          ‡∏ï‡∏£‡∏ß‡∏à‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö
                        </button>
                      </div>
                    </div>

                    <div class="bg-white p-3 border border-gray-200">
                      <div class="text-xs text-gray-600 mb-1">‡∏™‡∏≠‡∏ö‡∏ã‡πà‡∏≠‡∏°</div>
                      <div class="text-lg font-semibold" :class="[item.enroll?.analytics?.retest?.score > 32 ? 'text-green-600' : 'text-red-600']">
                        {{ item.enroll?.analytics?.retest?.score || 'N/A' }}
                      </div>
                    </div>

                    <div class="bg-white p-3 border border-gray-200">
                      <div class="text-xs text-gray-600 mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
                      <div class="text-sm font-medium" :class="[item.enroll?.analytics?.post?.message === '‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á' ? 'text-green-600' : 'text-red-600']">
                        {{ item.enroll?.analytics?.post?.message || 'N/A' }}
                      </div>
                    </div>
                  </div>

                  <!-- Additional Tools -->
                  <div class="bg-white p-3 border border-gray-200">
                    <div class="flex items-center justify-between">
                      <h4 class="text-sm font-medium text-gray-900">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</h4>
                      <div class="flex gap-2">
                        <button 
                          @click="generateDetailReport(item.user._id)"
                          class="inline-flex items-center px-3 py-1.5 text-xs text-blue-600 bg-gray-100 border border-gray-300 hover:bg-gray-200"
                        >
                          <font-awesome-icon :icon="['fas','file-alt']" class="mr-1"/>
                          ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                        </button>
                        
                        <button 
                          @click="sendProgressUpdate(item.user._id)"
                          class="inline-flex items-center px-3 py-1.5 text-xs text-green-600 bg-gray-100 border border-gray-300 hover:bg-gray-200"
                        >
                          <font-awesome-icon :icon="['fas','paper-plane']" class="mr-1"/>
                          ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤
                        </button>

                        <Limit/>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </template>

          <!-- üöÄ PROGRESSIVE/LAZY LOADING INDICATORS -->
          <div v-if="lazy" class="border-t border-gray-200 bg-white">
            <div class="p-4 flex items-center justify-center space-x-4">
              <!-- Loading Indicator -->
              <div v-if="isLoadingMore" class="flex items-center space-x-2 text-blue-600">
                <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="text-sm">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°...</span>
              </div>
              
              <!-- Manual Load More Button -->
              <button v-else-if="hasMoreItems" @click="loadMoreItems" 
                      class="inline-flex items-center px-4 py-2 border border-blue-300 rounded-md text-sm font-medium text-blue-700 bg-blue-50 hover:bg-blue-100 transition-colors">
                <font-awesome-icon :icon="['fas','plus']" class="mr-2" />
                ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏° ({{ progressiveLoadingStats?.remaining || 0 }} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)
              </button>
              
              <!-- All Loaded Message -->
              <div v-else class="text-sm text-green-600">
                <font-awesome-icon :icon="['fas','check-circle']" class="mr-1" />
                ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏£‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß ({{ progressiveLoadingStats?.total || 0 }} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)
              </div>
            </div>
          </div>

          <!-- üöÄ PROGRESSIVE/LAZY LOADING - Floating Progress Toast -->
          <transition name="toast-slide">
            <div v-if="showProgressToast && progressiveLoadingStats && progressiveLoadingStats.percentage < 100" 
                 class="fixed bottom-6 left-1/2 transform -translate-x-1/2 z-40 pointer-events-none">
              <div class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow-lg flex items-center space-x-3 pointer-events-auto">
                <!-- Progress Stats -->
                <div class="flex items-center space-x-2">
                  <font-awesome-icon :icon="['fas','list']" class="text-blue-200" />
                  <span class="text-sm font-medium">
                    ‡πÅ‡∏™‡∏î‡∏á {{ progressiveLoadingStats.showing }} / {{ progressiveLoadingStats.total }} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                  </span>
                </div>
                
                <!-- Progress Bar -->
                <div class="w-20 bg-blue-500 rounded-full h-1.5">
                  <div class="bg-white h-1.5 rounded-full transition-all duration-300" 
                       :style="`width: ${progressiveLoadingStats.percentage}%`"></div>
                </div>
                
                <!-- Percentage -->
                <span class="text-xs text-blue-200 font-medium">{{ progressiveLoadingStats.percentage }}%</span>
                
                <!-- Show All Button -->
                <button v-if="hasMoreItems" @click="showAllItems" 
                        class="text-xs px-2 py-1 bg-white bg-opacity-20 rounded hover:bg-opacity-30 transition-colors">
                  ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </button>
              </div>
            </div>
          </transition>
        </div>

        <!-- Pagination Footer -->
        <div v-if="listItems.length > 0" class="bg-white border-t border-gray-200 px-4 py-3">
          <Pagination
            :current-page="currentPage"
            :total-items="totalItems"
            :total-pages="totalPages"
            :limit-items="limitItem"
            :data-loading="loading"
            :display-mode="'summary'"
            @page-changed="handlePageChanged"
          />
        </div>
      </div>
    </div>
    
    <!-- üéâ Toast Notification -->
    <transition name="toast-fade">
      <div v-if="toastVisible" class="fixed top-4 right-4 z-[70] max-w-sm">
        <div class="p-4 rounded-lg shadow-lg border-l-4 bg-white" 
             :class="{
               'border-green-500': toastType === 'success',
               'border-red-500': toastType === 'error', 
               'border-yellow-500': toastType === 'warning',
               'border-blue-500': toastType === 'info'
             }">
          <div class="flex items-start">
            <div class="flex-shrink-0">
              <!-- Success Icon -->
              <svg v-if="toastType === 'success'" class="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
              <!-- Error Icon -->
              <svg v-else-if="toastType === 'error'" class="w-5 h-5 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
              </svg>
              <!-- Warning Icon -->
              <svg v-else-if="toastType === 'warning'" class="w-5 h-5 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
              </svg>
              <!-- Info Icon -->
              <svg v-else class="w-5 h-5 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
              </svg>
            </div>
            <div class="ml-3 flex-1">
              <p class="text-sm text-gray-800">{{ toastMessage }}</p>
            </div>
            <div class="ml-3 flex-shrink-0">
              <button @click="hideToast" class="text-gray-400 hover:text-gray-600">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>
    </transition>
  </div>
</template>

<style scoped>
/* üéâ Toast Fade Animation */
.toast-fade-enter-active,
.toast-fade-leave-active {
  transition: all 0.3s ease;
}

.toast-fade-enter-from {
  opacity: 0;
  transform: translateX(100%);
}

.toast-fade-leave-to {
  opacity: 0;
  transform: translateX(100%);
}

/* üöÄ PROGRESSIVE/LAZY LOADING - Toast Animation */
.toast-slide-enter-active,
.toast-slide-leave-active {
  transition: all 0.3s ease-in-out;
}

.toast-slide-enter-from {
  transform: translate(-50%, 100%);
  opacity: 0;
}

.toast-slide-leave-to {
  transform: translate(-50%, 100%);
  opacity: 0;
}

.toast-slide-enter-to,
.toast-slide-leave-from {
  transform: translate(-50%, 0);
  opacity: 1;
}
</style>

<style>
.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  z-index: 9999;
}

.loading-text {
  color: #fff;
  font-size: 24px;
  margin-bottom: 10px;
}

.processing-count {
  color: #fff;
  font-size: 18px;
}

/* CSS to disable body scrolling when the modal is open */
.body-scroll-lock {
  overflow: hidden;
}

/* Enhanced table styles */
.table-row-hover:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
}

/* Action button animations */
.action-btn {
  transition: all 0.2s ease-in-out;
}

.action-btn:hover {
  transform: scale(1.05);
}

/* Status indicator pulses */
.status-indicator {
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% {
    opacity: 1;
  }
  50% {
    opacity: 0.5;
  }
}

/* Card hover effects */
.progress-card {
  transition: all 0.3s ease;
}

.progress-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
}

/* Gradient backgrounds */
.gradient-bg {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

/* Responsive grid improvements */
@media (max-width: 768px) {
  .mobile-stack {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
}

/* Loading states */
.skeleton {
  background: linear-gradient(90deg, #f0f0f0 25%, transparent 37%, #f0f0f0 63%);
  background-size: 400% 100%;
  animation: skeleton 1.4s ease infinite;
}

@keyframes skeleton {
  0% {
    background-position: 100% 50%;
  }
  100% {
    background-position: 0 50%;
  }
}

/* Enhanced dropdown styling */
.dropdown-enter-active {
  transition: all 0.2s ease-out;
}

.dropdown-leave-active {
  transition: all 0.15s ease-in;
}

.dropdown-enter-from {
  opacity: 0;
  transform: translateY(-10px);
}

.dropdown-leave-to {
  opacity: 0;
  transform: translateY(-10px);
}

/* Better scrollbars */
::-webkit-scrollbar {
  width: 6px;
  height: 6px;
}

::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 3px;
}

::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 3px;
}

::-webkit-scrollbar-thumb:hover {
  background: #a8a8a8;
}

/* Progress indicators */
.progress-ring {
  transform: rotate(-90deg);
}

.progress-ring-circle {
  transition: stroke-dashoffset 0.35s;
  transform-origin: 50% 50%;
}

/* Modern badge styles */
.badge {
  display: inline-flex;
  align-items: center;
  padding: 0.25rem 0.5rem;
  border-radius: 0.5rem;
  font-size: 0.75rem;
  font-weight: 500;
  white-space: nowrap;
}

.badge-success {
  background-color: #d1fae5;
  color: #065f46;
}

.badge-warning {
  background-color: #fef3c7;
  color: #92400e;
}

.badge-error {
  background-color: #fee2e2;
  color: #991b1b;
}

.badge-info {
  background-color: #dbeafe;
  color: #1e40af;
}

/* Avatar initials styles */
.avatar-initials {
  background: linear-gradient(135deg, var(--tw-gradient-stops));
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  user-select: none;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  font-weight: 600;
  letter-spacing: -0.02em;
}

.avatar-initials:hover {
  transform: scale(1.05);
}

/* Enhanced avatar containers */
.avatar-container {
  position: relative;
  display: inline-block;
}

.avatar-container::before {
  content: '';
  position: absolute;
  top: -2px;
  left: -2px;
  right: -2px;
  bottom: -2px;
  background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
  border-radius: 50%;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.avatar-container:hover::before {
  opacity: 1;
}

/* Fallback for empty avatars */
.avatar-fallback {
  background: linear-gradient(135deg, #6b73ff 0%, #9c88ff 100%);
}
</style>