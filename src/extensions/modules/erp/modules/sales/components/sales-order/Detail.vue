<template>
  <div class="min-h-screen bg-gray-50">
    <!-- Header Section -->
    <div class="bg-white shadow-sm border-b border-gray-200">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-3xl font-bold text-gray-900">Sales Order Detail</h1>
            <p v-if="order" class="mt-2 text-gray-600">‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏Ç‡∏≤‡∏¢ / Sales Order - <span class="font-mono">{{ order.orderNumber }}</span></p>
            <p v-else class="mt-2 text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
          </div>
          <div class="flex space-x-3">
            <button 
              class="bg-gray-600 h          // Ad        }

        // Save to engine with minimal update data matching schema        
        const result = await engine.update(TRANSACTION_TYPES.SALES, order.value.id, updateData)vity log to update data if it exists
        if (order.value.activityLog && Array.isArray(order.value.activityLog)) {
          updateData.activityLog = [...order.value.activityLog, newActivityEntry]
        } else {
          updateData.activityLog = [newActivityEntry]
        }

        // Save to engine with minimal update data matching schema
        const result = await engine.update(TRANSACTION_TYPES.SALES, order.value.id, updateData)lse {
          updateData.activityLog = [newActivityEntry]
        }

        // Save to engine with minimal update data matching schema
        const result = await engine.update(TRANSACTION_TYPES.SALES, order.value.id, updateData)   // Save to engine with minimal update data matching schema
        const result = await engine.update(TRANSACTION_TYPES.SALES, order.value.id, updateData)   // Save to engine with minimal update data matching schema
        console.log('üì§ Sending update data:', updateData):bg-gray-700 text-white px-4 py-2 rounded-lg font-medium transition-colors inline-flex items-center"
              @click="$router.go(-1)"
            >
              <i class="fas fa-arrow-left mr-2"></i>
              ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
            </button>
            <button 
              v-if="order"
              class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors inline-flex items-center"
              @click="editOrder"
            >
              <i class="fas fa-edit mr-2"></i>
              ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
            </button>
            <button 
              v-if="order"
              class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors inline-flex items-center"
              @click="printOrder"
            >
              <i class="fas fa-print mr-2"></i>
              ‡∏û‡∏¥‡∏°‡∏û‡πå
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Breadcrumb Navigation -->
    <ErpBreadcrumb :nav="breadcrumbNav" />

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- Loading State -->
      <div v-if="loading" class="animate-pulse">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <div class="lg:col-span-2 space-y-6">
            <div class="bg-white rounded-lg p-6">
              <div class="h-6 bg-gray-200 rounded mb-4"></div>
              <div class="space-y-3">
                <div class="h-4 bg-gray-200 rounded"></div>
                <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                <div class="h-4 bg-gray-200 rounded w-1/2"></div>
              </div>
            </div>
          </div>
          <div class="space-y-6">
            <div class="bg-white rounded-lg p-6">
              <div class="h-6 bg-gray-200 rounded mb-4"></div>
              <div class="space-y-3">
                <div class="h-4 bg-gray-200 rounded"></div>
                <div class="h-4 bg-gray-200 rounded"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Error State -->
      <div v-else-if="error" class="flex flex-col items-center justify-center py-16 text-center">
        <div class="bg-red-50 rounded-full p-6 mb-6">
          <i class="fas fa-exclamation-triangle text-4xl text-red-500"></i>
        </div>
        <h3 class="text-xl font-semibold text-gray-900 mb-2">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h3>
        <p class="text-gray-600 mb-6 max-w-md">{{ error }}</p>
        <button 
          class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors inline-flex items-center"
          @click="loadOrder"
        >
          <i class="fas fa-refresh mr-2"></i>
          ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
        </button>
      </div>

      <!-- Not Found State -->
      <div v-else-if="!order" class="flex flex-col items-center justify-center py-20 text-center">
        <div class="bg-gray-100 rounded-full p-8 mb-6">
          <i class="fas fa-search text-5xl text-gray-400"></i>
        </div>
        <h3 class="text-2xl font-semibold text-gray-900 mb-3">‡πÑ‡∏°‡πà‡∏û‡∏ö Sales Order</h3>
        <p class="text-gray-600 mb-8 max-w-md">Sales Order ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
        <button 
          class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors inline-flex items-center"
          @click="$router.push('/sales/sales-order')"
        >
          <i class="fas fa-list mr-2"></i>
          ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
        </button>
      </div>
      <!-- Order Detail Content -->
      <div v-else-if="order" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Main Details -->
        <div class="lg:col-span-2 space-y-6">
          <!-- Document Flow -->
          <div v-if="order" class="bg-white rounded shadow-sm p-4 border border-gray-200">
            <h3 class="text-sm font-medium text-gray-700 mb-3">‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á</h3>
            
            <div class="flex items-center gap-2 text-xs">
              <!-- Quotation -->
              <div 
                v-if="linkedQuotation"
                @click="viewDocument('quotation', linkedQuotation.id || linkedQuotation._id)"
                class="flex-1 p-2 rounded border border-gray-400 bg-white cursor-pointer hover:bg-gray-50"
              >
                <div class="text-gray-600 mb-0.5">‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</div>
                <div class="font-semibold text-gray-900">{{ linkedQuotation.quoteNumber || linkedQuotation.quote_number || linkedQuotation.quotation_number }}</div>
              </div>
              <div v-else class="flex-1 p-2 rounded border border-dashed border-gray-300 bg-gray-50">
                <div class="text-gray-400">‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</div>
                <div class="text-gray-400 text-xs">-</div>
              </div>
              
              <i class="fas fa-arrow-right text-gray-400 text-sm"></i>
              
              <!-- Invoice -->
              <div 
                v-if="linkedInvoice"
                @click="viewDocument('invoice', linkedInvoice.id || linkedInvoice._id)"
                class="flex-1 p-2 rounded border border-gray-400 bg-white cursor-pointer hover:bg-gray-50"
              >
                <div class="text-gray-600 mb-0.5">‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ</div>
                <div class="font-semibold text-gray-900">{{ linkedInvoice.invoiceNumber || linkedInvoice.invoice_number }}</div>
              </div>
              <div v-else class="flex-1 p-2 rounded border border-dashed border-gray-300 bg-gray-50">
                <div class="text-gray-400">‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ</div>
                <div class="text-gray-400 text-xs">-</div>
              </div>
              
              <i class="fas fa-arrow-right text-gray-400 text-sm"></i>
              
              <!-- Sales Order (Current) -->
              <div class="flex-1 p-2 rounded border-2 border-gray-600 bg-gray-50">
                <div class="text-gray-600 mb-0.5">‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏Ç‡∏≤‡∏¢</div>
                <div class="font-semibold text-gray-900">{{ order.orderNumber || order.order_number }}</div>
              </div>
            </div>
          </div>

          <!-- Order Status -->
          <div class="bg-white rounded-lg shadow-sm">
            <div class="px-6 py-4 border-b border-gray-200">
              <h3 class="text-lg font-semibold text-gray-900">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h3>
            </div>
            <div class="p-6 text-center">
              <span class="inline-flex px-6 py-3 text-lg font-semibold rounded-full" :class="getStatusClass(order.status)">
                {{ getStatusText(order.status) }}
              </span>
            </div>
          </div>

          <!-- Basic Information -->
          <div class="bg-white rounded-lg shadow-sm">
            <div class="px-6 py-4 border-b border-gray-200">
              <h3 class="text-lg font-semibold text-gray-900">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h3>
            </div>
            <div class="p-6">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç SO</label>
                  <div class="p-3 bg-gray-50 rounded-lg border">
                    <p class="text-gray-900 font-mono font-semibold">{{ order.orderNumber }}</p>
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á</label>
                  <div class="p-3 bg-gray-50 rounded-lg border">
                    <p class="text-gray-900">{{ formatDate(order.orderDate) }}</p>
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö</label>
                  <div class="p-3 bg-gray-50 rounded-lg border">
                    <p class="text-gray-900">{{ formatDate(order.deliveryDate) || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' }}</p>
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                  <div class="p-3 bg-gray-50 rounded-lg border">
                    <span class="inline-flex px-3 py-1 text-sm font-semibold rounded-full" :class="getStatusClass(order.status)">
                      {{ getStatusText(order.status) }}
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Customer Information -->
          <div class="bg-white rounded-lg shadow-sm">
            <div class="px-6 py-4 border-b border-gray-200">
              <h3 class="text-lg font-semibold text-gray-900">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h3>
            </div>
            <div class="p-6">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
                  <div class="p-3 bg-gray-50 rounded-lg border">
                    <p class="text-gray-900 font-semibold">{{ order.customerName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' }}</p>
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label>
                  <div class="p-3 bg-gray-50 rounded-lg border">
                    <p class="text-gray-900">{{ order.customerPhone || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' }}</p>
                  </div>
                </div>
                <div class="md:col-span-2">
                  <label class="block text-sm font-medium text-gray-700 mb-2">Customer ID</label>
                  <div class="p-3 bg-gray-50 rounded-lg border">
                    <p class="text-gray-900 font-mono">{{ order.customerId || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' }}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Stock Reservation Status -->
          <div v-if="order.status === 'confirmed' || stockReservations.length > 0" class="bg-white rounded-lg shadow-sm">
            <div class="px-6 py-4 border-b border-gray-200">
              <h3 class="text-lg font-semibold text-gray-900">
                <i class="fas fa-lock mr-2 text-blue-600"></i>
                ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å
              </h3>
            </div>
            <div class="p-6">
              <div v-if="stockReservations.length > 0" class="space-y-4">
                <!-- Reservation Summary -->
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                  <div class="flex items-center">
                    <div class="flex-shrink-0">
                      <i class="fas fa-check-circle text-green-600 text-xl"></i>
                    </div>
                    <div class="ml-3">
                      <h4 class="text-sm font-medium text-green-800">‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß</h4>
                      <p class="text-sm text-green-700">
                        ‡∏à‡∏≠‡∏á‡πÑ‡∏ß‡πâ {{ stockReservations.length }} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ 
                        ‡∏£‡∏ß‡∏° {{ totalReservedQuantity }} ‡∏´‡∏ô‡πà‡∏ß‡∏¢
                      </p>
                    </div>
                  </div>
                </div>

                <!-- Reservation Details -->
                <div class="overflow-hidden border border-gray-200 rounded-lg">
                  <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                      <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                          ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                        </th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                          ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏≠‡∏á
                        </th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                          ‡∏´‡∏ô‡πà‡∏ß‡∏¢
                        </th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                          ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á
                        </th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                          ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                        </th>
                      </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                      <tr v-for="reservation in stockReservations" :key="reservation.id" class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                          <div class="text-sm font-medium text-gray-900">
                            {{ reservation.product_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' }}
                          </div>
                          <div v-if="reservation.sku" class="text-sm text-gray-500">
                            SKU: {{ reservation.sku }}
                          </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-semibold text-gray-900">
                          {{ reservation.quantity || 0 }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">
                          {{ reservation.unit || '‡∏ä‡∏¥‡πâ‡∏ô' }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">
                          {{ formatDate(reservation.movement_date) }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                          <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                            ‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß
                          </span>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- No Reservations -->
              <div v-else-if="order.status === 'confirmed'" class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <div class="flex items-center">
                  <div class="flex-shrink-0">
                    <i class="fas fa-exclamation-triangle text-yellow-600 text-xl"></i>
                  </div>
                  <div class="ml-3">
                    <h4 class="text-sm font-medium text-yellow-800">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å</h4>
                    <p class="text-sm text-yellow-700">
                      ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å
                    </p>
                  </div>
                </div>
              </div>

              <!-- Action Buttons -->
              <div class="mt-4 pt-4 border-t border-gray-200 flex flex-wrap gap-3">
                <button 
                  @click="checkStockReservations"
                  :disabled="loadingReservations"
                  class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors inline-flex items-center"
                >
                  <i v-if="loadingReservations" class="fas fa-spinner fa-spin mr-2"></i>
                  <i v-else class="fas fa-sync mr-2"></i>
                  {{ loadingReservations ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...' : '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á' }}
                </button>
                
                <button 
                  @click="debugInventoryData"
                  class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-medium transition-colors inline-flex items-center"
                >
                  <i class="fas fa-bug mr-2"></i>
                  Debug ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </button>
              </div>
            </div>
          </div>

          <!-- Items Section -->
          <div class="bg-white rounded-lg shadow-sm">
            <div class="px-6 py-4 border-b border-gray-200">
              <h3 class="text-lg font-semibold text-gray-900">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
            </div>
            <div class="p-6">
              <div v-if="order.items && order.items.length > 0" class="overflow-hidden border border-gray-200 rounded-lg">
                <table class="min-w-full divide-y divide-gray-200">
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                      <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                      <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                      <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                      <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</th>
                      <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th>
                    </tr>
                  </thead>
                  <tbody class="bg-white divide-y divide-gray-200">
                    <tr v-for="(item, index) in order.items" :key="index" class="hover:bg-gray-50">
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center">{{ index + 1 }}</td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ item.productName || item.productId }}</td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center">{{ formatNumber(item.quantity) }}</td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center">{{ item.unit || '-' }}</td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-right">{{ formatCurrency(item.unitPrice) }}</td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600 text-right">{{ formatCurrency(item.discount) }}</td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-green-600 text-right">{{ formatCurrency(item.total) }}</td>
                    </tr>
                  </tbody>
                  <tfoot class="bg-gray-50">
                    <tr>
                      <td colspan="6" class="px-6 py-4 text-right text-sm font-semibold text-gray-900">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-green-600 text-right">{{ formatCurrency(itemsTotal) }}</td>
                    </tr>
                  </tfoot>
                </table>
              </div>
              
              <div v-else class="text-center py-12 text-gray-500">
                <div class="bg-gray-100 rounded-full p-6 mx-auto w-20 h-20 flex items-center justify-center mb-4">
                  <i class="fas fa-shopping-cart text-2xl text-gray-400"></i>
                </div>
                <p class="text-lg">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>
              </div>
            </div>
          </div>

          <!-- Notes Section -->
          <div v-if="order.notes" class="bg-white rounded-lg shadow-sm">
            <div class="px-6 py-4 border-b border-gray-200">
              <h3 class="text-lg font-semibold text-gray-900">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</h3>
            </div>
            <div class="p-6">
              <div class="p-4 bg-gray-50 rounded-lg border">
                <p class="text-gray-900 whitespace-pre-wrap">{{ order.notes }}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
          <!-- Summary Information -->
          <div class="bg-white rounded-lg shadow-sm">
            <div class="px-6 py-4 border-b border-gray-200">
              <h3 class="text-lg font-semibold text-gray-900">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</h3>
            </div>
            <div class="p-6 space-y-4">
              <div class="flex justify-between items-center">
                <span class="text-sm font-medium text-gray-700">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</span>
                <span class="font-semibold text-gray-900">{{ formatCurrency(order.subtotal) }}</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-sm font-medium text-gray-700">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î:</span>
                <span class="font-semibold text-red-600">-{{ formatCurrency(order.totalDiscount) }}</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-sm font-medium text-gray-700">VAT:</span>
                <span class="font-semibold text-gray-900">{{ formatCurrency(order.vatAmount) }}</span>
              </div>
              <div class="border-t border-gray-200 pt-4">
                <div class="flex justify-between items-center">
                  <span class="text-base font-semibold text-gray-900">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥:</span>
                  <span class="text-xl font-bold text-green-600">{{ formatCurrency(order.totalAmount) }}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Meta Information -->
          <div class="bg-white rounded-lg shadow-sm">
            <div class="px-6 py-4 border-b border-gray-200">
              <h3 class="text-lg font-semibold text-gray-900">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö</h3>
            </div>
            <div class="p-6 space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠</label>
                <p class="text-sm text-gray-600">{{ formatDateTime(order.createdAt) }}</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</label>
                <p class="text-sm text-gray-600">{{ formatDateTime(order.updatedAt) || '‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢' }}</p>
              </div>
            </div>
          </div>

          <!-- Quick Actions -->
          <div class="bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg shadow-sm p-6 text-white">
            <h3 class="text-lg font-semibold mb-4">Quick Actions</h3>
            <div class="space-y-3">
              <!-- Status Change Actions -->
              <div v-if="availableActions.length > 0" class="space-y-2">
                <p class="text-sm text-white opacity-90 mb-3">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</p>
                <button 
                  v-for="action in availableActions"
                  :key="action.status"
                  @click="changeStatus(action.status)"
                  :class="getActionButtonClass(action.status)"
                  class="w-full px-4 py-2 rounded-lg font-medium transition-colors inline-flex items-center justify-center"
                >
                  <i :class="action.icon" class="mr-2"></i>
                  {{ action.label }}
                </button>
              </div>
              
              <!-- Divider -->
              <div v-if="availableActions.length > 0" class="border-t border-white border-opacity-20 my-4"></div>
              
              <!-- Other Actions -->
              <button 
                @click="editOrder"
                class="w-full bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-lg font-medium transition-colors inline-flex items-center justify-center"
              >
                <i class="fas fa-edit mr-2"></i>
                ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
              </button>
              <button 
                @click="printOrder"
                class="w-full bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-lg font-medium transition-colors inline-flex items-center justify-center"
              >
                <i class="fas fa-print mr-2"></i>
                ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
              </button>
              <button 
                @click="$router.push('/sales/sales-order')"
                class="w-full bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-lg font-medium transition-colors inline-flex items-center justify-center"
              >
                <i class="fas fa-list mr-2"></i>
                ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
              </button>
            </div>
          </div>
        </div>
      </div>

    <!-- Document Debug Panel -->
    <DocumentDebugPanel 
      v-if="order"
      :current-document="order"
      document-type="Sales Order"
      :sales-service="salesService"
    />

    <!-- Status Change Confirmation Modal -->
    <div v-if="showStatusModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div class="bg-white rounded-lg max-w-md w-full" @click.stop>
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-6 border-b border-gray-200">
          <h3 class="text-lg font-semibold text-gray-900">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</h3>
          <button 
            @click="cancelStatusChange"
            class="text-gray-400 hover:text-gray-600 text-xl"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>

        <!-- Modal Body -->
        <div class="p-6">
          <!-- Status Change Info -->
          <div class="flex items-center justify-center gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
            <div class="text-center">
              <label class="block text-xs font-medium text-gray-500 uppercase tracking-wider mb-1">‡∏à‡∏≤‡∏Å</label>
              <span class="inline-flex px-3 py-1 text-sm font-semibold rounded-full" :class="getStatusClass(order.status)">
                {{ getStatusText(order.status) }}
              </span>
            </div>
            <div class="text-blue-500">
              <i class="fas fa-arrow-right text-xl"></i>
            </div>
            <div class="text-center">
              <label class="block text-xs font-medium text-gray-500 uppercase tracking-wider mb-1">‡πÄ‡∏õ‡πá‡∏ô</label>
              <span class="inline-flex px-3 py-1 text-sm font-semibold rounded-full" :class="getStatusClass(pendingStatus)">
                {{ getStatusText(pendingStatus) }}
              </span>
            </div>
          </div>

          <!-- Notes -->
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
            <textarea 
              v-model="statusNotes"
              class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              rows="3"
              placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞..."
            ></textarea>
          </div>
        </div>

        <!-- Modal Footer -->
        <div class="flex items-center justify-end gap-3 p-6 border-t border-gray-200 bg-gray-50 rounded-b-lg">
          <button 
            @click="cancelStatusChange"
            class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
          >
            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
          </button>
          <button 
            @click="confirmStatusChange"
            :disabled="changingStatus"
            class="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors inline-flex items-center"
          >
            <i v-if="changingStatus" class="fas fa-spinner fa-spin mr-2"></i>
            <i v-else class="fas fa-check mr-2"></i>
            {{ changingStatus ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô...' : '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô' }}
          </button>
        </div>
      </div>
    </div>
    </div>
  </div>
</template>

<script>
import { ref, computed, onMounted, inject } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import { TransactionEngine, TRANSACTION_TYPES } from '@/extensions/modules/erp'
import DocumentDebugPanel from '../../shared/DocumentDebugPanel.vue'
import { ErpBreadcrumb } from '@/extensions/modules/erp'

export default {
  name: 'SalesOrderDetail',
  components: {
    DocumentDebugPanel,
    ErpBreadcrumb
  },
  setup() {
    const route = useRoute()
    const router = useRouter()
    const engine = new TransactionEngine()
    const salesService = inject('salesService')
    
    // Breadcrumb navigation
    const breadcrumbNav = ref([
      { name: 'Home', path: '/', icon: 'fas fa-home' },
      { name: 'Sales', path: '/sales', icon: 'fas fa-shopping-cart' },
      { name: 'Sales Orders', path: '/sales/sales-order', icon: 'fas fa-file-invoice' },
      { name: 'Sales Order Detail' }
    ])
    
    // State
    const order = ref(null)
    const loading = ref(false)
    const error = ref('')
    
    // Linked Documents
    const linkedQuotation = ref(null)
    const linkedInvoice = ref(null)
    
    // Status change modal
    const showStatusModal = ref(false)
    const pendingStatus = ref('')
    const statusNotes = ref('')
    const changingStatus = ref(false)

    // Stock Reservations
    const stockReservations = ref([])
    const loadingReservations = ref(false)
    
    // Computed
    const itemsTotal = computed(() => {
      if (!order.value?.items) return 0
      return order.value.items.reduce((sum, item) => sum + (item.total || 0), 0)
    })

    const totalReservedQuantity = computed(() => {
      return stockReservations.value.reduce((total, reservation) => {
        return total + (reservation.quantity || 0)
      }, 0)
    })

    // Status definitions
    const statusDefinitions = {
      'draft': {
        label: '‡∏£‡πà‡∏≤‡∏á',
        class: 'bg-gray-100 text-gray-800',
        nextActions: [
          { status: 'quoted', label: '‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤', icon: 'fas fa-file-invoice' }
        ]
      },
      'quoted': {
        label: '‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤',
        class: 'bg-blue-100 text-blue-800',
        nextActions: [
          { status: 'confirmed', label: '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô', icon: 'fas fa-check-circle' }
        ]
      },
      'confirmed': {
        label: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß',
        class: 'bg-green-100 text-green-800',
        nextActions: [
          { status: 'approved', label: '‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß', icon: 'fas fa-credit-card' }
        ]
      },
      'approved': {
        label: '‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß',
        class: 'bg-purple-100 text-purple-800',
        nextActions: [
          { status: 'create_work_order', label: '‡∏™‡∏£‡πâ‡∏≤‡∏á Work Order', icon: 'fas fa-tasks' }
        ]
      },
      'in_production': {
        label: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡∏•‡∏¥‡∏ï',
        class: 'bg-yellow-100 text-yellow-800',
        nextActions: [
          { status: 'shipped', label: '‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß', icon: 'fas fa-shipping-fast' }
        ]
      },
      'shipped': {
        label: '‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß',
        class: 'bg-orange-100 text-orange-800',
        nextActions: [
          { status: 'delivered', label: '‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß', icon: 'fas fa-check-double' }
        ]
      },
      'delivered': {
        label: '‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß',
        class: 'bg-indigo-100 text-indigo-800',
        nextActions: [
          { status: 'completed', label: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', icon: 'fas fa-trophy' }
        ]
      },
      'completed': {
        label: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        class: 'bg-green-100 text-green-800',
        nextActions: []
      },
      'cancelled': {
        label: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
        class: 'bg-red-100 text-red-800',
        nextActions: []
      }
    }

    const availableActions = computed(() => {
      if (!order.value?.status) return []
      const statusDef = statusDefinitions[order.value.status]
      return statusDef ? statusDef.nextActions : []
    })

    // Load order data
    const loadOrder = async () => {
      loading.value = true
      error.value = ''
      
      try {
        const orderId = route.params.id
        console.log('üîç Loading order:', orderId)
        
        if (!orderId) {
          throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö Order ID')
        }
        
        // ‡πÉ‡∏ä‡πâ SalesService ‡πÅ‡∏ó‡∏ô Transaction Engine
        let result
        if (salesService && salesService.getSalesOrder) {
          result = await salesService.getSalesOrder(orderId)
        } else {
          // Fallback: Dynamic import
          const { salesService: newSalesService } = await import('@/services/SalesService.js')
          if (!newSalesService.isReady()) {
            newSalesService.initialize(window.vueApp?.config?.globalProperties)
          }
          result = await newSalesService.getSalesOrder(orderId)
        }
        
        console.log('üì¶ Order result:', result)
        
        if (result) {
          // Map field names to match component expectations
          order.value = {
            ...result,
            id: result._id || result.id,
            orderNumber: result.order_number || result.orderNumber,
            orderDate: result.order_date || result.orderDate,
            deliveryDate: result.delivery_date || result.deliveryDate,
            customerId: result.customer_id || result.customerId,
            customerName: result.customer_name || result.customerName,
            customerPhone: result.customer_phone || result.customerPhone
          }
          console.log('‚úÖ Order loaded:', order.value)
          
          // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ñ‡πâ‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô confirmed
          if (order.value.status === 'confirmed') {
            await checkStockReservations()
          }
        } else {
          throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Sales Order')
        }
        
      } catch (err) {
        console.error('‚ùå Error loading order:', err)
        error.value = err.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'
      } finally {
        loading.value = false
      }
    }

    // Load linked documents
    const loadLinkedDocuments = async () => {
      if (!order.value?.id) return
      
      try {
        console.log('üîÑ [Sales Order Detail] Loading linked documents for order:', order.value.id)
        
        let result
        if (salesService && salesService.getSalesOrderWithLinkedDocuments) {
          result = await salesService.getSalesOrderWithLinkedDocuments(order.value.id)
        } else {
          // Fallback: Dynamic import
          const { salesService: newSalesService } = await import('@/services/SalesService.js')
          if (!newSalesService.isReady()) {
            newSalesService.initialize(window.vueApp?.config?.globalProperties)
          }
          result = await newSalesService.getSalesOrderWithLinkedDocuments(order.value.id)
        }
        
        if (result) {
          linkedQuotation.value = result.quotation || null
          linkedInvoice.value = result.invoice || null
          
          console.log('‚úÖ [Sales Order Detail] Linked documents loaded:', {
            quotation: linkedQuotation.value?.quoteNumber || linkedQuotation.value?.quote_number || 'None',
            invoice: linkedInvoice.value?.invoiceNumber || linkedInvoice.value?.invoice_number || 'None'
          })
        }
      } catch (err) {
        console.error('‚ùå [Sales Order Detail] Error loading linked documents:', err)
      }
    }

    // Format currency
    const formatCurrency = (amount) => {
      return new Intl.NumberFormat('th-TH', {
        style: 'currency',
        currency: 'THB',
        minimumFractionDigits: 0,
        maximumFractionDigits: 2
      }).format(amount || 0)
    }

    // Format number
    const formatNumber = (number) => {
      return new Intl.NumberFormat('th-TH').format(number || 0)
    }

    // Format date
    const formatDate = (dateString) => {
      if (!dateString) return ''
      try {
        return new Date(dateString).toLocaleDateString('th-TH')
      } catch (error) {
        return dateString
      }
    }

    // Format date time
    const formatDateTime = (dateString) => {
      if (!dateString) return ''
      try {
        return new Date(dateString).toLocaleString('th-TH')
      } catch (error) {
        return dateString
      }
    }

    // Get status class
    const getStatusClass = (status) => {
      const statusDef = statusDefinitions[status]
      return statusDef ? statusDef.class : 'bg-gray-100 text-gray-800'
    }

    // Get status text
    const getStatusText = (status) => {
      const statusDef = statusDefinitions[status]
      return statusDef ? statusDef.label : status
    }

    // Get action button class
    const getActionButtonClass = (status) => {
      const classes = {
        'quoted': 'bg-blue-500 hover:bg-blue-600 text-white',
        'confirmed': 'bg-green-500 hover:bg-green-600 text-white',
        'approved': 'bg-purple-500 hover:bg-purple-600 text-white',
        'create_work_order': 'bg-orange-500 hover:bg-orange-600 text-white',
        'in_production': 'bg-yellow-500 hover:bg-yellow-600 text-white',
        'shipped': 'bg-orange-500 hover:bg-orange-600 text-white',
        'delivered': 'bg-indigo-500 hover:bg-indigo-600 text-white',
        'completed': 'bg-green-600 hover:bg-green-700 text-white'
      }
      return classes[status] || 'bg-gray-500 hover:bg-gray-600 text-white'
    }

    // Status change methods
    const changeStatus = (newStatus) => {
      pendingStatus.value = newStatus
      statusNotes.value = ''
      showStatusModal.value = true
    }

    const confirmStatusChange = async () => {
      if (changingStatus.value) return
      
      try {
        changingStatus.value = true
        
        console.log('üîÑ Changing status from', order.value.status, 'to', pendingStatus.value)
        
        // ‚úÖ ‡∏Å‡∏£‡∏ì‡∏µ‡∏û‡∏¥‡πÄ‡∏®‡∏©: ‡∏™‡∏£‡πâ‡∏≤‡∏á Work Order ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        if (pendingStatus.value === 'create_work_order') {
          console.log('üè≠ Creating Work Order instead of status change...')
          
          // ‡∏õ‡∏¥‡∏î modal ‡∏Å‡πà‡∏≠‡∏ô
          showStatusModal.value = false
          pendingStatus.value = ''
          statusNotes.value = ''
          
          // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á Work Order (‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å SalesOrderDetail.vue)
          await createWorkOrder()
          return
        }

        // ‚úÖ ‡∏Å‡∏£‡∏ì‡∏µ‡∏û‡∏¥‡πÄ‡∏®‡∏©: ‡∏à‡∏≠‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô confirmed
        if (pendingStatus.value === 'confirmed') {
          console.log('üîí Confirming order - will reserve stock...')
          console.log('üì¶ Order items to reserve:', order.value?.items)
          
          try {
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏à‡∏≠‡∏á
            console.log('üîç Checking stock availability...')
            const stockCheck = await checkStockAvailability()
            console.log('üìä Stock check result:', stockCheck)
            
            // ‡∏à‡∏≠‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å
            console.log('üîí Starting stock reservation...')
            const reservations = await reserveStock()
            console.log('üìã Reservations created:', reservations)
            
            console.log('‚úÖ Stock reserved successfully')
          } catch (stockError) {
            console.error('‚ùå Stock reservation failed:', stockError)
            alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å: ' + stockError.message)
            return // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ñ‡πâ‡∏≤‡∏à‡∏≠‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
          }
        }
        
        // Prepare update data with only necessary fields matching schema
        const updateData = {
          status: pendingStatus.value
        }

        // Add activity log entry (‡∏ï‡∏≤‡∏° schema ‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ activityLog)
        const newActivityEntry = {
          id: Date.now(),
          action: 'status_changed',
          description: `‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å ${getStatusText(order.value.status)} ‡πÄ‡∏õ‡πá‡∏ô ${getStatusText(pendingStatus.value)}`,
          notes: statusNotes.value,
          timestamp: new Date().toISOString(),
          user: 'system',
          from_status: order.value.status,
          to_status: pendingStatus.value
        }

        // Add activity log to update data if it exists
        if (order.value.activityLog && Array.isArray(order.value.activityLog)) {
          updateData.activityLog = [...order.value.activityLog, newActivityEntry]
        } else {
          updateData.activityLog = [newActivityEntry]
        }

        // Save to engine with minimal update data matching schema
        const result = await engine.update(TRANSACTION_TYPES.SALES, order.value.id, updateData)
        
        if (result?.success) {
          // Update local order object with new status and activity log
          order.value.status = pendingStatus.value
          if (updateData.activityLog) {
            order.value.activityLog = updateData.activityLog
          }
          
          console.log('‚úÖ Status changed successfully to:', pendingStatus.value)
          
          // Close modal
          showStatusModal.value = false
          pendingStatus.value = ''
          statusNotes.value = ''
          
          // Show success message
          const successMsg = pendingStatus.value === 'confirmed' ? 
            `‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô ${getStatusText(order.value.status)} ‡πÅ‡∏•‡∏∞‡∏à‡∏≠‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à` :
            `‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô ${getStatusText(order.value.status)} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`
          alert(successMsg)
        } else {
          throw new Error(result?.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏î‡πâ')
        }
        
      } catch (err) {
        console.error('‚ùå Error changing status:', err)
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ' + err.message)
      } finally {
        changingStatus.value = false
      }
    }

    const cancelStatusChange = () => {
      showStatusModal.value = false
      pendingStatus.value = ''
      statusNotes.value = ''
    }

    // Stock Management Functions (‡∏à‡∏≤‡∏Å SalesOrderDetail.vue)
    const checkStockAvailability = async () => {
      try {
        if (!order.value?.items) return { available: false, details: [] }
        
        console.log('üì¶ Checking stock availability for sales order items...')
        
        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Product ‡πÅ‡∏•‡∏∞ Balance
        const [productResult, balanceResult] = await Promise.all([
          engine.list('product'),
          engine.list('inventory_balance')
        ])
        
        const products = productResult?.data || []
        const balances = balanceResult?.data || []
        
        const stockDetails = []
        let allAvailable = true
        
        for (const item of order.value.items) {
          // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ product_id
          let productId = item.product_id || item.productId
          
          if (!productId) {
            // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å product name ‡∏´‡∏£‡∏∑‡∏≠ SKU
            const product = products.find(p => 
              p.name === (item.productName || item.product_name || item.name) ||
              p.sku === (item.code || item.sku)
            )
            productId = product?.id
          }
          
          if (!productId) {
            stockDetails.push({
              item: item,
              product_id: null,
              available: false,
              current_stock: 0,
              reserved_stock: 0,
              available_stock: 0,
              required: item.quantity || 0,
              status: 'no_product_id'
            })
            allAvailable = false
            continue
          }
          
          // ‡∏´‡∏≤ Balance ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö product ‡∏ô‡∏µ‡πâ
          const balance = balances.find(b => b.product_id === productId)
          const currentStock = balance?.qty_on_hand || 0
          const reservedStock = balance?.qty_reserved || 0
          const availableStock = balance?.qty_available || (currentStock - reservedStock)
          const required = item.quantity || 0
          
          const itemAvailable = availableStock >= required
          
          stockDetails.push({
            item: item,
            product_id: productId,
            available: itemAvailable,
            current_stock: currentStock,
            reserved_stock: reservedStock,
            available_stock: availableStock,
            required: required,
            status: itemAvailable ? 'available' : 'insufficient'
          })
          
          if (!itemAvailable) {
            allAvailable = false
          }
        }
        
        console.log('üìä Stock check results:', stockDetails)
        
        return {
          available: allAvailable,
          details: stockDetails
        }
        
      } catch (error) {
        console.error('‚ùå Error checking stock availability:', error)
        return { available: false, details: [], error: error.message }
      }
    }

    const reserveStock = async () => {
      try {
        console.log('üîí Starting stock reservation process for sales order...')
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô
        const stockCheck = await checkStockAvailability()
        
        if (!stockCheck.available) {
          console.error('‚ùå Stock not available:', stockCheck)
          
          // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠
          let errorMessage = '‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠:\n\n'
          
          stockCheck.details.forEach(detail => {
            if (detail.status === 'insufficient') {
              const productName = detail.item.productName || detail.item.product_name || detail.item.name || '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠'
              errorMessage += `‚Ä¢ ${productName}: ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ${detail.required} ‡πÅ‡∏ï‡πà‡∏°‡∏µ‡πÄ‡∏û‡∏µ‡∏¢‡∏á ${detail.available_stock}\n`
            } else if (detail.status === 'no_product_id') {
              const productName = detail.item.productName || detail.item.product_name || detail.item.name || '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠'
              errorMessage += `‚Ä¢ ${productName}: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö\n`
            }
          })
          
          throw new Error(errorMessage)
        }
        
        const reservations = []
        console.log(`üîÑ Processing ${stockCheck.details?.length || 0} items for reservation...`)
        
        // ‡∏à‡∏≠‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
        for (const detail of stockCheck.details) {
          if (detail.status === 'available' && detail.product_id) {
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Balance
            const balanceResult = await engine.list('inventory_balance')
            const balances = balanceResult?.data || []
            const existingBalance = balances.find(b => b.product_id === detail.product_id)
            
            if (existingBalance) {
              const newReservedQuantity = (existingBalance.qty_reserved || 0) + detail.required
              const newAvailableQuantity = Math.max(0, (existingBalance.qty_on_hand || 0) - newReservedQuantity)
              
              const updateData = {
                qty_reserved: newReservedQuantity,
                qty_available: newAvailableQuantity,
                updated_at: new Date().toISOString()
              }
              
              const updateResult = await engine.update('inventory_balance', existingBalance.id, updateData)
              
              if (updateResult.success) {
                console.log(`‚úÖ Reserved ${detail.required} units for product ${detail.product_id}`)
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á inventory reservation record
                const allowedUnits = ['‡∏ä‡∏¥‡πâ‡∏ô', '‡∏ä‡∏∏‡∏î', '‡∏Å‡∏•‡πà‡∏≠‡∏á', '‡πÅ‡∏û‡πá‡∏Ñ', '‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°', '‡∏Å‡∏£‡∏±‡∏°', '‡∏•‡∏¥‡∏ï‡∏£', '‡πÄ‡∏°‡∏ï‡∏£', '‡∏°‡πâ‡∏ß‡∏ô', '‡∏Ç‡∏ß‡∏î', '‡∏ñ‡∏∏‡∏á']
                const itemUnit = detail.item.unit || '‡∏ä‡∏¥‡πâ‡∏ô'
                const validUnit = allowedUnits.includes(itemUnit) ? itemUnit : '‡∏ä‡∏¥‡πâ‡∏ô'
                
                const reservationData = {
                  subtype: 'reservation',
                  product_id: detail.product_id,
                  product_name: detail.item.productName || detail.item.product_name || detail.item.name,
                  sku: detail.item.sku || detail.item.code,
                  movement_type: 'adjustment',
                  transaction_type: 'reservation',
                  quantity: detail.required,
                  unit: validUnit,
                  reference_type: 'sales_order',
                  reference_id: order.value.id,
                  reference_number: order.value.orderNumber,
                  sales_order_id: order.value.id,
                  notes: `‡∏à‡∏≠‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Sales Order ${order.value.orderNumber}`,
                  movement_date: new Date().toISOString(),
                  created_by: 'sales_system',
                  status: 'reserved'
                }
                
                console.log('üìù Creating inventory reservation record with data:', reservationData)
                const inventoryResult = await engine.create(TRANSACTION_TYPES.INVENTORY, reservationData, 'sales_system')
                console.log('üìù Inventory creation result:', inventoryResult)
                
                if (inventoryResult.success) {
                  console.log(`‚úÖ Created inventory reservation record for product ${detail.product_id}`)
                  console.log('üìÑ Created record ID:', inventoryResult.data?.id)
                  
                  reservations.push({
                    product_id: detail.product_id,
                    quantity: detail.required,
                    balance_id: existingBalance.id,
                    sales_order_id: order.value.id,
                    reservation_id: inventoryResult.data?.id
                  })
                } else {
                  console.error(`‚ùå Failed to create inventory reservation record:`, inventoryResult.error)
                }
              } else {
                throw new Error(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${detail.product_id} ‡πÑ‡∏î‡πâ`)
              }
            }
          }
        }
        
        console.log(`‚úÖ Stock reservation completed: ${reservations.length} items reserved`)
        
        // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
        await checkStockReservations()
        
        return reservations
        
      } catch (error) {
        console.error('‚ùå Error reserving stock:', error)
        throw error
      }
    }

    // Check and load stock reservations
    const checkStockReservations = async () => {
      try {
        if (!order.value?.id) return
        
        loadingReservations.value = true
        console.log('üîç Loading stock reservations for order:', order.value.id)
        
        // Query inventory records ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö sales order ‡∏ô‡∏µ‡πâ
        const inventoryResult = await engine.list(TRANSACTION_TYPES.INVENTORY)
        console.log('üì¶ All inventory records:', inventoryResult)
        
        if (inventoryResult.success && inventoryResult.data) {
          console.log('üîç Filtering reservations for order:', order.value.id)
          console.log('üìã Total inventory records:', inventoryResult.data.length)
          
          // ‡πÅ‡∏™‡∏î‡∏á sample records ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö debug
          const sampleRecords = inventoryResult.data.slice(0, 3)
          console.log('üìÑ Sample inventory records:', sampleRecords)
          
          const allReservations = inventoryResult.data.filter(record => 
            record.subtype === 'reservation'
          )
          console.log('üîç All reservation records:', allReservations.length)
          
          const orderReservations = inventoryResult.data.filter(record => 
            record.sales_order_id === order.value.id
          )
          console.log('üîç Records for this order:', orderReservations.length)
          
          const reservations = inventoryResult.data.filter(record => 
            record.subtype === 'reservation' && 
            record.sales_order_id === order.value.id && 
            record.transaction_type === 'reservation'
          )
          
          console.log('üîç Final filtered reservations:', reservations)
          
          stockReservations.value = reservations
          console.log(`‚úÖ Found ${reservations.length} stock reservations for order ${order.value.id}`)
        } else {
          console.log('‚ùå No inventory data or failed to load')
          stockReservations.value = []
        }
        
      } catch (error) {
        console.error('‚ùå Error loading stock reservations:', error)
        stockReservations.value = []
      } finally {
        loadingReservations.value = false
      }
    }

    // Debug function
    const debugInventoryData = async () => {
      try {
        console.log('üêõ === DEBUG INVENTORY DATA ===')
        console.log('Order ID:', order.value?.id)
        console.log('Order Status:', order.value?.status)
        console.log('Order Items:', order.value?.items)
        
        const inventoryResult = await engine.list(TRANSACTION_TYPES.INVENTORY)
        console.log('All Inventory Records:', inventoryResult.data?.length || 0)
        
        if (inventoryResult.data && inventoryResult.data.length > 0) {
          // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 5 records ‡πÅ‡∏£‡∏Å
          console.log('Sample Inventory Records:', inventoryResult.data.slice(0, 5))
          
          // ‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö order ‡∏ô‡∏µ‡πâ
          const relatedRecords = inventoryResult.data.filter(record => 
            record.sales_order_id === order.value.id || 
            record.reference_id === order.value.id
          )
          console.log('Records Related to This Order:', relatedRecords)
          
          // ‡∏´‡∏≤ reservation records ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
          const allReservations = inventoryResult.data.filter(record => 
            record.subtype === 'reservation' || 
            record.transaction_type === 'reservation'
          )
          console.log('All Reservation Records:', allReservations)
        }
        
        console.log('Current Stock Reservations State:', stockReservations.value)
        console.log('üêõ === END DEBUG ===')
        
        alert('Debug ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß - ‡∏î‡∏π‡πÉ‡∏ô Console (F12)')
      } catch (error) {
        console.error('Debug Error:', error)
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ debug: ' + error.message)
      }
    }

    // Work Order functions
    const createWorkOrder = async () => {
      try {
        console.log('üè≠ Creating Work Order for Sales Order:', order.value.id)
        
        if (!order.value || !order.value.items) {
          throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡πÉ‡∏ö‡∏Ç‡∏≤‡∏¢')
        }

        // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• work order
        const workOrderData = {
          sales_order_id: order.value.id,
          sales_order_number: order.value.orderNumber,
          order_number: `WO-${Date.now()}`,
          customer_name: order.value.customerName,
          due_date: order.value.deliveryDate,
          priority: 'normal',
          warehouse: 'main',
          notes: `Work Order ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏Ç‡∏≤‡∏¢ ${order.value.orderNumber}`,
          
          // ‡πÅ‡∏õ‡∏•‡∏á items ‡∏à‡∏≤‡∏Å sales order ‡πÄ‡∏õ‡πá‡∏ô work order items
          items: order.value.items.map(item => ({
            id: Math.random().toString(36).substr(2, 9),
            product_id: item.productId || item.product_id || '',
            product_name: item.productName || item.product_name || item.name || '',
            product_code: item.sku || item.code || '',
            sku: item.sku || item.code || '',
            quantity: item.quantity || 0,
            required_quantity: item.quantity || 0,
            picked_quantity: 0,
            unit: item.unit || '‡∏ä‡∏¥‡πâ‡∏ô',
            unit_price: item.unitPrice || item.unit_price || item.price || 0,
            status: 'pending',
            // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ
            originalSalesItem: {
              productId: item.productId,
              productName: item.productName,
              sku: item.sku,
              quantity: item.quantity,
              unitPrice: item.unitPrice,
              unit: item.unit,
              discount: item.discount,
              total: item.total
            }
          })),
          
          activities: [{
            timestamp: new Date().toISOString(),
            user: '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö',
            action: 'created',
            description: '‡∏™‡∏£‡πâ‡∏≤‡∏á Work Order ‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡∏Ç‡∏≤‡∏¢',
            notes: `‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡∏Ç‡∏≤‡∏¢ ${order.value.orderNumber}`,
            sales_order_id: order.value.id
          }]
        }
        
        console.log('üìã Work Order data prepared:', workOrderData)
        
        // üè≠ ‡∏™‡∏£‡πâ‡∏≤‡∏á Work Order ‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡πÉ‡∏ô database
        const workOrderResult = await engine.create(TRANSACTION_TYPES.WORK_ORDER, workOrderData)
        
        if (!workOrderResult?.success) {
          throw new Error(workOrderResult?.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á Work Order ‡πÑ‡∏î‡πâ')
        }
        
        console.log('‚úÖ Work Order created successfully:', workOrderResult.data)
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ sales order ‡πÄ‡∏õ‡πá‡∏ô in_production (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö work_order_id ‡πÉ‡∏ô sales order schema)
        const updateData = {
          status: 'in_production'
        }

        // ‡πÄ‡∏û‡∏¥‡πà‡∏° activity log ‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á Work Order
        const newActivityEntry = {
          id: Date.now(),
          action: 'work_order_created',
          description: `‡∏™‡∏£‡πâ‡∏≤‡∏á Work Order ${workOrderData.order_number} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`,
          notes: `Work Order ID: ${workOrderResult.data.id}`,
          timestamp: new Date().toISOString(),
          user: 'system',
          work_order_id: workOrderResult.data.id,
          work_order_number: workOrderData.order_number
        }

        // Add activity log to update data if it exists
        if (order.value.activityLog && Array.isArray(order.value.activityLog)) {
          updateData.activityLog = [...order.value.activityLog, newActivityEntry]
        } else {
          updateData.activityLog = [newActivityEntry]
        }
        
        const statusResult = await engine.update(TRANSACTION_TYPES.SALES, order.value.id, updateData)
        
        if (statusResult?.success) {
          order.value.status = 'in_production'
          // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï activity log ‡πÉ‡∏ô local object
          if (updateData.activityLog) {
            order.value.activityLog = updateData.activityLog
          }
          // ‡πÄ‡∏Å‡πá‡∏ö work order info ‡πÉ‡∏ô local object ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô database)
          order.value._localWorkOrder = {
            id: workOrderResult.data.id,
            number: workOrderData.order_number
          }
          
          console.log('‚úÖ Sales Order status updated to in_production')
          
          const workOrderNumber = workOrderData.order_number
          alert(`Work Order ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n\n‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç Work Order: ${workOrderNumber}\n\n‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Sales Order ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡∏•‡∏¥‡∏ï" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`)
          
          // Refresh order data to show updated status
          await loadOrder()
        } else {
          throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Sales Order ‡πÑ‡∏î‡πâ')
        }
        
      } catch (error) {
        console.error('‚ùå Error creating work order:', error)
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message)
      }
    }

    // Edit order
    const editOrder = () => {
      router.push(`/sales/sales-order/${order.value.id}/edit`)
    }

    // Print order
    const printOrder = () => {
      window.print()
    }

    // Navigate to document
    const viewDocument = (type, id) => {
      if (!id) return
      const routes = {
        'quotation': `/sales/quotation/${id}`,
        'invoice': `/sales/invoice/${id}`
      }
      if (routes[type]) {
        router.push(routes[type])
      }
    }

    // Initialize
    onMounted(async () => {
      await loadOrder()
      await loadLinkedDocuments()
    })

    return {
      // Data
      order,
      loading,
      error,
      linkedQuotation,
      linkedInvoice,
      breadcrumbNav,
      
      // Status change modal
      showStatusModal,
      pendingStatus,
      statusNotes,
      changingStatus,

      // Stock Reservations
      stockReservations,
      loadingReservations,
      totalReservedQuantity,
      
      // Computed
      itemsTotal,
      availableActions,
      
      // Services
      salesService,
      
      // Methods
      loadOrder,
      formatCurrency,
      formatNumber,
      formatDate,
      formatDateTime,
      getStatusClass,
      getStatusText,
      getActionButtonClass,
      changeStatus,
      confirmStatusChange,
      cancelStatusChange,
      editOrder,
      printOrder,
      viewDocument,
      checkStockReservations,
      debugInventoryData
    }
  }
}
</script>

<style scoped>
/* Custom animations for loading */
.animate-pulse {
  animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

@keyframes pulse {
  0%, 100% {
    opacity: 1;
  }
  50% {
    opacity: .5;
  }
}

/* Smooth transitions */
.transition-colors {
  transition-property: background-color, border-color, color, fill, stroke;
  transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
  transition-duration: 150ms;
}

/* Modal animations */
.modal-enter-active, .modal-leave-active {
  transition: opacity 0.3s ease;
}

.modal-enter-from, .modal-leave-to {
  opacity: 0;
}

.modal-content-enter-active, .modal-content-leave-active {
  transition: transform 0.3s ease;
}

.modal-content-enter-from, .modal-content-leave-to {
  transform: scale(0.95) translateY(-20px);
}

/* Loading spinner animation */
.fa-spin {
  animation: fa-spin 2s infinite linear;
}

@keyframes fa-spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Print styles */
@media print {
  .no-print {
    display: none !important;
  }
  
  .bg-white {
    background-color: white !important;
  }
  
  .shadow-sm {
    box-shadow: none !important;
  }
  
  .border {
    border: 1px solid #000 !important;
  }
}
</style>