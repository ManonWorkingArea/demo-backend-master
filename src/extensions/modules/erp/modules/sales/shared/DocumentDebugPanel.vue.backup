<template>
  <div class="debug-panel" v-if="isDebugMode">
    <div class="debug-header" @click="togglePanel">
      <div class="debug-title">
        <i class="fas fa-sitemap"></i>
        <span>Document Flow & Links</span>
      </div>
      <div class="header-actions">
        <span class="doc-type-badge" :class="getDocumentTypeClass()">
          {{ documentType }}
        </span>
        <i class="fas" :class="isExpanded ? 'fa-chevron-down' : 'fa-chevron-up'"></i>
      </div>
    </div>
    
    <transition name="slide">
      <div class="debug-content" v-if="isExpanded">
        <!-- Document Flow Visualization -->
        <div class="debug-section flow-section">
          <h4 class="section-title">
            <i class="fas fa-project-diagram"></i>
            Document Flow
          </h4>
          
          <div class="flow-diagram">
            <!-- Quotation Box -->
            <div class="flow-box" :class="{ 
              'current': documentType === 'Quotation',
              'linked': hasQuotation,
              'not-linked': !hasQuotation && documentType !== 'Quotation'
            }">
              <div class="flow-box-header">
                <i class="fas fa-file-alt"></i>
                <span>Quotation</span>
              </div>
              <div class="flow-box-content" v-if="quotationData">
                <div class="flow-detail">
                  <strong>{{ quotationData.quote_number || quotationData.quotation_number }}</strong>
                </div>
                <div class="flow-status" :class="getFlowStatusClass(quotationData)">
                  {{ quotationData.status }}
                </div>
                <div class="flow-amount" v-if="quotationData.total_amount">
                  {{ formatCurrency(quotationData.total_amount) }}
                </div>
              </div>
              <div class="flow-box-content empty" v-else>
                <span class="empty-text">{{ documentType === 'Quotation' ? 'Current' : 'Not Linked' }}</span>
              </div>
              <button 
                v-if="quotationData && documentType !== 'Quotation'"
                class="flow-view-btn"
                @click="viewDocument({ route: `/sales/quotation/${quotationData._id || quotationData.id}` })"
              >
                <i class="fas fa-eye"></i> View
              </button>
            </div>

            <!-- Arrow 1: Quotation â†’ Invoice -->
            <div class="flow-arrow" :class="{ 'active': hasInvoice }">
              <i class="fas fa-arrow-right"></i>
              <span class="arrow-label">Create Invoice</span>
            </div>

            <!-- Invoice Box -->
            <div class="flow-box" :class="{ 
              'current': documentType === 'Invoice',
              'linked': hasInvoice,
              'not-linked': !hasInvoice && documentType !== 'Invoice'
            }">
              <div class="flow-box-header">
                <i class="fas fa-file-invoice"></i>
                <span>Invoice</span>
              </div>
              <div class="flow-box-content" v-if="invoiceData">
                <div class="flow-detail">
                  <strong>{{ invoiceData.invoice_number }}</strong>
                </div>
                <div class="flow-status" :class="getFlowStatusClass(invoiceData)">
                  {{ invoiceData.payment_status || invoiceData.status }}
                </div>
                <div class="flow-amount" v-if="invoiceData.total_amount">
                  {{ formatCurrency(invoiceData.total_amount) }}
                </div>
                <div class="flow-payment" v-if="invoiceData.payment_status === 'paid'">
                  <i class="fas fa-check-circle"></i> Paid
                </div>
              </div>
              <div class="flow-box-content empty" v-else>
                <span class="empty-text">{{ documentType === 'Invoice' ? 'Current' : 'Not Created' }}</span>
              </div>
              <button 
                v-if="invoiceData && documentType !== 'Invoice'"
                class="flow-view-btn"
                @click="viewDocument({ route: `/sales/invoice/${invoiceData._id || invoiceData.id}` })"
              >
                <i class="fas fa-eye"></i> View
              </button>
            </div>

            <!-- Arrow 2: Invoice â†’ Sales Order -->
            <div class="flow-arrow" :class="{ 'active': hasSalesOrder }">
              <i class="fas fa-arrow-right"></i>
              <span class="arrow-label">After Payment</span>
            </div>

            <!-- Sales Order Box -->
            <div class="flow-box" :class="{ 
              'current': documentType === 'Sales Order',
              'linked': hasSalesOrder,
              'not-linked': !hasSalesOrder && documentType !== 'Sales Order'
            }">
              <div class="flow-box-header">
                <i class="fas fa-shopping-cart"></i>
                <span>Sales Order</span>
              </div>
              <div class="flow-box-content" v-if="salesOrderData">
                <div class="flow-detail">
                  <strong>{{ salesOrderData.order_number || salesOrderData.orderNumber }}</strong>
                </div>
                <div class="flow-status" :class="getFlowStatusClass(salesOrderData)">
                  {{ salesOrderData.status }}
                </div>
                <div class="flow-amount" v-if="salesOrderData.total_amount">
                  {{ formatCurrency(salesOrderData.total_amount) }}
                </div>
              </div>
              <div class="flow-box-content empty" v-else>
                <span class="empty-text">{{ documentType === 'Sales Order' ? 'Current' : 'Not Created' }}</span>
              </div>
              <button 
                v-if="salesOrderData && documentType !== 'Sales Order'"
                class="flow-view-btn"
                @click="viewDocument({ route: `/sales/sales-order/${salesOrderData._id || salesOrderData.id}` })"
              >
                <i class="fas fa-eye"></i> View
              </button>
            </div>
          </div>
        </div>

        <!-- Current Document Details -->
        <div class="debug-section">
          <h4 class="section-title">
            <i class="fas fa-file-alt"></i>
            Current Document Details
          </h4>
          <div class="details-grid">
            <div class="detail-card">
              <label><i class="fas fa-hashtag"></i> Document Number</label>
              <div class="detail-value">{{ getDocumentNumber() }}</div>
            </div>
            <div class="detail-card">
              <label><i class="fas fa-tag"></i> Status</label>
              <div class="detail-value">
                <span class="status-badge" :class="getStatusClass()">
                  {{ currentDocument?.status || currentDocument?.workflow_state || currentDocument?.payment_status || 'N/A' }}
                </span>
              </div>
            </div>
            <div class="detail-card">
              <label><i class="fas fa-user"></i> Customer</label>
              <div class="detail-value">{{ currentDocument?.customer_name || 'N/A' }}</div>
            </div>
            <div class="detail-card">
              <label><i class="fas fa-dollar-sign"></i> Total Amount</label>
              <div class="detail-value amount-highlight">
                {{ formatCurrency(currentDocument?.total_amount || 0) }}
              </div>
            </div>
            <div class="detail-card">
              <label><i class="fas fa-calendar"></i> Created Date</label>
              <div class="detail-value">
                {{ formatDate(currentDocument?.created_at || currentDocument?.created_date) }}
              </div>
            </div>
            <div class="detail-card" v-if="currentDocument?.payment_status">
              <label><i class="fas fa-money-bill-wave"></i> Payment Status</label>
              <div class="detail-value">
                <span class="status-badge" :class="getPaymentStatusClass()">
                  {{ currentDocument.payment_status }}
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Linked Documents Summary -->
        <div class="debug-section" v-if="linkedDocumentsSummary.length > 0">
          <h4 class="section-title">
            <i class="fas fa-link"></i>
            Linked Documents Summary
          </h4>
          
          <div class="summary-cards">
            <div 
              v-for="summary in linkedDocumentsSummary" 
              :key="summary.type"
              class="summary-card"
              :class="summary.status"
            >
              <div class="summary-icon">
                <i :class="getDocIcon(summary.type)"></i>
              </div>
              <div class="summary-content">
                <div class="summary-type">{{ summary.type }}</div>
                <div class="summary-number" v-if="summary.number">{{ summary.number }}</div>
                <div class="summary-status">
                  <span :class="summary.status">
                    {{ summary.status === 'found' ? 'âœ“ Linked' : 'âœ— Not Created' }}
                  </span>
                </div>
              </div>
              <button 
                v-if="summary.status === 'found'"
                class="summary-view-btn"
                @click="viewDocument(summary)"
                title="View Document"
              >
                <i class="fas fa-arrow-right"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- Raw Data (Collapsible) -->
        <div class="debug-section">
          <h4 class="section-title clickable" @click="showRawData = !showRawData">
            <i class="fas fa-code"></i>
            Raw JSON Data
            <i class="fas chevron-icon" :class="showRawData ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
          </h4>
          
          <transition name="slide-fade">
            <div class="raw-data" v-if="showRawData">
              <pre>{{ JSON.stringify(currentDocument, null, 2) }}</pre>
            </div>
          </transition>
        </div>

        <!-- Actions -->
        <div class="debug-actions">
          <button class="btn-close" @click="disableDebug">
            <i class="fas fa-times"></i>
            Close Panel
          </button>
        </div>
      </div>
    </transition>
  </div>
</template>

<script>
import { ref, computed, watch } from 'vue'
import { useRouter } from 'vue-router'

export default {
  name: 'DocumentDebugPanel',
  props: {
    documentType: {
      type: String,
      required: true,
      validator: (value) => ['Quotation', 'Invoice', 'Sales Order'].includes(value)
    },
    currentDocument: {
      type: Object,
      required: true
    },
    salesService: {
      type: Object,
      required: false,
      default: null
    }
  },
  setup(props) {
    const router = useRouter()
    const isDebugMode = ref(true)
    const isExpanded = ref(true)
    const showRawData = ref(false)
    const linkedDocuments = ref([])
    const serviceInstance = ref(null)
    
    // Document data refs
    const quotationData = ref(null)
    const invoiceData = ref(null)
    const salesOrderData = ref(null)
    
    console.log('[Debug Panel] Component mounted:', {
      documentType: props.documentType,
      hasDocument: !!props.currentDocument,
      hasSalesService: !!props.salesService
    })
    
    // Computed properties for flow diagram
    const hasQuotation = computed(() => !!quotationData.value)
    const hasInvoice = computed(() => !!invoiceData.value)
    const hasSalesOrder = computed(() => !!salesOrderData.value)
    
    // Linked documents summary
    const linkedDocumentsSummary = computed(() => {
      const summary = []
      
      if (props.documentType === 'Quotation') {
        if (invoiceData.value) {
          summary.push({
            type: 'Invoice',
            number: invoiceData.value.invoice_number,
            status: 'found',
            route: `/sales/invoice/${invoiceData.value._id || invoiceData.value.id}`
          })
        }
        if (salesOrderData.value) {
          summary.push({
            type: 'Sales Order',
            number: salesOrderData.value.order_number || salesOrderData.value.orderNumber,
            status: 'found',
            route: `/sales/sales-order/${salesOrderData.value._id || salesOrderData.value.id}`
          })
        }
      } else if (props.documentType === 'Invoice') {
        if (quotationData.value) {
          summary.push({
            type: 'Quotation',
            number: quotationData.value.quote_number || quotationData.value.quotation_number,
            status: 'found',
            route: `/sales/quotation/${quotationData.value._id || quotationData.value.id}`
          })
        }
        if (salesOrderData.value) {
          summary.push({
            type: 'Sales Order',
            number: salesOrderData.value.order_number || salesOrderData.value.orderNumber,
            status: 'found',
            route: `/sales/sales-order/${salesOrderData.value._id || salesOrderData.value.id}`
          })
        }
      } else if (props.documentType === 'Sales Order') {
        if (quotationData.value) {
          summary.push({
            type: 'Quotation',
            number: quotationData.value.quote_number || quotationData.value.quotation_number,
            status: 'found',
            route: `/sales/quotation/${quotationData.value._id || quotationData.value.id}`
          })
        }
        if (invoiceData.value) {
          summary.push({
            type: 'Invoice',
            number: invoiceData.value.invoice_number,
            status: 'found',
            route: `/sales/invoice/${invoiceData.value._id || invoiceData.value.id}`
          })
        }
      }
      
      return summary
    })
    
    // Initialize salesService
    const initializeSalesService = async () => {
      console.log('[Debug Panel] Initializing salesService...')
      if (props.salesService) {
        serviceInstance.value = props.salesService
        console.log('[Debug Panel] Using provided salesService')
      } else {
        // Fallback: Create new instance
        try {
          console.log('[Debug Panel] Creating new salesService instance')
          const { salesService: newSalesService } = await import('@/services/SalesService.js')
          if (!newSalesService.isReady()) {
            newSalesService.initialize(window.vueApp?.config?.globalProperties)
          }
          serviceInstance.value = newSalesService
          console.log('[Debug Panel] SalesService initialized successfully')
        } catch (error) {
          console.error('[Debug Panel] Failed to initialize salesService:', error)
        }
      }
    }

    const togglePanel = () => {
      isExpanded.value = !isExpanded.value
    }

    const disableDebug = () => {
      isDebugMode.value = false
    }

    const getDocumentNumber = () => {
      const doc = props.currentDocument
      return doc?.quotation_number || doc?.invoice_number || doc?.orderNumber || doc?.order_number || 'N/A'
    }

    const getStatusClass = () => {
      const status = props.currentDocument?.status || props.currentDocument?.workflow_state
      const statusMap = {
        'draft': 'status-draft',
        'confirmed': 'status-confirmed',
        'approved': 'status-approved',
        'paid': 'status-paid',
        'pending': 'status-pending',
        'completed': 'status-completed',
        'cancelled': 'status-cancelled'
      }
      return statusMap[status] || 'status-default'
    }

    const getDocStatusClass = (docData) => {
      const status = docData?.status || docData?.workflow_state || docData?.payment_status
      const statusMap = {
        'draft': 'status-draft',
        'confirmed': 'status-confirmed',
        'approved': 'status-approved',
        'paid': 'status-paid',
        'pending': 'status-pending',
        'completed': 'status-completed',
        'cancelled': 'status-cancelled'
      }
      return statusMap[status] || 'status-default'
    }

    const getDocIcon = (type) => {
      const icons = {
        'Quotation': 'fas fa-file-alt',
        'Invoice': 'fas fa-file-invoice',
        'Sales Order': 'fas fa-shopping-cart'
      }
      return icons[type] || 'fas fa-file'
    }
    
    const getDocumentTypeClass = () => {
      const typeClasses = {
        'Quotation': 'type-quotation',
        'Invoice': 'type-invoice',
        'Sales Order': 'type-sales-order'
      }
      return typeClasses[props.documentType] || 'type-default'
    }
    
    const getFlowStatusClass = (docData) => {
      if (!docData) return ''
      const status = docData.status || docData.workflow_state || docData.payment_status
      const statusMap = {
        'draft': 'flow-draft',
        'quoted': 'flow-quoted',
        'invoiced': 'flow-invoiced',
        'confirmed': 'flow-confirmed',
        'approved': 'flow-approved',
        'paid': 'flow-paid',
        'pending': 'flow-pending',
        'pending_payment': 'flow-pending-payment',
        'completed': 'flow-completed',
        'cancelled': 'flow-cancelled'
      }
      return statusMap[status] || 'flow-default'
    }
    
    const getPaymentStatusClass = () => {
      const paymentStatus = props.currentDocument?.payment_status
      const statusMap = {
        'pending': 'payment-pending',
        'pending_payment': 'payment-pending',
        'paid': 'payment-paid',
        'partial': 'payment-partial',
        'overdue': 'payment-overdue'
      }
      return statusMap[paymentStatus] || 'payment-default'
    }

    const getNotFoundMessage = (type) => {
      const messages = {
        'Invoice': 'Invoice has not been created yet from this Quotation',
        'Sales Order': 'Sales Order has not been created yet (waiting for payment)',
        'Quotation': 'Original Quotation reference not found'
      }
      return messages[type] || `${type} not found`
    }

    const formatCurrency = (amount) => {
      if (!amount) return 'à¸¿0.00'
      return new Intl.NumberFormat('th-TH', {
        style: 'currency',
        currency: 'THB'
      }).format(amount)
    }

    const formatDate = (date) => {
      if (!date) return 'N/A'
      return new Date(date).toLocaleDateString('th-TH', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      })
    }

    const viewDocument = (doc) => {
      if (doc.route) {
        router.push(doc.route)
      }
    }

    const loadLinkedDocuments = async () => {
      // Initialize service if needed
      if (!serviceInstance.value) {
        console.log('[Debug Panel] Service not initialized, initializing...')
        await initializeSalesService()
      }
      
      if (!serviceInstance.value) {
        console.error('[Debug Panel] âŒ SalesService not available after initialization')
        return
      }
      
      const doc = props.currentDocument
      if (!doc) {
        console.warn('[Debug Panel] âš ï¸ No current document provided')
        return
      }
      
      const docId = doc._id || doc.id
      if (!docId) {
        console.warn('[Debug Panel] âš ï¸ Document has no ID')
        return
      }
      
      // Reset data
      quotationData.value = null
      invoiceData.value = null
      salesOrderData.value = null
      const links = []

      try {
        console.log('[Debug Panel] ðŸ” Loading linked documents...')
        console.log('  - Document Type:', props.documentType)
        console.log('  - Document ID:', docId)
        
        let linkedData = null
        
        // à¹ƒà¸Šà¹‰à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¹ƒà¸«à¸¡à¹ˆà¸ˆà¸²à¸ SalesService
        if (props.documentType === 'Quotation') {
          console.log('[Debug Panel] ðŸ“‹ Fetching Quotation linked documents...')
          
          // Check if method exists
          if (!serviceInstance.value.getQuotationWithLinkedDocuments) {
            console.error('[Debug Panel] âŒ Method getQuotationWithLinkedDocuments not found in salesService')
            return
          }
          
          linkedData = await serviceInstance.value.getQuotationWithLinkedDocuments(docId)
          console.log('[Debug Panel] ðŸ“¦ Quotation linked data:', linkedData)
          
          // Set current document as quotation
          quotationData.value = linkedData.quotation
          
          // Set linked documents
          if (linkedData.links.hasInvoice && linkedData.invoice) {
            console.log('[Debug Panel] âœ… Invoice found:', linkedData.invoice.invoice_number)
            invoiceData.value = linkedData.invoice
            links.push({
              type: 'Invoice',
              id: linkedData.invoice._id || linkedData.invoice.id,
              number: linkedData.invoice.invoice_number,
              status: 'found',
              data: linkedData.invoice,
              route: `/sales/invoice/${linkedData.invoice._id || linkedData.invoice.id}`
            })
          } else {
            console.log('[Debug Panel] âŒ Invoice not found')
            links.push({
              type: 'Invoice',
              status: 'not-found'
            })
          }
          
          if (linkedData.links.hasSalesOrder && linkedData.salesOrder) {
            console.log('[Debug Panel] âœ… Sales Order found:', linkedData.salesOrder.order_number || linkedData.salesOrder.orderNumber)
            salesOrderData.value = linkedData.salesOrder
            links.push({
              type: 'Sales Order',
              id: linkedData.salesOrder._id || linkedData.salesOrder.id,
              number: linkedData.salesOrder.order_number || linkedData.salesOrder.orderNumber,
              status: 'found',
              data: linkedData.salesOrder,
              route: `/sales/sales-order/${linkedData.salesOrder._id || linkedData.salesOrder.id}`
            })
          } else {
            console.log('[Debug Panel] âŒ Sales Order not found')
            links.push({
              type: 'Sales Order',
              status: 'not-found'
            })
          }
        }
        
        else if (props.documentType === 'Invoice') {
          console.log('[Debug Panel] ðŸ§¾ Fetching Invoice linked documents...')
          
          // Check if method exists
          if (!serviceInstance.value.getInvoiceWithLinkedDocuments) {
            console.error('[Debug Panel] âŒ Method getInvoiceWithLinkedDocuments not found in salesService')
            return
          }
          
          linkedData = await serviceInstance.value.getInvoiceWithLinkedDocuments(docId)
          console.log('[Debug Panel] ðŸ“¦ Invoice linked data:', linkedData)
          
          // Set current document as invoice
          invoiceData.value = linkedData.invoice
          
          // Set linked documents
          if (linkedData.links.hasQuotation && linkedData.quotation) {
            console.log('[Debug Panel] âœ… Quotation found:', linkedData.quotation.quote_number || linkedData.quotation.quotation_number)
            quotationData.value = linkedData.quotation
          console.log('[Debug Panel] ðŸ“¦ Invoice linked data:', linkedData)
          
          // Add Quotation
          if (linkedData.links.hasQuotation && linkedData.quotation) {
            console.log('[Debug Panel] âœ… Quotation found:', linkedData.quotation.quote_number || linkedData.quotation.quotation_number)
            links.push({
              type: 'Quotation',
              id: linkedData.quotation._id || linkedData.quotation.id,
              number: linkedData.quotation.quote_number || linkedData.quotation.quotation_number,
              status: 'found',
              data: linkedData.quotation,
              route: `/sales/quotation/${linkedData.quotation._id || linkedData.quotation.id}`
            })
          } else {
            console.log('[Debug Panel] âŒ Quotation not found')
            links.push({
              type: 'Quotation',
              status: 'not-found'
            })
          }
          
          // Add Sales Order
          if (linkedData.links.hasSalesOrder && linkedData.salesOrder) {
            console.log('[Debug Panel] âœ… Sales Order found:', linkedData.salesOrder.order_number || linkedData.salesOrder.orderNumber)
            links.push({
              type: 'Sales Order',
              id: linkedData.salesOrder._id || linkedData.salesOrder.id,
              number: linkedData.salesOrder.order_number || linkedData.salesOrder.orderNumber,
              status: 'found',
              data: linkedData.salesOrder,
              route: `/sales/sales-order/${linkedData.salesOrder._id || linkedData.salesOrder.id}`
            })
          } else {
            console.log('[Debug Panel] âŒ Sales Order not found')
            links.push({
              type: 'Sales Order',
              status: 'not-found'
            })
          }
        }
        
        else if (props.documentType === 'Sales Order') {
          console.log('[Debug Panel] ðŸ›’ Fetching Sales Order linked documents...')
          
          // Check if method exists
          if (!serviceInstance.value.getSalesOrderWithLinkedDocuments) {
            console.error('[Debug Panel] âŒ Method getSalesOrderWithLinkedDocuments not found in salesService')
            return
          }
          
          linkedData = await serviceInstance.value.getSalesOrderWithLinkedDocuments(docId)
          console.log('[Debug Panel] ðŸ“¦ Sales Order linked data:', linkedData)
          
          // Add Invoice
          if (linkedData.links.hasInvoice && linkedData.invoice) {
            console.log('[Debug Panel] âœ… Invoice found:', linkedData.invoice.invoice_number)
            links.push({
              type: 'Invoice',
              id: linkedData.invoice._id || linkedData.invoice.id,
              number: linkedData.invoice.invoice_number,
              status: 'found',
              data: linkedData.invoice,
              route: `/sales/invoice/${linkedData.invoice._id || linkedData.invoice.id}`
            })
          } else {
            console.log('[Debug Panel] âŒ Invoice not found')
            links.push({
              type: 'Invoice',
              status: 'not-found'
            })
          }
          
          // Add Quotation
          if (linkedData.links.hasQuotation && linkedData.quotation) {
            console.log('[Debug Panel] âœ… Quotation found:', linkedData.quotation.quote_number || linkedData.quotation.quotation_number)
            links.push({
              type: 'Quotation',
              id: linkedData.quotation._id || linkedData.quotation.id,
              number: linkedData.quotation.quote_number || linkedData.quotation.quotation_number,
              status: 'found',
              data: linkedData.quotation,
              route: `/sales/quotation/${linkedData.quotation._id || linkedData.quotation.id}`
            })
          } else {
            console.log('[Debug Panel] âŒ Quotation not found')
            links.push({
              type: 'Quotation',
              status: 'not-found'
            })
          }
        }

        linkedDocuments.value = links
        console.log('[Debug Panel] âœ… Linked documents loaded:', links.length, 'documents')
        console.log('[Debug Panel] ðŸ“‹ Final links array:', links)
        
      } catch (error) {
        console.error('[Debug Panel] âŒ Error loading linked documents:', error)
        console.error('[Debug Panel] Error stack:', error.stack)
        linkedDocuments.value = []
      }
    }

    // Watch for document changes and reload links
    watch(() => props.currentDocument, () => {
      if (props.currentDocument && isDebugMode.value) {
        loadLinkedDocuments()
      }
    }, { immediate: true, deep: true })

    return {
      isDebugMode,
      isExpanded,
      showRawData,
      linkedDocuments,
      togglePanel,
      disableDebug,
      getDocumentNumber,
      getStatusClass,
      getDocStatusClass,
      getDocIcon,
      getNotFoundMessage,
      formatCurrency,
      formatDate,
      viewDocument
    }
  }
}
</script>

<style scoped>
.debug-panel {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 450px;
  max-height: 80vh;
  background: #1e1e1e;
  border-radius: 12px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
  z-index: 8888;
  overflow: hidden;
  font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
  border: 2px solid #00ff88;
}

.debug-header {
  background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
  padding: 12px 16px;
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
  user-select: none;
}

.debug-header:hover {
  background: linear-gradient(135deg, #00ff99 0%, #00dd7a 100%);
}

.debug-title {
  display: flex;
  align-items: center;
  gap: 8px;
  color: #1e1e1e;
  font-weight: 700;
  font-size: 14px;
}

.debug-title i {
  font-size: 16px;
}

.debug-content {
  max-height: calc(80vh - 60px);
  overflow-y: auto;
  padding: 16px;
}

.debug-content::-webkit-scrollbar {
  width: 8px;
}

.debug-content::-webkit-scrollbar-track {
  background: #2d2d2d;
}

.debug-content::-webkit-scrollbar-thumb {
  background: #00ff88;
  border-radius: 4px;
}

.debug-section {
  margin-bottom: 20px;
  padding-bottom: 20px;
  border-bottom: 1px solid #3d3d3d;
}

.debug-section:last-child {
  border-bottom: none;
  margin-bottom: 0;
  padding-bottom: 0;
}

.section-title {
  color: #00ff88;
  font-size: 13px;
  font-weight: 600;
  margin: 0 0 12px 0;
  display: flex;
  align-items: center;
  gap: 8px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.section-title.clickable {
  cursor: pointer;
  justify-content: space-between;
}

.section-title.clickable:hover {
  color: #00ffaa;
}

.info-grid {
  display: grid;
  gap: 8px;
}

.info-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 6px 10px;
  background: #2d2d2d;
  border-radius: 6px;
  font-size: 12px;
}

.info-item label {
  color: #999;
  font-weight: 500;
}

.info-item code {
  color: #00ff88;
  background: #1a1a1a;
  padding: 2px 6px;
  border-radius: 3px;
  font-size: 11px;
}

.info-item span {
  color: #e0e0e0;
}

.status-badge {
  padding: 3px 8px;
  border-radius: 4px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
}

.status-draft {
  background: #6c757d;
  color: white;
}

.status-confirmed {
  background: #17a2b8;
  color: white;
}

.status-approved {
  background: #007bff;
  color: white;
}

.status-paid {
  background: #28a745;
  color: white;
}

.status-pending {
  background: #ffc107;
  color: #000;
}

.status-completed {
  background: #20c997;
  color: white;
}

.status-cancelled {
  background: #dc3545;
  color: white;
}

.status-default {
  background: #495057;
  color: white;
}

.linked-docs {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.linked-doc-card {
  background: #2d2d2d;
  border-radius: 8px;
  padding: 12px;
  border-left: 4px solid #6c757d;
}

.linked-doc-card.found {
  border-left-color: #00ff88;
}

.linked-doc-card.not-found {
  border-left-color: #ffc107;
}

.doc-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.doc-type {
  display: flex;
  align-items: center;
  gap: 6px;
  color: #00ff88;
  font-size: 13px;
}

.doc-type i {
  font-size: 14px;
}

.link-status {
  font-size: 11px;
  font-weight: 600;
  padding: 3px 8px;
  border-radius: 4px;
}

.link-status.found {
  background: rgba(0, 255, 136, 0.2);
  color: #00ff88;
}

.link-status.not-found {
  background: rgba(255, 193, 7, 0.2);
  color: #ffc107;
}

.doc-details {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.detail-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 4px 8px;
  background: #1a1a1a;
  border-radius: 4px;
  font-size: 11px;
}

.detail-row label {
  color: #999;
  font-weight: 500;
}

.detail-row code {
  color: #00ccff;
  background: #0d0d0d;
  padding: 2px 6px;
  border-radius: 3px;
  font-size: 10px;
}

.detail-row .amount {
  color: #00ff88;
  font-weight: 600;
}

.btn-view-doc {
  margin-top: 8px;
  padding: 6px 12px;
  background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
  color: #1e1e1e;
  border: none;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  transition: all 0.2s;
}

.btn-view-doc:hover {
  background: linear-gradient(135deg, #00ffaa 0%, #00dd7a 100%);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0, 255, 136, 0.3);
}

.not-found-message {
  color: #ffc107;
  font-size: 11px;
  margin: 0;
  padding: 8px;
  background: rgba(255, 193, 7, 0.1);
  border-radius: 4px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.raw-data {
  background: #1a1a1a;
  border-radius: 6px;
  padding: 12px;
  max-height: 300px;
  overflow-y: auto;
}

.raw-data pre {
  color: #00ccff;
  font-size: 10px;
  margin: 0;
  white-space: pre-wrap;
  word-wrap: break-word;
}

.debug-actions {
  margin-top: 16px;
  padding-top: 16px;
  border-top: 1px solid #3d3d3d;
}

.btn-toggle-debug {
  width: 100%;
  padding: 8px 12px;
  background: #dc3545;
  color: white;
  border: none;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  transition: all 0.2s;
}

.btn-toggle-debug:hover {
  background: #c82333;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
}

/* Slide transition */
.slide-enter-active,
.slide-leave-active {
  transition: all 0.3s ease;
}

.slide-enter-from,
.slide-leave-to {
  max-height: 0;
  opacity: 0;
}

.slide-enter-to,
.slide-leave-from {
  max-height: 80vh;
  opacity: 1;
}
</style>
