<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERP Storage Recovery Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        .button:hover {
            background: #0056b3;
        }
        .button.danger {
            background: #dc3545;
        }
        .button.danger:hover {
            background: #c82333;
        }
        .button.success {
            background: #28a745;
        }
        .button.success:hover {
            background: #1e7e34;
        }
        .console {
            background: #1a1a1a;
            color: #00ff00;
            padding: 15px;
            border-radius: 6px;
            height: 400px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            line-height: 1.4;
            margin-top: 20px;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .status-card {
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            background: #f9f9f9;
        }
        .status-card h3 {
            margin-top: 0;
            color: #333;
        }
        .metric {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
        }
        .metric .value {
            font-weight: bold;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ†Ô∏è ERP Storage Recovery System</h1>
            <p>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• localStorage ‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢</p>
        </div>

        <div class="status-grid" id="statusGrid">
            <!-- Status cards ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÉ‡∏™‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
        </div>

        <div class="controls">
            <h3>üîß ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
            <button class="button" onclick="runHealthCheck()">üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</button>
            <button class="button" onclick="runCleanup()">üßπ ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î</button>
            <button class="button" onclick="showBackups()">üìã ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏£‡∏≠‡∏á</button>
            <button class="button success" onclick="exportData()">üíæ Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            
            <h3>‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á</h3>
            <button class="button danger" onclick="simulateCorruption()">üß™ ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢</button>
            <button class="button danger" onclick="clearAllData()">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            
            <h3>üîÑ ‡∏Å‡∏≤‡∏£‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á</h3>
            <input type="text" id="backupKey" placeholder="‡πÉ‡∏™‡πà backup key ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô" style="width: 300px; padding: 8px; margin: 5px;">
            <button class="button" onclick="manualRestore()">üîÑ ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏à‡∏≤‡∏Å Backup</button>
        </div>

        <div class="console" id="console"></div>
    </div>

    <script type="module">
        // Import ERP modules
        import { StorageDebugHelper } from '../src/extensions/modules/erp/core/utils/StorageDebugHelper.js'
        import { LocalStorageDriver } from '../src/extensions/modules/erp/core/drivers/LocalStorageDriver.js'
        
        // Global instances
        window.debugHelper = new StorageDebugHelper()
        window.driver = new LocalStorageDriver()
        
        // Console output handler
        const originalLog = console.log
        const originalWarn = console.warn
        const originalError = console.error
        
        function addToConsole(message, type = 'log') {
            const console = document.getElementById('console')
            const timestamp = new Date().toLocaleTimeString()
            const color = type === 'error' ? '#ff4444' : type === 'warn' ? '#ffaa00' : '#00ff00'
            
            const line = document.createElement('div')
            line.style.color = color
            line.innerHTML = `[${timestamp}] ${message}`
            console.appendChild(line)
            console.scrollTop = console.scrollHeight
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args)
            addToConsole(args.join(' '), 'log')
        }
        
        console.warn = function(...args) {
            originalWarn.apply(console, args)
            addToConsole(args.join(' '), 'warn')
        }
        
        console.error = function(...args) {
            originalError.apply(console, args)
            addToConsole(args.join(' '), 'error')
        }
        
        // Global functions for buttons
        window.runHealthCheck = async function() {
            console.log('üîç Starting health check...')
            try {
                const report = await window.debugHelper.generateHealthReport()
                updateStatusCards(report)
                console.log('‚úÖ Health check completed')
            } catch (error) {
                console.error('‚ùå Health check failed:', error.message)
            }
        }
        
        window.runCleanup = async function() {
            console.log('üßπ Starting cleanup process...')
            try {
                const result = await window.debugHelper.cleanupCorruption()
                console.log(`üßπ Cleanup completed: ${result.cleanedBackups} backups removed, ${result.corruptedTypes} types processed`)
                
                if (result.recoveryResults.length > 0) {
                    result.recoveryResults.forEach(recovery => {
                        if (recovery.success) {
                            console.log(`‚úÖ ${recovery.type}: ${recovery.message}`)
                        } else {
                            console.error(`‚ùå ${recovery.type}: ${recovery.message}`)
                        }
                    })
                }
                
                // Re-run health check
                await window.runHealthCheck()
                
            } catch (error) {
                console.error('‚ùå Cleanup failed:', error.message)
            }
        }
        
        window.showBackups = function() {
            console.log('üìã Listing corrupted backups...')
            const backups = window.driver.getCorruptedBackups()
            
            if (backups.length === 0) {
                console.log('‚úÖ No corrupted backups found')
                return
            }
            
            console.log(`üìä Found ${backups.length} corrupted backups:`)
            backups.forEach((backup, index) => {
                console.log(`${index + 1}. Type: ${backup.type}, Date: ${backup.date}, Size: ${Math.round(backup.size/1024)}KB`)
                console.log(`   Key: ${backup.key}`)
            })
        }
        
        window.exportData = async function() {
            console.log('üíæ Starting data export...')
            try {
                const exported = await window.debugHelper.exportAllData()
                
                let totalRecords = 0
                Object.values(exported.data).forEach(typeData => {
                    if (typeData && !typeData.error) {
                        totalRecords += Object.keys(typeData).length
                    }
                })
                
                // Create download
                const blob = new Blob([JSON.stringify(exported, null, 2)], { type: 'application/json' })
                const url = URL.createObjectURL(blob)
                const a = document.createElement('a')
                a.href = url
                a.download = `erp_backup_${new Date().toISOString().split('T')[0]}.json`
                document.body.appendChild(a)
                a.click()
                document.body.removeChild(a)
                URL.revokeObjectURL(url)
                
                console.log(`‚úÖ Export completed: ${totalRecords} records exported to file`)
                
            } catch (error) {
                console.error('‚ùå Export failed:', error.message)
            }
        }
        
        window.simulateCorruption = function() {
            console.log('üß™ Simulating data corruption...')
            try {
                // Create corrupted JSON data
                const corruptedData = '{"test_transaction_123": {"id": "test", "type": "inventory", "state": "active"'
                localStorage.setItem('erp_inventory_transactions', corruptedData)
                console.log('‚ö†Ô∏è Simulated corruption in inventory data (missing closing braces)')
                console.log('‚ÑπÔ∏è Run health check to see the corruption detected')
            } catch (error) {
                console.error('‚ùå Failed to simulate corruption:', error.message)
            }
        }
        
        window.clearAllData = function() {
            const confirmed = confirm('‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ERP ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ!')
            if (confirmed) {
                try {
                    window.driver.clearAll()
                    console.log('üóëÔ∏è All ERP data cleared')
                    window.runHealthCheck()
                } catch (error) {
                    console.error('‚ùå Failed to clear data:', error.message)
                }
            }
        }
        
        window.manualRestore = async function() {
            const backupKey = document.getElementById('backupKey').value.trim()
            if (!backupKey) {
                console.error('‚ùå Please enter a backup key')
                return
            }
            
            console.log(`üîÑ Attempting manual restore from: ${backupKey}`)
            try {
                const result = await window.driver.restoreFromBackup(backupKey)
                console.log(`‚úÖ Restore successful: ${Object.keys(result).length} transactions recovered`)
                document.getElementById('backupKey').value = ''
                await window.runHealthCheck()
            } catch (error) {
                console.error(`‚ùå Restore failed: ${error.message}`)
            }
        }
        
        function updateStatusCards(report) {
            const statusGrid = document.getElementById('statusGrid')
            statusGrid.innerHTML = ''
            
            // Overall Health Card
            const healthCard = document.createElement('div')
            healthCard.className = 'status-card'
            healthCard.innerHTML = `
                <h3>${report.overallHealth ? '‚úÖ' : '‚ùå'} ‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°</h3>
                <div class="metric"><span>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</span><span class="value">${report.overallHealth ? '‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏î‡∏µ' : '‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤'}</span></div>
                <div class="metric"><span>‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏ß‡∏°:</span><span class="value">${report.storage.totalSizeKB} KB</span></div>
                <div class="metric"><span>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°:</span><span class="value">${report.storage.totalTransactionTypes}</span></div>
            `
            statusGrid.appendChild(healthCard)
            
            // Corruption Card
            const corruptionCard = document.createElement('div')
            corruptionCard.className = 'status-card'
            corruptionCard.innerHTML = `
                <h3>${report.corruption.hasCorruption ? '‚ö†Ô∏è' : '‚úÖ'} ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢</h3>
                <div class="metric"><span>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢:</span><span class="value">${report.corruption.totalCorruptedBackups}</span></div>
                <div class="metric"><span>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö:</span><span class="value">${report.corruption.affectedTypes.length}</span></div>
                <div class="metric"><span>‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢:</span><span class="value">${Math.round(report.corruption.corruptionSizeBytes / 1024)} KB</span></div>
            `
            statusGrid.appendChild(corruptionCard)
            
            // Transaction Status
            const validTransactions = Object.values(report.transactions).filter(t => t.exists && t.isValid).length
            const corruptedTransactions = Object.values(report.transactions).filter(t => t.exists && !t.isValid).length
            
            const transactionCard = document.createElement('div')
            transactionCard.className = 'status-card'
            transactionCard.innerHTML = `
                <h3>üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°</h3>
                <div class="metric"><span>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á:</span><span class="value" style="color: green">${validTransactions}</span></div>
                <div class="metric"><span>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢:</span><span class="value" style="color: red">${corruptedTransactions}</span></div>
                <div class="metric"><span>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏ß‡∏°:</span><span class="value">${Object.values(report.transactions).reduce((sum, t) => sum + t.recordCount, 0)}</span></div>
            `
            statusGrid.appendChild(transactionCard)
            
            // Show recommendations
            if (report.recommendations.length > 0) {
                report.recommendations.forEach(rec => {
                    const alertClass = rec.priority === 'HIGH' ? 'error' : rec.priority === 'MEDIUM' ? 'warning' : 'success'
                    const alertDiv = document.createElement('div')
                    alertDiv.className = alertClass
                    alertDiv.innerHTML = `<strong>${rec.type}:</strong> ${rec.message}<br><small>‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ${rec.action}</small>`
                    statusGrid.appendChild(alertDiv)
                })
            }
        }
        
        // Initial health check
        console.log('üöÄ Storage Recovery System initialized')
        console.log('‚ÑπÔ∏è Click "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û" to start')
        
        // Auto-run health check on load
        setTimeout(() => {
            window.runHealthCheck()
        }, 1000)
        
    </script>
</body>
</html>