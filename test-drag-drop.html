<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Multi-File Drag Drop</title>
    <style>
        .file-item {
            width: 150px;
            height: 100px;
            background: #f0f0f0;
            border: 2px solid #ddd;
            margin: 10px;
            display: inline-block;
            position: relative;
            cursor: move;
            user-select: none;
        }
        .file-item.selected {
            border-color: #007bff;
            background: #e7f3ff;
        }
        .file-item.dragging {
            opacity: 0.5;
        }
        .folder {
            width: 200px;
            height: 150px;
            background: #fff3cd;
            border: 2px dashed #ffc107;
            margin: 20px;
            display: inline-block;
            text-align: center;
            line-height: 150px;
            font-weight: bold;
        }
        .folder.drop-highlight {
            background: #d4edda;
            border-color: #28a745;
        }
        .checkbox {
            position: absolute;
            top: 5px;
            left: 5px;
        }
        .debug {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: #000;
            color: #fff;
            padding: 10px;
            max-width: 300px;
            font-size: 12px;
            overflow-y: auto;
            max-height: 200px;
        }
    </style>
</head>
<body>
    <h2>ทดสอบการลากไฟล์หลายๆไฟล์</h2>
    <p>1. เลือกไฟล์หลายๆไฟล์โดยคลิก checkbox</p>
    <p>2. ลากไฟล์ใดไฟล์หนึ่งที่เลือกไว้</p>
    <p>3. วางลงในโฟลเดอร์</p>
    
    <div id="files-container">
        <div class="file-item" data-file-id="file1" draggable="true">
            <input type="checkbox" class="checkbox" />
            <div style="padding: 20px;">File 1</div>
        </div>
        <div class="file-item" data-file-id="file2" draggable="true">
            <input type="checkbox" class="checkbox" />
            <div style="padding: 20px;">File 2</div>
        </div>
        <div class="file-item" data-file-id="file3" draggable="true">
            <input type="checkbox" class="checkbox" />
            <div style="padding: 20px;">File 3</div>
        </div>
        <div class="file-item" data-file-id="file4" draggable="true">
            <input type="checkbox" class="checkbox" />
            <div style="padding: 20px;">File 4</div>
        </div>
    </div>
    
    <div class="folder" id="target-folder">
        โฟลเดอร์ปลายทาง
    </div>
    
    <div class="debug" id="debug-log"></div>

    <script>
        let selectedFiles = new Set();
        let draggedItem = null;
        
        function debug(...args) {
            console.log('[Test Debug]', ...args);
            const debugDiv = document.getElementById('debug-log');
            debugDiv.innerHTML += args.join(' ') + '<br>';
            debugDiv.scrollTop = debugDiv.scrollHeight;
        }
        
        // Handle checkbox selection
        document.querySelectorAll('.checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', (e) => {
                const fileItem = e.target.closest('.file-item');
                const fileId = fileItem.dataset.fileId;
                
                if (e.target.checked) {
                    selectedFiles.add(fileId);
                    fileItem.classList.add('selected');
                } else {
                    selectedFiles.delete(fileId);
                    fileItem.classList.remove('selected');
                }
                
                debug(`Selected files: ${Array.from(selectedFiles).join(', ')}`);
            });
        });
        
        // Handle drag start
        document.querySelectorAll('.file-item').forEach(fileItem => {
            fileItem.addEventListener('dragstart', (e) => {
                const fileId = fileItem.dataset.fileId;
                debug(`Drag start: ${fileId}, Selected: ${selectedFiles.size}`);
                
                if (selectedFiles.size > 1 && selectedFiles.has(fileId)) {
                    // Multi-drag
                    draggedItem = 'multi';
                    const selectedIds = Array.from(selectedFiles);
                    
                    e.dataTransfer.setData('text/plain', JSON.stringify({
                        type: 'multiple',
                        fileIds: selectedIds,
                        source: 'internal'
                    }));
                    
                    debug(`Multi-drag: ${selectedIds.join(', ')}`);
                    
                    // Visual feedback
                    selectedIds.forEach(id => {
                        const element = document.querySelector(`[data-file-id="${id}"]`);
                        if (element) element.classList.add('dragging');
                    });
                    
                } else {
                    // Single drag
                    draggedItem = fileId;
                    
                    e.dataTransfer.setData('text/plain', JSON.stringify({
                        type: 'single',
                        fileId: fileId,
                        source: 'internal'
                    }));
                    
                    debug(`Single drag: ${fileId}`);
                    fileItem.classList.add('dragging');
                }
            });
            
            fileItem.addEventListener('dragend', (e) => {
                debug('Drag end');
                
                // Clear visual feedback
                document.querySelectorAll('.file-item').forEach(item => {
                    item.classList.remove('dragging');
                });
                
                draggedItem = null;
            });
        });
        
        // Handle folder drop
        const folder = document.getElementById('target-folder');
        
        folder.addEventListener('dragover', (e) => {
            e.preventDefault();
            folder.classList.add('drop-highlight');
        });
        
        folder.addEventListener('dragleave', (e) => {
            folder.classList.remove('drop-highlight');
        });
        
        folder.addEventListener('drop', (e) => {
            e.preventDefault();
            folder.classList.remove('drop-highlight');
            
            try {
                const dragData = JSON.parse(e.dataTransfer.getData('text/plain'));
                debug('Drop data:', dragData);
                
                if (dragData.source === 'internal') {
                    if (dragData.type === 'multiple') {
                        debug(`✅ Multi-drop: ${dragData.fileIds.length} files`);
                        // จำลองการย้ายไฟล์
                        dragData.fileIds.forEach(id => {
                            const element = document.querySelector(`[data-file-id="${id}"]`);
                            if (element) {
                                element.style.display = 'none';
                            }
                        });
                        alert(`ย้ายไฟล์ ${dragData.fileIds.length} ไฟล์สำเร็จ!`);
                    } else if (dragData.type === 'single') {
                        debug(`✅ Single drop: ${dragData.fileId}`);
                        const element = document.querySelector(`[data-file-id="${dragData.fileId}"]`);
                        if (element) {
                            element.style.display = 'none';
                        }
                        alert(`ย้ายไฟล์ ${dragData.fileId} สำเร็จ!`);
                    }
                } else {
                    debug('❌ External file drop');
                    alert('การลากไฟล์จากภายนอก');
                }
                
            } catch (error) {
                debug('❌ Drop error:', error);
            }
        });
        
        debug('Test initialized');
    </script>
</body>
</html>
