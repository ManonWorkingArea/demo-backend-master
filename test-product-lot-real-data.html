<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ทดสอบ ProductLotSummary พร้อมข้อมูลจริง</title>
    <script src="https://unpkg.com/vue@3.3.4/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50 p-8">
    <div id="app" class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold mb-8">ทดสอบระบบ Textile Lot Tracking</h1>
        
        <!-- ProductLotSummary Component -->
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <product-lot-summary 
                :product-id="testProductId"
                :show-header="true"
            ></product-lot-summary>
        </div>
    </div>

    <script>
        // Mock ProductLotSummaryService
        class ProductLotSummaryService {
            static async getProductWithLots(productId) {
                console.log('Getting product data for:', productId)
                
                // Simulate API delay
                await new Promise(resolve => setTimeout(resolve, 1000))
                
                // Return real-structure data based on user's example
                return {
                    success: true,
                    data: {
                        product: {
                            id: "66f123456789abcd12345678",
                            product_code: "PRD-402-177-152",
                            product_name: "ผ้าฝ้าย สีกรม 152cm",
                            fabric_type: "cotton",
                            color_code: "177",
                            model_code: "402",
                            fabric_width_cm: 152,
                            weight_per_meter_grams: 180,
                            price_per_meter: 85.50,
                            current_stock_meters: 247.5,
                            min_stock_meters: 50,
                            category: "TEXTILE"
                        },
                        lots: [
                            {
                                id: "66f789abcdef123456789abc",
                                lot_id: "LOT-08883",
                                lot_status: "active",
                                original_weight_kg: 25.0,
                                current_weight_kg: 13.75,
                                calculated_meters: 138.89,
                                current_meters: 76.39,
                                price_per_kg: 475.0,
                                supplier_name: "บริษัท เท็กซไทล์ จำกัด",
                                received_date: "2024-01-15",
                                expiry_date: "2025-01-15",
                                usage_percentage: 45.0,
                                total_used_meters: 62.5,
                                roll_type: "partial",
                                status_class: "bg-yellow-500"
                            },
                            {
                                id: "66f789abcdef123456789abd",
                                lot_id: "LOT-08884",
                                lot_status: "active", 
                                original_weight_kg: 30.0,
                                current_weight_kg: 30.0,
                                calculated_meters: 166.67,
                                current_meters: 166.67,
                                price_per_kg: 475.0,
                                supplier_name: "บริษัท เท็กซไทล์ จำกัด",
                                received_date: "2024-02-01",
                                expiry_date: "2025-02-01",
                                usage_percentage: 0.0,
                                total_used_meters: 0.0,
                                roll_type: "full",
                                status_class: "bg-green-500"
                            }
                        ],
                        statistics: {
                            total_lots: 2,
                            total_original_meters: 305.56,
                            total_current_meters: 243.06,
                            total_used_meters: 62.5,
                            total_original_weight_kg: 55.0,
                            total_current_weight_kg: 43.75,
                            total_value: 26125.0,
                            average_usage_percentage: 22.5,
                            full_rolls: 1,
                            partial_rolls: 1,
                            consumed_rolls: 0
                        }
                    }
                }
            }
        }

        // ProductLotSummary Component
        const ProductLotSummary = {
            props: {
                productId: {
                    type: String,
                    required: true
                },
                showHeader: {
                    type: Boolean,
                    default: true
                }
            },
            setup(props) {
                const { ref, onMounted, computed } = Vue
                
                const loading = ref(false)
                const product = ref(null)
                const lots = ref([])
                const showOnlyActive = ref(true)
                const sortBy = ref('lot_id')
                
                // Computed properties
                const filteredLots = computed(() => {
                    let filtered = lots.value || []
                    if (showOnlyActive.value) {
                        filtered = filtered.filter(lot => lot.lot_status === 'active')
                    }
                    
                    return filtered.sort((a, b) => {
                        const field = sortBy.value
                        if (field === 'usage_percentage') {
                            return (b[field] || 0) - (a[field] || 0)
                        }
                        return (a[field] || '').toString().localeCompare((b[field] || '').toString())
                    })
                })
                
                const totalLots = computed(() => filteredLots.value.length)
                const totalMeters = computed(() => {
                    return filteredLots.value.reduce((sum, lot) => sum + (lot.current_meters || 0), 0)
                })
                
                const totalValue = computed(() => {
                    return filteredLots.value.reduce((sum, lot) => {
                        return sum + ((lot.current_weight_kg || 0) * (lot.price_per_kg || 0))
                    }, 0)
                })
                
                const fullRolls = computed(() => {
                    return filteredLots.value.filter(lot => lot.roll_type === 'full').length
                })
                
                const partialRolls = computed(() => {
                    return filteredLots.value.filter(lot => lot.roll_type === 'partial').length
                })
                
                const consumedRolls = computed(() => {
                    return filteredLots.value.filter(lot => lot.roll_type === 'consumed').length
                })
                
                // Methods
                const loadProductAndLots = async () => {
                    loading.value = true
                    try {
                        const response = await ProductLotSummaryService.getProductWithLots(props.productId)
                        
                        if (response.success) {
                            product.value = response.data.product
                            lots.value = response.data.lots
                            console.log('Loaded product:', product.value)
                            console.log('Loaded lots:', lots.value)
                        } else {
                            throw new Error(response.message || 'Failed to load data')
                        }
                    } catch (err) {
                        console.error('Error loading product data:', err)
                    } finally {
                        loading.value = false
                    }
                }
                
                const getStatusClass = (status) => {
                    const classes = {
                        active: 'bg-green-100 text-green-800',
                        partial: 'bg-yellow-100 text-yellow-800',
                        consumed: 'bg-gray-100 text-gray-800',
                        hold: 'bg-red-100 text-red-800'
                    }
                    return classes[status] || 'bg-gray-100 text-gray-800'
                }
                
                const getStatusText = (status) => {
                    const texts = {
                        active: 'ใช้งานได้',
                        partial: 'ใช้บางส่วน',
                        consumed: 'ใช้หมด',
                        hold: 'ระงับ'
                    }
                    return texts[status] || status
                }
                
                const getRollIconClass = (lot) => {
                    return lot.status_class || 'bg-blue-500'
                }
                
                const getRollIcon = (lot) => {
                    const rollType = lot.roll_type || 'unknown'
                    
                    switch (rollType) {
                        case 'full':
                            return 'fas fa-circle'
                        case 'partial':
                            return 'fas fa-adjust'
                        case 'consumed':
                            return 'fas fa-times-circle'
                        default:
                            return 'fas fa-question-circle'
                    }
                }
                
                const getUsagePercentage = (lot) => {
                    return lot.usage_percentage || 0
                }
                
                const getUsageBarClass = (lot) => {
                    const percentage = getUsagePercentage(lot)
                    if (percentage === 0) return 'bg-green-500'
                    if (percentage < 50) return 'bg-yellow-500'
                    if (percentage < 100) return 'bg-orange-500'
                    return 'bg-red-500'
                }
                
                const getUsageText = (lot) => {
                    const used = (lot.calculated_meters || 0) - (lot.current_meters || 0)
                    if (used === 0) return 'ยังไม่ได้ใช้'
                    return `ใช้ไป ${used.toFixed(2)} เมตร`
                }
                
                const formatFabricType = (type) => {
                    const types = {
                        cotton: 'ผ้าฝ้าย',
                        polyester: 'ผ้าโพลีเอสเตอร์',
                        silk: 'ผ้าไหม',
                        wool: 'ผ้าขนสัตว์',
                        blend: 'ผ้าผสม'
                    }
                    return types[type] || type || '-'
                }
                
                const formatDate = (dateStr) => {
                    if (!dateStr) return '-'
                    return new Date(dateStr).toLocaleDateString('th-TH')
                }
                
                onMounted(() => {
                    loadProductAndLots()
                })
                
                return {
                    loading,
                    product,
                    lots,
                    showOnlyActive,
                    sortBy,
                    filteredLots,
                    totalLots,
                    totalMeters,
                    totalValue,
                    fullRolls,
                    partialRolls,
                    consumedRolls,
                    loadProductAndLots,
                    getStatusClass,
                    getStatusText,
                    getRollIconClass,
                    getRollIcon,
                    getUsagePercentage,
                    getUsageBarClass,
                    getUsageText,
                    formatFabricType,
                    formatDate
                }
            },
            template: `
                <div class="product-lot-summary">
                    <!-- Loading State -->
                    <div v-if="loading" class="flex items-center justify-center p-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                        <span class="ml-2">กำลังโหลดข้อมูล...</span>
                    </div>
                    
                    <!-- Main Content -->
                    <div v-else-if="product" class="space-y-6">
                        <!-- Product Header -->
                        <div v-if="showHeader" class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-lg border">
                            <div class="flex items-start justify-between">
                                <div>
                                    <h2 class="text-2xl font-bold text-gray-900 mb-2">{{ product.product_name }}</h2>
                                    <div class="text-sm text-gray-600 space-y-1">
                                        <p><strong>รหัสสินค้า:</strong> {{ product.product_code }}</p>
                                        <p><strong>ประเภทผ้า:</strong> {{ formatFabricType(product.fabric_type) }}</p>
                                        <p><strong>ความกว้าง:</strong> {{ product.fabric_width_cm }} ซม.</p>
                                        <p><strong>น้ำหนักต่อเมตร:</strong> {{ product.weight_per_meter_grams }} กรัม</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-3xl font-bold text-green-600">{{ totalMeters.toFixed(2) }} ม.</div>
                                    <div class="text-sm text-gray-500">คงเหลือทั้งหมด</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Statistics Cards -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="bg-white p-4 rounded-lg border text-center">
                                <div class="text-2xl font-bold text-blue-600">{{ totalLots }}</div>
                                <div class="text-sm text-gray-500">จำนวน Lot</div>
                            </div>
                            <div class="bg-white p-4 rounded-lg border text-center">
                                <div class="text-2xl font-bold text-green-600">{{ fullRolls }}</div>
                                <div class="text-sm text-gray-500">ม้วนเต็ม</div>
                            </div>
                            <div class="bg-white p-4 rounded-lg border text-center">
                                <div class="text-2xl font-bold text-yellow-600">{{ partialRolls }}</div>
                                <div class="text-sm text-gray-500">ม้วนใช้บางส่วน</div>
                            </div>
                            <div class="bg-white p-4 rounded-lg border text-center">
                                <div class="text-2xl font-bold text-gray-600">{{ totalValue.toLocaleString() }}</div>
                                <div class="text-sm text-gray-500">มูลค่ารวม (บาท)</div>
                            </div>
                        </div>
                        
                        <!-- Controls -->
                        <div class="flex flex-wrap items-center gap-4 p-4 bg-gray-50 rounded-lg">
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" v-model="showOnlyActive" class="rounded">
                                <span class="text-sm">แสดงเฉพาะ Lot ที่ใช้งานได้</span>
                            </label>
                            
                            <select v-model="sortBy" class="px-3 py-1 border rounded text-sm">
                                <option value="lot_id">เรียงตาม Lot ID</option>
                                <option value="usage_percentage">เรียงตามการใช้งาน</option>
                                <option value="received_date">เรียงตามวันที่รับ</option>
                            </select>
                        </div>
                        
                        <!-- Lot List -->
                        <div class="space-y-4">
                            <h3 class="text-lg font-semibold">รายการ Lot ({{ filteredLots.length }})</h3>
                            
                            <div v-for="lot in filteredLots" :key="lot.id" 
                                 class="bg-white border rounded-lg p-4 hover:shadow-md transition-shadow">
                                <div class="flex items-start justify-between">
                                    <div class="flex items-center space-x-3">
                                        <!-- Roll Icon -->
                                        <div :class="[getRollIconClass(lot), 'w-8 h-8 rounded-full flex items-center justify-center text-white text-sm']">
                                            <i :class="getRollIcon(lot)"></i>
                                        </div>
                                        
                                        <!-- Lot Info -->
                                        <div>
                                            <h4 class="font-semibold text-lg">{{ lot.lot_id }}</h4>
                                            <div class="text-sm text-gray-600">
                                                <span :class="getStatusClass(lot.lot_status)" 
                                                      class="inline-block px-2 py-1 rounded text-xs font-medium">
                                                    {{ getStatusText(lot.lot_status) }}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Lot Details -->
                                    <div class="text-right">
                                        <div class="text-lg font-semibold">{{ lot.current_meters?.toFixed(2) }} / {{ lot.calculated_meters?.toFixed(2) }} ม.</div>
                                        <div class="text-sm text-gray-500">{{ getUsageText(lot) }}</div>
                                    </div>
                                </div>
                                
                                <!-- Usage Progress Bar -->
                                <div class="mt-3">
                                    <div class="flex justify-between text-xs text-gray-500 mb-1">
                                        <span>การใช้งาน</span>
                                        <span>{{ getUsagePercentage(lot).toFixed(1) }}%</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div :class="getUsageBarClass(lot)" 
                                             class="h-2 rounded-full transition-all duration-300"
                                             :style="{ width: getUsagePercentage(lot) + '%' }">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Additional Info -->
                                <div class="mt-3 grid grid-cols-2 md:grid-cols-4 gap-4 text-xs text-gray-600">
                                    <div>
                                        <strong>น้ำหนักคงเหลือ:</strong><br>
                                        {{ lot.current_weight_kg?.toFixed(2) }} / {{ lot.original_weight_kg?.toFixed(2) }} กก.
                                    </div>
                                    <div>
                                        <strong>ราคา:</strong><br>
                                        {{ lot.price_per_kg?.toLocaleString() }} บาท/กก.
                                    </div>
                                    <div>
                                        <strong>วันที่รับ:</strong><br>
                                        {{ formatDate(lot.received_date) }}
                                    </div>
                                    <div>
                                        <strong>ผู้ผลิต:</strong><br>
                                        {{ lot.supplier_name || '-' }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Empty State -->
                        <div v-if="filteredLots.length === 0" class="text-center py-8">
                            <i class="fas fa-inbox text-4xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500">ไม่พบข้อมูล Lot ที่ตรงกับเงื่อนไข</p>
                        </div>
                    </div>
                    
                    <!-- Error State -->
                    <div v-else class="text-center py-8">
                        <i class="fas fa-exclamation-triangle text-4xl text-red-400 mb-4"></i>
                        <p class="text-red-600">เกิดข้อผิดพลาดในการโหลดข้อมูล</p>
                    </div>
                </div>
            `
        }

        // Vue App
        const { createApp } = Vue
        
        createApp({
            components: {
                ProductLotSummary
            },
            setup() {
                const testProductId = "66f123456789abcd12345678"
                
                return {
                    testProductId
                }
            }
        }).mount('#app')
    </script>
</body>
</html>